<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>os/windows.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! This file contains thin wrappers around Windows-specific APIs, with these</span></span>
<span class="line" id="L2"><span class="tok-comment">//! specific goals in mind:</span></span>
<span class="line" id="L3"><span class="tok-comment">//! * Convert &quot;errno&quot;-style error codes into Zig errors.</span></span>
<span class="line" id="L4"><span class="tok-comment">//! * When null-terminated or UTF16LE byte buffers are required, provide APIs which accept</span></span>
<span class="line" id="L5"><span class="tok-comment">//!   slices as well as APIs which accept null-terminated UTF16LE byte buffers.</span></span>
<span class="line" id="L6"></span>
<span class="line" id="L7"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L8"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../std.zig&quot;</span>);</span>
<span class="line" id="L9"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L12"><span class="tok-kw">const</span> maxInt = std.math.maxInt;</span>
<span class="line" id="L13"><span class="tok-kw">const</span> native_arch = builtin.cpu.arch;</span>
<span class="line" id="L14"></span>
<span class="line" id="L15"><span class="tok-kw">test</span> {</span>
<span class="line" id="L16">    <span class="tok-kw">if</span> (builtin.os.tag == .windows) {</span>
<span class="line" id="L17">        _ = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/test.zig&quot;</span>);</span>
<span class="line" id="L18">    }</span>
<span class="line" id="L19">}</span>
<span class="line" id="L20"></span>
<span class="line" id="L21"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> advapi32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/advapi32.zig&quot;</span>);</span>
<span class="line" id="L22"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> kernel32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/kernel32.zig&quot;</span>);</span>
<span class="line" id="L23"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ntdll = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/ntdll.zig&quot;</span>);</span>
<span class="line" id="L24"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ole32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/ole32.zig&quot;</span>);</span>
<span class="line" id="L25"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> psapi = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/psapi.zig&quot;</span>);</span>
<span class="line" id="L26"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> shell32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/shell32.zig&quot;</span>);</span>
<span class="line" id="L27"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> user32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/user32.zig&quot;</span>);</span>
<span class="line" id="L28"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ws2_32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/ws2_32.zig&quot;</span>);</span>
<span class="line" id="L29"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> gdi32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/gdi32.zig&quot;</span>);</span>
<span class="line" id="L30"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> winmm = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/winmm.zig&quot;</span>);</span>
<span class="line" id="L31"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> crypt32 = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/crypt32.zig&quot;</span>);</span>
<span class="line" id="L32"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> nls = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/nls.zig&quot;</span>);</span>
<span class="line" id="L33"></span>
<span class="line" id="L34"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> self_process_handle = <span class="tok-builtin">@as</span>(HANDLE, <span class="tok-builtin">@ptrFromInt</span>(maxInt(<span class="tok-type">usize</span>)));</span>
<span class="line" id="L35"></span>
<span class="line" id="L36"><span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L37"></span>
<span class="line" id="L38"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OpenError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L39">    IsDir,</span>
<span class="line" id="L40">    NotDir,</span>
<span class="line" id="L41">    FileNotFound,</span>
<span class="line" id="L42">    NoDevice,</span>
<span class="line" id="L43">    AccessDenied,</span>
<span class="line" id="L44">    PipeBusy,</span>
<span class="line" id="L45">    PathAlreadyExists,</span>
<span class="line" id="L46">    Unexpected,</span>
<span class="line" id="L47">    NameTooLong,</span>
<span class="line" id="L48">    WouldBlock,</span>
<span class="line" id="L49">    NetworkNotFound,</span>
<span class="line" id="L50">};</span>
<span class="line" id="L51"></span>
<span class="line" id="L52"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OpenFileOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L53">    access_mask: ACCESS_MASK,</span>
<span class="line" id="L54">    dir: ?HANDLE = <span class="tok-null">null</span>,</span>
<span class="line" id="L55">    sa: ?*SECURITY_ATTRIBUTES = <span class="tok-null">null</span>,</span>
<span class="line" id="L56">    share_access: ULONG = FILE_SHARE_WRITE | FILE_SHARE_READ | FILE_SHARE_DELETE,</span>
<span class="line" id="L57">    creation: ULONG,</span>
<span class="line" id="L58">    io_mode: std.io.ModeOverride,</span>
<span class="line" id="L59">    <span class="tok-comment">/// If true, tries to open path as a directory.</span></span>
<span class="line" id="L60">    <span class="tok-comment">/// Defaults to false.</span></span>
<span class="line" id="L61">    filter: Filter = .file_only,</span>
<span class="line" id="L62">    <span class="tok-comment">/// If false, tries to open path as a reparse point without dereferencing it.</span></span>
<span class="line" id="L63">    <span class="tok-comment">/// Defaults to true.</span></span>
<span class="line" id="L64">    follow_symlinks: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L65"></span>
<span class="line" id="L66">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Filter = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L67">        <span class="tok-comment">/// Causes `OpenFile` to return `error.IsDir` if the opened handle would be a directory.</span></span>
<span class="line" id="L68">        file_only,</span>
<span class="line" id="L69">        <span class="tok-comment">/// Causes `OpenFile` to return `error.NotDir` if the opened handle would be a file.</span></span>
<span class="line" id="L70">        dir_only,</span>
<span class="line" id="L71">        <span class="tok-comment">/// `OpenFile` does not discriminate between opening files and directories.</span></span>
<span class="line" id="L72">        any,</span>
<span class="line" id="L73">    };</span>
<span class="line" id="L74">};</span>
<span class="line" id="L75"></span>
<span class="line" id="L76"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">OpenFile</span>(sub_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, options: OpenFileOptions) OpenError!HANDLE {</span>
<span class="line" id="L77">    <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u16</span>, sub_path_w, &amp;[_]<span class="tok-type">u16</span>{<span class="tok-str">'.'</span>}) <span class="tok-kw">and</span> options.filter == .file_only) {</span>
<span class="line" id="L78">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir;</span>
<span class="line" id="L79">    }</span>
<span class="line" id="L80">    <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u16</span>, sub_path_w, &amp;[_]<span class="tok-type">u16</span>{ <span class="tok-str">'.'</span>, <span class="tok-str">'.'</span> }) <span class="tok-kw">and</span> options.filter == .file_only) {</span>
<span class="line" id="L81">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir;</span>
<span class="line" id="L82">    }</span>
<span class="line" id="L83"></span>
<span class="line" id="L84">    <span class="tok-kw">var</span> result: HANDLE = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L85"></span>
<span class="line" id="L86">    <span class="tok-kw">const</span> path_len_bytes = math.cast(<span class="tok-type">u16</span>, sub_path_w.len * <span class="tok-number">2</span>) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L87">    <span class="tok-kw">var</span> nt_name = UNICODE_STRING{</span>
<span class="line" id="L88">        .Length = path_len_bytes,</span>
<span class="line" id="L89">        .MaximumLength = path_len_bytes,</span>
<span class="line" id="L90">        .Buffer = <span class="tok-builtin">@constCast</span>(sub_path_w.ptr),</span>
<span class="line" id="L91">    };</span>
<span class="line" id="L92">    <span class="tok-kw">var</span> attr = OBJECT_ATTRIBUTES{</span>
<span class="line" id="L93">        .Length = <span class="tok-builtin">@sizeOf</span>(OBJECT_ATTRIBUTES),</span>
<span class="line" id="L94">        .RootDirectory = <span class="tok-kw">if</span> (std.fs.path.isAbsoluteWindowsWTF16(sub_path_w)) <span class="tok-null">null</span> <span class="tok-kw">else</span> options.dir,</span>
<span class="line" id="L95">        .Attributes = <span class="tok-number">0</span>, <span class="tok-comment">// Note we do not use OBJ_CASE_INSENSITIVE here.</span>
</span>
<span class="line" id="L96">        .ObjectName = &amp;nt_name,</span>
<span class="line" id="L97">        .SecurityDescriptor = <span class="tok-kw">if</span> (options.sa) |ptr| ptr.lpSecurityDescriptor <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L98">        .SecurityQualityOfService = <span class="tok-null">null</span>,</span>
<span class="line" id="L99">    };</span>
<span class="line" id="L100">    <span class="tok-kw">var</span> io: IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L101">    <span class="tok-kw">const</span> blocking_flag: ULONG = <span class="tok-kw">if</span> (options.io_mode == .blocking) FILE_SYNCHRONOUS_IO_NONALERT <span class="tok-kw">else</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L102">    <span class="tok-kw">const</span> file_or_dir_flag: ULONG = <span class="tok-kw">switch</span> (options.filter) {</span>
<span class="line" id="L103">        .file_only =&gt; FILE_NON_DIRECTORY_FILE,</span>
<span class="line" id="L104">        .dir_only =&gt; FILE_DIRECTORY_FILE,</span>
<span class="line" id="L105">        .any =&gt; <span class="tok-number">0</span>,</span>
<span class="line" id="L106">    };</span>
<span class="line" id="L107">    <span class="tok-comment">// If we're not following symlinks, we need to ensure we don't pass in any synchronization flags such as FILE_SYNCHRONOUS_IO_NONALERT.</span>
</span>
<span class="line" id="L108">    <span class="tok-kw">const</span> flags: ULONG = <span class="tok-kw">if</span> (options.follow_symlinks) file_or_dir_flag | blocking_flag <span class="tok-kw">else</span> file_or_dir_flag | FILE_OPEN_REPARSE_POINT;</span>
<span class="line" id="L109"></span>
<span class="line" id="L110">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L111">        <span class="tok-kw">const</span> rc = ntdll.NtCreateFile(</span>
<span class="line" id="L112">            &amp;result,</span>
<span class="line" id="L113">            options.access_mask,</span>
<span class="line" id="L114">            &amp;attr,</span>
<span class="line" id="L115">            &amp;io,</span>
<span class="line" id="L116">            <span class="tok-null">null</span>,</span>
<span class="line" id="L117">            FILE_ATTRIBUTE_NORMAL,</span>
<span class="line" id="L118">            options.share_access,</span>
<span class="line" id="L119">            options.creation,</span>
<span class="line" id="L120">            flags,</span>
<span class="line" id="L121">            <span class="tok-null">null</span>,</span>
<span class="line" id="L122">            <span class="tok-number">0</span>,</span>
<span class="line" id="L123">        );</span>
<span class="line" id="L124">        <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L125">            .SUCCESS =&gt; {</span>
<span class="line" id="L126">                <span class="tok-kw">if</span> (std.io.is_async <span class="tok-kw">and</span> options.io_mode == .evented) {</span>
<span class="line" id="L127">                    _ = CreateIoCompletionPort(result, std.event.Loop.instance.?.os_data.io_port, <span class="tok-null">undefined</span>, <span class="tok-null">undefined</span>) <span class="tok-kw">catch</span> <span class="tok-null">undefined</span>;</span>
<span class="line" id="L128">                }</span>
<span class="line" id="L129">                <span class="tok-kw">return</span> result;</span>
<span class="line" id="L130">            },</span>
<span class="line" id="L131">            .OBJECT_NAME_INVALID =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L132">            .OBJECT_NAME_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L133">            .OBJECT_PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L134">            .BAD_NETWORK_PATH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkNotFound, <span class="tok-comment">// \\server was not found</span>
</span>
<span class="line" id="L135">            .BAD_NETWORK_NAME =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkNotFound, <span class="tok-comment">// \\server was found but \\server\share wasn't</span>
</span>
<span class="line" id="L136">            .NO_MEDIA_IN_DEVICE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L137">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L138">            .SHARING_VIOLATION =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L139">            .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L140">            .PIPE_BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PipeBusy,</span>
<span class="line" id="L141">            .OBJECT_PATH_SYNTAX_BAD =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L142">            .OBJECT_NAME_COLLISION =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L143">            .FILE_IS_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L144">            .NOT_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L145">            .USER_MAPPED_FILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L146">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L147">            .DELETE_PENDING =&gt; {</span>
<span class="line" id="L148">                <span class="tok-comment">// This error means that there *was* a file in this location on</span>
</span>
<span class="line" id="L149">                <span class="tok-comment">// the file system, but it was deleted. However, the OS is not</span>
</span>
<span class="line" id="L150">                <span class="tok-comment">// finished with the deletion operation, and so this CreateFile</span>
</span>
<span class="line" id="L151">                <span class="tok-comment">// call has failed. There is not really a sane way to handle</span>
</span>
<span class="line" id="L152">                <span class="tok-comment">// this other than retrying the creation after the OS finishes</span>
</span>
<span class="line" id="L153">                <span class="tok-comment">// the deletion.</span>
</span>
<span class="line" id="L154">                std.time.sleep(std.time.ns_per_ms);</span>
<span class="line" id="L155">                <span class="tok-kw">continue</span>;</span>
<span class="line" id="L156">            },</span>
<span class="line" id="L157">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L158">        }</span>
<span class="line" id="L159">    }</span>
<span class="line" id="L160">}</span>
<span class="line" id="L161"></span>
<span class="line" id="L162"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CreatePipeError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L163"></span>
<span class="line" id="L164"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CreatePipe</span>(rd: *HANDLE, wr: *HANDLE, sattr: *<span class="tok-kw">const</span> SECURITY_ATTRIBUTES) CreatePipeError!<span class="tok-type">void</span> {</span>
<span class="line" id="L165">    <span class="tok-kw">if</span> (kernel32.CreatePipe(rd, wr, sattr, <span class="tok-number">0</span>) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L166">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L167">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L168">        }</span>
<span class="line" id="L169">    }</span>
<span class="line" id="L170">}</span>
<span class="line" id="L171"></span>
<span class="line" id="L172"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CreateEventEx</span>(attributes: ?*SECURITY_ATTRIBUTES, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: DWORD, desired_access: DWORD) !HANDLE {</span>
<span class="line" id="L173">    <span class="tok-kw">const</span> nameW = <span class="tok-kw">try</span> sliceToPrefixedFileW(name);</span>
<span class="line" id="L174">    <span class="tok-kw">return</span> CreateEventExW(attributes, nameW.span().ptr, flags, desired_access);</span>
<span class="line" id="L175">}</span>
<span class="line" id="L176"></span>
<span class="line" id="L177"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CreateEventExW</span>(attributes: ?*SECURITY_ATTRIBUTES, nameW: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, flags: DWORD, desired_access: DWORD) !HANDLE {</span>
<span class="line" id="L178">    <span class="tok-kw">const</span> handle = kernel32.CreateEventExW(attributes, nameW, flags, desired_access);</span>
<span class="line" id="L179">    <span class="tok-kw">if</span> (handle) |h| {</span>
<span class="line" id="L180">        <span class="tok-kw">return</span> h;</span>
<span class="line" id="L181">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L182">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L183">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L184">        }</span>
<span class="line" id="L185">    }</span>
<span class="line" id="L186">}</span>
<span class="line" id="L187"></span>
<span class="line" id="L188"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DeviceIoControlError = <span class="tok-kw">error</span>{ AccessDenied, Unexpected };</span>
<span class="line" id="L189"></span>
<span class="line" id="L190"><span class="tok-comment">/// A Zig wrapper around `NtDeviceIoControlFile` and `NtFsControlFile` syscalls.</span></span>
<span class="line" id="L191"><span class="tok-comment">/// It implements similar behavior to `DeviceIoControl` and is meant to serve</span></span>
<span class="line" id="L192"><span class="tok-comment">/// as a direct substitute for that call.</span></span>
<span class="line" id="L193"><span class="tok-comment">/// TODO work out if we need to expose other arguments to the underlying syscalls.</span></span>
<span class="line" id="L194"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">DeviceIoControl</span>(</span>
<span class="line" id="L195">    h: HANDLE,</span>
<span class="line" id="L196">    ioControlCode: ULONG,</span>
<span class="line" id="L197">    in: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L198">    out: ?[]<span class="tok-type">u8</span>,</span>
<span class="line" id="L199">) DeviceIoControlError!<span class="tok-type">void</span> {</span>
<span class="line" id="L200">    <span class="tok-comment">// Logic from: https://doxygen.reactos.org/d3/d74/deviceio_8c.html</span>
</span>
<span class="line" id="L201">    <span class="tok-kw">const</span> is_fsctl = (ioControlCode &gt;&gt; <span class="tok-number">16</span>) == FILE_DEVICE_FILE_SYSTEM;</span>
<span class="line" id="L202"></span>
<span class="line" id="L203">    <span class="tok-kw">var</span> io: IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L204">    <span class="tok-kw">const</span> in_ptr = <span class="tok-kw">if</span> (in) |i| i.ptr <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L205">    <span class="tok-kw">const</span> in_len = <span class="tok-kw">if</span> (in) |i| <span class="tok-builtin">@as</span>(ULONG, <span class="tok-builtin">@intCast</span>(i.len)) <span class="tok-kw">else</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L206">    <span class="tok-kw">const</span> out_ptr = <span class="tok-kw">if</span> (out) |o| o.ptr <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L207">    <span class="tok-kw">const</span> out_len = <span class="tok-kw">if</span> (out) |o| <span class="tok-builtin">@as</span>(ULONG, <span class="tok-builtin">@intCast</span>(o.len)) <span class="tok-kw">else</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L208"></span>
<span class="line" id="L209">    <span class="tok-kw">const</span> rc = blk: {</span>
<span class="line" id="L210">        <span class="tok-kw">if</span> (is_fsctl) {</span>
<span class="line" id="L211">            <span class="tok-kw">break</span> :blk ntdll.NtFsControlFile(</span>
<span class="line" id="L212">                h,</span>
<span class="line" id="L213">                <span class="tok-null">null</span>,</span>
<span class="line" id="L214">                <span class="tok-null">null</span>,</span>
<span class="line" id="L215">                <span class="tok-null">null</span>,</span>
<span class="line" id="L216">                &amp;io,</span>
<span class="line" id="L217">                ioControlCode,</span>
<span class="line" id="L218">                in_ptr,</span>
<span class="line" id="L219">                in_len,</span>
<span class="line" id="L220">                out_ptr,</span>
<span class="line" id="L221">                out_len,</span>
<span class="line" id="L222">            );</span>
<span class="line" id="L223">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L224">            <span class="tok-kw">break</span> :blk ntdll.NtDeviceIoControlFile(</span>
<span class="line" id="L225">                h,</span>
<span class="line" id="L226">                <span class="tok-null">null</span>,</span>
<span class="line" id="L227">                <span class="tok-null">null</span>,</span>
<span class="line" id="L228">                <span class="tok-null">null</span>,</span>
<span class="line" id="L229">                &amp;io,</span>
<span class="line" id="L230">                ioControlCode,</span>
<span class="line" id="L231">                in_ptr,</span>
<span class="line" id="L232">                in_len,</span>
<span class="line" id="L233">                out_ptr,</span>
<span class="line" id="L234">                out_len,</span>
<span class="line" id="L235">            );</span>
<span class="line" id="L236">        }</span>
<span class="line" id="L237">    };</span>
<span class="line" id="L238">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L239">        .SUCCESS =&gt; {},</span>
<span class="line" id="L240">        .PRIVILEGE_NOT_HELD =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L241">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L242">        .INVALID_DEVICE_REQUEST =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied, <span class="tok-comment">// Not supported by the underlying filesystem</span>
</span>
<span class="line" id="L243">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L244">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L245">    }</span>
<span class="line" id="L246">}</span>
<span class="line" id="L247"></span>
<span class="line" id="L248"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetOverlappedResult</span>(h: HANDLE, overlapped: *OVERLAPPED, wait: <span class="tok-type">bool</span>) !DWORD {</span>
<span class="line" id="L249">    <span class="tok-kw">var</span> bytes: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L250">    <span class="tok-kw">if</span> (kernel32.GetOverlappedResult(h, overlapped, &amp;bytes, <span class="tok-builtin">@intFromBool</span>(wait)) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L251">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L252">            .IO_INCOMPLETE =&gt; <span class="tok-kw">if</span> (!wait) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock <span class="tok-kw">else</span> <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L253">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L254">        }</span>
<span class="line" id="L255">    }</span>
<span class="line" id="L256">    <span class="tok-kw">return</span> bytes;</span>
<span class="line" id="L257">}</span>
<span class="line" id="L258"></span>
<span class="line" id="L259"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetHandleInformationError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L260"></span>
<span class="line" id="L261"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetHandleInformation</span>(h: HANDLE, mask: DWORD, flags: DWORD) SetHandleInformationError!<span class="tok-type">void</span> {</span>
<span class="line" id="L262">    <span class="tok-kw">if</span> (kernel32.SetHandleInformation(h, mask, flags) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L263">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L264">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L265">        }</span>
<span class="line" id="L266">    }</span>
<span class="line" id="L267">}</span>
<span class="line" id="L268"></span>
<span class="line" id="L269"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RtlGenRandomError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L270"></span>
<span class="line" id="L271"><span class="tok-comment">/// Call RtlGenRandom() instead of CryptGetRandom() on Windows</span></span>
<span class="line" id="L272"><span class="tok-comment">/// https://github.com/rust-lang-nursery/rand/issues/111</span></span>
<span class="line" id="L273"><span class="tok-comment">/// https://bugzilla.mozilla.org/show_bug.cgi?id=504270</span></span>
<span class="line" id="L274"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">RtlGenRandom</span>(output: []<span class="tok-type">u8</span>) RtlGenRandomError!<span class="tok-type">void</span> {</span>
<span class="line" id="L275">    <span class="tok-kw">var</span> total_read: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L276">    <span class="tok-kw">var</span> buff: []<span class="tok-type">u8</span> = output[<span class="tok-number">0</span>..];</span>
<span class="line" id="L277">    <span class="tok-kw">const</span> max_read_size: ULONG = maxInt(ULONG);</span>
<span class="line" id="L278"></span>
<span class="line" id="L279">    <span class="tok-kw">while</span> (total_read &lt; output.len) {</span>
<span class="line" id="L280">        <span class="tok-kw">const</span> to_read: ULONG = <span class="tok-builtin">@min</span>(buff.len, max_read_size);</span>
<span class="line" id="L281"></span>
<span class="line" id="L282">        <span class="tok-kw">if</span> (advapi32.RtlGenRandom(buff.ptr, to_read) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L283">            <span class="tok-kw">return</span> unexpectedError(kernel32.GetLastError());</span>
<span class="line" id="L284">        }</span>
<span class="line" id="L285"></span>
<span class="line" id="L286">        total_read += to_read;</span>
<span class="line" id="L287">        buff = buff[to_read..];</span>
<span class="line" id="L288">    }</span>
<span class="line" id="L289">}</span>
<span class="line" id="L290"></span>
<span class="line" id="L291"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WaitForSingleObjectError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L292">    WaitAbandoned,</span>
<span class="line" id="L293">    WaitTimeOut,</span>
<span class="line" id="L294">    Unexpected,</span>
<span class="line" id="L295">};</span>
<span class="line" id="L296"></span>
<span class="line" id="L297"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WaitForSingleObject</span>(handle: HANDLE, milliseconds: DWORD) WaitForSingleObjectError!<span class="tok-type">void</span> {</span>
<span class="line" id="L298">    <span class="tok-kw">return</span> WaitForSingleObjectEx(handle, milliseconds, <span class="tok-null">false</span>);</span>
<span class="line" id="L299">}</span>
<span class="line" id="L300"></span>
<span class="line" id="L301"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WaitForSingleObjectEx</span>(handle: HANDLE, milliseconds: DWORD, alertable: <span class="tok-type">bool</span>) WaitForSingleObjectError!<span class="tok-type">void</span> {</span>
<span class="line" id="L302">    <span class="tok-kw">switch</span> (kernel32.WaitForSingleObjectEx(handle, milliseconds, <span class="tok-builtin">@intFromBool</span>(alertable))) {</span>
<span class="line" id="L303">        WAIT_ABANDONED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WaitAbandoned,</span>
<span class="line" id="L304">        WAIT_OBJECT_0 =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L305">        WAIT_TIMEOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WaitTimeOut,</span>
<span class="line" id="L306">        WAIT_FAILED =&gt; <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L307">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L308">        },</span>
<span class="line" id="L309">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L310">    }</span>
<span class="line" id="L311">}</span>
<span class="line" id="L312"></span>
<span class="line" id="L313"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WaitForMultipleObjectsEx</span>(handles: []<span class="tok-kw">const</span> HANDLE, waitAll: <span class="tok-type">bool</span>, milliseconds: DWORD, alertable: <span class="tok-type">bool</span>) !<span class="tok-type">u32</span> {</span>
<span class="line" id="L314">    assert(handles.len &lt; MAXIMUM_WAIT_OBJECTS);</span>
<span class="line" id="L315">    <span class="tok-kw">const</span> nCount: DWORD = <span class="tok-builtin">@as</span>(DWORD, <span class="tok-builtin">@intCast</span>(handles.len));</span>
<span class="line" id="L316">    <span class="tok-kw">switch</span> (kernel32.WaitForMultipleObjectsEx(</span>
<span class="line" id="L317">        nCount,</span>
<span class="line" id="L318">        handles.ptr,</span>
<span class="line" id="L319">        <span class="tok-builtin">@intFromBool</span>(waitAll),</span>
<span class="line" id="L320">        milliseconds,</span>
<span class="line" id="L321">        <span class="tok-builtin">@intFromBool</span>(alertable),</span>
<span class="line" id="L322">    )) {</span>
<span class="line" id="L323">        WAIT_OBJECT_0...WAIT_OBJECT_0 + MAXIMUM_WAIT_OBJECTS =&gt; |n| {</span>
<span class="line" id="L324">            <span class="tok-kw">const</span> handle_index = n - WAIT_OBJECT_0;</span>
<span class="line" id="L325">            assert(handle_index &lt; nCount);</span>
<span class="line" id="L326">            <span class="tok-kw">return</span> handle_index;</span>
<span class="line" id="L327">        },</span>
<span class="line" id="L328">        WAIT_ABANDONED_0...WAIT_ABANDONED_0 + MAXIMUM_WAIT_OBJECTS =&gt; |n| {</span>
<span class="line" id="L329">            <span class="tok-kw">const</span> handle_index = n - WAIT_ABANDONED_0;</span>
<span class="line" id="L330">            assert(handle_index &lt; nCount);</span>
<span class="line" id="L331">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WaitAbandoned;</span>
<span class="line" id="L332">        },</span>
<span class="line" id="L333">        WAIT_TIMEOUT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WaitTimeOut,</span>
<span class="line" id="L334">        WAIT_FAILED =&gt; <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L335">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L336">        },</span>
<span class="line" id="L337">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L338">    }</span>
<span class="line" id="L339">}</span>
<span class="line" id="L340"></span>
<span class="line" id="L341"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CreateIoCompletionPortError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L342"></span>
<span class="line" id="L343"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CreateIoCompletionPort</span>(</span>
<span class="line" id="L344">    file_handle: HANDLE,</span>
<span class="line" id="L345">    existing_completion_port: ?HANDLE,</span>
<span class="line" id="L346">    completion_key: <span class="tok-type">usize</span>,</span>
<span class="line" id="L347">    concurrent_thread_count: DWORD,</span>
<span class="line" id="L348">) CreateIoCompletionPortError!HANDLE {</span>
<span class="line" id="L349">    <span class="tok-kw">const</span> handle = kernel32.CreateIoCompletionPort(file_handle, existing_completion_port, completion_key, concurrent_thread_count) <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L350">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L351">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L352">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L353">        }</span>
<span class="line" id="L354">    };</span>
<span class="line" id="L355">    <span class="tok-kw">return</span> handle;</span>
<span class="line" id="L356">}</span>
<span class="line" id="L357"></span>
<span class="line" id="L358"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PostQueuedCompletionStatusError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L359"></span>
<span class="line" id="L360"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">PostQueuedCompletionStatus</span>(</span>
<span class="line" id="L361">    completion_port: HANDLE,</span>
<span class="line" id="L362">    bytes_transferred_count: DWORD,</span>
<span class="line" id="L363">    completion_key: <span class="tok-type">usize</span>,</span>
<span class="line" id="L364">    lpOverlapped: ?*OVERLAPPED,</span>
<span class="line" id="L365">) PostQueuedCompletionStatusError!<span class="tok-type">void</span> {</span>
<span class="line" id="L366">    <span class="tok-kw">if</span> (kernel32.PostQueuedCompletionStatus(completion_port, bytes_transferred_count, completion_key, lpOverlapped) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L367">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L368">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L369">        }</span>
<span class="line" id="L370">    }</span>
<span class="line" id="L371">}</span>
<span class="line" id="L372"></span>
<span class="line" id="L373"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetQueuedCompletionStatusResult = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L374">    Normal,</span>
<span class="line" id="L375">    Aborted,</span>
<span class="line" id="L376">    Cancelled,</span>
<span class="line" id="L377">    EOF,</span>
<span class="line" id="L378">};</span>
<span class="line" id="L379"></span>
<span class="line" id="L380"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetQueuedCompletionStatus</span>(</span>
<span class="line" id="L381">    completion_port: HANDLE,</span>
<span class="line" id="L382">    bytes_transferred_count: *DWORD,</span>
<span class="line" id="L383">    lpCompletionKey: *<span class="tok-type">usize</span>,</span>
<span class="line" id="L384">    lpOverlapped: *?*OVERLAPPED,</span>
<span class="line" id="L385">    dwMilliseconds: DWORD,</span>
<span class="line" id="L386">) GetQueuedCompletionStatusResult {</span>
<span class="line" id="L387">    <span class="tok-kw">if</span> (kernel32.GetQueuedCompletionStatus(</span>
<span class="line" id="L388">        completion_port,</span>
<span class="line" id="L389">        bytes_transferred_count,</span>
<span class="line" id="L390">        lpCompletionKey,</span>
<span class="line" id="L391">        lpOverlapped,</span>
<span class="line" id="L392">        dwMilliseconds,</span>
<span class="line" id="L393">    ) == FALSE) {</span>
<span class="line" id="L394">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L395">            .ABANDONED_WAIT_0 =&gt; <span class="tok-kw">return</span> GetQueuedCompletionStatusResult.Aborted,</span>
<span class="line" id="L396">            .OPERATION_ABORTED =&gt; <span class="tok-kw">return</span> GetQueuedCompletionStatusResult.Cancelled,</span>
<span class="line" id="L397">            .HANDLE_EOF =&gt; <span class="tok-kw">return</span> GetQueuedCompletionStatusResult.EOF,</span>
<span class="line" id="L398">            <span class="tok-kw">else</span> =&gt; |err| {</span>
<span class="line" id="L399">                <span class="tok-kw">if</span> (std.debug.runtime_safety) {</span>
<span class="line" id="L400">                    <span class="tok-builtin">@setEvalBranchQuota</span>(<span class="tok-number">2500</span>);</span>
<span class="line" id="L401">                    std.debug.panic(<span class="tok-str">&quot;unexpected error: {}\n&quot;</span>, .{err});</span>
<span class="line" id="L402">                }</span>
<span class="line" id="L403">            },</span>
<span class="line" id="L404">        }</span>
<span class="line" id="L405">    }</span>
<span class="line" id="L406">    <span class="tok-kw">return</span> GetQueuedCompletionStatusResult.Normal;</span>
<span class="line" id="L407">}</span>
<span class="line" id="L408"></span>
<span class="line" id="L409"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetQueuedCompletionStatusError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L410">    Aborted,</span>
<span class="line" id="L411">    Cancelled,</span>
<span class="line" id="L412">    EOF,</span>
<span class="line" id="L413">    Timeout,</span>
<span class="line" id="L414">} || std.os.UnexpectedError;</span>
<span class="line" id="L415"></span>
<span class="line" id="L416"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetQueuedCompletionStatusEx</span>(</span>
<span class="line" id="L417">    completion_port: HANDLE,</span>
<span class="line" id="L418">    completion_port_entries: []OVERLAPPED_ENTRY,</span>
<span class="line" id="L419">    timeout_ms: ?DWORD,</span>
<span class="line" id="L420">    alertable: <span class="tok-type">bool</span>,</span>
<span class="line" id="L421">) GetQueuedCompletionStatusError!<span class="tok-type">u32</span> {</span>
<span class="line" id="L422">    <span class="tok-kw">var</span> num_entries_removed: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L423"></span>
<span class="line" id="L424">    <span class="tok-kw">const</span> success = kernel32.GetQueuedCompletionStatusEx(</span>
<span class="line" id="L425">        completion_port,</span>
<span class="line" id="L426">        completion_port_entries.ptr,</span>
<span class="line" id="L427">        <span class="tok-builtin">@as</span>(ULONG, <span class="tok-builtin">@intCast</span>(completion_port_entries.len)),</span>
<span class="line" id="L428">        &amp;num_entries_removed,</span>
<span class="line" id="L429">        timeout_ms <span class="tok-kw">orelse</span> INFINITE,</span>
<span class="line" id="L430">        <span class="tok-builtin">@intFromBool</span>(alertable),</span>
<span class="line" id="L431">    );</span>
<span class="line" id="L432"></span>
<span class="line" id="L433">    <span class="tok-kw">if</span> (success == FALSE) {</span>
<span class="line" id="L434">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L435">            .ABANDONED_WAIT_0 =&gt; <span class="tok-kw">error</span>.Aborted,</span>
<span class="line" id="L436">            .OPERATION_ABORTED =&gt; <span class="tok-kw">error</span>.Cancelled,</span>
<span class="line" id="L437">            .HANDLE_EOF =&gt; <span class="tok-kw">error</span>.EOF,</span>
<span class="line" id="L438">            .IMEOUT =&gt; <span class="tok-kw">error</span>.Timeout,</span>
<span class="line" id="L439">            <span class="tok-kw">else</span> =&gt; |err| unexpectedError(err),</span>
<span class="line" id="L440">        };</span>
<span class="line" id="L441">    }</span>
<span class="line" id="L442"></span>
<span class="line" id="L443">    <span class="tok-kw">return</span> num_entries_removed;</span>
<span class="line" id="L444">}</span>
<span class="line" id="L445"></span>
<span class="line" id="L446"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CloseHandle</span>(hObject: HANDLE) <span class="tok-type">void</span> {</span>
<span class="line" id="L447">    assert(ntdll.NtClose(hObject) == .SUCCESS);</span>
<span class="line" id="L448">}</span>
<span class="line" id="L449"></span>
<span class="line" id="L450"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">FindClose</span>(hFindFile: HANDLE) <span class="tok-type">void</span> {</span>
<span class="line" id="L451">    assert(kernel32.FindClose(hFindFile) != <span class="tok-number">0</span>);</span>
<span class="line" id="L452">}</span>
<span class="line" id="L453"></span>
<span class="line" id="L454"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ReadFileError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L455">    BrokenPipe,</span>
<span class="line" id="L456">    NetNameDeleted,</span>
<span class="line" id="L457">    OperationAborted,</span>
<span class="line" id="L458">    Unexpected,</span>
<span class="line" id="L459">};</span>
<span class="line" id="L460"></span>
<span class="line" id="L461"><span class="tok-comment">/// If buffer's length exceeds what a Windows DWORD integer can hold, it will be broken into</span></span>
<span class="line" id="L462"><span class="tok-comment">/// multiple non-atomic reads.</span></span>
<span class="line" id="L463"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ReadFile</span>(in_hFile: HANDLE, buffer: []<span class="tok-type">u8</span>, offset: ?<span class="tok-type">u64</span>, io_mode: std.io.ModeOverride) ReadFileError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L464">    <span class="tok-kw">if</span> (io_mode != .blocking) {</span>
<span class="line" id="L465">        <span class="tok-kw">const</span> loop = std.event.Loop.instance.?;</span>
<span class="line" id="L466">        <span class="tok-comment">// TODO make getting the file position non-blocking</span>
</span>
<span class="line" id="L467">        <span class="tok-kw">const</span> off = <span class="tok-kw">if</span> (offset) |o| o <span class="tok-kw">else</span> <span class="tok-kw">try</span> SetFilePointerEx_CURRENT_get(in_hFile);</span>
<span class="line" id="L468">        <span class="tok-kw">var</span> resume_node = std.event.Loop.ResumeNode.Basic{</span>
<span class="line" id="L469">            .base = .{</span>
<span class="line" id="L470">                .id = .Basic,</span>
<span class="line" id="L471">                .handle = <span class="tok-builtin">@frame</span>(),</span>
<span class="line" id="L472">                .overlapped = OVERLAPPED{</span>
<span class="line" id="L473">                    .Internal = <span class="tok-number">0</span>,</span>
<span class="line" id="L474">                    .InternalHigh = <span class="tok-number">0</span>,</span>
<span class="line" id="L475">                    .DUMMYUNIONNAME = .{</span>
<span class="line" id="L476">                        .DUMMYSTRUCTNAME = .{</span>
<span class="line" id="L477">                            .Offset = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off)),</span>
<span class="line" id="L478">                            .OffsetHigh = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off &gt;&gt; <span class="tok-number">32</span>)),</span>
<span class="line" id="L479">                        },</span>
<span class="line" id="L480">                    },</span>
<span class="line" id="L481">                    .hEvent = <span class="tok-null">null</span>,</span>
<span class="line" id="L482">                },</span>
<span class="line" id="L483">            },</span>
<span class="line" id="L484">        };</span>
<span class="line" id="L485">        loop.beginOneEvent();</span>
<span class="line" id="L486">        <span class="tok-kw">suspend</span> {</span>
<span class="line" id="L487">            <span class="tok-comment">// TODO handle buffer bigger than DWORD can hold</span>
</span>
<span class="line" id="L488">            _ = kernel32.ReadFile(in_hFile, buffer.ptr, <span class="tok-builtin">@as</span>(DWORD, <span class="tok-builtin">@intCast</span>(buffer.len)), <span class="tok-null">null</span>, &amp;resume_node.base.overlapped);</span>
<span class="line" id="L489">        }</span>
<span class="line" id="L490">        <span class="tok-kw">var</span> bytes_transferred: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L491">        <span class="tok-kw">if</span> (kernel32.GetOverlappedResult(in_hFile, &amp;resume_node.base.overlapped, &amp;bytes_transferred, FALSE) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L492">            <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L493">                .IO_PENDING =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L494">                .OPERATION_ABORTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationAborted,</span>
<span class="line" id="L495">                .BROKEN_PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L496">                .NETNAME_DELETED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetNameDeleted,</span>
<span class="line" id="L497">                .HANDLE_EOF =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, bytes_transferred),</span>
<span class="line" id="L498">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L499">            }</span>
<span class="line" id="L500">        }</span>
<span class="line" id="L501">        <span class="tok-kw">if</span> (offset == <span class="tok-null">null</span>) {</span>
<span class="line" id="L502">            <span class="tok-comment">// TODO make setting the file position non-blocking</span>
</span>
<span class="line" id="L503">            <span class="tok-kw">const</span> new_off = off + bytes_transferred;</span>
<span class="line" id="L504">            <span class="tok-kw">try</span> SetFilePointerEx_CURRENT(in_hFile, <span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, <span class="tok-builtin">@bitCast</span>(new_off)));</span>
<span class="line" id="L505">        }</span>
<span class="line" id="L506">        <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, bytes_transferred);</span>
<span class="line" id="L507">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L508">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L509">            <span class="tok-kw">const</span> want_read_count: DWORD = <span class="tok-builtin">@min</span>(<span class="tok-builtin">@as</span>(DWORD, maxInt(DWORD)), buffer.len);</span>
<span class="line" id="L510">            <span class="tok-kw">var</span> amt_read: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L511">            <span class="tok-kw">var</span> overlapped_data: OVERLAPPED = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L512">            <span class="tok-kw">const</span> overlapped: ?*OVERLAPPED = <span class="tok-kw">if</span> (offset) |off| blk: {</span>
<span class="line" id="L513">                overlapped_data = .{</span>
<span class="line" id="L514">                    .Internal = <span class="tok-number">0</span>,</span>
<span class="line" id="L515">                    .InternalHigh = <span class="tok-number">0</span>,</span>
<span class="line" id="L516">                    .DUMMYUNIONNAME = .{</span>
<span class="line" id="L517">                        .DUMMYSTRUCTNAME = .{</span>
<span class="line" id="L518">                            .Offset = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off)),</span>
<span class="line" id="L519">                            .OffsetHigh = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off &gt;&gt; <span class="tok-number">32</span>)),</span>
<span class="line" id="L520">                        },</span>
<span class="line" id="L521">                    },</span>
<span class="line" id="L522">                    .hEvent = <span class="tok-null">null</span>,</span>
<span class="line" id="L523">                };</span>
<span class="line" id="L524">                <span class="tok-kw">break</span> :blk &amp;overlapped_data;</span>
<span class="line" id="L525">            } <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L526">            <span class="tok-kw">if</span> (kernel32.ReadFile(in_hFile, buffer.ptr, want_read_count, &amp;amt_read, overlapped) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L527">                <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L528">                    .IO_PENDING =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L529">                    .OPERATION_ABORTED =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L530">                    .BROKEN_PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-number">0</span>,</span>
<span class="line" id="L531">                    .HANDLE_EOF =&gt; <span class="tok-kw">return</span> <span class="tok-number">0</span>,</span>
<span class="line" id="L532">                    .NETNAME_DELETED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetNameDeleted,</span>
<span class="line" id="L533">                    <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L534">                }</span>
<span class="line" id="L535">            }</span>
<span class="line" id="L536">            <span class="tok-kw">return</span> amt_read;</span>
<span class="line" id="L537">        }</span>
<span class="line" id="L538">    }</span>
<span class="line" id="L539">}</span>
<span class="line" id="L540"></span>
<span class="line" id="L541"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WriteFileError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L542">    SystemResources,</span>
<span class="line" id="L543">    OperationAborted,</span>
<span class="line" id="L544">    BrokenPipe,</span>
<span class="line" id="L545">    NotOpenForWriting,</span>
<span class="line" id="L546">    <span class="tok-comment">/// The process cannot access the file because another process has locked</span></span>
<span class="line" id="L547">    <span class="tok-comment">/// a portion of the file.</span></span>
<span class="line" id="L548">    LockViolation,</span>
<span class="line" id="L549">    Unexpected,</span>
<span class="line" id="L550">};</span>
<span class="line" id="L551"></span>
<span class="line" id="L552"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WriteFile</span>(</span>
<span class="line" id="L553">    handle: HANDLE,</span>
<span class="line" id="L554">    bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L555">    offset: ?<span class="tok-type">u64</span>,</span>
<span class="line" id="L556">    io_mode: std.io.ModeOverride,</span>
<span class="line" id="L557">) WriteFileError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L558">    <span class="tok-kw">if</span> (std.event.Loop.instance != <span class="tok-null">null</span> <span class="tok-kw">and</span> io_mode != .blocking) {</span>
<span class="line" id="L559">        <span class="tok-kw">const</span> loop = std.event.Loop.instance.?;</span>
<span class="line" id="L560">        <span class="tok-comment">// TODO make getting the file position non-blocking</span>
</span>
<span class="line" id="L561">        <span class="tok-kw">const</span> off = <span class="tok-kw">if</span> (offset) |o| o <span class="tok-kw">else</span> <span class="tok-kw">try</span> SetFilePointerEx_CURRENT_get(handle);</span>
<span class="line" id="L562">        <span class="tok-kw">var</span> resume_node = std.event.Loop.ResumeNode.Basic{</span>
<span class="line" id="L563">            .base = .{</span>
<span class="line" id="L564">                .id = .Basic,</span>
<span class="line" id="L565">                .handle = <span class="tok-builtin">@frame</span>(),</span>
<span class="line" id="L566">                .overlapped = OVERLAPPED{</span>
<span class="line" id="L567">                    .Internal = <span class="tok-number">0</span>,</span>
<span class="line" id="L568">                    .InternalHigh = <span class="tok-number">0</span>,</span>
<span class="line" id="L569">                    .DUMMYUNIONNAME = .{</span>
<span class="line" id="L570">                        .DUMMYSTRUCTNAME = .{</span>
<span class="line" id="L571">                            .Offset = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off)),</span>
<span class="line" id="L572">                            .OffsetHigh = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off &gt;&gt; <span class="tok-number">32</span>)),</span>
<span class="line" id="L573">                        },</span>
<span class="line" id="L574">                    },</span>
<span class="line" id="L575">                    .hEvent = <span class="tok-null">null</span>,</span>
<span class="line" id="L576">                },</span>
<span class="line" id="L577">            },</span>
<span class="line" id="L578">        };</span>
<span class="line" id="L579">        loop.beginOneEvent();</span>
<span class="line" id="L580">        <span class="tok-kw">suspend</span> {</span>
<span class="line" id="L581">            <span class="tok-kw">const</span> adjusted_len = math.cast(DWORD, bytes.len) <span class="tok-kw">orelse</span> maxInt(DWORD);</span>
<span class="line" id="L582">            _ = kernel32.WriteFile(handle, bytes.ptr, adjusted_len, <span class="tok-null">null</span>, &amp;resume_node.base.overlapped);</span>
<span class="line" id="L583">        }</span>
<span class="line" id="L584">        <span class="tok-kw">var</span> bytes_transferred: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L585">        <span class="tok-kw">if</span> (kernel32.GetOverlappedResult(handle, &amp;resume_node.base.overlapped, &amp;bytes_transferred, FALSE) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L586">            <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L587">                .IO_PENDING =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L588">                .INVALID_USER_BUFFER =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L589">                .NOT_ENOUGH_MEMORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L590">                .OPERATION_ABORTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationAborted,</span>
<span class="line" id="L591">                .NOT_ENOUGH_QUOTA =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L592">                .BROKEN_PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L593">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L594">            }</span>
<span class="line" id="L595">        }</span>
<span class="line" id="L596">        <span class="tok-kw">if</span> (offset == <span class="tok-null">null</span>) {</span>
<span class="line" id="L597">            <span class="tok-comment">// TODO make setting the file position non-blocking</span>
</span>
<span class="line" id="L598">            <span class="tok-kw">const</span> new_off = off + bytes_transferred;</span>
<span class="line" id="L599">            <span class="tok-kw">try</span> SetFilePointerEx_CURRENT(handle, <span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, <span class="tok-builtin">@bitCast</span>(new_off)));</span>
<span class="line" id="L600">        }</span>
<span class="line" id="L601">        <span class="tok-kw">return</span> bytes_transferred;</span>
<span class="line" id="L602">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L603">        <span class="tok-kw">var</span> bytes_written: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L604">        <span class="tok-kw">var</span> overlapped_data: OVERLAPPED = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L605">        <span class="tok-kw">const</span> overlapped: ?*OVERLAPPED = <span class="tok-kw">if</span> (offset) |off| blk: {</span>
<span class="line" id="L606">            overlapped_data = .{</span>
<span class="line" id="L607">                .Internal = <span class="tok-number">0</span>,</span>
<span class="line" id="L608">                .InternalHigh = <span class="tok-number">0</span>,</span>
<span class="line" id="L609">                .DUMMYUNIONNAME = .{</span>
<span class="line" id="L610">                    .DUMMYSTRUCTNAME = .{</span>
<span class="line" id="L611">                        .Offset = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off)),</span>
<span class="line" id="L612">                        .OffsetHigh = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(off &gt;&gt; <span class="tok-number">32</span>)),</span>
<span class="line" id="L613">                    },</span>
<span class="line" id="L614">                },</span>
<span class="line" id="L615">                .hEvent = <span class="tok-null">null</span>,</span>
<span class="line" id="L616">            };</span>
<span class="line" id="L617">            <span class="tok-kw">break</span> :blk &amp;overlapped_data;</span>
<span class="line" id="L618">        } <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L619">        <span class="tok-kw">const</span> adjusted_len = math.cast(<span class="tok-type">u32</span>, bytes.len) <span class="tok-kw">orelse</span> maxInt(<span class="tok-type">u32</span>);</span>
<span class="line" id="L620">        <span class="tok-kw">if</span> (kernel32.WriteFile(handle, bytes.ptr, adjusted_len, &amp;bytes_written, overlapped) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L621">            <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L622">                .INVALID_USER_BUFFER =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L623">                .NOT_ENOUGH_MEMORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L624">                .OPERATION_ABORTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OperationAborted,</span>
<span class="line" id="L625">                .NOT_ENOUGH_QUOTA =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L626">                .IO_PENDING =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L627">                .BROKEN_PIPE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BrokenPipe,</span>
<span class="line" id="L628">                .INVALID_HANDLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotOpenForWriting,</span>
<span class="line" id="L629">                .LOCK_VIOLATION =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.LockViolation,</span>
<span class="line" id="L630">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L631">            }</span>
<span class="line" id="L632">        }</span>
<span class="line" id="L633">        <span class="tok-kw">return</span> bytes_written;</span>
<span class="line" id="L634">    }</span>
<span class="line" id="L635">}</span>
<span class="line" id="L636"></span>
<span class="line" id="L637"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetCurrentDirectoryError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L638">    NameTooLong,</span>
<span class="line" id="L639">    InvalidUtf8,</span>
<span class="line" id="L640">    FileNotFound,</span>
<span class="line" id="L641">    NotDir,</span>
<span class="line" id="L642">    AccessDenied,</span>
<span class="line" id="L643">    NoDevice,</span>
<span class="line" id="L644">    BadPathName,</span>
<span class="line" id="L645">    Unexpected,</span>
<span class="line" id="L646">};</span>
<span class="line" id="L647"></span>
<span class="line" id="L648"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetCurrentDirectory</span>(path_name: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>) SetCurrentDirectoryError!<span class="tok-type">void</span> {</span>
<span class="line" id="L649">    <span class="tok-kw">const</span> path_len_bytes = math.cast(<span class="tok-type">u16</span>, path_name.len * <span class="tok-number">2</span>) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L650"></span>
<span class="line" id="L651">    <span class="tok-kw">var</span> nt_name = UNICODE_STRING{</span>
<span class="line" id="L652">        .Length = path_len_bytes,</span>
<span class="line" id="L653">        .MaximumLength = path_len_bytes,</span>
<span class="line" id="L654">        .Buffer = <span class="tok-builtin">@constCast</span>(path_name.ptr),</span>
<span class="line" id="L655">    };</span>
<span class="line" id="L656"></span>
<span class="line" id="L657">    <span class="tok-kw">const</span> rc = ntdll.RtlSetCurrentDirectory_U(&amp;nt_name);</span>
<span class="line" id="L658">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L659">        .SUCCESS =&gt; {},</span>
<span class="line" id="L660">        .OBJECT_NAME_INVALID =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadPathName,</span>
<span class="line" id="L661">        .OBJECT_NAME_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L662">        .OBJECT_PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L663">        .NO_MEDIA_IN_DEVICE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoDevice,</span>
<span class="line" id="L664">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L665">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L666">        .OBJECT_PATH_SYNTAX_BAD =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L667">        .NOT_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L668">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L669">    }</span>
<span class="line" id="L670">}</span>
<span class="line" id="L671"></span>
<span class="line" id="L672"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetCurrentDirectoryError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L673">    NameTooLong,</span>
<span class="line" id="L674">    Unexpected,</span>
<span class="line" id="L675">};</span>
<span class="line" id="L676"></span>
<span class="line" id="L677"><span class="tok-comment">/// The result is a slice of `buffer`, indexed from 0.</span></span>
<span class="line" id="L678"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetCurrentDirectory</span>(buffer: []<span class="tok-type">u8</span>) GetCurrentDirectoryError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L679">    <span class="tok-kw">var</span> utf16le_buf: [PATH_MAX_WIDE]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L680">    <span class="tok-kw">const</span> result = kernel32.GetCurrentDirectoryW(utf16le_buf.len, &amp;utf16le_buf);</span>
<span class="line" id="L681">    <span class="tok-kw">if</span> (result == <span class="tok-number">0</span>) {</span>
<span class="line" id="L682">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L683">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L684">        }</span>
<span class="line" id="L685">    }</span>
<span class="line" id="L686">    assert(result &lt;= utf16le_buf.len);</span>
<span class="line" id="L687">    <span class="tok-kw">const</span> utf16le_slice = utf16le_buf[<span class="tok-number">0</span>..result];</span>
<span class="line" id="L688">    <span class="tok-comment">// Trust that Windows gives us valid UTF-16LE.</span>
</span>
<span class="line" id="L689">    <span class="tok-kw">var</span> end_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L690">    <span class="tok-kw">var</span> it = std.unicode.Utf16LeIterator.init(utf16le_slice);</span>
<span class="line" id="L691">    <span class="tok-kw">while</span> (it.nextCodepoint() <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>) |codepoint| {</span>
<span class="line" id="L692">        <span class="tok-kw">const</span> seq_len = std.unicode.utf8CodepointSequenceLength(codepoint) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L693">        <span class="tok-kw">if</span> (end_index + seq_len &gt;= buffer.len)</span>
<span class="line" id="L694">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L695">        end_index += std.unicode.utf8Encode(codepoint, buffer[end_index..]) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L696">    }</span>
<span class="line" id="L697">    <span class="tok-kw">return</span> buffer[<span class="tok-number">0</span>..end_index];</span>
<span class="line" id="L698">}</span>
<span class="line" id="L699"></span>
<span class="line" id="L700"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CreateSymbolicLinkError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L701">    AccessDenied,</span>
<span class="line" id="L702">    PathAlreadyExists,</span>
<span class="line" id="L703">    FileNotFound,</span>
<span class="line" id="L704">    NameTooLong,</span>
<span class="line" id="L705">    NoDevice,</span>
<span class="line" id="L706">    NetworkNotFound,</span>
<span class="line" id="L707">    Unexpected,</span>
<span class="line" id="L708">};</span>
<span class="line" id="L709"></span>
<span class="line" id="L710"><span class="tok-comment">/// Needs either:</span></span>
<span class="line" id="L711"><span class="tok-comment">/// - `SeCreateSymbolicLinkPrivilege` privilege</span></span>
<span class="line" id="L712"><span class="tok-comment">/// or</span></span>
<span class="line" id="L713"><span class="tok-comment">/// - Developer mode on Windows 10</span></span>
<span class="line" id="L714"><span class="tok-comment">/// otherwise fails with `error.AccessDenied`. In which case `sym_link_path` may still</span></span>
<span class="line" id="L715"><span class="tok-comment">/// be created on the file system but will lack reparse processing data applied to it.</span></span>
<span class="line" id="L716"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CreateSymbolicLink</span>(</span>
<span class="line" id="L717">    dir: ?HANDLE,</span>
<span class="line" id="L718">    sym_link_path: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>,</span>
<span class="line" id="L719">    target_path: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>,</span>
<span class="line" id="L720">    is_directory: <span class="tok-type">bool</span>,</span>
<span class="line" id="L721">) CreateSymbolicLinkError!<span class="tok-type">void</span> {</span>
<span class="line" id="L722">    <span class="tok-kw">const</span> SYMLINK_DATA = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L723">        ReparseTag: ULONG,</span>
<span class="line" id="L724">        ReparseDataLength: USHORT,</span>
<span class="line" id="L725">        Reserved: USHORT,</span>
<span class="line" id="L726">        SubstituteNameOffset: USHORT,</span>
<span class="line" id="L727">        SubstituteNameLength: USHORT,</span>
<span class="line" id="L728">        PrintNameOffset: USHORT,</span>
<span class="line" id="L729">        PrintNameLength: USHORT,</span>
<span class="line" id="L730">        Flags: ULONG,</span>
<span class="line" id="L731">    };</span>
<span class="line" id="L732"></span>
<span class="line" id="L733">    <span class="tok-kw">const</span> symlink_handle = OpenFile(sym_link_path, .{</span>
<span class="line" id="L734">        .access_mask = SYNCHRONIZE | GENERIC_READ | GENERIC_WRITE,</span>
<span class="line" id="L735">        .dir = dir,</span>
<span class="line" id="L736">        .creation = FILE_CREATE,</span>
<span class="line" id="L737">        .io_mode = .blocking,</span>
<span class="line" id="L738">        .filter = <span class="tok-kw">if</span> (is_directory) .dir_only <span class="tok-kw">else</span> .file_only,</span>
<span class="line" id="L739">    }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L740">        <span class="tok-kw">error</span>.IsDir =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PathAlreadyExists,</span>
<span class="line" id="L741">        <span class="tok-kw">error</span>.NotDir =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L742">        <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L743">        <span class="tok-kw">error</span>.PipeBusy =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L744">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L745">    };</span>
<span class="line" id="L746">    <span class="tok-kw">defer</span> CloseHandle(symlink_handle);</span>
<span class="line" id="L747"></span>
<span class="line" id="L748">    <span class="tok-comment">// prepare reparse data buffer</span>
</span>
<span class="line" id="L749">    <span class="tok-kw">var</span> buffer: [MAXIMUM_REPARSE_DATA_BUFFER_SIZE]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L750">    <span class="tok-kw">const</span> buf_len = <span class="tok-builtin">@sizeOf</span>(SYMLINK_DATA) + target_path.len * <span class="tok-number">4</span>;</span>
<span class="line" id="L751">    <span class="tok-kw">const</span> header_len = <span class="tok-builtin">@sizeOf</span>(ULONG) + <span class="tok-builtin">@sizeOf</span>(USHORT) * <span class="tok-number">2</span>;</span>
<span class="line" id="L752">    <span class="tok-kw">const</span> symlink_data = SYMLINK_DATA{</span>
<span class="line" id="L753">        .ReparseTag = IO_REPARSE_TAG_SYMLINK,</span>
<span class="line" id="L754">        .ReparseDataLength = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(buf_len - header_len)),</span>
<span class="line" id="L755">        .Reserved = <span class="tok-number">0</span>,</span>
<span class="line" id="L756">        .SubstituteNameOffset = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(target_path.len * <span class="tok-number">2</span>)),</span>
<span class="line" id="L757">        .SubstituteNameLength = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(target_path.len * <span class="tok-number">2</span>)),</span>
<span class="line" id="L758">        .PrintNameOffset = <span class="tok-number">0</span>,</span>
<span class="line" id="L759">        .PrintNameLength = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(target_path.len * <span class="tok-number">2</span>)),</span>
<span class="line" id="L760">        .Flags = <span class="tok-kw">if</span> (dir) |_| SYMLINK_FLAG_RELATIVE <span class="tok-kw">else</span> <span class="tok-number">0</span>,</span>
<span class="line" id="L761">    };</span>
<span class="line" id="L762"></span>
<span class="line" id="L763">    <span class="tok-builtin">@memcpy</span>(buffer[<span class="tok-number">0</span>..<span class="tok-builtin">@sizeOf</span>(SYMLINK_DATA)], std.mem.asBytes(&amp;symlink_data));</span>
<span class="line" id="L764">    <span class="tok-builtin">@memcpy</span>(buffer[<span class="tok-builtin">@sizeOf</span>(SYMLINK_DATA)..][<span class="tok-number">0</span> .. target_path.len * <span class="tok-number">2</span>], <span class="tok-builtin">@as</span>([*]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-builtin">@ptrCast</span>(target_path)));</span>
<span class="line" id="L765">    <span class="tok-kw">const</span> paths_start = <span class="tok-builtin">@sizeOf</span>(SYMLINK_DATA) + target_path.len * <span class="tok-number">2</span>;</span>
<span class="line" id="L766">    <span class="tok-builtin">@memcpy</span>(buffer[paths_start..][<span class="tok-number">0</span> .. target_path.len * <span class="tok-number">2</span>], <span class="tok-builtin">@as</span>([*]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-builtin">@ptrCast</span>(target_path)));</span>
<span class="line" id="L767">    _ = <span class="tok-kw">try</span> DeviceIoControl(symlink_handle, FSCTL_SET_REPARSE_POINT, buffer[<span class="tok-number">0</span>..buf_len], <span class="tok-null">null</span>);</span>
<span class="line" id="L768">}</span>
<span class="line" id="L769"></span>
<span class="line" id="L770"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ReadLinkError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L771">    FileNotFound,</span>
<span class="line" id="L772">    AccessDenied,</span>
<span class="line" id="L773">    Unexpected,</span>
<span class="line" id="L774">    NameTooLong,</span>
<span class="line" id="L775">    UnsupportedReparsePointType,</span>
<span class="line" id="L776">};</span>
<span class="line" id="L777"></span>
<span class="line" id="L778"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ReadLink</span>(dir: ?HANDLE, sub_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, out_buffer: []<span class="tok-type">u8</span>) ReadLinkError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L779">    <span class="tok-comment">// Here, we use `NtCreateFile` to shave off one syscall if we were to use `OpenFile` wrapper.</span>
</span>
<span class="line" id="L780">    <span class="tok-comment">// With the latter, we'd need to call `NtCreateFile` twice, once for file symlink, and if that</span>
</span>
<span class="line" id="L781">    <span class="tok-comment">// failed, again for dir symlink. Omitting any mention of file/dir flags makes it possible</span>
</span>
<span class="line" id="L782">    <span class="tok-comment">// to open the symlink there and then.</span>
</span>
<span class="line" id="L783">    <span class="tok-kw">const</span> path_len_bytes = math.cast(<span class="tok-type">u16</span>, sub_path_w.len * <span class="tok-number">2</span>) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L784">    <span class="tok-kw">var</span> nt_name = UNICODE_STRING{</span>
<span class="line" id="L785">        .Length = path_len_bytes,</span>
<span class="line" id="L786">        .MaximumLength = path_len_bytes,</span>
<span class="line" id="L787">        .Buffer = <span class="tok-builtin">@constCast</span>(sub_path_w.ptr),</span>
<span class="line" id="L788">    };</span>
<span class="line" id="L789">    <span class="tok-kw">var</span> attr = OBJECT_ATTRIBUTES{</span>
<span class="line" id="L790">        .Length = <span class="tok-builtin">@sizeOf</span>(OBJECT_ATTRIBUTES),</span>
<span class="line" id="L791">        .RootDirectory = <span class="tok-kw">if</span> (std.fs.path.isAbsoluteWindowsWTF16(sub_path_w)) <span class="tok-null">null</span> <span class="tok-kw">else</span> dir,</span>
<span class="line" id="L792">        .Attributes = <span class="tok-number">0</span>, <span class="tok-comment">// Note we do not use OBJ_CASE_INSENSITIVE here.</span>
</span>
<span class="line" id="L793">        .ObjectName = &amp;nt_name,</span>
<span class="line" id="L794">        .SecurityDescriptor = <span class="tok-null">null</span>,</span>
<span class="line" id="L795">        .SecurityQualityOfService = <span class="tok-null">null</span>,</span>
<span class="line" id="L796">    };</span>
<span class="line" id="L797">    <span class="tok-kw">var</span> result_handle: HANDLE = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L798">    <span class="tok-kw">var</span> io: IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L799"></span>
<span class="line" id="L800">    <span class="tok-kw">const</span> rc = ntdll.NtCreateFile(</span>
<span class="line" id="L801">        &amp;result_handle,</span>
<span class="line" id="L802">        FILE_READ_ATTRIBUTES,</span>
<span class="line" id="L803">        &amp;attr,</span>
<span class="line" id="L804">        &amp;io,</span>
<span class="line" id="L805">        <span class="tok-null">null</span>,</span>
<span class="line" id="L806">        FILE_ATTRIBUTE_NORMAL,</span>
<span class="line" id="L807">        FILE_SHARE_READ,</span>
<span class="line" id="L808">        FILE_OPEN,</span>
<span class="line" id="L809">        FILE_OPEN_REPARSE_POINT,</span>
<span class="line" id="L810">        <span class="tok-null">null</span>,</span>
<span class="line" id="L811">        <span class="tok-number">0</span>,</span>
<span class="line" id="L812">    );</span>
<span class="line" id="L813">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L814">        .SUCCESS =&gt; {},</span>
<span class="line" id="L815">        .OBJECT_NAME_INVALID =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L816">        .OBJECT_NAME_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L817">        .OBJECT_PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L818">        .NO_MEDIA_IN_DEVICE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L819">        <span class="tok-comment">// TODO: Should BAD_NETWORK_* be translated to a different error?</span>
</span>
<span class="line" id="L820">        .BAD_NETWORK_PATH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound, <span class="tok-comment">// \\server was not found</span>
</span>
<span class="line" id="L821">        .BAD_NETWORK_NAME =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound, <span class="tok-comment">// \\server was found but \\server\share wasn't</span>
</span>
<span class="line" id="L822">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L823">        .SHARING_VIOLATION =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L824">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L825">        .PIPE_BUSY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L826">        .OBJECT_PATH_SYNTAX_BAD =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L827">        .OBJECT_NAME_COLLISION =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L828">        .FILE_IS_A_DIRECTORY =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L829">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L830">    }</span>
<span class="line" id="L831">    <span class="tok-kw">defer</span> CloseHandle(result_handle);</span>
<span class="line" id="L832"></span>
<span class="line" id="L833">    <span class="tok-kw">var</span> reparse_buf: [MAXIMUM_REPARSE_DATA_BUFFER_SIZE]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(REPARSE_DATA_BUFFER)) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L834">    _ = DeviceIoControl(result_handle, FSCTL_GET_REPARSE_POINT, <span class="tok-null">null</span>, reparse_buf[<span class="tok-number">0</span>..]) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L835">        <span class="tok-kw">error</span>.AccessDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L836">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L837">    };</span>
<span class="line" id="L838"></span>
<span class="line" id="L839">    <span class="tok-kw">const</span> reparse_struct: *<span class="tok-kw">const</span> REPARSE_DATA_BUFFER = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(&amp;reparse_buf[<span class="tok-number">0</span>]));</span>
<span class="line" id="L840">    <span class="tok-kw">switch</span> (reparse_struct.ReparseTag) {</span>
<span class="line" id="L841">        IO_REPARSE_TAG_SYMLINK =&gt; {</span>
<span class="line" id="L842">            <span class="tok-kw">const</span> buf: *<span class="tok-kw">const</span> SYMBOLIC_LINK_REPARSE_BUFFER = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(&amp;reparse_struct.DataBuffer[<span class="tok-number">0</span>]));</span>
<span class="line" id="L843">            <span class="tok-kw">const</span> offset = buf.SubstituteNameOffset &gt;&gt; <span class="tok-number">1</span>;</span>
<span class="line" id="L844">            <span class="tok-kw">const</span> len = buf.SubstituteNameLength &gt;&gt; <span class="tok-number">1</span>;</span>
<span class="line" id="L845">            <span class="tok-kw">const</span> path_buf = <span class="tok-builtin">@as</span>([*]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, &amp;buf.PathBuffer);</span>
<span class="line" id="L846">            <span class="tok-kw">const</span> is_relative = buf.Flags &amp; SYMLINK_FLAG_RELATIVE != <span class="tok-number">0</span>;</span>
<span class="line" id="L847">            <span class="tok-kw">return</span> parseReadlinkPath(path_buf[offset..][<span class="tok-number">0</span>..len], is_relative, out_buffer);</span>
<span class="line" id="L848">        },</span>
<span class="line" id="L849">        IO_REPARSE_TAG_MOUNT_POINT =&gt; {</span>
<span class="line" id="L850">            <span class="tok-kw">const</span> buf: *<span class="tok-kw">const</span> MOUNT_POINT_REPARSE_BUFFER = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(&amp;reparse_struct.DataBuffer[<span class="tok-number">0</span>]));</span>
<span class="line" id="L851">            <span class="tok-kw">const</span> offset = buf.SubstituteNameOffset &gt;&gt; <span class="tok-number">1</span>;</span>
<span class="line" id="L852">            <span class="tok-kw">const</span> len = buf.SubstituteNameLength &gt;&gt; <span class="tok-number">1</span>;</span>
<span class="line" id="L853">            <span class="tok-kw">const</span> path_buf = <span class="tok-builtin">@as</span>([*]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, &amp;buf.PathBuffer);</span>
<span class="line" id="L854">            <span class="tok-kw">return</span> parseReadlinkPath(path_buf[offset..][<span class="tok-number">0</span>..len], <span class="tok-null">false</span>, out_buffer);</span>
<span class="line" id="L855">        },</span>
<span class="line" id="L856">        <span class="tok-kw">else</span> =&gt; |value| {</span>
<span class="line" id="L857">            std.debug.print(<span class="tok-str">&quot;unsupported symlink type: {}&quot;</span>, .{value});</span>
<span class="line" id="L858">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedReparsePointType;</span>
<span class="line" id="L859">        },</span>
<span class="line" id="L860">    }</span>
<span class="line" id="L861">}</span>
<span class="line" id="L862"></span>
<span class="line" id="L863"><span class="tok-kw">fn</span> <span class="tok-fn">parseReadlinkPath</span>(path: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, is_relative: <span class="tok-type">bool</span>, out_buffer: []<span class="tok-type">u8</span>) []<span class="tok-type">u8</span> {</span>
<span class="line" id="L864">    <span class="tok-kw">const</span> prefix = [_]<span class="tok-type">u16</span>{ <span class="tok-str">'\\'</span>, <span class="tok-str">'?'</span>, <span class="tok-str">'?'</span>, <span class="tok-str">'\\'</span> };</span>
<span class="line" id="L865">    <span class="tok-kw">var</span> start_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L866">    <span class="tok-kw">if</span> (!is_relative <span class="tok-kw">and</span> std.mem.startsWith(<span class="tok-type">u16</span>, path, &amp;prefix)) {</span>
<span class="line" id="L867">        start_index = prefix.len;</span>
<span class="line" id="L868">    }</span>
<span class="line" id="L869">    <span class="tok-kw">const</span> out_len = std.unicode.utf16leToUtf8(out_buffer, path[start_index..]) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L870">    <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..out_len];</span>
<span class="line" id="L871">}</span>
<span class="line" id="L872"></span>
<span class="line" id="L873"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DeleteFileError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L874">    FileNotFound,</span>
<span class="line" id="L875">    AccessDenied,</span>
<span class="line" id="L876">    NameTooLong,</span>
<span class="line" id="L877">    <span class="tok-comment">/// Also known as sharing violation.</span></span>
<span class="line" id="L878">    FileBusy,</span>
<span class="line" id="L879">    Unexpected,</span>
<span class="line" id="L880">    NotDir,</span>
<span class="line" id="L881">    IsDir,</span>
<span class="line" id="L882">    DirNotEmpty,</span>
<span class="line" id="L883">    NetworkNotFound,</span>
<span class="line" id="L884">};</span>
<span class="line" id="L885"></span>
<span class="line" id="L886"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DeleteFileOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L887">    dir: ?HANDLE,</span>
<span class="line" id="L888">    remove_dir: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L889">};</span>
<span class="line" id="L890"></span>
<span class="line" id="L891"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">DeleteFile</span>(sub_path_w: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, options: DeleteFileOptions) DeleteFileError!<span class="tok-type">void</span> {</span>
<span class="line" id="L892">    <span class="tok-kw">const</span> create_options_flags: ULONG = <span class="tok-kw">if</span> (options.remove_dir)</span>
<span class="line" id="L893">        FILE_DIRECTORY_FILE | FILE_OPEN_REPARSE_POINT</span>
<span class="line" id="L894">    <span class="tok-kw">else</span></span>
<span class="line" id="L895">        FILE_NON_DIRECTORY_FILE | FILE_OPEN_REPARSE_POINT; <span class="tok-comment">// would we ever want to delete the target instead?</span>
</span>
<span class="line" id="L896"></span>
<span class="line" id="L897">    <span class="tok-kw">const</span> path_len_bytes = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(sub_path_w.len * <span class="tok-number">2</span>));</span>
<span class="line" id="L898">    <span class="tok-kw">var</span> nt_name = UNICODE_STRING{</span>
<span class="line" id="L899">        .Length = path_len_bytes,</span>
<span class="line" id="L900">        .MaximumLength = path_len_bytes,</span>
<span class="line" id="L901">        <span class="tok-comment">// The Windows API makes this mutable, but it will not mutate here.</span>
</span>
<span class="line" id="L902">        .Buffer = <span class="tok-builtin">@constCast</span>(sub_path_w.ptr),</span>
<span class="line" id="L903">    };</span>
<span class="line" id="L904"></span>
<span class="line" id="L905">    <span class="tok-kw">if</span> (sub_path_w[<span class="tok-number">0</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> sub_path_w[<span class="tok-number">1</span>] == <span class="tok-number">0</span>) {</span>
<span class="line" id="L906">        <span class="tok-comment">// Windows does not recognize this, but it does work with empty string.</span>
</span>
<span class="line" id="L907">        nt_name.Length = <span class="tok-number">0</span>;</span>
<span class="line" id="L908">    }</span>
<span class="line" id="L909">    <span class="tok-kw">if</span> (sub_path_w[<span class="tok-number">0</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> sub_path_w[<span class="tok-number">1</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> sub_path_w[<span class="tok-number">2</span>] == <span class="tok-number">0</span>) {</span>
<span class="line" id="L910">        <span class="tok-comment">// Can't remove the parent directory with an open handle.</span>
</span>
<span class="line" id="L911">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy;</span>
<span class="line" id="L912">    }</span>
<span class="line" id="L913"></span>
<span class="line" id="L914">    <span class="tok-kw">var</span> attr = OBJECT_ATTRIBUTES{</span>
<span class="line" id="L915">        .Length = <span class="tok-builtin">@sizeOf</span>(OBJECT_ATTRIBUTES),</span>
<span class="line" id="L916">        .RootDirectory = <span class="tok-kw">if</span> (std.fs.path.isAbsoluteWindowsWTF16(sub_path_w)) <span class="tok-null">null</span> <span class="tok-kw">else</span> options.dir,</span>
<span class="line" id="L917">        .Attributes = <span class="tok-number">0</span>, <span class="tok-comment">// Note we do not use OBJ_CASE_INSENSITIVE here.</span>
</span>
<span class="line" id="L918">        .ObjectName = &amp;nt_name,</span>
<span class="line" id="L919">        .SecurityDescriptor = <span class="tok-null">null</span>,</span>
<span class="line" id="L920">        .SecurityQualityOfService = <span class="tok-null">null</span>,</span>
<span class="line" id="L921">    };</span>
<span class="line" id="L922">    <span class="tok-kw">var</span> io: IO_STATUS_BLOCK = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L923">    <span class="tok-kw">var</span> tmp_handle: HANDLE = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L924">    <span class="tok-kw">var</span> rc = ntdll.NtCreateFile(</span>
<span class="line" id="L925">        &amp;tmp_handle,</span>
<span class="line" id="L926">        SYNCHRONIZE | DELETE,</span>
<span class="line" id="L927">        &amp;attr,</span>
<span class="line" id="L928">        &amp;io,</span>
<span class="line" id="L929">        <span class="tok-null">null</span>,</span>
<span class="line" id="L930">        <span class="tok-number">0</span>,</span>
<span class="line" id="L931">        FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,</span>
<span class="line" id="L932">        FILE_OPEN,</span>
<span class="line" id="L933">        create_options_flags,</span>
<span class="line" id="L934">        <span class="tok-null">null</span>,</span>
<span class="line" id="L935">        <span class="tok-number">0</span>,</span>
<span class="line" id="L936">    );</span>
<span class="line" id="L937">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L938">        .SUCCESS =&gt; {},</span>
<span class="line" id="L939">        .OBJECT_NAME_INVALID =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L940">        .OBJECT_NAME_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L941">        .OBJECT_PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L942">        .BAD_NETWORK_PATH =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkNotFound, <span class="tok-comment">// \\server was not found</span>
</span>
<span class="line" id="L943">        .BAD_NETWORK_NAME =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkNotFound, <span class="tok-comment">// \\server was found but \\server\share wasn't</span>
</span>
<span class="line" id="L944">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L945">        .FILE_IS_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.IsDir,</span>
<span class="line" id="L946">        .NOT_A_DIRECTORY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotDir,</span>
<span class="line" id="L947">        .SHARING_VIOLATION =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileBusy,</span>
<span class="line" id="L948">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L949">        .DELETE_PENDING =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L950">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L951">    }</span>
<span class="line" id="L952">    <span class="tok-kw">defer</span> CloseHandle(tmp_handle);</span>
<span class="line" id="L953"></span>
<span class="line" id="L954">    <span class="tok-comment">// FileDispositionInformationEx (and therefore FILE_DISPOSITION_POSIX_SEMANTICS and FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE)</span>
</span>
<span class="line" id="L955">    <span class="tok-comment">// are only supported on NTFS filesystems, so the version check on its own is only a partial solution. To support non-NTFS filesystems</span>
</span>
<span class="line" id="L956">    <span class="tok-comment">// like FAT32, we need to fallback to FileDispositionInformation if the usage of FileDispositionInformationEx gives</span>
</span>
<span class="line" id="L957">    <span class="tok-comment">// us INVALID_PARAMETER.</span>
</span>
<span class="line" id="L958">    <span class="tok-kw">var</span> need_fallback = <span class="tok-null">true</span>;</span>
<span class="line" id="L959">    <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> builtin.target.os.version_range.windows.min.isAtLeast(.win10_rs1)) {</span>
<span class="line" id="L960">        <span class="tok-comment">// Deletion with posix semantics if the filesystem supports it.</span>
</span>
<span class="line" id="L961">        <span class="tok-kw">var</span> info = FILE_DISPOSITION_INFORMATION_EX{</span>
<span class="line" id="L962">            .Flags = FILE_DISPOSITION_DELETE |</span>
<span class="line" id="L963">                FILE_DISPOSITION_POSIX_SEMANTICS |</span>
<span class="line" id="L964">                FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE,</span>
<span class="line" id="L965">        };</span>
<span class="line" id="L966"></span>
<span class="line" id="L967">        rc = ntdll.NtSetInformationFile(</span>
<span class="line" id="L968">            tmp_handle,</span>
<span class="line" id="L969">            &amp;io,</span>
<span class="line" id="L970">            &amp;info,</span>
<span class="line" id="L971">            <span class="tok-builtin">@sizeOf</span>(FILE_DISPOSITION_INFORMATION_EX),</span>
<span class="line" id="L972">            .FileDispositionInformationEx,</span>
<span class="line" id="L973">        );</span>
<span class="line" id="L974">        <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L975">            <span class="tok-comment">// INVALID_PARAMETER here means that the filesystem does not support FileDispositionInformationEx</span>
</span>
<span class="line" id="L976">            .INVALID_PARAMETER =&gt; {},</span>
<span class="line" id="L977">            <span class="tok-comment">// For all other statuses, fall down to the switch below to handle them.</span>
</span>
<span class="line" id="L978">            <span class="tok-kw">else</span> =&gt; need_fallback = <span class="tok-null">false</span>,</span>
<span class="line" id="L979">        }</span>
<span class="line" id="L980">    }</span>
<span class="line" id="L981">    <span class="tok-kw">if</span> (need_fallback) {</span>
<span class="line" id="L982">        <span class="tok-comment">// Deletion with file pending semantics, which requires waiting or moving</span>
</span>
<span class="line" id="L983">        <span class="tok-comment">// files to get them removed (from here).</span>
</span>
<span class="line" id="L984">        <span class="tok-kw">var</span> file_dispo = FILE_DISPOSITION_INFORMATION{</span>
<span class="line" id="L985">            .DeleteFile = TRUE,</span>
<span class="line" id="L986">        };</span>
<span class="line" id="L987"></span>
<span class="line" id="L988">        rc = ntdll.NtSetInformationFile(</span>
<span class="line" id="L989">            tmp_handle,</span>
<span class="line" id="L990">            &amp;io,</span>
<span class="line" id="L991">            &amp;file_dispo,</span>
<span class="line" id="L992">            <span class="tok-builtin">@sizeOf</span>(FILE_DISPOSITION_INFORMATION),</span>
<span class="line" id="L993">            .FileDispositionInformation,</span>
<span class="line" id="L994">        );</span>
<span class="line" id="L995">    }</span>
<span class="line" id="L996">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L997">        .SUCCESS =&gt; {},</span>
<span class="line" id="L998">        .DIRECTORY_NOT_EMPTY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.DirNotEmpty,</span>
<span class="line" id="L999">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1000">        .CANNOT_DELETE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1001">        .MEDIA_WRITE_PROTECTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1002">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1003">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L1004">    }</span>
<span class="line" id="L1005">}</span>
<span class="line" id="L1006"></span>
<span class="line" id="L1007"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MoveFileError = <span class="tok-kw">error</span>{ FileNotFound, AccessDenied, Unexpected };</span>
<span class="line" id="L1008"></span>
<span class="line" id="L1009"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">MoveFileEx</span>(old_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, new_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: DWORD) MoveFileError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1010">    <span class="tok-kw">const</span> old_path_w = <span class="tok-kw">try</span> sliceToPrefixedFileW(old_path);</span>
<span class="line" id="L1011">    <span class="tok-kw">const</span> new_path_w = <span class="tok-kw">try</span> sliceToPrefixedFileW(new_path);</span>
<span class="line" id="L1012">    <span class="tok-kw">return</span> MoveFileExW(old_path_w.span().ptr, new_path_w.span().ptr, flags);</span>
<span class="line" id="L1013">}</span>
<span class="line" id="L1014"></span>
<span class="line" id="L1015"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">MoveFileExW</span>(old_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, new_path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, flags: DWORD) MoveFileError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1016">    <span class="tok-kw">if</span> (kernel32.MoveFileExW(old_path, new_path, flags) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1017">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1018">            .FILE_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1019">            .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1020">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1021">        }</span>
<span class="line" id="L1022">    }</span>
<span class="line" id="L1023">}</span>
<span class="line" id="L1024"></span>
<span class="line" id="L1025"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetStdHandleError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1026">    NoStandardHandleAttached,</span>
<span class="line" id="L1027">    Unexpected,</span>
<span class="line" id="L1028">};</span>
<span class="line" id="L1029"></span>
<span class="line" id="L1030"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetStdHandle</span>(handle_id: DWORD) GetStdHandleError!HANDLE {</span>
<span class="line" id="L1031">    <span class="tok-kw">const</span> handle = kernel32.GetStdHandle(handle_id) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NoStandardHandleAttached;</span>
<span class="line" id="L1032">    <span class="tok-kw">if</span> (handle == INVALID_HANDLE_VALUE) {</span>
<span class="line" id="L1033">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1034">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1035">        }</span>
<span class="line" id="L1036">    }</span>
<span class="line" id="L1037">    <span class="tok-kw">return</span> handle;</span>
<span class="line" id="L1038">}</span>
<span class="line" id="L1039"></span>
<span class="line" id="L1040"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetFilePointerError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1041"></span>
<span class="line" id="L1042"><span class="tok-comment">/// The SetFilePointerEx function with the `dwMoveMethod` parameter set to `FILE_BEGIN`.</span></span>
<span class="line" id="L1043"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetFilePointerEx_BEGIN</span>(handle: HANDLE, offset: <span class="tok-type">u64</span>) SetFilePointerError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1044">    <span class="tok-comment">// &quot;The starting point is zero or the beginning of the file. If [FILE_BEGIN]</span>
</span>
<span class="line" id="L1045">    <span class="tok-comment">// is specified, then the liDistanceToMove parameter is interpreted as an unsigned value.&quot;</span>
</span>
<span class="line" id="L1046">    <span class="tok-comment">// https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-setfilepointerex</span>
</span>
<span class="line" id="L1047">    <span class="tok-kw">const</span> ipos = <span class="tok-builtin">@as</span>(LARGE_INTEGER, <span class="tok-builtin">@bitCast</span>(offset));</span>
<span class="line" id="L1048">    <span class="tok-kw">if</span> (kernel32.SetFilePointerEx(handle, ipos, <span class="tok-null">null</span>, FILE_BEGIN) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1049">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1050">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1051">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1052">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1053">        }</span>
<span class="line" id="L1054">    }</span>
<span class="line" id="L1055">}</span>
<span class="line" id="L1056"></span>
<span class="line" id="L1057"><span class="tok-comment">/// The SetFilePointerEx function with the `dwMoveMethod` parameter set to `FILE_CURRENT`.</span></span>
<span class="line" id="L1058"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetFilePointerEx_CURRENT</span>(handle: HANDLE, offset: <span class="tok-type">i64</span>) SetFilePointerError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1059">    <span class="tok-kw">if</span> (kernel32.SetFilePointerEx(handle, offset, <span class="tok-null">null</span>, FILE_CURRENT) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1060">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1061">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1062">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1063">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1064">        }</span>
<span class="line" id="L1065">    }</span>
<span class="line" id="L1066">}</span>
<span class="line" id="L1067"></span>
<span class="line" id="L1068"><span class="tok-comment">/// The SetFilePointerEx function with the `dwMoveMethod` parameter set to `FILE_END`.</span></span>
<span class="line" id="L1069"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetFilePointerEx_END</span>(handle: HANDLE, offset: <span class="tok-type">i64</span>) SetFilePointerError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1070">    <span class="tok-kw">if</span> (kernel32.SetFilePointerEx(handle, offset, <span class="tok-null">null</span>, FILE_END) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1071">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1072">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1073">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1074">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1075">        }</span>
<span class="line" id="L1076">    }</span>
<span class="line" id="L1077">}</span>
<span class="line" id="L1078"></span>
<span class="line" id="L1079"><span class="tok-comment">/// The SetFilePointerEx function with parameters to get the current offset.</span></span>
<span class="line" id="L1080"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetFilePointerEx_CURRENT_get</span>(handle: HANDLE) SetFilePointerError!<span class="tok-type">u64</span> {</span>
<span class="line" id="L1081">    <span class="tok-kw">var</span> result: LARGE_INTEGER = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1082">    <span class="tok-kw">if</span> (kernel32.SetFilePointerEx(handle, <span class="tok-number">0</span>, &amp;result, FILE_CURRENT) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1083">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1084">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1085">            .INVALID_HANDLE =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1086">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1087">        }</span>
<span class="line" id="L1088">    }</span>
<span class="line" id="L1089">    <span class="tok-comment">// Based on the docs for FILE_BEGIN, it seems that the returned signed integer</span>
</span>
<span class="line" id="L1090">    <span class="tok-comment">// should be interpreted as an unsigned integer.</span>
</span>
<span class="line" id="L1091">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-builtin">@bitCast</span>(result));</span>
<span class="line" id="L1092">}</span>
<span class="line" id="L1093"></span>
<span class="line" id="L1094"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">QueryObjectName</span>(</span>
<span class="line" id="L1095">    handle: HANDLE,</span>
<span class="line" id="L1096">    out_buffer: []<span class="tok-type">u16</span>,</span>
<span class="line" id="L1097">) ![]<span class="tok-type">u16</span> {</span>
<span class="line" id="L1098">    <span class="tok-kw">const</span> out_buffer_aligned = mem.alignInSlice(out_buffer, <span class="tok-builtin">@alignOf</span>(OBJECT_NAME_INFORMATION)) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L1099"></span>
<span class="line" id="L1100">    <span class="tok-kw">const</span> info = <span class="tok-builtin">@as</span>(*OBJECT_NAME_INFORMATION, <span class="tok-builtin">@ptrCast</span>(out_buffer_aligned));</span>
<span class="line" id="L1101">    <span class="tok-comment">//buffer size is specified in bytes</span>
</span>
<span class="line" id="L1102">    <span class="tok-kw">const</span> out_buffer_len = std.math.cast(ULONG, out_buffer_aligned.len * <span class="tok-number">2</span>) <span class="tok-kw">orelse</span> std.math.maxInt(ULONG);</span>
<span class="line" id="L1103">    <span class="tok-comment">//last argument would return the length required for full_buffer, not exposed here</span>
</span>
<span class="line" id="L1104">    <span class="tok-kw">const</span> rc = ntdll.NtQueryObject(handle, .ObjectNameInformation, info, out_buffer_len, <span class="tok-null">null</span>);</span>
<span class="line" id="L1105">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L1106">        .SUCCESS =&gt; {</span>
<span class="line" id="L1107">            <span class="tok-comment">// info.Name.Buffer from ObQueryNameString is documented to be null (and MaximumLength == 0)</span>
</span>
<span class="line" id="L1108">            <span class="tok-comment">// if the object was &quot;unnamed&quot;, not sure if this can happen for file handles</span>
</span>
<span class="line" id="L1109">            <span class="tok-kw">if</span> (info.Name.MaximumLength == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L1110">            <span class="tok-comment">// resulting string length is specified in bytes</span>
</span>
<span class="line" id="L1111">            <span class="tok-kw">const</span> path_length_unterminated = <span class="tok-builtin">@divExact</span>(info.Name.Length, <span class="tok-number">2</span>);</span>
<span class="line" id="L1112">            <span class="tok-kw">return</span> info.Name.Buffer[<span class="tok-number">0</span>..path_length_unterminated];</span>
<span class="line" id="L1113">        },</span>
<span class="line" id="L1114">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1115">        .INVALID_HANDLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidHandle,</span>
<span class="line" id="L1116">        <span class="tok-comment">// triggered when the buffer is too small for the OBJECT_NAME_INFORMATION object (.INFO_LENGTH_MISMATCH),</span>
</span>
<span class="line" id="L1117">        <span class="tok-comment">// or if the buffer is too small for the file path returned (.BUFFER_OVERFLOW, .BUFFER_TOO_SMALL)</span>
</span>
<span class="line" id="L1118">        .INFO_LENGTH_MISMATCH, .BUFFER_OVERFLOW, .BUFFER_TOO_SMALL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L1119">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> unexpectedStatus(e),</span>
<span class="line" id="L1120">    }</span>
<span class="line" id="L1121">}</span>
<span class="line" id="L1122"><span class="tok-kw">test</span> <span class="tok-str">&quot;QueryObjectName&quot;</span> {</span>
<span class="line" id="L1123">    <span class="tok-kw">if</span> (builtin.os.tag != .windows)</span>
<span class="line" id="L1124">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L1125"></span>
<span class="line" id="L1126">    <span class="tok-comment">//any file will do; canonicalization works on NTFS junctions and symlinks, hardlinks remain separate paths.</span>
</span>
<span class="line" id="L1127">    <span class="tok-kw">var</span> tmp = std.testing.tmpDir(.{});</span>
<span class="line" id="L1128">    <span class="tok-kw">defer</span> tmp.cleanup();</span>
<span class="line" id="L1129">    <span class="tok-kw">const</span> handle = tmp.dir.fd;</span>
<span class="line" id="L1130">    <span class="tok-kw">var</span> out_buffer: [PATH_MAX_WIDE]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1131"></span>
<span class="line" id="L1132">    <span class="tok-kw">var</span> result_path = <span class="tok-kw">try</span> QueryObjectName(handle, &amp;out_buffer);</span>
<span class="line" id="L1133">    <span class="tok-kw">const</span> required_len_in_u16 = result_path.len + <span class="tok-builtin">@divExact</span>(<span class="tok-builtin">@intFromPtr</span>(result_path.ptr) - <span class="tok-builtin">@intFromPtr</span>(&amp;out_buffer), <span class="tok-number">2</span>) + <span class="tok-number">1</span>;</span>
<span class="line" id="L1134">    <span class="tok-comment">//insufficient size</span>
</span>
<span class="line" id="L1135">    <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.NameTooLong, QueryObjectName(handle, out_buffer[<span class="tok-number">0</span> .. required_len_in_u16 - <span class="tok-number">1</span>]));</span>
<span class="line" id="L1136">    <span class="tok-comment">//exactly-sufficient size</span>
</span>
<span class="line" id="L1137">    _ = <span class="tok-kw">try</span> QueryObjectName(handle, out_buffer[<span class="tok-number">0</span>..required_len_in_u16]);</span>
<span class="line" id="L1138">}</span>
<span class="line" id="L1139"></span>
<span class="line" id="L1140"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetFinalPathNameByHandleError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1141">    AccessDenied,</span>
<span class="line" id="L1142">    BadPathName,</span>
<span class="line" id="L1143">    FileNotFound,</span>
<span class="line" id="L1144">    NameTooLong,</span>
<span class="line" id="L1145">    Unexpected,</span>
<span class="line" id="L1146">};</span>
<span class="line" id="L1147"></span>
<span class="line" id="L1148"><span class="tok-comment">/// Specifies how to format volume path in the result of `GetFinalPathNameByHandle`.</span></span>
<span class="line" id="L1149"><span class="tok-comment">/// Defaults to DOS volume names.</span></span>
<span class="line" id="L1150"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetFinalPathNameByHandleFormat = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1151">    volume_name: <span class="tok-kw">enum</span> {</span>
<span class="line" id="L1152">        <span class="tok-comment">/// Format as DOS volume name</span></span>
<span class="line" id="L1153">        Dos,</span>
<span class="line" id="L1154">        <span class="tok-comment">/// Format as NT volume name</span></span>
<span class="line" id="L1155">        Nt,</span>
<span class="line" id="L1156">    } = .Dos,</span>
<span class="line" id="L1157">};</span>
<span class="line" id="L1158"></span>
<span class="line" id="L1159"><span class="tok-comment">/// Returns canonical (normalized) path of handle.</span></span>
<span class="line" id="L1160"><span class="tok-comment">/// Use `GetFinalPathNameByHandleFormat` to specify whether the path is meant to include</span></span>
<span class="line" id="L1161"><span class="tok-comment">/// NT or DOS volume name (e.g., `\Device\HarddiskVolume0\foo.txt` versus `C:\foo.txt`).</span></span>
<span class="line" id="L1162"><span class="tok-comment">/// If DOS volume name format is selected, note that this function does *not* prepend</span></span>
<span class="line" id="L1163"><span class="tok-comment">/// `\\?\` prefix to the resultant path.</span></span>
<span class="line" id="L1164"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetFinalPathNameByHandle</span>(</span>
<span class="line" id="L1165">    hFile: HANDLE,</span>
<span class="line" id="L1166">    fmt: GetFinalPathNameByHandleFormat,</span>
<span class="line" id="L1167">    out_buffer: []<span class="tok-type">u16</span>,</span>
<span class="line" id="L1168">) GetFinalPathNameByHandleError![]<span class="tok-type">u16</span> {</span>
<span class="line" id="L1169">    <span class="tok-kw">const</span> final_path = QueryObjectName(hFile, out_buffer) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1170">        <span class="tok-comment">// we assume InvalidHandle is close enough to FileNotFound in semantics</span>
</span>
<span class="line" id="L1171">        <span class="tok-comment">// to not further complicate the error set</span>
</span>
<span class="line" id="L1172">        <span class="tok-kw">error</span>.InvalidHandle =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1173">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1174">    };</span>
<span class="line" id="L1175"></span>
<span class="line" id="L1176">    <span class="tok-kw">switch</span> (fmt.volume_name) {</span>
<span class="line" id="L1177">        .Nt =&gt; {</span>
<span class="line" id="L1178">            <span class="tok-comment">// the returned path is already in .Nt format</span>
</span>
<span class="line" id="L1179">            <span class="tok-kw">return</span> final_path;</span>
<span class="line" id="L1180">        },</span>
<span class="line" id="L1181">        .Dos =&gt; {</span>
<span class="line" id="L1182">            <span class="tok-comment">// parse the string to separate volume path from file path</span>
</span>
<span class="line" id="L1183">            <span class="tok-kw">const</span> expected_prefix = std.unicode.utf8ToUtf16LeStringLiteral(<span class="tok-str">&quot;\\Device\\&quot;</span>);</span>
<span class="line" id="L1184"></span>
<span class="line" id="L1185">            <span class="tok-comment">// TODO find out if a path can start with something besides `\Device\&lt;volume name&gt;`,</span>
</span>
<span class="line" id="L1186">            <span class="tok-comment">// and if we need to handle it differently</span>
</span>
<span class="line" id="L1187">            <span class="tok-comment">// (i.e. how to determine the start and end of the volume name in that case)</span>
</span>
<span class="line" id="L1188">            <span class="tok-kw">if</span> (!mem.eql(<span class="tok-type">u16</span>, expected_prefix, final_path[<span class="tok-number">0</span>..expected_prefix.len])) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L1189"></span>
<span class="line" id="L1190">            <span class="tok-kw">const</span> file_path_begin_index = mem.indexOfPos(<span class="tok-type">u16</span>, final_path, expected_prefix.len, &amp;[_]<span class="tok-type">u16</span>{<span class="tok-str">'\\'</span>}) <span class="tok-kw">orelse</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1191">            <span class="tok-kw">const</span> volume_name_u16 = final_path[<span class="tok-number">0</span>..file_path_begin_index];</span>
<span class="line" id="L1192">            <span class="tok-kw">const</span> file_name_u16 = final_path[file_path_begin_index..];</span>
<span class="line" id="L1193"></span>
<span class="line" id="L1194">            <span class="tok-comment">// Get DOS volume name. DOS volume names are actually symbolic link objects to the</span>
</span>
<span class="line" id="L1195">            <span class="tok-comment">// actual NT volume. For example:</span>
</span>
<span class="line" id="L1196">            <span class="tok-comment">// (NT) \Device\HarddiskVolume4 =&gt; (DOS) \DosDevices\C: == (DOS) C:</span>
</span>
<span class="line" id="L1197">            <span class="tok-kw">const</span> MIN_SIZE = <span class="tok-builtin">@sizeOf</span>(MOUNTMGR_MOUNT_POINT) + MAX_PATH;</span>
<span class="line" id="L1198">            <span class="tok-comment">// We initialize the input buffer to all zeros for convenience since</span>
</span>
<span class="line" id="L1199">            <span class="tok-comment">// `DeviceIoControl` with `IOCTL_MOUNTMGR_QUERY_POINTS` expects this.</span>
</span>
<span class="line" id="L1200">            <span class="tok-kw">var</span> input_buf: [MIN_SIZE]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(MOUNTMGR_MOUNT_POINT)) = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** MIN_SIZE;</span>
<span class="line" id="L1201">            <span class="tok-kw">var</span> output_buf: [MIN_SIZE * <span class="tok-number">4</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(MOUNTMGR_MOUNT_POINTS)) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1202"></span>
<span class="line" id="L1203">            <span class="tok-comment">// This surprising path is a filesystem path to the mount manager on Windows.</span>
</span>
<span class="line" id="L1204">            <span class="tok-comment">// Source: https://stackoverflow.com/questions/3012828/using-ioctl-mountmgr-query-points</span>
</span>
<span class="line" id="L1205">            <span class="tok-comment">// This is the NT namespaced version of \\.\MountPointManager</span>
</span>
<span class="line" id="L1206">            <span class="tok-kw">const</span> mgmt_path_u16 = std.unicode.utf8ToUtf16LeStringLiteral(<span class="tok-str">&quot;\\??\\MountPointManager&quot;</span>);</span>
<span class="line" id="L1207">            <span class="tok-kw">const</span> mgmt_handle = OpenFile(mgmt_path_u16, .{</span>
<span class="line" id="L1208">                .access_mask = SYNCHRONIZE,</span>
<span class="line" id="L1209">                .share_access = FILE_SHARE_READ | FILE_SHARE_WRITE,</span>
<span class="line" id="L1210">                .creation = FILE_OPEN,</span>
<span class="line" id="L1211">                .io_mode = .blocking,</span>
<span class="line" id="L1212">            }) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1213">                <span class="tok-kw">error</span>.IsDir =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1214">                <span class="tok-kw">error</span>.NotDir =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1215">                <span class="tok-kw">error</span>.NoDevice =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1216">                <span class="tok-kw">error</span>.AccessDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1217">                <span class="tok-kw">error</span>.PipeBusy =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1218">                <span class="tok-kw">error</span>.PathAlreadyExists =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1219">                <span class="tok-kw">error</span>.WouldBlock =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1220">                <span class="tok-kw">error</span>.NetworkNotFound =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1221">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1222">            };</span>
<span class="line" id="L1223">            <span class="tok-kw">defer</span> CloseHandle(mgmt_handle);</span>
<span class="line" id="L1224"></span>
<span class="line" id="L1225">            <span class="tok-kw">var</span> input_struct = <span class="tok-builtin">@as</span>(*MOUNTMGR_MOUNT_POINT, <span class="tok-builtin">@ptrCast</span>(&amp;input_buf[<span class="tok-number">0</span>]));</span>
<span class="line" id="L1226">            input_struct.DeviceNameOffset = <span class="tok-builtin">@sizeOf</span>(MOUNTMGR_MOUNT_POINT);</span>
<span class="line" id="L1227">            input_struct.DeviceNameLength = <span class="tok-builtin">@as</span>(USHORT, <span class="tok-builtin">@intCast</span>(volume_name_u16.len * <span class="tok-number">2</span>));</span>
<span class="line" id="L1228">            <span class="tok-builtin">@memcpy</span>(input_buf[<span class="tok-builtin">@sizeOf</span>(MOUNTMGR_MOUNT_POINT)..][<span class="tok-number">0</span> .. volume_name_u16.len * <span class="tok-number">2</span>], <span class="tok-builtin">@as</span>([*]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-builtin">@ptrCast</span>(volume_name_u16.ptr)));</span>
<span class="line" id="L1229"></span>
<span class="line" id="L1230">            DeviceIoControl(mgmt_handle, IOCTL_MOUNTMGR_QUERY_POINTS, &amp;input_buf, &amp;output_buf) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1231">                <span class="tok-kw">error</span>.AccessDenied =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1232">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1233">            };</span>
<span class="line" id="L1234">            <span class="tok-kw">const</span> mount_points_struct = <span class="tok-builtin">@as</span>(*<span class="tok-kw">const</span> MOUNTMGR_MOUNT_POINTS, <span class="tok-builtin">@ptrCast</span>(&amp;output_buf[<span class="tok-number">0</span>]));</span>
<span class="line" id="L1235"></span>
<span class="line" id="L1236">            <span class="tok-kw">const</span> mount_points = <span class="tok-builtin">@as</span>(</span>
<span class="line" id="L1237">                [*]<span class="tok-kw">const</span> MOUNTMGR_MOUNT_POINT,</span>
<span class="line" id="L1238">                <span class="tok-builtin">@ptrCast</span>(&amp;mount_points_struct.MountPoints[<span class="tok-number">0</span>]),</span>
<span class="line" id="L1239">            )[<span class="tok-number">0</span>..mount_points_struct.NumberOfMountPoints];</span>
<span class="line" id="L1240"></span>
<span class="line" id="L1241">            <span class="tok-kw">for</span> (mount_points) |mount_point| {</span>
<span class="line" id="L1242">                <span class="tok-kw">const</span> symlink = <span class="tok-builtin">@as</span>(</span>
<span class="line" id="L1243">                    [*]<span class="tok-kw">const</span> <span class="tok-type">u16</span>,</span>
<span class="line" id="L1244">                    <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(&amp;output_buf[mount_point.SymbolicLinkNameOffset])),</span>
<span class="line" id="L1245">                )[<span class="tok-number">0</span> .. mount_point.SymbolicLinkNameLength / <span class="tok-number">2</span>];</span>
<span class="line" id="L1246"></span>
<span class="line" id="L1247">                <span class="tok-comment">// Look for `\DosDevices\` prefix. We don't really care if there are more than one symlinks</span>
</span>
<span class="line" id="L1248">                <span class="tok-comment">// with traditional DOS drive letters, so pick the first one available.</span>
</span>
<span class="line" id="L1249">                <span class="tok-kw">var</span> prefix_buf = std.unicode.utf8ToUtf16LeStringLiteral(<span class="tok-str">&quot;\\DosDevices\\&quot;</span>);</span>
<span class="line" id="L1250">                <span class="tok-kw">const</span> prefix = prefix_buf[<span class="tok-number">0</span>..prefix_buf.len];</span>
<span class="line" id="L1251"></span>
<span class="line" id="L1252">                <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u16</span>, symlink, prefix)) {</span>
<span class="line" id="L1253">                    <span class="tok-kw">const</span> drive_letter = symlink[prefix.len..];</span>
<span class="line" id="L1254"></span>
<span class="line" id="L1255">                    <span class="tok-kw">if</span> (out_buffer.len &lt; drive_letter.len + file_name_u16.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L1256"></span>
<span class="line" id="L1257">                    <span class="tok-builtin">@memcpy</span>(out_buffer[<span class="tok-number">0</span>..drive_letter.len], drive_letter);</span>
<span class="line" id="L1258">                    mem.copyForwards(<span class="tok-type">u16</span>, out_buffer[drive_letter.len..][<span class="tok-number">0</span>..file_name_u16.len], file_name_u16);</span>
<span class="line" id="L1259">                    <span class="tok-kw">const</span> total_len = drive_letter.len + file_name_u16.len;</span>
<span class="line" id="L1260"></span>
<span class="line" id="L1261">                    <span class="tok-comment">// Validate that DOS does not contain any spurious nul bytes.</span>
</span>
<span class="line" id="L1262">                    <span class="tok-kw">if</span> (mem.indexOfScalar(<span class="tok-type">u16</span>, out_buffer[<span class="tok-number">0</span>..total_len], <span class="tok-number">0</span>)) |_| {</span>
<span class="line" id="L1263">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadPathName;</span>
<span class="line" id="L1264">                    }</span>
<span class="line" id="L1265"></span>
<span class="line" id="L1266">                    <span class="tok-kw">return</span> out_buffer[<span class="tok-number">0</span>..total_len];</span>
<span class="line" id="L1267">                }</span>
<span class="line" id="L1268">            }</span>
<span class="line" id="L1269"></span>
<span class="line" id="L1270">            <span class="tok-comment">// If we've ended up here, then something went wrong/is corrupted in the OS,</span>
</span>
<span class="line" id="L1271">            <span class="tok-comment">// so error out!</span>
</span>
<span class="line" id="L1272">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound;</span>
<span class="line" id="L1273">        },</span>
<span class="line" id="L1274">    }</span>
<span class="line" id="L1275">}</span>
<span class="line" id="L1276"></span>
<span class="line" id="L1277"><span class="tok-kw">test</span> <span class="tok-str">&quot;GetFinalPathNameByHandle&quot;</span> {</span>
<span class="line" id="L1278">    <span class="tok-kw">if</span> (builtin.os.tag != .windows)</span>
<span class="line" id="L1279">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L1280"></span>
<span class="line" id="L1281">    <span class="tok-comment">//any file will do</span>
</span>
<span class="line" id="L1282">    <span class="tok-kw">var</span> tmp = std.testing.tmpDir(.{});</span>
<span class="line" id="L1283">    <span class="tok-kw">defer</span> tmp.cleanup();</span>
<span class="line" id="L1284">    <span class="tok-kw">const</span> handle = tmp.dir.fd;</span>
<span class="line" id="L1285">    <span class="tok-kw">var</span> buffer: [PATH_MAX_WIDE]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1286"></span>
<span class="line" id="L1287">    <span class="tok-comment">//check with sufficient size</span>
</span>
<span class="line" id="L1288">    <span class="tok-kw">const</span> nt_path = <span class="tok-kw">try</span> GetFinalPathNameByHandle(handle, .{ .volume_name = .Nt }, &amp;buffer);</span>
<span class="line" id="L1289">    _ = <span class="tok-kw">try</span> GetFinalPathNameByHandle(handle, .{ .volume_name = .Dos }, &amp;buffer);</span>
<span class="line" id="L1290"></span>
<span class="line" id="L1291">    <span class="tok-kw">const</span> required_len_in_u16 = nt_path.len + <span class="tok-builtin">@divExact</span>(<span class="tok-builtin">@intFromPtr</span>(nt_path.ptr) - <span class="tok-builtin">@intFromPtr</span>(&amp;buffer), <span class="tok-number">2</span>) + <span class="tok-number">1</span>;</span>
<span class="line" id="L1292">    <span class="tok-comment">//check with insufficient size</span>
</span>
<span class="line" id="L1293">    <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.NameTooLong, GetFinalPathNameByHandle(handle, .{ .volume_name = .Nt }, buffer[<span class="tok-number">0</span> .. required_len_in_u16 - <span class="tok-number">1</span>]));</span>
<span class="line" id="L1294">    <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.NameTooLong, GetFinalPathNameByHandle(handle, .{ .volume_name = .Dos }, buffer[<span class="tok-number">0</span> .. required_len_in_u16 - <span class="tok-number">1</span>]));</span>
<span class="line" id="L1295"></span>
<span class="line" id="L1296">    <span class="tok-comment">//check with exactly-sufficient size</span>
</span>
<span class="line" id="L1297">    _ = <span class="tok-kw">try</span> GetFinalPathNameByHandle(handle, .{ .volume_name = .Nt }, buffer[<span class="tok-number">0</span>..required_len_in_u16]);</span>
<span class="line" id="L1298">    _ = <span class="tok-kw">try</span> GetFinalPathNameByHandle(handle, .{ .volume_name = .Dos }, buffer[<span class="tok-number">0</span>..required_len_in_u16]);</span>
<span class="line" id="L1299">}</span>
<span class="line" id="L1300"></span>
<span class="line" id="L1301"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetFileSizeError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1302"></span>
<span class="line" id="L1303"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetFileSizeEx</span>(hFile: HANDLE) GetFileSizeError!<span class="tok-type">u64</span> {</span>
<span class="line" id="L1304">    <span class="tok-kw">var</span> file_size: LARGE_INTEGER = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1305">    <span class="tok-kw">if</span> (kernel32.GetFileSizeEx(hFile, &amp;file_size) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1306">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1307">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1308">        }</span>
<span class="line" id="L1309">    }</span>
<span class="line" id="L1310">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-builtin">@bitCast</span>(file_size));</span>
<span class="line" id="L1311">}</span>
<span class="line" id="L1312"></span>
<span class="line" id="L1313"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetFileAttributesError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1314">    FileNotFound,</span>
<span class="line" id="L1315">    PermissionDenied,</span>
<span class="line" id="L1316">    Unexpected,</span>
<span class="line" id="L1317">};</span>
<span class="line" id="L1318"></span>
<span class="line" id="L1319"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetFileAttributes</span>(filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) GetFileAttributesError!DWORD {</span>
<span class="line" id="L1320">    <span class="tok-kw">const</span> filename_w = <span class="tok-kw">try</span> sliceToPrefixedFileW(filename);</span>
<span class="line" id="L1321">    <span class="tok-kw">return</span> GetFileAttributesW(filename_w.span().ptr);</span>
<span class="line" id="L1322">}</span>
<span class="line" id="L1323"></span>
<span class="line" id="L1324"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetFileAttributesW</span>(lpFileName: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>) GetFileAttributesError!DWORD {</span>
<span class="line" id="L1325">    <span class="tok-kw">const</span> rc = kernel32.GetFileAttributesW(lpFileName);</span>
<span class="line" id="L1326">    <span class="tok-kw">if</span> (rc == INVALID_FILE_ATTRIBUTES) {</span>
<span class="line" id="L1327">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1328">            .FILE_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1329">            .PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1330">            .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PermissionDenied,</span>
<span class="line" id="L1331">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1332">        }</span>
<span class="line" id="L1333">    }</span>
<span class="line" id="L1334">    <span class="tok-kw">return</span> rc;</span>
<span class="line" id="L1335">}</span>
<span class="line" id="L1336"></span>
<span class="line" id="L1337"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WSAStartup</span>(majorVersion: <span class="tok-type">u8</span>, minorVersion: <span class="tok-type">u8</span>) !ws2_32.WSADATA {</span>
<span class="line" id="L1338">    <span class="tok-kw">var</span> wsadata: ws2_32.WSADATA = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1339">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (ws2_32.WSAStartup((<span class="tok-builtin">@as</span>(WORD, minorVersion) &lt;&lt; <span class="tok-number">8</span>) | majorVersion, &amp;wsadata)) {</span>
<span class="line" id="L1340">        <span class="tok-number">0</span> =&gt; wsadata,</span>
<span class="line" id="L1341">        <span class="tok-kw">else</span> =&gt; |err_int| <span class="tok-kw">switch</span> (<span class="tok-builtin">@as</span>(ws2_32.WinsockError, <span class="tok-builtin">@enumFromInt</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(err_int))))) {</span>
<span class="line" id="L1342">            .WSASYSNOTREADY =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemNotAvailable,</span>
<span class="line" id="L1343">            .WSAVERNOTSUPPORTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.VersionNotSupported,</span>
<span class="line" id="L1344">            .WSAEINPROGRESS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BlockingOperationInProgress,</span>
<span class="line" id="L1345">            .WSAEPROCLIM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1346">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedWSAError(err),</span>
<span class="line" id="L1347">        },</span>
<span class="line" id="L1348">    };</span>
<span class="line" id="L1349">}</span>
<span class="line" id="L1350"></span>
<span class="line" id="L1351"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WSACleanup</span>() !<span class="tok-type">void</span> {</span>
<span class="line" id="L1352">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (ws2_32.WSACleanup()) {</span>
<span class="line" id="L1353">        <span class="tok-number">0</span> =&gt; {},</span>
<span class="line" id="L1354">        ws2_32.SOCKET_ERROR =&gt; <span class="tok-kw">switch</span> (ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L1355">            .WSANOTINITIALISED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotInitialized,</span>
<span class="line" id="L1356">            .WSAENETDOWN =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NetworkNotAvailable,</span>
<span class="line" id="L1357">            .WSAEINPROGRESS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BlockingOperationInProgress,</span>
<span class="line" id="L1358">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedWSAError(err),</span>
<span class="line" id="L1359">        },</span>
<span class="line" id="L1360">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1361">    };</span>
<span class="line" id="L1362">}</span>
<span class="line" id="L1363"></span>
<span class="line" id="L1364"><span class="tok-kw">var</span> wsa_startup_mutex: std.Thread.Mutex = .{};</span>
<span class="line" id="L1365"></span>
<span class="line" id="L1366"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">callWSAStartup</span>() !<span class="tok-type">void</span> {</span>
<span class="line" id="L1367">    wsa_startup_mutex.lock();</span>
<span class="line" id="L1368">    <span class="tok-kw">defer</span> wsa_startup_mutex.unlock();</span>
<span class="line" id="L1369"></span>
<span class="line" id="L1370">    <span class="tok-comment">// Here we could use a flag to prevent multiple threads to prevent</span>
</span>
<span class="line" id="L1371">    <span class="tok-comment">// multiple calls to WSAStartup, but it doesn't matter. We're globally</span>
</span>
<span class="line" id="L1372">    <span class="tok-comment">// leaking the resource intentionally, and the mutex already prevents</span>
</span>
<span class="line" id="L1373">    <span class="tok-comment">// data races within the WSAStartup function.</span>
</span>
<span class="line" id="L1374">    _ = WSAStartup(<span class="tok-number">2</span>, <span class="tok-number">2</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1375">        <span class="tok-kw">error</span>.SystemNotAvailable =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1376">        <span class="tok-kw">error</span>.VersionNotSupported =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L1377">        <span class="tok-kw">error</span>.BlockingOperationInProgress =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L1378">        <span class="tok-kw">error</span>.ProcessFdQuotaExceeded =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1379">        <span class="tok-kw">error</span>.Unexpected =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected,</span>
<span class="line" id="L1380">    };</span>
<span class="line" id="L1381">}</span>
<span class="line" id="L1382"></span>
<span class="line" id="L1383"><span class="tok-comment">/// Microsoft requires WSAStartup to be called to initialize, or else</span></span>
<span class="line" id="L1384"><span class="tok-comment">/// WSASocketW will return WSANOTINITIALISED.</span></span>
<span class="line" id="L1385"><span class="tok-comment">/// Since this is a standard library, we do not have the luxury of</span></span>
<span class="line" id="L1386"><span class="tok-comment">/// putting initialization code anywhere, because we would not want</span></span>
<span class="line" id="L1387"><span class="tok-comment">/// to pay the cost of calling WSAStartup if there ended up being no</span></span>
<span class="line" id="L1388"><span class="tok-comment">/// networking. Also, if Zig code is used as a library, Zig is not in</span></span>
<span class="line" id="L1389"><span class="tok-comment">/// charge of the start code, and we couldn't put in any initialization</span></span>
<span class="line" id="L1390"><span class="tok-comment">/// code even if we wanted to.</span></span>
<span class="line" id="L1391"><span class="tok-comment">/// The documentation for WSAStartup mentions that there must be a</span></span>
<span class="line" id="L1392"><span class="tok-comment">/// matching WSACleanup call. It is not possible for the Zig Standard</span></span>
<span class="line" id="L1393"><span class="tok-comment">/// Library to honor this for the same reason - there is nowhere to put</span></span>
<span class="line" id="L1394"><span class="tok-comment">/// deinitialization code.</span></span>
<span class="line" id="L1395"><span class="tok-comment">/// So, API users of the zig std lib have two options:</span></span>
<span class="line" id="L1396"><span class="tok-comment">///  * (recommended) The simple, cross-platform way: just call `WSASocketW`</span></span>
<span class="line" id="L1397"><span class="tok-comment">///    and don't worry about it. Zig will call WSAStartup() in a thread-safe</span></span>
<span class="line" id="L1398"><span class="tok-comment">///    manner and never deinitialize networking. This is ideal for an</span></span>
<span class="line" id="L1399"><span class="tok-comment">///    application which has the capability to do networking.</span></span>
<span class="line" id="L1400"><span class="tok-comment">///  * The getting-your-hands-dirty way: call `WSAStartup()` before doing</span></span>
<span class="line" id="L1401"><span class="tok-comment">///    networking, so that the error handling code for WSANOTINITIALISED never</span></span>
<span class="line" id="L1402"><span class="tok-comment">///    gets run, which then allows the application or library to call `WSACleanup()`.</span></span>
<span class="line" id="L1403"><span class="tok-comment">///    This could make sense for a library, which has init and deinit</span></span>
<span class="line" id="L1404"><span class="tok-comment">///    functions for the whole library's lifetime.</span></span>
<span class="line" id="L1405"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WSASocketW</span>(</span>
<span class="line" id="L1406">    af: <span class="tok-type">i32</span>,</span>
<span class="line" id="L1407">    socket_type: <span class="tok-type">i32</span>,</span>
<span class="line" id="L1408">    protocol: <span class="tok-type">i32</span>,</span>
<span class="line" id="L1409">    protocolInfo: ?*ws2_32.WSAPROTOCOL_INFOW,</span>
<span class="line" id="L1410">    g: ws2_32.GROUP,</span>
<span class="line" id="L1411">    dwFlags: DWORD,</span>
<span class="line" id="L1412">) !ws2_32.SOCKET {</span>
<span class="line" id="L1413">    <span class="tok-kw">var</span> first = <span class="tok-null">true</span>;</span>
<span class="line" id="L1414">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1415">        <span class="tok-kw">const</span> rc = ws2_32.WSASocketW(af, socket_type, protocol, protocolInfo, g, dwFlags);</span>
<span class="line" id="L1416">        <span class="tok-kw">if</span> (rc == ws2_32.INVALID_SOCKET) {</span>
<span class="line" id="L1417">            <span class="tok-kw">switch</span> (ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L1418">                .WSAEAFNOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AddressFamilyNotSupported,</span>
<span class="line" id="L1419">                .WSAEMFILE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProcessFdQuotaExceeded,</span>
<span class="line" id="L1420">                .WSAENOBUFS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1421">                .WSAEPROTONOSUPPORT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ProtocolNotSupported,</span>
<span class="line" id="L1422">                .WSANOTINITIALISED =&gt; {</span>
<span class="line" id="L1423">                    <span class="tok-kw">if</span> (!first) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L1424">                    first = <span class="tok-null">false</span>;</span>
<span class="line" id="L1425">                    <span class="tok-kw">try</span> callWSAStartup();</span>
<span class="line" id="L1426">                    <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1427">                },</span>
<span class="line" id="L1428">                <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedWSAError(err),</span>
<span class="line" id="L1429">            }</span>
<span class="line" id="L1430">        }</span>
<span class="line" id="L1431">        <span class="tok-kw">return</span> rc;</span>
<span class="line" id="L1432">    }</span>
<span class="line" id="L1433">}</span>
<span class="line" id="L1434"></span>
<span class="line" id="L1435"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">bind</span>(s: ws2_32.SOCKET, name: *<span class="tok-kw">const</span> ws2_32.sockaddr, namelen: ws2_32.socklen_t) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1436">    <span class="tok-kw">return</span> ws2_32.bind(s, name, <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(namelen)));</span>
<span class="line" id="L1437">}</span>
<span class="line" id="L1438"></span>
<span class="line" id="L1439"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">listen</span>(s: ws2_32.SOCKET, backlog: <span class="tok-type">u31</span>) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1440">    <span class="tok-kw">return</span> ws2_32.listen(s, backlog);</span>
<span class="line" id="L1441">}</span>
<span class="line" id="L1442"></span>
<span class="line" id="L1443"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">closesocket</span>(s: ws2_32.SOCKET) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1444">    <span class="tok-kw">switch</span> (ws2_32.closesocket(s)) {</span>
<span class="line" id="L1445">        <span class="tok-number">0</span> =&gt; {},</span>
<span class="line" id="L1446">        ws2_32.SOCKET_ERROR =&gt; <span class="tok-kw">switch</span> (ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L1447">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedWSAError(err),</span>
<span class="line" id="L1448">        },</span>
<span class="line" id="L1449">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1450">    }</span>
<span class="line" id="L1451">}</span>
<span class="line" id="L1452"></span>
<span class="line" id="L1453"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">accept</span>(s: ws2_32.SOCKET, name: ?*ws2_32.sockaddr, namelen: ?*ws2_32.socklen_t) ws2_32.SOCKET {</span>
<span class="line" id="L1454">    assert((name == <span class="tok-null">null</span>) == (namelen == <span class="tok-null">null</span>));</span>
<span class="line" id="L1455">    <span class="tok-kw">return</span> ws2_32.accept(s, name, <span class="tok-builtin">@as</span>(?*<span class="tok-type">i32</span>, <span class="tok-builtin">@ptrCast</span>(namelen)));</span>
<span class="line" id="L1456">}</span>
<span class="line" id="L1457"></span>
<span class="line" id="L1458"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getsockname</span>(s: ws2_32.SOCKET, name: *ws2_32.sockaddr, namelen: *ws2_32.socklen_t) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1459">    <span class="tok-kw">return</span> ws2_32.getsockname(s, name, <span class="tok-builtin">@as</span>(*<span class="tok-type">i32</span>, <span class="tok-builtin">@ptrCast</span>(namelen)));</span>
<span class="line" id="L1460">}</span>
<span class="line" id="L1461"></span>
<span class="line" id="L1462"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getpeername</span>(s: ws2_32.SOCKET, name: *ws2_32.sockaddr, namelen: *ws2_32.socklen_t) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1463">    <span class="tok-kw">return</span> ws2_32.getpeername(s, name, <span class="tok-builtin">@as</span>(*<span class="tok-type">i32</span>, <span class="tok-builtin">@ptrCast</span>(namelen)));</span>
<span class="line" id="L1464">}</span>
<span class="line" id="L1465"></span>
<span class="line" id="L1466"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sendmsg</span>(</span>
<span class="line" id="L1467">    s: ws2_32.SOCKET,</span>
<span class="line" id="L1468">    msg: *<span class="tok-kw">const</span> ws2_32.WSAMSG,</span>
<span class="line" id="L1469">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1470">) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1471">    <span class="tok-kw">var</span> bytes_send: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1472">    <span class="tok-kw">if</span> (ws2_32.WSASendMsg(s, msg, flags, &amp;bytes_send, <span class="tok-null">null</span>, <span class="tok-null">null</span>) == ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L1473">        <span class="tok-kw">return</span> ws2_32.SOCKET_ERROR;</span>
<span class="line" id="L1474">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1475">        <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">u31</span>, <span class="tok-builtin">@intCast</span>(bytes_send)));</span>
<span class="line" id="L1476">    }</span>
<span class="line" id="L1477">}</span>
<span class="line" id="L1478"></span>
<span class="line" id="L1479"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sendto</span>(s: ws2_32.SOCKET, buf: [*]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, len: <span class="tok-type">usize</span>, flags: <span class="tok-type">u32</span>, to: ?*<span class="tok-kw">const</span> ws2_32.sockaddr, to_len: ws2_32.socklen_t) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1480">    <span class="tok-kw">var</span> buffer = ws2_32.WSABUF{ .len = <span class="tok-builtin">@as</span>(<span class="tok-type">u31</span>, <span class="tok-builtin">@truncate</span>(len)), .buf = <span class="tok-builtin">@constCast</span>(buf) };</span>
<span class="line" id="L1481">    <span class="tok-kw">var</span> bytes_send: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1482">    <span class="tok-kw">if</span> (ws2_32.WSASendTo(s, <span class="tok-builtin">@as</span>([*]ws2_32.WSABUF, <span class="tok-builtin">@ptrCast</span>(&amp;buffer)), <span class="tok-number">1</span>, &amp;bytes_send, flags, to, <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(to_len)), <span class="tok-null">null</span>, <span class="tok-null">null</span>) == ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L1483">        <span class="tok-kw">return</span> ws2_32.SOCKET_ERROR;</span>
<span class="line" id="L1484">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1485">        <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">u31</span>, <span class="tok-builtin">@intCast</span>(bytes_send)));</span>
<span class="line" id="L1486">    }</span>
<span class="line" id="L1487">}</span>
<span class="line" id="L1488"></span>
<span class="line" id="L1489"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">recvfrom</span>(s: ws2_32.SOCKET, buf: [*]<span class="tok-type">u8</span>, len: <span class="tok-type">usize</span>, flags: <span class="tok-type">u32</span>, from: ?*ws2_32.sockaddr, from_len: ?*ws2_32.socklen_t) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1490">    <span class="tok-kw">var</span> buffer = ws2_32.WSABUF{ .len = <span class="tok-builtin">@as</span>(<span class="tok-type">u31</span>, <span class="tok-builtin">@truncate</span>(len)), .buf = buf };</span>
<span class="line" id="L1491">    <span class="tok-kw">var</span> bytes_received: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1492">    <span class="tok-kw">var</span> flags_inout = flags;</span>
<span class="line" id="L1493">    <span class="tok-kw">if</span> (ws2_32.WSARecvFrom(s, <span class="tok-builtin">@as</span>([*]ws2_32.WSABUF, <span class="tok-builtin">@ptrCast</span>(&amp;buffer)), <span class="tok-number">1</span>, &amp;bytes_received, &amp;flags_inout, from, <span class="tok-builtin">@as</span>(?*<span class="tok-type">i32</span>, <span class="tok-builtin">@ptrCast</span>(from_len)), <span class="tok-null">null</span>, <span class="tok-null">null</span>) == ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L1494">        <span class="tok-kw">return</span> ws2_32.SOCKET_ERROR;</span>
<span class="line" id="L1495">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1496">        <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">u31</span>, <span class="tok-builtin">@intCast</span>(bytes_received)));</span>
<span class="line" id="L1497">    }</span>
<span class="line" id="L1498">}</span>
<span class="line" id="L1499"></span>
<span class="line" id="L1500"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">poll</span>(fds: [*]ws2_32.pollfd, n: <span class="tok-type">c_ulong</span>, timeout: <span class="tok-type">i32</span>) <span class="tok-type">i32</span> {</span>
<span class="line" id="L1501">    <span class="tok-kw">return</span> ws2_32.WSAPoll(fds, n, timeout);</span>
<span class="line" id="L1502">}</span>
<span class="line" id="L1503"></span>
<span class="line" id="L1504"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WSAIoctl</span>(</span>
<span class="line" id="L1505">    s: ws2_32.SOCKET,</span>
<span class="line" id="L1506">    dwIoControlCode: DWORD,</span>
<span class="line" id="L1507">    inBuffer: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1508">    outBuffer: []<span class="tok-type">u8</span>,</span>
<span class="line" id="L1509">    overlapped: ?*OVERLAPPED,</span>
<span class="line" id="L1510">    completionRoutine: ?ws2_32.LPWSAOVERLAPPED_COMPLETION_ROUTINE,</span>
<span class="line" id="L1511">) !DWORD {</span>
<span class="line" id="L1512">    <span class="tok-kw">var</span> bytes: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1513">    <span class="tok-kw">switch</span> (ws2_32.WSAIoctl(</span>
<span class="line" id="L1514">        s,</span>
<span class="line" id="L1515">        dwIoControlCode,</span>
<span class="line" id="L1516">        <span class="tok-kw">if</span> (inBuffer) |i| i.ptr <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L1517">        <span class="tok-kw">if</span> (inBuffer) |i| <span class="tok-builtin">@as</span>(DWORD, <span class="tok-builtin">@intCast</span>(i.len)) <span class="tok-kw">else</span> <span class="tok-number">0</span>,</span>
<span class="line" id="L1518">        outBuffer.ptr,</span>
<span class="line" id="L1519">        <span class="tok-builtin">@as</span>(DWORD, <span class="tok-builtin">@intCast</span>(outBuffer.len)),</span>
<span class="line" id="L1520">        &amp;bytes,</span>
<span class="line" id="L1521">        overlapped,</span>
<span class="line" id="L1522">        completionRoutine,</span>
<span class="line" id="L1523">    )) {</span>
<span class="line" id="L1524">        <span class="tok-number">0</span> =&gt; {},</span>
<span class="line" id="L1525">        ws2_32.SOCKET_ERROR =&gt; <span class="tok-kw">switch</span> (ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L1526">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedWSAError(err),</span>
<span class="line" id="L1527">        },</span>
<span class="line" id="L1528">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1529">    }</span>
<span class="line" id="L1530">    <span class="tok-kw">return</span> bytes;</span>
<span class="line" id="L1531">}</span>
<span class="line" id="L1532"></span>
<span class="line" id="L1533"><span class="tok-kw">const</span> GetModuleFileNameError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1534"></span>
<span class="line" id="L1535"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetModuleFileNameW</span>(hModule: ?HMODULE, buf_ptr: [*]<span class="tok-type">u16</span>, buf_len: DWORD) GetModuleFileNameError![:<span class="tok-number">0</span>]<span class="tok-type">u16</span> {</span>
<span class="line" id="L1536">    <span class="tok-kw">const</span> rc = kernel32.GetModuleFileNameW(hModule, buf_ptr, buf_len);</span>
<span class="line" id="L1537">    <span class="tok-kw">if</span> (rc == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1538">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1539">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1540">        }</span>
<span class="line" id="L1541">    }</span>
<span class="line" id="L1542">    <span class="tok-kw">return</span> buf_ptr[<span class="tok-number">0</span>..rc :<span class="tok-number">0</span>];</span>
<span class="line" id="L1543">}</span>
<span class="line" id="L1544"></span>
<span class="line" id="L1545"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TerminateProcessError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1546"></span>
<span class="line" id="L1547"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">TerminateProcess</span>(hProcess: HANDLE, uExitCode: UINT) TerminateProcessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1548">    <span class="tok-kw">if</span> (kernel32.TerminateProcess(hProcess, uExitCode) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1549">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1550">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1551">        }</span>
<span class="line" id="L1552">    }</span>
<span class="line" id="L1553">}</span>
<span class="line" id="L1554"></span>
<span class="line" id="L1555"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VirtualAllocError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1556"></span>
<span class="line" id="L1557"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">VirtualAlloc</span>(addr: ?LPVOID, size: <span class="tok-type">usize</span>, alloc_type: DWORD, flProtect: DWORD) VirtualAllocError!LPVOID {</span>
<span class="line" id="L1558">    <span class="tok-kw">return</span> kernel32.VirtualAlloc(addr, size, alloc_type, flProtect) <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L1559">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1560">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1561">        }</span>
<span class="line" id="L1562">    };</span>
<span class="line" id="L1563">}</span>
<span class="line" id="L1564"></span>
<span class="line" id="L1565"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">VirtualFree</span>(lpAddress: ?LPVOID, dwSize: <span class="tok-type">usize</span>, dwFreeType: DWORD) <span class="tok-type">void</span> {</span>
<span class="line" id="L1566">    assert(kernel32.VirtualFree(lpAddress, dwSize, dwFreeType) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1567">}</span>
<span class="line" id="L1568"></span>
<span class="line" id="L1569"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VirtualProtectError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1570">    InvalidAddress,</span>
<span class="line" id="L1571">    Unexpected,</span>
<span class="line" id="L1572">};</span>
<span class="line" id="L1573"></span>
<span class="line" id="L1574"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">VirtualProtect</span>(lpAddress: ?LPVOID, dwSize: SIZE_T, flNewProtect: DWORD, lpflOldProtect: *DWORD) VirtualProtectError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1575">    <span class="tok-comment">// ntdll takes an extra level of indirection here</span>
</span>
<span class="line" id="L1576">    <span class="tok-kw">var</span> addr = lpAddress;</span>
<span class="line" id="L1577">    <span class="tok-kw">var</span> size = dwSize;</span>
<span class="line" id="L1578">    <span class="tok-kw">switch</span> (ntdll.NtProtectVirtualMemory(self_process_handle, &amp;addr, &amp;size, flNewProtect, lpflOldProtect)) {</span>
<span class="line" id="L1579">        .SUCCESS =&gt; {},</span>
<span class="line" id="L1580">        .INVALID_ADDRESS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidAddress,</span>
<span class="line" id="L1581">        <span class="tok-kw">else</span> =&gt; |st| <span class="tok-kw">return</span> unexpectedStatus(st),</span>
<span class="line" id="L1582">    }</span>
<span class="line" id="L1583">}</span>
<span class="line" id="L1584"></span>
<span class="line" id="L1585"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">VirtualProtectEx</span>(handle: HANDLE, addr: ?LPVOID, size: SIZE_T, new_prot: DWORD) VirtualProtectError!DWORD {</span>
<span class="line" id="L1586">    <span class="tok-kw">var</span> old_prot: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1587">    <span class="tok-kw">var</span> out_addr = addr;</span>
<span class="line" id="L1588">    <span class="tok-kw">var</span> out_size = size;</span>
<span class="line" id="L1589">    <span class="tok-kw">switch</span> (ntdll.NtProtectVirtualMemory(</span>
<span class="line" id="L1590">        handle,</span>
<span class="line" id="L1591">        &amp;out_addr,</span>
<span class="line" id="L1592">        &amp;out_size,</span>
<span class="line" id="L1593">        new_prot,</span>
<span class="line" id="L1594">        &amp;old_prot,</span>
<span class="line" id="L1595">    )) {</span>
<span class="line" id="L1596">        .SUCCESS =&gt; <span class="tok-kw">return</span> old_prot,</span>
<span class="line" id="L1597">        .INVALID_ADDRESS =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidAddress,</span>
<span class="line" id="L1598">        <span class="tok-comment">// TODO: map errors</span>
</span>
<span class="line" id="L1599">        <span class="tok-kw">else</span> =&gt; |rc| <span class="tok-kw">return</span> std.os.windows.unexpectedStatus(rc),</span>
<span class="line" id="L1600">    }</span>
<span class="line" id="L1601">}</span>
<span class="line" id="L1602"></span>
<span class="line" id="L1603"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VirtualQueryError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1604"></span>
<span class="line" id="L1605"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">VirtualQuery</span>(lpAddress: ?LPVOID, lpBuffer: PMEMORY_BASIC_INFORMATION, dwLength: SIZE_T) VirtualQueryError!SIZE_T {</span>
<span class="line" id="L1606">    <span class="tok-kw">const</span> rc = kernel32.VirtualQuery(lpAddress, lpBuffer, dwLength);</span>
<span class="line" id="L1607">    <span class="tok-kw">if</span> (rc == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1608">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1609">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1610">        }</span>
<span class="line" id="L1611">    }</span>
<span class="line" id="L1612"></span>
<span class="line" id="L1613">    <span class="tok-kw">return</span> rc;</span>
<span class="line" id="L1614">}</span>
<span class="line" id="L1615"></span>
<span class="line" id="L1616"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetConsoleTextAttributeError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1617"></span>
<span class="line" id="L1618"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetConsoleTextAttribute</span>(hConsoleOutput: HANDLE, wAttributes: WORD) SetConsoleTextAttributeError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1619">    <span class="tok-kw">if</span> (kernel32.SetConsoleTextAttribute(hConsoleOutput, wAttributes) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1620">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1621">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1622">        }</span>
<span class="line" id="L1623">    }</span>
<span class="line" id="L1624">}</span>
<span class="line" id="L1625"></span>
<span class="line" id="L1626"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetConsoleCtrlHandler</span>(handler_routine: ?HANDLER_ROUTINE, add: <span class="tok-type">bool</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1627">    <span class="tok-kw">const</span> success = kernel32.SetConsoleCtrlHandler(</span>
<span class="line" id="L1628">        handler_routine,</span>
<span class="line" id="L1629">        <span class="tok-kw">if</span> (add) TRUE <span class="tok-kw">else</span> FALSE,</span>
<span class="line" id="L1630">    );</span>
<span class="line" id="L1631"></span>
<span class="line" id="L1632">    <span class="tok-kw">if</span> (success == FALSE) {</span>
<span class="line" id="L1633">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1634">            <span class="tok-kw">else</span> =&gt; |err| unexpectedError(err),</span>
<span class="line" id="L1635">        };</span>
<span class="line" id="L1636">    }</span>
<span class="line" id="L1637">}</span>
<span class="line" id="L1638"></span>
<span class="line" id="L1639"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetFileCompletionNotificationModes</span>(handle: HANDLE, flags: UCHAR) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1640">    <span class="tok-kw">const</span> success = kernel32.SetFileCompletionNotificationModes(handle, flags);</span>
<span class="line" id="L1641">    <span class="tok-kw">if</span> (success == FALSE) {</span>
<span class="line" id="L1642">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1643">            <span class="tok-kw">else</span> =&gt; |err| unexpectedError(err),</span>
<span class="line" id="L1644">        };</span>
<span class="line" id="L1645">    }</span>
<span class="line" id="L1646">}</span>
<span class="line" id="L1647"></span>
<span class="line" id="L1648"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetEnvironmentStringsError = <span class="tok-kw">error</span>{OutOfMemory};</span>
<span class="line" id="L1649"></span>
<span class="line" id="L1650"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetEnvironmentStringsW</span>() GetEnvironmentStringsError![*:<span class="tok-number">0</span>]<span class="tok-type">u16</span> {</span>
<span class="line" id="L1651">    <span class="tok-kw">return</span> kernel32.GetEnvironmentStringsW() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.OutOfMemory;</span>
<span class="line" id="L1652">}</span>
<span class="line" id="L1653"></span>
<span class="line" id="L1654"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">FreeEnvironmentStringsW</span>(penv: [*:<span class="tok-number">0</span>]<span class="tok-type">u16</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1655">    assert(kernel32.FreeEnvironmentStringsW(penv) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1656">}</span>
<span class="line" id="L1657"></span>
<span class="line" id="L1658"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetEnvironmentVariableError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1659">    EnvironmentVariableNotFound,</span>
<span class="line" id="L1660">    Unexpected,</span>
<span class="line" id="L1661">};</span>
<span class="line" id="L1662"></span>
<span class="line" id="L1663"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetEnvironmentVariableW</span>(lpName: LPWSTR, lpBuffer: [*]<span class="tok-type">u16</span>, nSize: DWORD) GetEnvironmentVariableError!DWORD {</span>
<span class="line" id="L1664">    <span class="tok-kw">const</span> rc = kernel32.GetEnvironmentVariableW(lpName, lpBuffer, nSize);</span>
<span class="line" id="L1665">    <span class="tok-kw">if</span> (rc == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1666">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1667">            .ENVVAR_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.EnvironmentVariableNotFound,</span>
<span class="line" id="L1668">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1669">        }</span>
<span class="line" id="L1670">    }</span>
<span class="line" id="L1671">    <span class="tok-kw">return</span> rc;</span>
<span class="line" id="L1672">}</span>
<span class="line" id="L1673"></span>
<span class="line" id="L1674"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CreateProcessError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1675">    FileNotFound,</span>
<span class="line" id="L1676">    AccessDenied,</span>
<span class="line" id="L1677">    InvalidName,</span>
<span class="line" id="L1678">    NameTooLong,</span>
<span class="line" id="L1679">    InvalidExe,</span>
<span class="line" id="L1680">    Unexpected,</span>
<span class="line" id="L1681">};</span>
<span class="line" id="L1682"></span>
<span class="line" id="L1683"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CreateProcessW</span>(</span>
<span class="line" id="L1684">    lpApplicationName: ?LPWSTR,</span>
<span class="line" id="L1685">    lpCommandLine: LPWSTR,</span>
<span class="line" id="L1686">    lpProcessAttributes: ?*SECURITY_ATTRIBUTES,</span>
<span class="line" id="L1687">    lpThreadAttributes: ?*SECURITY_ATTRIBUTES,</span>
<span class="line" id="L1688">    bInheritHandles: BOOL,</span>
<span class="line" id="L1689">    dwCreationFlags: DWORD,</span>
<span class="line" id="L1690">    lpEnvironment: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L1691">    lpCurrentDirectory: ?LPWSTR,</span>
<span class="line" id="L1692">    lpStartupInfo: *STARTUPINFOW,</span>
<span class="line" id="L1693">    lpProcessInformation: *PROCESS_INFORMATION,</span>
<span class="line" id="L1694">) CreateProcessError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1695">    <span class="tok-kw">if</span> (kernel32.CreateProcessW(</span>
<span class="line" id="L1696">        lpApplicationName,</span>
<span class="line" id="L1697">        lpCommandLine,</span>
<span class="line" id="L1698">        lpProcessAttributes,</span>
<span class="line" id="L1699">        lpThreadAttributes,</span>
<span class="line" id="L1700">        bInheritHandles,</span>
<span class="line" id="L1701">        dwCreationFlags,</span>
<span class="line" id="L1702">        lpEnvironment,</span>
<span class="line" id="L1703">        lpCurrentDirectory,</span>
<span class="line" id="L1704">        lpStartupInfo,</span>
<span class="line" id="L1705">        lpProcessInformation,</span>
<span class="line" id="L1706">    ) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1707">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1708">            .FILE_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1709">            .PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1710">            .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1711">            .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1712">            .INVALID_NAME =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidName,</span>
<span class="line" id="L1713">            .FILENAME_EXCED_RANGE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong,</span>
<span class="line" id="L1714">            <span class="tok-comment">// These are all the system errors that are mapped to ENOEXEC by</span>
</span>
<span class="line" id="L1715">            <span class="tok-comment">// the undocumented _dosmaperr (old CRT) or __acrt_errno_map_os_error</span>
</span>
<span class="line" id="L1716">            <span class="tok-comment">// (newer CRT) functions. Their code can be found in crt/src/dosmap.c (old SDK)</span>
</span>
<span class="line" id="L1717">            <span class="tok-comment">// or urt/misc/errno.cpp (newer SDK) in the Windows SDK.</span>
</span>
<span class="line" id="L1718">            .BAD_FORMAT,</span>
<span class="line" id="L1719">            .INVALID_STARTING_CODESEG, <span class="tok-comment">// MIN_EXEC_ERROR in errno.cpp</span>
</span>
<span class="line" id="L1720">            .INVALID_STACKSEG,</span>
<span class="line" id="L1721">            .INVALID_MODULETYPE,</span>
<span class="line" id="L1722">            .INVALID_EXE_SIGNATURE,</span>
<span class="line" id="L1723">            .EXE_MARKED_INVALID,</span>
<span class="line" id="L1724">            .BAD_EXE_FORMAT,</span>
<span class="line" id="L1725">            .ITERATED_DATA_EXCEEDS_64k,</span>
<span class="line" id="L1726">            .INVALID_MINALLOCSIZE,</span>
<span class="line" id="L1727">            .DYNLINK_FROM_INVALID_RING,</span>
<span class="line" id="L1728">            .IOPL_NOT_ENABLED,</span>
<span class="line" id="L1729">            .INVALID_SEGDPL,</span>
<span class="line" id="L1730">            .AUTODATASEG_EXCEEDS_64k,</span>
<span class="line" id="L1731">            .RING2SEG_MUST_BE_MOVABLE,</span>
<span class="line" id="L1732">            .RELOC_CHAIN_XEEDS_SEGLIM,</span>
<span class="line" id="L1733">            .INFLOOP_IN_RELOC_CHAIN, <span class="tok-comment">// MAX_EXEC_ERROR in errno.cpp</span>
</span>
<span class="line" id="L1734">            <span class="tok-comment">// This one is not mapped to ENOEXEC but it is possible, for example</span>
</span>
<span class="line" id="L1735">            <span class="tok-comment">// when calling CreateProcessW on a plain text file with a .exe extension</span>
</span>
<span class="line" id="L1736">            .EXE_MACHINE_TYPE_MISMATCH,</span>
<span class="line" id="L1737">            =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidExe,</span>
<span class="line" id="L1738">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1739">        }</span>
<span class="line" id="L1740">    }</span>
<span class="line" id="L1741">}</span>
<span class="line" id="L1742"></span>
<span class="line" id="L1743"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LoadLibraryError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1744">    FileNotFound,</span>
<span class="line" id="L1745">    Unexpected,</span>
<span class="line" id="L1746">};</span>
<span class="line" id="L1747"></span>
<span class="line" id="L1748"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">LoadLibraryW</span>(lpLibFileName: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>) LoadLibraryError!HMODULE {</span>
<span class="line" id="L1749">    <span class="tok-kw">return</span> kernel32.LoadLibraryW(lpLibFileName) <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L1750">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1751">            .FILE_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1752">            .PATH_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1753">            .MOD_NOT_FOUND =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FileNotFound,</span>
<span class="line" id="L1754">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1755">        }</span>
<span class="line" id="L1756">    };</span>
<span class="line" id="L1757">}</span>
<span class="line" id="L1758"></span>
<span class="line" id="L1759"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">FreeLibrary</span>(hModule: HMODULE) <span class="tok-type">void</span> {</span>
<span class="line" id="L1760">    assert(kernel32.FreeLibrary(hModule) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1761">}</span>
<span class="line" id="L1762"></span>
<span class="line" id="L1763"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">QueryPerformanceFrequency</span>() <span class="tok-type">u64</span> {</span>
<span class="line" id="L1764">    <span class="tok-comment">// &quot;On systems that run Windows XP or later, the function will always succeed&quot;</span>
</span>
<span class="line" id="L1765">    <span class="tok-comment">// https://docs.microsoft.com/en-us/windows/desktop/api/profileapi/nf-profileapi-queryperformancefrequency</span>
</span>
<span class="line" id="L1766">    <span class="tok-kw">var</span> result: LARGE_INTEGER = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1767">    assert(kernel32.QueryPerformanceFrequency(&amp;result) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1768">    <span class="tok-comment">// The kernel treats this integer as unsigned.</span>
</span>
<span class="line" id="L1769">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-builtin">@bitCast</span>(result));</span>
<span class="line" id="L1770">}</span>
<span class="line" id="L1771"></span>
<span class="line" id="L1772"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">QueryPerformanceCounter</span>() <span class="tok-type">u64</span> {</span>
<span class="line" id="L1773">    <span class="tok-comment">// &quot;On systems that run Windows XP or later, the function will always succeed&quot;</span>
</span>
<span class="line" id="L1774">    <span class="tok-comment">// https://docs.microsoft.com/en-us/windows/desktop/api/profileapi/nf-profileapi-queryperformancecounter</span>
</span>
<span class="line" id="L1775">    <span class="tok-kw">var</span> result: LARGE_INTEGER = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1776">    assert(kernel32.QueryPerformanceCounter(&amp;result) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1777">    <span class="tok-comment">// The kernel treats this integer as unsigned.</span>
</span>
<span class="line" id="L1778">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-builtin">@bitCast</span>(result));</span>
<span class="line" id="L1779">}</span>
<span class="line" id="L1780"></span>
<span class="line" id="L1781"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">InitOnceExecuteOnce</span>(InitOnce: *INIT_ONCE, InitFn: INIT_ONCE_FN, Parameter: ?*<span class="tok-type">anyopaque</span>, Context: ?*<span class="tok-type">anyopaque</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1782">    assert(kernel32.InitOnceExecuteOnce(InitOnce, InitFn, Parameter, Context) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1783">}</span>
<span class="line" id="L1784"></span>
<span class="line" id="L1785"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">HeapFree</span>(hHeap: HANDLE, dwFlags: DWORD, lpMem: *<span class="tok-type">anyopaque</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1786">    assert(kernel32.HeapFree(hHeap, dwFlags, lpMem) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1787">}</span>
<span class="line" id="L1788"></span>
<span class="line" id="L1789"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">HeapDestroy</span>(hHeap: HANDLE) <span class="tok-type">void</span> {</span>
<span class="line" id="L1790">    assert(kernel32.HeapDestroy(hHeap) != <span class="tok-number">0</span>);</span>
<span class="line" id="L1791">}</span>
<span class="line" id="L1792"></span>
<span class="line" id="L1793"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">LocalFree</span>(hMem: HLOCAL) <span class="tok-type">void</span> {</span>
<span class="line" id="L1794">    assert(kernel32.LocalFree(hMem) == <span class="tok-null">null</span>);</span>
<span class="line" id="L1795">}</span>
<span class="line" id="L1796"></span>
<span class="line" id="L1797"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SetFileTimeError = <span class="tok-kw">error</span>{Unexpected};</span>
<span class="line" id="L1798"></span>
<span class="line" id="L1799"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">SetFileTime</span>(</span>
<span class="line" id="L1800">    hFile: HANDLE,</span>
<span class="line" id="L1801">    lpCreationTime: ?*<span class="tok-kw">const</span> FILETIME,</span>
<span class="line" id="L1802">    lpLastAccessTime: ?*<span class="tok-kw">const</span> FILETIME,</span>
<span class="line" id="L1803">    lpLastWriteTime: ?*<span class="tok-kw">const</span> FILETIME,</span>
<span class="line" id="L1804">) SetFileTimeError!<span class="tok-type">void</span> {</span>
<span class="line" id="L1805">    <span class="tok-kw">const</span> rc = kernel32.SetFileTime(hFile, lpCreationTime, lpLastAccessTime, lpLastWriteTime);</span>
<span class="line" id="L1806">    <span class="tok-kw">if</span> (rc == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1807">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L1808">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L1809">        }</span>
<span class="line" id="L1810">    }</span>
<span class="line" id="L1811">}</span>
<span class="line" id="L1812"></span>
<span class="line" id="L1813"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LockFileError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1814">    SystemResources,</span>
<span class="line" id="L1815">    WouldBlock,</span>
<span class="line" id="L1816">} || std.os.UnexpectedError;</span>
<span class="line" id="L1817"></span>
<span class="line" id="L1818"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">LockFile</span>(</span>
<span class="line" id="L1819">    FileHandle: HANDLE,</span>
<span class="line" id="L1820">    Event: ?HANDLE,</span>
<span class="line" id="L1821">    ApcRoutine: ?*IO_APC_ROUTINE,</span>
<span class="line" id="L1822">    ApcContext: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L1823">    IoStatusBlock: *IO_STATUS_BLOCK,</span>
<span class="line" id="L1824">    ByteOffset: *<span class="tok-kw">const</span> LARGE_INTEGER,</span>
<span class="line" id="L1825">    Length: *<span class="tok-kw">const</span> LARGE_INTEGER,</span>
<span class="line" id="L1826">    Key: ?*ULONG,</span>
<span class="line" id="L1827">    FailImmediately: BOOLEAN,</span>
<span class="line" id="L1828">    ExclusiveLock: BOOLEAN,</span>
<span class="line" id="L1829">) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1830">    <span class="tok-kw">const</span> rc = ntdll.NtLockFile(</span>
<span class="line" id="L1831">        FileHandle,</span>
<span class="line" id="L1832">        Event,</span>
<span class="line" id="L1833">        ApcRoutine,</span>
<span class="line" id="L1834">        ApcContext,</span>
<span class="line" id="L1835">        IoStatusBlock,</span>
<span class="line" id="L1836">        ByteOffset,</span>
<span class="line" id="L1837">        Length,</span>
<span class="line" id="L1838">        Key,</span>
<span class="line" id="L1839">        FailImmediately,</span>
<span class="line" id="L1840">        ExclusiveLock,</span>
<span class="line" id="L1841">    );</span>
<span class="line" id="L1842">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L1843">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1844">        .INSUFFICIENT_RESOURCES =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1845">        .LOCK_NOT_GRANTED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.WouldBlock,</span>
<span class="line" id="L1846">        .ACCESS_VIOLATION =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// bad io_status_block pointer</span>
</span>
<span class="line" id="L1847">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L1848">    }</span>
<span class="line" id="L1849">}</span>
<span class="line" id="L1850"></span>
<span class="line" id="L1851"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UnlockFileError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L1852">    RangeNotLocked,</span>
<span class="line" id="L1853">} || std.os.UnexpectedError;</span>
<span class="line" id="L1854"></span>
<span class="line" id="L1855"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">UnlockFile</span>(</span>
<span class="line" id="L1856">    FileHandle: HANDLE,</span>
<span class="line" id="L1857">    IoStatusBlock: *IO_STATUS_BLOCK,</span>
<span class="line" id="L1858">    ByteOffset: *<span class="tok-kw">const</span> LARGE_INTEGER,</span>
<span class="line" id="L1859">    Length: *<span class="tok-kw">const</span> LARGE_INTEGER,</span>
<span class="line" id="L1860">    Key: ?*ULONG,</span>
<span class="line" id="L1861">) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1862">    <span class="tok-kw">const</span> rc = ntdll.NtUnlockFile(FileHandle, IoStatusBlock, ByteOffset, Length, Key);</span>
<span class="line" id="L1863">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L1864">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1865">        .RANGE_NOT_LOCKED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.RangeNotLocked,</span>
<span class="line" id="L1866">        .ACCESS_VIOLATION =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// bad io_status_block pointer</span>
</span>
<span class="line" id="L1867">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L1868">    }</span>
<span class="line" id="L1869">}</span>
<span class="line" id="L1870"></span>
<span class="line" id="L1871"><span class="tok-comment">/// This is a workaround for the C backend until zig has the ability to put</span></span>
<span class="line" id="L1872"><span class="tok-comment">/// C code in inline assembly.</span></span>
<span class="line" id="L1873"><span class="tok-kw">extern</span> <span class="tok-kw">fn</span> <span class="tok-fn">zig_x86_windows_teb</span>() <span class="tok-kw">callconv</span>(.C) *<span class="tok-type">anyopaque</span>;</span>
<span class="line" id="L1874"><span class="tok-kw">extern</span> <span class="tok-kw">fn</span> <span class="tok-fn">zig_x86_64_windows_teb</span>() <span class="tok-kw">callconv</span>(.C) *<span class="tok-type">anyopaque</span>;</span>
<span class="line" id="L1875"></span>
<span class="line" id="L1876"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">teb</span>() *TEB {</span>
<span class="line" id="L1877">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (native_arch) {</span>
<span class="line" id="L1878">        .x86 =&gt; blk: {</span>
<span class="line" id="L1879">            <span class="tok-kw">if</span> (builtin.zig_backend == .stage2_c) {</span>
<span class="line" id="L1880">                <span class="tok-kw">break</span> :blk <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(zig_x86_windows_teb()));</span>
<span class="line" id="L1881">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1882">                <span class="tok-kw">break</span> :blk <span class="tok-kw">asm</span> <span class="tok-kw">volatile</span> (</span>
<span class="line" id="L1883">                    <span class="tok-str">\\ movl %%fs:0x18, %[ptr]</span></span>

<span class="line" id="L1884">                    : [ptr] <span class="tok-str">&quot;=r&quot;</span> (-&gt; *TEB),</span>
<span class="line" id="L1885">                );</span>
<span class="line" id="L1886">            }</span>
<span class="line" id="L1887">        },</span>
<span class="line" id="L1888">        .x86_64 =&gt; blk: {</span>
<span class="line" id="L1889">            <span class="tok-kw">if</span> (builtin.zig_backend == .stage2_c) {</span>
<span class="line" id="L1890">                <span class="tok-kw">break</span> :blk <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(zig_x86_64_windows_teb()));</span>
<span class="line" id="L1891">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1892">                <span class="tok-kw">break</span> :blk <span class="tok-kw">asm</span> <span class="tok-kw">volatile</span> (</span>
<span class="line" id="L1893">                    <span class="tok-str">\\ movq %%gs:0x30, %[ptr]</span></span>

<span class="line" id="L1894">                    : [ptr] <span class="tok-str">&quot;=r&quot;</span> (-&gt; *TEB),</span>
<span class="line" id="L1895">                );</span>
<span class="line" id="L1896">            }</span>
<span class="line" id="L1897">        },</span>
<span class="line" id="L1898">        .aarch64 =&gt; <span class="tok-kw">asm</span> <span class="tok-kw">volatile</span> (</span>
<span class="line" id="L1899">            <span class="tok-str">\\ mov %[ptr], x18</span></span>

<span class="line" id="L1900">            : [ptr] <span class="tok-str">&quot;=r&quot;</span> (-&gt; *TEB),</span>
<span class="line" id="L1901">        ),</span>
<span class="line" id="L1902">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unsupported arch&quot;</span>),</span>
<span class="line" id="L1903">    };</span>
<span class="line" id="L1904">}</span>
<span class="line" id="L1905"></span>
<span class="line" id="L1906"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">peb</span>() *PEB {</span>
<span class="line" id="L1907">    <span class="tok-kw">return</span> teb().ProcessEnvironmentBlock;</span>
<span class="line" id="L1908">}</span>
<span class="line" id="L1909"></span>
<span class="line" id="L1910"><span class="tok-comment">/// A file time is a 64-bit value that represents the number of 100-nanosecond</span></span>
<span class="line" id="L1911"><span class="tok-comment">/// intervals that have elapsed since 12:00 A.M. January 1, 1601 Coordinated</span></span>
<span class="line" id="L1912"><span class="tok-comment">/// Universal Time (UTC).</span></span>
<span class="line" id="L1913"><span class="tok-comment">/// This function returns the number of nanoseconds since the canonical epoch,</span></span>
<span class="line" id="L1914"><span class="tok-comment">/// which is the POSIX one (Jan 01, 1970 AD).</span></span>
<span class="line" id="L1915"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fromSysTime</span>(hns: <span class="tok-type">i64</span>) <span class="tok-type">i128</span> {</span>
<span class="line" id="L1916">    <span class="tok-kw">const</span> adjusted_epoch: <span class="tok-type">i128</span> = hns + std.time.epoch.windows * (std.time.ns_per_s / <span class="tok-number">100</span>);</span>
<span class="line" id="L1917">    <span class="tok-kw">return</span> adjusted_epoch * <span class="tok-number">100</span>;</span>
<span class="line" id="L1918">}</span>
<span class="line" id="L1919"></span>
<span class="line" id="L1920"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toSysTime</span>(ns: <span class="tok-type">i128</span>) <span class="tok-type">i64</span> {</span>
<span class="line" id="L1921">    <span class="tok-kw">const</span> hns = <span class="tok-builtin">@divFloor</span>(ns, <span class="tok-number">100</span>);</span>
<span class="line" id="L1922">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, <span class="tok-builtin">@intCast</span>(hns)) - std.time.epoch.windows * (std.time.ns_per_s / <span class="tok-number">100</span>);</span>
<span class="line" id="L1923">}</span>
<span class="line" id="L1924"></span>
<span class="line" id="L1925"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fileTimeToNanoSeconds</span>(ft: FILETIME) <span class="tok-type">i128</span> {</span>
<span class="line" id="L1926">    <span class="tok-kw">const</span> hns = (<span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, ft.dwHighDateTime) &lt;&lt; <span class="tok-number">32</span>) | ft.dwLowDateTime;</span>
<span class="line" id="L1927">    <span class="tok-kw">return</span> fromSysTime(hns);</span>
<span class="line" id="L1928">}</span>
<span class="line" id="L1929"></span>
<span class="line" id="L1930"><span class="tok-comment">/// Converts a number of nanoseconds since the POSIX epoch to a Windows FILETIME.</span></span>
<span class="line" id="L1931"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">nanoSecondsToFileTime</span>(ns: <span class="tok-type">i128</span>) FILETIME {</span>
<span class="line" id="L1932">    <span class="tok-kw">const</span> adjusted: <span class="tok-type">u64</span> = <span class="tok-builtin">@bitCast</span>(toSysTime(ns));</span>
<span class="line" id="L1933">    <span class="tok-kw">return</span> FILETIME{</span>
<span class="line" id="L1934">        .dwHighDateTime = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(adjusted &gt;&gt; <span class="tok-number">32</span>)),</span>
<span class="line" id="L1935">        .dwLowDateTime = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(adjusted)),</span>
<span class="line" id="L1936">    };</span>
<span class="line" id="L1937">}</span>
<span class="line" id="L1938"></span>
<span class="line" id="L1939"><span class="tok-comment">/// Compares two WTF16 strings using the equivalent functionality of</span></span>
<span class="line" id="L1940"><span class="tok-comment">/// `RtlEqualUnicodeString` (with case insensitive comparison enabled).</span></span>
<span class="line" id="L1941"><span class="tok-comment">/// This function can be called on any target.</span></span>
<span class="line" id="L1942"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eqlIgnoreCaseWTF16</span>(a: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>, b: []<span class="tok-kw">const</span> <span class="tok-type">u16</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L1943">    <span class="tok-kw">if</span> (<span class="tok-builtin">@inComptime</span>() <span class="tok-kw">or</span> builtin.os.tag != .windows) {</span>
<span class="line" id="L1944">        <span class="tok-comment">// This function compares the strings code unit by code unit (aka u16-to-u16),</span>
</span>
<span class="line" id="L1945">        <span class="tok-comment">// so any length difference implies inequality. In other words, there's no possible</span>
</span>
<span class="line" id="L1946">        <span class="tok-comment">// conversion that changes the number of UTF-16 code units needed for the uppercase/lowercase</span>
</span>
<span class="line" id="L1947">        <span class="tok-comment">// version in the conversion table since only codepoints &lt;= max(u16) are eligible</span>
</span>
<span class="line" id="L1948">        <span class="tok-comment">// for conversion at all.</span>
</span>
<span class="line" id="L1949">        <span class="tok-kw">if</span> (a.len != b.len) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L1950"></span>
<span class="line" id="L1951">        <span class="tok-kw">for</span> (a, b) |a_c, b_c| {</span>
<span class="line" id="L1952">            <span class="tok-comment">// The slices are always UTF-16 LE, so need to convert the elements to native</span>
</span>
<span class="line" id="L1953">            <span class="tok-comment">// endianness for the uppercasing</span>
</span>
<span class="line" id="L1954">            <span class="tok-kw">const</span> a_c_native = std.mem.littleToNative(<span class="tok-type">u16</span>, a_c);</span>
<span class="line" id="L1955">            <span class="tok-kw">const</span> b_c_native = std.mem.littleToNative(<span class="tok-type">u16</span>, b_c);</span>
<span class="line" id="L1956">            <span class="tok-kw">if</span> (a_c != b_c <span class="tok-kw">and</span> nls.upcaseW(a_c_native) != nls.upcaseW(b_c_native)) {</span>
<span class="line" id="L1957">                <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L1958">            }</span>
<span class="line" id="L1959">        }</span>
<span class="line" id="L1960">        <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L1961">    }</span>
<span class="line" id="L1962">    <span class="tok-comment">// Use RtlEqualUnicodeString on Windows when not in comptime to avoid including a</span>
</span>
<span class="line" id="L1963">    <span class="tok-comment">// redundant copy of the uppercase data.</span>
</span>
<span class="line" id="L1964">    <span class="tok-kw">const</span> a_bytes = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(a.len * <span class="tok-number">2</span>));</span>
<span class="line" id="L1965">    <span class="tok-kw">const</span> a_string = UNICODE_STRING{</span>
<span class="line" id="L1966">        .Length = a_bytes,</span>
<span class="line" id="L1967">        .MaximumLength = a_bytes,</span>
<span class="line" id="L1968">        .Buffer = <span class="tok-builtin">@constCast</span>(a.ptr),</span>
<span class="line" id="L1969">    };</span>
<span class="line" id="L1970">    <span class="tok-kw">const</span> b_bytes = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(b.len * <span class="tok-number">2</span>));</span>
<span class="line" id="L1971">    <span class="tok-kw">const</span> b_string = UNICODE_STRING{</span>
<span class="line" id="L1972">        .Length = b_bytes,</span>
<span class="line" id="L1973">        .MaximumLength = b_bytes,</span>
<span class="line" id="L1974">        .Buffer = <span class="tok-builtin">@constCast</span>(b.ptr),</span>
<span class="line" id="L1975">    };</span>
<span class="line" id="L1976">    <span class="tok-kw">return</span> ntdll.RtlEqualUnicodeString(&amp;a_string, &amp;b_string, TRUE) == TRUE;</span>
<span class="line" id="L1977">}</span>
<span class="line" id="L1978"></span>
<span class="line" id="L1979"><span class="tok-comment">/// Compares two UTF-8 strings using the equivalent functionality of</span></span>
<span class="line" id="L1980"><span class="tok-comment">/// `RtlEqualUnicodeString` (with case insensitive comparison enabled).</span></span>
<span class="line" id="L1981"><span class="tok-comment">/// This function can be called on any target.</span></span>
<span class="line" id="L1982"><span class="tok-comment">/// Assumes `a` and `b` are valid UTF-8.</span></span>
<span class="line" id="L1983"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eqlIgnoreCaseUtf8</span>(a: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, b: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L1984">    <span class="tok-comment">// A length equality check is not possible here because there are</span>
</span>
<span class="line" id="L1985">    <span class="tok-comment">// some codepoints that have a different length uppercase UTF-8 representations</span>
</span>
<span class="line" id="L1986">    <span class="tok-comment">// than their lowercase counterparts, e.g. U+0250 (2 bytes) &lt;-&gt; U+2C6F (3 bytes).</span>
</span>
<span class="line" id="L1987">    <span class="tok-comment">// There are 7 such codepoints in the uppercase data used by Windows.</span>
</span>
<span class="line" id="L1988"></span>
<span class="line" id="L1989">    <span class="tok-kw">var</span> a_utf8_it = std.unicode.Utf8View.initUnchecked(a).iterator();</span>
<span class="line" id="L1990">    <span class="tok-kw">var</span> b_utf8_it = std.unicode.Utf8View.initUnchecked(b).iterator();</span>
<span class="line" id="L1991"></span>
<span class="line" id="L1992">    <span class="tok-comment">// Use RtlUpcaseUnicodeChar on Windows when not in comptime to avoid including a</span>
</span>
<span class="line" id="L1993">    <span class="tok-comment">// redundant copy of the uppercase data.</span>
</span>
<span class="line" id="L1994">    <span class="tok-kw">const</span> upcaseImpl = <span class="tok-kw">switch</span> (builtin.os.tag) {</span>
<span class="line" id="L1995">        .windows =&gt; <span class="tok-kw">if</span> (<span class="tok-builtin">@inComptime</span>()) nls.upcaseW <span class="tok-kw">else</span> ntdll.RtlUpcaseUnicodeChar,</span>
<span class="line" id="L1996">        <span class="tok-kw">else</span> =&gt; nls.upcaseW,</span>
<span class="line" id="L1997">    };</span>
<span class="line" id="L1998"></span>
<span class="line" id="L1999">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L2000">        <span class="tok-kw">var</span> a_cp = a_utf8_it.nextCodepoint() <span class="tok-kw">orelse</span> <span class="tok-kw">break</span>;</span>
<span class="line" id="L2001">        <span class="tok-kw">var</span> b_cp = b_utf8_it.nextCodepoint() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2002"></span>
<span class="line" id="L2003">        <span class="tok-kw">if</span> (a_cp &lt;= std.math.maxInt(<span class="tok-type">u16</span>) <span class="tok-kw">and</span> b_cp &lt;= std.math.maxInt(<span class="tok-type">u16</span>)) {</span>
<span class="line" id="L2004">            <span class="tok-kw">if</span> (a_cp != b_cp <span class="tok-kw">and</span> upcaseImpl(<span class="tok-builtin">@intCast</span>(a_cp)) != upcaseImpl(<span class="tok-builtin">@intCast</span>(b_cp))) {</span>
<span class="line" id="L2005">                <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2006">            }</span>
<span class="line" id="L2007">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (a_cp != b_cp) {</span>
<span class="line" id="L2008">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2009">        }</span>
<span class="line" id="L2010">    }</span>
<span class="line" id="L2011">    <span class="tok-comment">// Make sure there are no leftover codepoints in b</span>
</span>
<span class="line" id="L2012">    <span class="tok-kw">if</span> (b_utf8_it.nextCodepoint() != <span class="tok-null">null</span>) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2013"></span>
<span class="line" id="L2014">    <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L2015">}</span>
<span class="line" id="L2016"></span>
<span class="line" id="L2017"><span class="tok-kw">fn</span> <span class="tok-fn">testEqlIgnoreCase</span>(<span class="tok-kw">comptime</span> expect_eql: <span class="tok-type">bool</span>, <span class="tok-kw">comptime</span> a: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-kw">comptime</span> b: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L2018">    <span class="tok-kw">try</span> std.testing.expectEqual(expect_eql, eqlIgnoreCaseUtf8(a, b));</span>
<span class="line" id="L2019">    <span class="tok-kw">try</span> std.testing.expectEqual(expect_eql, eqlIgnoreCaseWTF16(</span>
<span class="line" id="L2020">        std.unicode.utf8ToUtf16LeStringLiteral(a),</span>
<span class="line" id="L2021">        std.unicode.utf8ToUtf16LeStringLiteral(b),</span>
<span class="line" id="L2022">    ));</span>
<span class="line" id="L2023"></span>
<span class="line" id="L2024">    <span class="tok-kw">try</span> <span class="tok-kw">comptime</span> std.testing.expect(expect_eql == eqlIgnoreCaseUtf8(a, b));</span>
<span class="line" id="L2025">    <span class="tok-kw">try</span> <span class="tok-kw">comptime</span> std.testing.expect(expect_eql == eqlIgnoreCaseWTF16(</span>
<span class="line" id="L2026">        std.unicode.utf8ToUtf16LeStringLiteral(a),</span>
<span class="line" id="L2027">        std.unicode.utf8ToUtf16LeStringLiteral(b),</span>
<span class="line" id="L2028">    ));</span>
<span class="line" id="L2029">}</span>
<span class="line" id="L2030"></span>
<span class="line" id="L2031"><span class="tok-kw">test</span> <span class="tok-str">&quot;eqlIgnoreCaseWTF16/Utf8&quot;</span> {</span>
<span class="line" id="L2032">    <span class="tok-kw">try</span> testEqlIgnoreCase(<span class="tok-null">true</span>, <span class="tok-str">&quot;\x01 a B  &quot;</span>, <span class="tok-str">&quot;\x01 A b  &quot;</span>);</span>
<span class="line" id="L2033">    <span class="tok-comment">// does not do case-insensitive comparison for codepoints &gt;= U+10000</span>
</span>
<span class="line" id="L2034">    <span class="tok-kw">try</span> testEqlIgnoreCase(<span class="tok-null">false</span>, <span class="tok-str">&quot;&quot;</span>, <span class="tok-str">&quot;&quot;</span>);</span>
<span class="line" id="L2035">}</span>
<span class="line" id="L2036"></span>
<span class="line" id="L2037"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PathSpace = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2038">    data: [PATH_MAX_WIDE:<span class="tok-number">0</span>]<span class="tok-type">u16</span>,</span>
<span class="line" id="L2039">    len: <span class="tok-type">usize</span>,</span>
<span class="line" id="L2040"></span>
<span class="line" id="L2041">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">span</span>(self: *<span class="tok-kw">const</span> PathSpace) [:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span> {</span>
<span class="line" id="L2042">        <span class="tok-kw">return</span> self.data[<span class="tok-number">0</span>..self.len :<span class="tok-number">0</span>];</span>
<span class="line" id="L2043">    }</span>
<span class="line" id="L2044">};</span>
<span class="line" id="L2045"></span>
<span class="line" id="L2046"><span class="tok-comment">/// The error type for `removeDotDirsSanitized`</span></span>
<span class="line" id="L2047"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RemoveDotDirsError = <span class="tok-kw">error</span>{TooManyParentDirs};</span>
<span class="line" id="L2048"></span>
<span class="line" id="L2049"><span class="tok-comment">/// Removes '.' and '..' path components from a &quot;sanitized relative path&quot;.</span></span>
<span class="line" id="L2050"><span class="tok-comment">/// A &quot;sanitized path&quot; is one where:</span></span>
<span class="line" id="L2051"><span class="tok-comment">///    1) all forward slashes have been replaced with back slashes</span></span>
<span class="line" id="L2052"><span class="tok-comment">///    2) all repeating back slashes have been collapsed</span></span>
<span class="line" id="L2053"><span class="tok-comment">///    3) the path is a relative one (does not start with a back slash)</span></span>
<span class="line" id="L2054"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">removeDotDirsSanitized</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, path: []T) RemoveDotDirsError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L2055">    std.debug.assert(path.len == <span class="tok-number">0</span> <span class="tok-kw">or</span> path[<span class="tok-number">0</span>] != <span class="tok-str">'\\'</span>);</span>
<span class="line" id="L2056"></span>
<span class="line" id="L2057">    <span class="tok-kw">var</span> write_idx: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2058">    <span class="tok-kw">var</span> read_idx: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2059">    <span class="tok-kw">while</span> (read_idx &lt; path.len) {</span>
<span class="line" id="L2060">        <span class="tok-kw">if</span> (path[read_idx] == <span class="tok-str">'.'</span>) {</span>
<span class="line" id="L2061">            <span class="tok-kw">if</span> (read_idx + <span class="tok-number">1</span> == path.len)</span>
<span class="line" id="L2062">                <span class="tok-kw">return</span> write_idx;</span>
<span class="line" id="L2063"></span>
<span class="line" id="L2064">            <span class="tok-kw">const</span> after_dot = path[read_idx + <span class="tok-number">1</span>];</span>
<span class="line" id="L2065">            <span class="tok-kw">if</span> (after_dot == <span class="tok-str">'\\'</span>) {</span>
<span class="line" id="L2066">                read_idx += <span class="tok-number">2</span>;</span>
<span class="line" id="L2067">                <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2068">            }</span>
<span class="line" id="L2069">            <span class="tok-kw">if</span> (after_dot == <span class="tok-str">'.'</span> <span class="tok-kw">and</span> (read_idx + <span class="tok-number">2</span> == path.len <span class="tok-kw">or</span> path[read_idx + <span class="tok-number">2</span>] == <span class="tok-str">'\\'</span>)) {</span>
<span class="line" id="L2070">                <span class="tok-kw">if</span> (write_idx == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TooManyParentDirs;</span>
<span class="line" id="L2071">                std.debug.assert(write_idx &gt;= <span class="tok-number">2</span>);</span>
<span class="line" id="L2072">                write_idx -= <span class="tok-number">1</span>;</span>
<span class="line" id="L2073">                <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L2074">                    write_idx -= <span class="tok-number">1</span>;</span>
<span class="line" id="L2075">                    <span class="tok-kw">if</span> (write_idx == <span class="tok-number">0</span>) <span class="tok-kw">break</span>;</span>
<span class="line" id="L2076">                    <span class="tok-kw">if</span> (path[write_idx] == <span class="tok-str">'\\'</span>) {</span>
<span class="line" id="L2077">                        write_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L2078">                        <span class="tok-kw">break</span>;</span>
<span class="line" id="L2079">                    }</span>
<span class="line" id="L2080">                }</span>
<span class="line" id="L2081">                <span class="tok-kw">if</span> (read_idx + <span class="tok-number">2</span> == path.len)</span>
<span class="line" id="L2082">                    <span class="tok-kw">return</span> write_idx;</span>
<span class="line" id="L2083">                read_idx += <span class="tok-number">3</span>;</span>
<span class="line" id="L2084">                <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2085">            }</span>
<span class="line" id="L2086">        }</span>
<span class="line" id="L2087"></span>
<span class="line" id="L2088">        <span class="tok-comment">// skip to the next path separator</span>
</span>
<span class="line" id="L2089">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) : (read_idx += <span class="tok-number">1</span>) {</span>
<span class="line" id="L2090">            <span class="tok-kw">if</span> (read_idx == path.len)</span>
<span class="line" id="L2091">                <span class="tok-kw">return</span> write_idx;</span>
<span class="line" id="L2092">            path[write_idx] = path[read_idx];</span>
<span class="line" id="L2093">            write_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L2094">            <span class="tok-kw">if</span> (path[read_idx] == <span class="tok-str">'\\'</span>)</span>
<span class="line" id="L2095">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L2096">        }</span>
<span class="line" id="L2097">        read_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L2098">    }</span>
<span class="line" id="L2099">    <span class="tok-kw">return</span> write_idx;</span>
<span class="line" id="L2100">}</span>
<span class="line" id="L2101"></span>
<span class="line" id="L2102"><span class="tok-comment">/// Normalizes a Windows path with the following steps:</span></span>
<span class="line" id="L2103"><span class="tok-comment">///     1) convert all forward slashes to back slashes</span></span>
<span class="line" id="L2104"><span class="tok-comment">///     2) collapse duplicate back slashes</span></span>
<span class="line" id="L2105"><span class="tok-comment">///     3) remove '.' and '..' directory parts</span></span>
<span class="line" id="L2106"><span class="tok-comment">/// Returns the length of the new path.</span></span>
<span class="line" id="L2107"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">normalizePath</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, path: []T) RemoveDotDirsError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L2108">    mem.replaceScalar(T, path, <span class="tok-str">'/'</span>, <span class="tok-str">'\\'</span>);</span>
<span class="line" id="L2109">    <span class="tok-kw">const</span> new_len = mem.collapseRepeatsLen(T, path, <span class="tok-str">'\\'</span>);</span>
<span class="line" id="L2110"></span>
<span class="line" id="L2111">    <span class="tok-kw">const</span> prefix_len: <span class="tok-type">usize</span> = init: {</span>
<span class="line" id="L2112">        <span class="tok-kw">if</span> (new_len &gt;= <span class="tok-number">1</span> <span class="tok-kw">and</span> path[<span class="tok-number">0</span>] == <span class="tok-str">'\\'</span>) <span class="tok-kw">break</span> :init <span class="tok-number">1</span>;</span>
<span class="line" id="L2113">        <span class="tok-kw">if</span> (new_len &gt;= <span class="tok-number">2</span> <span class="tok-kw">and</span> path[<span class="tok-number">1</span>] == <span class="tok-str">':'</span>)</span>
<span class="line" id="L2114">            <span class="tok-kw">break</span> :init <span class="tok-kw">if</span> (new_len &gt;= <span class="tok-number">3</span> <span class="tok-kw">and</span> path[<span class="tok-number">2</span>] == <span class="tok-str">'\\'</span>) <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">3</span>) <span class="tok-kw">else</span> <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span>);</span>
<span class="line" id="L2115">        <span class="tok-kw">break</span> :init <span class="tok-number">0</span>;</span>
<span class="line" id="L2116">    };</span>
<span class="line" id="L2117"></span>
<span class="line" id="L2118">    <span class="tok-kw">return</span> prefix_len + <span class="tok-kw">try</span> removeDotDirsSanitized(T, path[prefix_len..new_len]);</span>
<span class="line" id="L2119">}</span>
<span class="line" id="L2120"></span>
<span class="line" id="L2121"><span class="tok-comment">/// Same as `sliceToPrefixedFileW` but accepts a pointer</span></span>
<span class="line" id="L2122"><span class="tok-comment">/// to a null-terminated path.</span></span>
<span class="line" id="L2123"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">cStrToPrefixedFileW</span>(s: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !PathSpace {</span>
<span class="line" id="L2124">    <span class="tok-kw">return</span> sliceToPrefixedFileW(mem.sliceTo(s, <span class="tok-number">0</span>));</span>
<span class="line" id="L2125">}</span>
<span class="line" id="L2126"></span>
<span class="line" id="L2127"><span class="tok-comment">/// Same as `wToPrefixedFileW` but accepts a UTF-8 encoded path.</span></span>
<span class="line" id="L2128"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sliceToPrefixedFileW</span>(path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !PathSpace {</span>
<span class="line" id="L2129">    <span class="tok-kw">var</span> temp_path: PathSpace = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2130">    temp_path.len = <span class="tok-kw">try</span> std.unicode.utf8ToUtf16Le(&amp;temp_path.data, path);</span>
<span class="line" id="L2131">    temp_path.data[temp_path.len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L2132">    <span class="tok-kw">return</span> wToPrefixedFileW(temp_path.span());</span>
<span class="line" id="L2133">}</span>
<span class="line" id="L2134"></span>
<span class="line" id="L2135"><span class="tok-comment">/// Converts the `path` to WTF16, null-terminated. If the path contains any</span></span>
<span class="line" id="L2136"><span class="tok-comment">/// namespace prefix, or is anything but a relative path (rooted, drive relative,</span></span>
<span class="line" id="L2137"><span class="tok-comment">/// etc) the result will have the NT-style prefix `\??\`.</span></span>
<span class="line" id="L2138"><span class="tok-comment">///</span></span>
<span class="line" id="L2139"><span class="tok-comment">/// Similar to RtlDosPathNameToNtPathName_U with a few differences:</span></span>
<span class="line" id="L2140"><span class="tok-comment">/// - Does not allocate on the heap.</span></span>
<span class="line" id="L2141"><span class="tok-comment">/// - Relative paths are kept as relative unless they contain too many ..</span></span>
<span class="line" id="L2142"><span class="tok-comment">///   components, in which case they are treated as drive-relative and resolved</span></span>
<span class="line" id="L2143"><span class="tok-comment">///   against the CWD.</span></span>
<span class="line" id="L2144"><span class="tok-comment">/// - Special case device names like COM1, NUL, etc are not handled specially (TODO)</span></span>
<span class="line" id="L2145"><span class="tok-comment">/// - . and space are not stripped from the end of relative paths (potential TODO)</span></span>
<span class="line" id="L2146"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">wToPrefixedFileW</span>(path: [:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>) !PathSpace {</span>
<span class="line" id="L2147">    <span class="tok-kw">const</span> nt_prefix = [_]<span class="tok-type">u16</span>{ <span class="tok-str">'\\'</span>, <span class="tok-str">'?'</span>, <span class="tok-str">'?'</span>, <span class="tok-str">'\\'</span> };</span>
<span class="line" id="L2148">    <span class="tok-kw">switch</span> (getNamespacePrefix(<span class="tok-type">u16</span>, path)) {</span>
<span class="line" id="L2149">        <span class="tok-comment">// TODO: Figure out a way to design an API that can avoid the copy for .nt,</span>
</span>
<span class="line" id="L2150">        <span class="tok-comment">//       since it is always returned fully unmodified.</span>
</span>
<span class="line" id="L2151">        .nt, .verbatim =&gt; {</span>
<span class="line" id="L2152">            <span class="tok-kw">var</span> path_space: PathSpace = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2153">            path_space.data[<span class="tok-number">0</span>..nt_prefix.len].* = nt_prefix;</span>
<span class="line" id="L2154">            <span class="tok-kw">const</span> len_after_prefix = path.len - nt_prefix.len;</span>
<span class="line" id="L2155">            <span class="tok-builtin">@memcpy</span>(path_space.data[nt_prefix.len..][<span class="tok-number">0</span>..len_after_prefix], path[nt_prefix.len..]);</span>
<span class="line" id="L2156">            path_space.len = path.len;</span>
<span class="line" id="L2157">            path_space.data[path_space.len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L2158">            <span class="tok-kw">return</span> path_space;</span>
<span class="line" id="L2159">        },</span>
<span class="line" id="L2160">        .local_device, .fake_verbatim =&gt; {</span>
<span class="line" id="L2161">            <span class="tok-kw">var</span> path_space: PathSpace = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2162">            <span class="tok-kw">const</span> path_byte_len = ntdll.RtlGetFullPathName_U(</span>
<span class="line" id="L2163">                path.ptr,</span>
<span class="line" id="L2164">                path_space.data.len * <span class="tok-number">2</span>,</span>
<span class="line" id="L2165">                &amp;path_space.data,</span>
<span class="line" id="L2166">                <span class="tok-null">null</span>,</span>
<span class="line" id="L2167">            );</span>
<span class="line" id="L2168">            <span class="tok-kw">if</span> (path_byte_len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L2169">                <span class="tok-comment">// TODO: This may not be the right error</span>
</span>
<span class="line" id="L2170">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadPathName;</span>
<span class="line" id="L2171">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (path_byte_len / <span class="tok-number">2</span> &gt; path_space.data.len) {</span>
<span class="line" id="L2172">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L2173">            }</span>
<span class="line" id="L2174">            path_space.len = path_byte_len / <span class="tok-number">2</span>;</span>
<span class="line" id="L2175">            <span class="tok-comment">// Both prefixes will be normalized but retained, so all</span>
</span>
<span class="line" id="L2176">            <span class="tok-comment">// we need to do now is replace them with the NT prefix</span>
</span>
<span class="line" id="L2177">            path_space.data[<span class="tok-number">0</span>..nt_prefix.len].* = nt_prefix;</span>
<span class="line" id="L2178">            <span class="tok-kw">return</span> path_space;</span>
<span class="line" id="L2179">        },</span>
<span class="line" id="L2180">        .none =&gt; {</span>
<span class="line" id="L2181">            <span class="tok-kw">const</span> path_type = getUnprefixedPathType(<span class="tok-type">u16</span>, path);</span>
<span class="line" id="L2182">            <span class="tok-kw">var</span> path_space: PathSpace = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2183">            relative: {</span>
<span class="line" id="L2184">                <span class="tok-kw">if</span> (path_type == .relative) {</span>
<span class="line" id="L2185">                    <span class="tok-comment">// TODO: Handle special case device names like COM1, AUX, NUL, CONIN$, CONOUT$, etc.</span>
</span>
<span class="line" id="L2186">                    <span class="tok-comment">//       See https://googleprojectzero.blogspot.com/2016/02/the-definitive-guide-on-win32-to-nt.html</span>
</span>
<span class="line" id="L2187"></span>
<span class="line" id="L2188">                    <span class="tok-comment">// TODO: Potentially strip all trailing . and space characters from the</span>
</span>
<span class="line" id="L2189">                    <span class="tok-comment">//       end of the path. This is something that both RtlDosPathNameToNtPathName_U</span>
</span>
<span class="line" id="L2190">                    <span class="tok-comment">//       and RtlGetFullPathName_U do. Technically, trailing . and spaces</span>
</span>
<span class="line" id="L2191">                    <span class="tok-comment">//       are allowed, but such paths may not interact well with Windows (i.e.</span>
</span>
<span class="line" id="L2192">                    <span class="tok-comment">//       files with these paths can't be deleted from explorer.exe, etc).</span>
</span>
<span class="line" id="L2193">                    <span class="tok-comment">//       This could be something that normalizePath may want to do.</span>
</span>
<span class="line" id="L2194"></span>
<span class="line" id="L2195">                    <span class="tok-builtin">@memcpy</span>(path_space.data[<span class="tok-number">0</span>..path.len], path);</span>
<span class="line" id="L2196">                    <span class="tok-comment">// Try to normalize, but if we get too many parent directories,</span>
</span>
<span class="line" id="L2197">                    <span class="tok-comment">// then this is effectively a 'drive relative' path, so we need to</span>
</span>
<span class="line" id="L2198">                    <span class="tok-comment">// start over and use RtlGetFullPathName_U instead.</span>
</span>
<span class="line" id="L2199">                    path_space.len = normalizePath(<span class="tok-type">u16</span>, path_space.data[<span class="tok-number">0</span>..path.len]) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2200">                        <span class="tok-kw">error</span>.TooManyParentDirs =&gt; <span class="tok-kw">break</span> :relative,</span>
<span class="line" id="L2201">                    };</span>
<span class="line" id="L2202">                    path_space.data[path_space.len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L2203">                    <span class="tok-kw">return</span> path_space;</span>
<span class="line" id="L2204">                }</span>
<span class="line" id="L2205">            }</span>
<span class="line" id="L2206">            <span class="tok-comment">// We now know we are going to return an absolute NT path, so</span>
</span>
<span class="line" id="L2207">            <span class="tok-comment">// we can unconditionally prefix it with the NT prefix.</span>
</span>
<span class="line" id="L2208">            path_space.data[<span class="tok-number">0</span>..nt_prefix.len].* = nt_prefix;</span>
<span class="line" id="L2209">            <span class="tok-kw">if</span> (path_type == .root_local_device) {</span>
<span class="line" id="L2210">                <span class="tok-comment">// `\\.` and `\\?` always get converted to `\??\` exactly, so</span>
</span>
<span class="line" id="L2211">                <span class="tok-comment">// we can just stop here</span>
</span>
<span class="line" id="L2212">                path_space.len = nt_prefix.len;</span>
<span class="line" id="L2213">                path_space.data[path_space.len] = <span class="tok-number">0</span>;</span>
<span class="line" id="L2214">                <span class="tok-kw">return</span> path_space;</span>
<span class="line" id="L2215">            }</span>
<span class="line" id="L2216">            <span class="tok-kw">const</span> path_buf_offset = <span class="tok-kw">switch</span> (path_type) {</span>
<span class="line" id="L2217">                <span class="tok-comment">// UNC paths will always start with `\\`. However, we want to</span>
</span>
<span class="line" id="L2218">                <span class="tok-comment">// end up with something like `\??\UNC\server\share`, so to get</span>
</span>
<span class="line" id="L2219">                <span class="tok-comment">// RtlGetFullPathName to write into the spot we want the `server`</span>
</span>
<span class="line" id="L2220">                <span class="tok-comment">// part to end up, we need to provide an offset such that</span>
</span>
<span class="line" id="L2221">                <span class="tok-comment">// the `\\` part gets written where the `C\` of `UNC\` will be</span>
</span>
<span class="line" id="L2222">                <span class="tok-comment">// in the final NT path.</span>
</span>
<span class="line" id="L2223">                .unc_absolute =&gt; nt_prefix.len + <span class="tok-number">2</span>,</span>
<span class="line" id="L2224">                <span class="tok-kw">else</span> =&gt; nt_prefix.len,</span>
<span class="line" id="L2225">            };</span>
<span class="line" id="L2226">            <span class="tok-kw">const</span> buf_len = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(path_space.data.len - path_buf_offset));</span>
<span class="line" id="L2227">            <span class="tok-kw">const</span> path_byte_len = ntdll.RtlGetFullPathName_U(</span>
<span class="line" id="L2228">                path.ptr,</span>
<span class="line" id="L2229">                buf_len * <span class="tok-number">2</span>,</span>
<span class="line" id="L2230">                path_space.data[path_buf_offset..].ptr,</span>
<span class="line" id="L2231">                <span class="tok-null">null</span>,</span>
<span class="line" id="L2232">            );</span>
<span class="line" id="L2233">            <span class="tok-kw">if</span> (path_byte_len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L2234">                <span class="tok-comment">// TODO: This may not be the right error</span>
</span>
<span class="line" id="L2235">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadPathName;</span>
<span class="line" id="L2236">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (path_byte_len / <span class="tok-number">2</span> &gt; buf_len) {</span>
<span class="line" id="L2237">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NameTooLong;</span>
<span class="line" id="L2238">            }</span>
<span class="line" id="L2239">            path_space.len = path_buf_offset + (path_byte_len / <span class="tok-number">2</span>);</span>
<span class="line" id="L2240">            <span class="tok-kw">if</span> (path_type == .unc_absolute) {</span>
<span class="line" id="L2241">                <span class="tok-comment">// Now add in the UNC, the `C` should overwrite the first `\` of the</span>
</span>
<span class="line" id="L2242">                <span class="tok-comment">// FullPathName, ultimately resulting in `\??\UNC\&lt;the rest of the path&gt;`</span>
</span>
<span class="line" id="L2243">                std.debug.assert(path_space.data[path_buf_offset] == <span class="tok-str">'\\'</span>);</span>
<span class="line" id="L2244">                std.debug.assert(path_space.data[path_buf_offset + <span class="tok-number">1</span>] == <span class="tok-str">'\\'</span>);</span>
<span class="line" id="L2245">                <span class="tok-kw">const</span> unc = [_]<span class="tok-type">u16</span>{ <span class="tok-str">'U'</span>, <span class="tok-str">'N'</span>, <span class="tok-str">'C'</span> };</span>
<span class="line" id="L2246">                path_space.data[nt_prefix.len..][<span class="tok-number">0</span>..unc.len].* = unc;</span>
<span class="line" id="L2247">            }</span>
<span class="line" id="L2248">            <span class="tok-kw">return</span> path_space;</span>
<span class="line" id="L2249">        },</span>
<span class="line" id="L2250">    }</span>
<span class="line" id="L2251">}</span>
<span class="line" id="L2252"></span>
<span class="line" id="L2253"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NamespacePrefix = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L2254">    none,</span>
<span class="line" id="L2255">    <span class="tok-comment">/// `\\.\` (path separators can be `\` or `/`)</span></span>
<span class="line" id="L2256">    local_device,</span>
<span class="line" id="L2257">    <span class="tok-comment">/// `\\?\`</span></span>
<span class="line" id="L2258">    <span class="tok-comment">/// When converted to an NT path, everything past the prefix is left</span></span>
<span class="line" id="L2259">    <span class="tok-comment">/// untouched and `\\?\` is replaced by `\??\`.</span></span>
<span class="line" id="L2260">    verbatim,</span>
<span class="line" id="L2261">    <span class="tok-comment">/// `\\?\` without all path separators being `\`.</span></span>
<span class="line" id="L2262">    <span class="tok-comment">/// This seems to be recognized as a prefix, but the 'verbatim' aspect</span></span>
<span class="line" id="L2263">    <span class="tok-comment">/// is not respected (i.e. if `//?/C:/foo` is converted to an NT path,</span></span>
<span class="line" id="L2264">    <span class="tok-comment">/// it will become `\??\C:\foo` [it will be canonicalized and the //?/ won't</span></span>
<span class="line" id="L2265">    <span class="tok-comment">/// be treated as part of the final path])</span></span>
<span class="line" id="L2266">    fake_verbatim,</span>
<span class="line" id="L2267">    <span class="tok-comment">/// `\??\`</span></span>
<span class="line" id="L2268">    nt,</span>
<span class="line" id="L2269">};</span>
<span class="line" id="L2270"></span>
<span class="line" id="L2271"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getNamespacePrefix</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, path: []<span class="tok-kw">const</span> T) NamespacePrefix {</span>
<span class="line" id="L2272">    <span class="tok-kw">if</span> (path.len &lt; <span class="tok-number">4</span>) <span class="tok-kw">return</span> .none;</span>
<span class="line" id="L2273">    <span class="tok-kw">var</span> all_backslash = <span class="tok-kw">switch</span> (path[<span class="tok-number">0</span>]) {</span>
<span class="line" id="L2274">        <span class="tok-str">'\\'</span> =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L2275">        <span class="tok-str">'/'</span> =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L2276">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> .none,</span>
<span class="line" id="L2277">    };</span>
<span class="line" id="L2278">    all_backslash = all_backslash <span class="tok-kw">and</span> <span class="tok-kw">switch</span> (path[<span class="tok-number">3</span>]) {</span>
<span class="line" id="L2279">        <span class="tok-str">'\\'</span> =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L2280">        <span class="tok-str">'/'</span> =&gt; <span class="tok-null">false</span>,</span>
<span class="line" id="L2281">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> .none,</span>
<span class="line" id="L2282">    };</span>
<span class="line" id="L2283">    <span class="tok-kw">switch</span> (path[<span class="tok-number">1</span>]) {</span>
<span class="line" id="L2284">        <span class="tok-str">'?'</span> =&gt; <span class="tok-kw">if</span> (path[<span class="tok-number">2</span>] == <span class="tok-str">'?'</span> <span class="tok-kw">and</span> all_backslash) <span class="tok-kw">return</span> .nt <span class="tok-kw">else</span> <span class="tok-kw">return</span> .none,</span>
<span class="line" id="L2285">        <span class="tok-str">'\\'</span> =&gt; {},</span>
<span class="line" id="L2286">        <span class="tok-str">'/'</span> =&gt; all_backslash = <span class="tok-null">false</span>,</span>
<span class="line" id="L2287">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> .none,</span>
<span class="line" id="L2288">    }</span>
<span class="line" id="L2289">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (path[<span class="tok-number">2</span>]) {</span>
<span class="line" id="L2290">        <span class="tok-str">'?'</span> =&gt; <span class="tok-kw">if</span> (all_backslash) .verbatim <span class="tok-kw">else</span> .fake_verbatim,</span>
<span class="line" id="L2291">        <span class="tok-str">'.'</span> =&gt; .local_device,</span>
<span class="line" id="L2292">        <span class="tok-kw">else</span> =&gt; .none,</span>
<span class="line" id="L2293">    };</span>
<span class="line" id="L2294">}</span>
<span class="line" id="L2295"></span>
<span class="line" id="L2296"><span class="tok-kw">test</span> getNamespacePrefix {</span>
<span class="line" id="L2297">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.none, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;&quot;</span>));</span>
<span class="line" id="L2298">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.nt, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\??\\&quot;</span>));</span>
<span class="line" id="L2299">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.none, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;/??/&quot;</span>));</span>
<span class="line" id="L2300">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.none, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;/??\\&quot;</span>));</span>
<span class="line" id="L2301">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.none, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\?\\\\&quot;</span>));</span>
<span class="line" id="L2302">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.local_device, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\\\.\\&quot;</span>));</span>
<span class="line" id="L2303">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.local_device, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\\\./&quot;</span>));</span>
<span class="line" id="L2304">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.local_device, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;/\\./&quot;</span>));</span>
<span class="line" id="L2305">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.local_device, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;//./&quot;</span>));</span>
<span class="line" id="L2306">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.none, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;/.//&quot;</span>));</span>
<span class="line" id="L2307">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.verbatim, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\\\?\\&quot;</span>));</span>
<span class="line" id="L2308">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.fake_verbatim, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\/?\\&quot;</span>));</span>
<span class="line" id="L2309">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.fake_verbatim, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\/?/&quot;</span>));</span>
<span class="line" id="L2310">    <span class="tok-kw">try</span> std.testing.expectEqual(NamespacePrefix.fake_verbatim, getNamespacePrefix(<span class="tok-type">u8</span>, <span class="tok-str">&quot;//?/&quot;</span>));</span>
<span class="line" id="L2311">}</span>
<span class="line" id="L2312"></span>
<span class="line" id="L2313"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UnprefixedPathType = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L2314">    unc_absolute,</span>
<span class="line" id="L2315">    drive_absolute,</span>
<span class="line" id="L2316">    drive_relative,</span>
<span class="line" id="L2317">    rooted,</span>
<span class="line" id="L2318">    relative,</span>
<span class="line" id="L2319">    root_local_device,</span>
<span class="line" id="L2320">};</span>
<span class="line" id="L2321"></span>
<span class="line" id="L2322"><span class="tok-comment">/// Get the path type of a path that is known to not have any namespace prefixes</span></span>
<span class="line" id="L2323"><span class="tok-comment">/// (`\\?\`, `\\.\`, `\??\`).</span></span>
<span class="line" id="L2324"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getUnprefixedPathType</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, path: []<span class="tok-kw">const</span> T) UnprefixedPathType {</span>
<span class="line" id="L2325">    <span class="tok-kw">if</span> (path.len &lt; <span class="tok-number">1</span>) <span class="tok-kw">return</span> .relative;</span>
<span class="line" id="L2326"></span>
<span class="line" id="L2327">    <span class="tok-kw">if</span> (std.debug.runtime_safety) {</span>
<span class="line" id="L2328">        std.debug.assert(getNamespacePrefix(T, path) == .none);</span>
<span class="line" id="L2329">    }</span>
<span class="line" id="L2330"></span>
<span class="line" id="L2331">    <span class="tok-kw">const</span> windows_path = std.fs.path.PathType.windows;</span>
<span class="line" id="L2332">    <span class="tok-kw">if</span> (windows_path.isSep(T, path[<span class="tok-number">0</span>])) {</span>
<span class="line" id="L2333">        <span class="tok-comment">// \x</span>
</span>
<span class="line" id="L2334">        <span class="tok-kw">if</span> (path.len &lt; <span class="tok-number">2</span> <span class="tok-kw">or</span> !windows_path.isSep(T, path[<span class="tok-number">1</span>])) <span class="tok-kw">return</span> .rooted;</span>
<span class="line" id="L2335">        <span class="tok-comment">// exactly \\. or \\? with nothing trailing</span>
</span>
<span class="line" id="L2336">        <span class="tok-kw">if</span> (path.len == <span class="tok-number">3</span> <span class="tok-kw">and</span> (path[<span class="tok-number">2</span>] == <span class="tok-str">'.'</span> <span class="tok-kw">or</span> path[<span class="tok-number">2</span>] == <span class="tok-str">'?'</span>)) <span class="tok-kw">return</span> .root_local_device;</span>
<span class="line" id="L2337">        <span class="tok-comment">// \\x</span>
</span>
<span class="line" id="L2338">        <span class="tok-kw">return</span> .unc_absolute;</span>
<span class="line" id="L2339">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2340">        <span class="tok-comment">// x</span>
</span>
<span class="line" id="L2341">        <span class="tok-kw">if</span> (path.len &lt; <span class="tok-number">2</span> <span class="tok-kw">or</span> path[<span class="tok-number">1</span>] != <span class="tok-str">':'</span>) <span class="tok-kw">return</span> .relative;</span>
<span class="line" id="L2342">        <span class="tok-comment">// x:\</span>
</span>
<span class="line" id="L2343">        <span class="tok-kw">if</span> (path.len &gt; <span class="tok-number">2</span> <span class="tok-kw">and</span> windows_path.isSep(T, path[<span class="tok-number">2</span>])) <span class="tok-kw">return</span> .drive_absolute;</span>
<span class="line" id="L2344">        <span class="tok-comment">// x:</span>
</span>
<span class="line" id="L2345">        <span class="tok-kw">return</span> .drive_relative;</span>
<span class="line" id="L2346">    }</span>
<span class="line" id="L2347">}</span>
<span class="line" id="L2348"></span>
<span class="line" id="L2349"><span class="tok-kw">test</span> getUnprefixedPathType {</span>
<span class="line" id="L2350">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.relative, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;&quot;</span>));</span>
<span class="line" id="L2351">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.relative, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x&quot;</span>));</span>
<span class="line" id="L2352">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.relative, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x\\&quot;</span>));</span>
<span class="line" id="L2353">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.root_local_device, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;//.&quot;</span>));</span>
<span class="line" id="L2354">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.root_local_device, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;/\\?&quot;</span>));</span>
<span class="line" id="L2355">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.root_local_device, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\\\?&quot;</span>));</span>
<span class="line" id="L2356">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.unc_absolute, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\\\x&quot;</span>));</span>
<span class="line" id="L2357">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.unc_absolute, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;//x&quot;</span>));</span>
<span class="line" id="L2358">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.rooted, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;\\x&quot;</span>));</span>
<span class="line" id="L2359">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.rooted, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;/&quot;</span>));</span>
<span class="line" id="L2360">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.drive_relative, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x:&quot;</span>));</span>
<span class="line" id="L2361">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.drive_relative, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x:abc&quot;</span>));</span>
<span class="line" id="L2362">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.drive_relative, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x:a/b/c&quot;</span>));</span>
<span class="line" id="L2363">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.drive_absolute, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x:\\&quot;</span>));</span>
<span class="line" id="L2364">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.drive_absolute, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x:\\abc&quot;</span>));</span>
<span class="line" id="L2365">    <span class="tok-kw">try</span> std.testing.expectEqual(UnprefixedPathType.drive_absolute, getUnprefixedPathType(<span class="tok-type">u8</span>, <span class="tok-str">&quot;x:/a/b/c&quot;</span>));</span>
<span class="line" id="L2366">}</span>
<span class="line" id="L2367"></span>
<span class="line" id="L2368"><span class="tok-kw">fn</span> <span class="tok-fn">getFullPathNameW</span>(path: [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u16</span>, out: []<span class="tok-type">u16</span>) !<span class="tok-type">usize</span> {</span>
<span class="line" id="L2369">    <span class="tok-kw">const</span> result = kernel32.GetFullPathNameW(path, <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(out.len)), out.ptr, <span class="tok-null">null</span>);</span>
<span class="line" id="L2370">    <span class="tok-kw">if</span> (result == <span class="tok-number">0</span>) {</span>
<span class="line" id="L2371">        <span class="tok-kw">switch</span> (kernel32.GetLastError()) {</span>
<span class="line" id="L2372">            <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedError(err),</span>
<span class="line" id="L2373">        }</span>
<span class="line" id="L2374">    }</span>
<span class="line" id="L2375">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L2376">}</span>
<span class="line" id="L2377"></span>
<span class="line" id="L2378"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">MAKELANGID</span>(p: <span class="tok-type">c_ushort</span>, s: <span class="tok-type">c_ushort</span>) LANGID {</span>
<span class="line" id="L2379">    <span class="tok-kw">return</span> (s &lt;&lt; <span class="tok-number">10</span>) | p;</span>
<span class="line" id="L2380">}</span>
<span class="line" id="L2381"></span>
<span class="line" id="L2382"><span class="tok-comment">/// Loads a Winsock extension function in runtime specified by a GUID.</span></span>
<span class="line" id="L2383"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadWinsockExtensionFunction</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, sock: ws2_32.SOCKET, guid: GUID) !T {</span>
<span class="line" id="L2384">    <span class="tok-kw">var</span> function: T = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2385">    <span class="tok-kw">var</span> num_bytes: DWORD = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2386"></span>
<span class="line" id="L2387">    <span class="tok-kw">const</span> rc = ws2_32.WSAIoctl(</span>
<span class="line" id="L2388">        sock,</span>
<span class="line" id="L2389">        ws2_32.SIO_GET_EXTENSION_FUNCTION_POINTER,</span>
<span class="line" id="L2390">        <span class="tok-builtin">@as</span>(*<span class="tok-kw">const</span> <span class="tok-type">anyopaque</span>, <span class="tok-builtin">@ptrCast</span>(&amp;guid)),</span>
<span class="line" id="L2391">        <span class="tok-builtin">@sizeOf</span>(GUID),</span>
<span class="line" id="L2392">        <span class="tok-builtin">@as</span>(?*<span class="tok-type">anyopaque</span>, <span class="tok-builtin">@ptrFromInt</span>(<span class="tok-builtin">@intFromPtr</span>(&amp;function))),</span>
<span class="line" id="L2393">        <span class="tok-builtin">@sizeOf</span>(T),</span>
<span class="line" id="L2394">        &amp;num_bytes,</span>
<span class="line" id="L2395">        <span class="tok-null">null</span>,</span>
<span class="line" id="L2396">        <span class="tok-null">null</span>,</span>
<span class="line" id="L2397">    );</span>
<span class="line" id="L2398"></span>
<span class="line" id="L2399">    <span class="tok-kw">if</span> (rc == ws2_32.SOCKET_ERROR) {</span>
<span class="line" id="L2400">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (ws2_32.WSAGetLastError()) {</span>
<span class="line" id="L2401">            .WSAEOPNOTSUPP =&gt; <span class="tok-kw">error</span>.OperationNotSupported,</span>
<span class="line" id="L2402">            .WSAENOTSOCK =&gt; <span class="tok-kw">error</span>.FileDescriptorNotASocket,</span>
<span class="line" id="L2403">            <span class="tok-kw">else</span> =&gt; |err| unexpectedWSAError(err),</span>
<span class="line" id="L2404">        };</span>
<span class="line" id="L2405">    }</span>
<span class="line" id="L2406"></span>
<span class="line" id="L2407">    <span class="tok-kw">if</span> (num_bytes != <span class="tok-builtin">@sizeOf</span>(T)) {</span>
<span class="line" id="L2408">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ShortRead;</span>
<span class="line" id="L2409">    }</span>
<span class="line" id="L2410"></span>
<span class="line" id="L2411">    <span class="tok-kw">return</span> function;</span>
<span class="line" id="L2412">}</span>
<span class="line" id="L2413"></span>
<span class="line" id="L2414"><span class="tok-comment">/// Call this when you made a windows DLL call or something that does SetLastError</span></span>
<span class="line" id="L2415"><span class="tok-comment">/// and you get an unexpected error.</span></span>
<span class="line" id="L2416"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unexpectedError</span>(err: Win32Error) std.os.UnexpectedError {</span>
<span class="line" id="L2417">    <span class="tok-kw">if</span> (std.os.unexpected_error_tracing) {</span>
<span class="line" id="L2418">        <span class="tok-comment">// 614 is the length of the longest windows error description</span>
</span>
<span class="line" id="L2419">        <span class="tok-kw">var</span> buf_wstr: [<span class="tok-number">614</span>]WCHAR = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2420">        <span class="tok-kw">var</span> buf_utf8: [<span class="tok-number">614</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2421">        <span class="tok-kw">const</span> len = kernel32.FormatMessageW(</span>
<span class="line" id="L2422">            FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,</span>
<span class="line" id="L2423">            <span class="tok-null">null</span>,</span>
<span class="line" id="L2424">            err,</span>
<span class="line" id="L2425">            MAKELANGID(LANG.NEUTRAL, SUBLANG.DEFAULT),</span>
<span class="line" id="L2426">            &amp;buf_wstr,</span>
<span class="line" id="L2427">            buf_wstr.len,</span>
<span class="line" id="L2428">            <span class="tok-null">null</span>,</span>
<span class="line" id="L2429">        );</span>
<span class="line" id="L2430">        _ = std.unicode.utf16leToUtf8(&amp;buf_utf8, buf_wstr[<span class="tok-number">0</span>..len]) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L2431">        std.debug.print(<span class="tok-str">&quot;error.Unexpected: GetLastError({}): {s}\n&quot;</span>, .{ <span class="tok-builtin">@intFromEnum</span>(err), buf_utf8[<span class="tok-number">0</span>..len] });</span>
<span class="line" id="L2432">        std.debug.dumpCurrentStackTrace(<span class="tok-builtin">@returnAddress</span>());</span>
<span class="line" id="L2433">    }</span>
<span class="line" id="L2434">    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L2435">}</span>
<span class="line" id="L2436"></span>
<span class="line" id="L2437"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unexpectedWSAError</span>(err: ws2_32.WinsockError) std.os.UnexpectedError {</span>
<span class="line" id="L2438">    <span class="tok-kw">return</span> unexpectedError(<span class="tok-builtin">@as</span>(Win32Error, <span class="tok-builtin">@enumFromInt</span>(<span class="tok-builtin">@intFromEnum</span>(err))));</span>
<span class="line" id="L2439">}</span>
<span class="line" id="L2440"></span>
<span class="line" id="L2441"><span class="tok-comment">/// Call this when you made a windows NtDll call</span></span>
<span class="line" id="L2442"><span class="tok-comment">/// and you get an unexpected status.</span></span>
<span class="line" id="L2443"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">unexpectedStatus</span>(status: NTSTATUS) std.os.UnexpectedError {</span>
<span class="line" id="L2444">    <span class="tok-kw">if</span> (std.os.unexpected_error_tracing) {</span>
<span class="line" id="L2445">        std.debug.print(<span class="tok-str">&quot;error.Unexpected NTSTATUS=0x{x}\n&quot;</span>, .{<span class="tok-builtin">@intFromEnum</span>(status)});</span>
<span class="line" id="L2446">        std.debug.dumpCurrentStackTrace(<span class="tok-builtin">@returnAddress</span>());</span>
<span class="line" id="L2447">    }</span>
<span class="line" id="L2448">    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Unexpected;</span>
<span class="line" id="L2449">}</span>
<span class="line" id="L2450"></span>
<span class="line" id="L2451"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Win32Error = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/win32error.zig&quot;</span>).Win32Error;</span>
<span class="line" id="L2452"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NTSTATUS = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/ntstatus.zig&quot;</span>).NTSTATUS;</span>
<span class="line" id="L2453"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LANG = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/lang.zig&quot;</span>);</span>
<span class="line" id="L2454"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SUBLANG = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;windows/sublang.zig&quot;</span>);</span>
<span class="line" id="L2455"></span>
<span class="line" id="L2456"><span class="tok-comment">/// The standard input device. Initially, this is the console input buffer, CONIN$.</span></span>
<span class="line" id="L2457"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STD_INPUT_HANDLE = maxInt(DWORD) - <span class="tok-number">10</span> + <span class="tok-number">1</span>;</span>
<span class="line" id="L2458"></span>
<span class="line" id="L2459"><span class="tok-comment">/// The standard output device. Initially, this is the active console screen buffer, CONOUT$.</span></span>
<span class="line" id="L2460"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STD_OUTPUT_HANDLE = maxInt(DWORD) - <span class="tok-number">11</span> + <span class="tok-number">1</span>;</span>
<span class="line" id="L2461"></span>
<span class="line" id="L2462"><span class="tok-comment">/// The standard error device. Initially, this is the active console screen buffer, CONOUT$.</span></span>
<span class="line" id="L2463"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STD_ERROR_HANDLE = maxInt(DWORD) - <span class="tok-number">12</span> + <span class="tok-number">1</span>;</span>
<span class="line" id="L2464"></span>
<span class="line" id="L2465"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WINAPI: std.builtin.CallingConvention = <span class="tok-kw">if</span> (native_arch == .x86)</span>
<span class="line" id="L2466">    .Stdcall</span>
<span class="line" id="L2467"><span class="tok-kw">else</span></span>
<span class="line" id="L2468">    .C;</span>
<span class="line" id="L2469"></span>
<span class="line" id="L2470"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BOOL = <span class="tok-type">c_int</span>;</span>
<span class="line" id="L2471"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BOOLEAN = BYTE;</span>
<span class="line" id="L2472"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BYTE = <span class="tok-type">u8</span>;</span>
<span class="line" id="L2473"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CHAR = <span class="tok-type">u8</span>;</span>
<span class="line" id="L2474"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UCHAR = <span class="tok-type">u8</span>;</span>
<span class="line" id="L2475"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FLOAT = <span class="tok-type">f32</span>;</span>
<span class="line" id="L2476"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HANDLE = *<span class="tok-type">anyopaque</span>;</span>
<span class="line" id="L2477"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HCRYPTPROV = ULONG_PTR;</span>
<span class="line" id="L2478"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ATOM = <span class="tok-type">u16</span>;</span>
<span class="line" id="L2479"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HBRUSH = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2480"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HCURSOR = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2481"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HICON = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2482"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HINSTANCE = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2483"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HMENU = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2484"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HMODULE = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2485"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HWND = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2486"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HDC = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2487"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HGLRC = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2488"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FARPROC = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2489"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INT = <span class="tok-type">c_int</span>;</span>
<span class="line" id="L2490"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPCSTR = [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> CHAR;</span>
<span class="line" id="L2491"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPCVOID = *<span class="tok-kw">const</span> <span class="tok-type">anyopaque</span>;</span>
<span class="line" id="L2492"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPSTR = [*:<span class="tok-number">0</span>]CHAR;</span>
<span class="line" id="L2493"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPVOID = *<span class="tok-type">anyopaque</span>;</span>
<span class="line" id="L2494"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPWSTR = [*:<span class="tok-number">0</span>]WCHAR;</span>
<span class="line" id="L2495"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPCWSTR = [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> WCHAR;</span>
<span class="line" id="L2496"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PVOID = *<span class="tok-type">anyopaque</span>;</span>
<span class="line" id="L2497"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PWSTR = [*:<span class="tok-number">0</span>]WCHAR;</span>
<span class="line" id="L2498"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PCWSTR = [*:<span class="tok-number">0</span>]<span class="tok-kw">const</span> WCHAR;</span>
<span class="line" id="L2499"><span class="tok-comment">/// Allocated by SysAllocString, freed by SysFreeString</span></span>
<span class="line" id="L2500"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BSTR = [*:<span class="tok-number">0</span>]WCHAR;</span>
<span class="line" id="L2501"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SIZE_T = <span class="tok-type">usize</span>;</span>
<span class="line" id="L2502"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UINT = <span class="tok-type">c_uint</span>;</span>
<span class="line" id="L2503"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ULONG_PTR = <span class="tok-type">usize</span>;</span>
<span class="line" id="L2504"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LONG_PTR = <span class="tok-type">isize</span>;</span>
<span class="line" id="L2505"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DWORD_PTR = ULONG_PTR;</span>
<span class="line" id="L2506"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WCHAR = <span class="tok-type">u16</span>;</span>
<span class="line" id="L2507"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WORD = <span class="tok-type">u16</span>;</span>
<span class="line" id="L2508"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DWORD = <span class="tok-type">u32</span>;</span>
<span class="line" id="L2509"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DWORD64 = <span class="tok-type">u64</span>;</span>
<span class="line" id="L2510"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LARGE_INTEGER = <span class="tok-type">i64</span>;</span>
<span class="line" id="L2511"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ULARGE_INTEGER = <span class="tok-type">u64</span>;</span>
<span class="line" id="L2512"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> USHORT = <span class="tok-type">u16</span>;</span>
<span class="line" id="L2513"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SHORT = <span class="tok-type">i16</span>;</span>
<span class="line" id="L2514"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ULONG = <span class="tok-type">u32</span>;</span>
<span class="line" id="L2515"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LONG = <span class="tok-type">i32</span>;</span>
<span class="line" id="L2516"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ULONG64 = <span class="tok-type">u64</span>;</span>
<span class="line" id="L2517"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ULONGLONG = <span class="tok-type">u64</span>;</span>
<span class="line" id="L2518"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LONGLONG = <span class="tok-type">i64</span>;</span>
<span class="line" id="L2519"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HLOCAL = HANDLE;</span>
<span class="line" id="L2520"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LANGID = <span class="tok-type">c_ushort</span>;</span>
<span class="line" id="L2521"></span>
<span class="line" id="L2522"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WPARAM = <span class="tok-type">usize</span>;</span>
<span class="line" id="L2523"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPARAM = LONG_PTR;</span>
<span class="line" id="L2524"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LRESULT = LONG_PTR;</span>
<span class="line" id="L2525"></span>
<span class="line" id="L2526"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> va_list = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L2527"></span>
<span class="line" id="L2528"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TRUE = <span class="tok-number">1</span>;</span>
<span class="line" id="L2529"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FALSE = <span class="tok-number">0</span>;</span>
<span class="line" id="L2530"></span>
<span class="line" id="L2531"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DEVICE_TYPE = ULONG;</span>
<span class="line" id="L2532"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_BEEP: DEVICE_TYPE = <span class="tok-number">0x0001</span>;</span>
<span class="line" id="L2533"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_CD_ROM: DEVICE_TYPE = <span class="tok-number">0x0002</span>;</span>
<span class="line" id="L2534"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_CD_ROM_FILE_SYSTEM: DEVICE_TYPE = <span class="tok-number">0x0003</span>;</span>
<span class="line" id="L2535"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_CONTROLLER: DEVICE_TYPE = <span class="tok-number">0x0004</span>;</span>
<span class="line" id="L2536"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DATALINK: DEVICE_TYPE = <span class="tok-number">0x0005</span>;</span>
<span class="line" id="L2537"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DFS: DEVICE_TYPE = <span class="tok-number">0x0006</span>;</span>
<span class="line" id="L2538"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DISK: DEVICE_TYPE = <span class="tok-number">0x0007</span>;</span>
<span class="line" id="L2539"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DISK_FILE_SYSTEM: DEVICE_TYPE = <span class="tok-number">0x0008</span>;</span>
<span class="line" id="L2540"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_FILE_SYSTEM: DEVICE_TYPE = <span class="tok-number">0x0009</span>;</span>
<span class="line" id="L2541"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_INPORT_PORT: DEVICE_TYPE = <span class="tok-number">0x000a</span>;</span>
<span class="line" id="L2542"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_KEYBOARD: DEVICE_TYPE = <span class="tok-number">0x000b</span>;</span>
<span class="line" id="L2543"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MAILSLOT: DEVICE_TYPE = <span class="tok-number">0x000c</span>;</span>
<span class="line" id="L2544"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MIDI_IN: DEVICE_TYPE = <span class="tok-number">0x000d</span>;</span>
<span class="line" id="L2545"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MIDI_OUT: DEVICE_TYPE = <span class="tok-number">0x000e</span>;</span>
<span class="line" id="L2546"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MOUSE: DEVICE_TYPE = <span class="tok-number">0x000f</span>;</span>
<span class="line" id="L2547"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MULTI_UNC_PROVIDER: DEVICE_TYPE = <span class="tok-number">0x0010</span>;</span>
<span class="line" id="L2548"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NAMED_PIPE: DEVICE_TYPE = <span class="tok-number">0x0011</span>;</span>
<span class="line" id="L2549"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NETWORK: DEVICE_TYPE = <span class="tok-number">0x0012</span>;</span>
<span class="line" id="L2550"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NETWORK_BROWSER: DEVICE_TYPE = <span class="tok-number">0x0013</span>;</span>
<span class="line" id="L2551"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NETWORK_FILE_SYSTEM: DEVICE_TYPE = <span class="tok-number">0x0014</span>;</span>
<span class="line" id="L2552"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NULL: DEVICE_TYPE = <span class="tok-number">0x0015</span>;</span>
<span class="line" id="L2553"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_PARALLEL_PORT: DEVICE_TYPE = <span class="tok-number">0x0016</span>;</span>
<span class="line" id="L2554"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_PHYSICAL_NETCARD: DEVICE_TYPE = <span class="tok-number">0x0017</span>;</span>
<span class="line" id="L2555"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_PRINTER: DEVICE_TYPE = <span class="tok-number">0x0018</span>;</span>
<span class="line" id="L2556"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SCANNER: DEVICE_TYPE = <span class="tok-number">0x0019</span>;</span>
<span class="line" id="L2557"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SERIAL_MOUSE_PORT: DEVICE_TYPE = <span class="tok-number">0x001a</span>;</span>
<span class="line" id="L2558"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SERIAL_PORT: DEVICE_TYPE = <span class="tok-number">0x001b</span>;</span>
<span class="line" id="L2559"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SCREEN: DEVICE_TYPE = <span class="tok-number">0x001c</span>;</span>
<span class="line" id="L2560"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SOUND: DEVICE_TYPE = <span class="tok-number">0x001d</span>;</span>
<span class="line" id="L2561"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_STREAMS: DEVICE_TYPE = <span class="tok-number">0x001e</span>;</span>
<span class="line" id="L2562"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_TAPE: DEVICE_TYPE = <span class="tok-number">0x001f</span>;</span>
<span class="line" id="L2563"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_TAPE_FILE_SYSTEM: DEVICE_TYPE = <span class="tok-number">0x0020</span>;</span>
<span class="line" id="L2564"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_TRANSPORT: DEVICE_TYPE = <span class="tok-number">0x0021</span>;</span>
<span class="line" id="L2565"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_UNKNOWN: DEVICE_TYPE = <span class="tok-number">0x0022</span>;</span>
<span class="line" id="L2566"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_VIDEO: DEVICE_TYPE = <span class="tok-number">0x0023</span>;</span>
<span class="line" id="L2567"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_VIRTUAL_DISK: DEVICE_TYPE = <span class="tok-number">0x0024</span>;</span>
<span class="line" id="L2568"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_WAVE_IN: DEVICE_TYPE = <span class="tok-number">0x0025</span>;</span>
<span class="line" id="L2569"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_WAVE_OUT: DEVICE_TYPE = <span class="tok-number">0x0026</span>;</span>
<span class="line" id="L2570"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_8042_PORT: DEVICE_TYPE = <span class="tok-number">0x0027</span>;</span>
<span class="line" id="L2571"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NETWORK_REDIRECTOR: DEVICE_TYPE = <span class="tok-number">0x0028</span>;</span>
<span class="line" id="L2572"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_BATTERY: DEVICE_TYPE = <span class="tok-number">0x0029</span>;</span>
<span class="line" id="L2573"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_BUS_EXTENDER: DEVICE_TYPE = <span class="tok-number">0x002a</span>;</span>
<span class="line" id="L2574"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MODEM: DEVICE_TYPE = <span class="tok-number">0x002b</span>;</span>
<span class="line" id="L2575"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_VDM: DEVICE_TYPE = <span class="tok-number">0x002c</span>;</span>
<span class="line" id="L2576"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MASS_STORAGE: DEVICE_TYPE = <span class="tok-number">0x002d</span>;</span>
<span class="line" id="L2577"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SMB: DEVICE_TYPE = <span class="tok-number">0x002e</span>;</span>
<span class="line" id="L2578"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_KS: DEVICE_TYPE = <span class="tok-number">0x002f</span>;</span>
<span class="line" id="L2579"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_CHANGER: DEVICE_TYPE = <span class="tok-number">0x0030</span>;</span>
<span class="line" id="L2580"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SMARTCARD: DEVICE_TYPE = <span class="tok-number">0x0031</span>;</span>
<span class="line" id="L2581"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_ACPI: DEVICE_TYPE = <span class="tok-number">0x0032</span>;</span>
<span class="line" id="L2582"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DVD: DEVICE_TYPE = <span class="tok-number">0x0033</span>;</span>
<span class="line" id="L2583"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_FULLSCREEN_VIDEO: DEVICE_TYPE = <span class="tok-number">0x0034</span>;</span>
<span class="line" id="L2584"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DFS_FILE_SYSTEM: DEVICE_TYPE = <span class="tok-number">0x0035</span>;</span>
<span class="line" id="L2585"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DFS_VOLUME: DEVICE_TYPE = <span class="tok-number">0x0036</span>;</span>
<span class="line" id="L2586"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SERENUM: DEVICE_TYPE = <span class="tok-number">0x0037</span>;</span>
<span class="line" id="L2587"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_TERMSRV: DEVICE_TYPE = <span class="tok-number">0x0038</span>;</span>
<span class="line" id="L2588"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_KSEC: DEVICE_TYPE = <span class="tok-number">0x0039</span>;</span>
<span class="line" id="L2589"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_FIPS: DEVICE_TYPE = <span class="tok-number">0x003a</span>;</span>
<span class="line" id="L2590"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_INFINIBAND: DEVICE_TYPE = <span class="tok-number">0x003b</span>;</span>
<span class="line" id="L2591"><span class="tok-comment">// TODO: missing values?</span>
</span>
<span class="line" id="L2592"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_VMBUS: DEVICE_TYPE = <span class="tok-number">0x003e</span>;</span>
<span class="line" id="L2593"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_CRYPT_PROVIDER: DEVICE_TYPE = <span class="tok-number">0x003f</span>;</span>
<span class="line" id="L2594"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_WPD: DEVICE_TYPE = <span class="tok-number">0x0040</span>;</span>
<span class="line" id="L2595"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_BLUETOOTH: DEVICE_TYPE = <span class="tok-number">0x0041</span>;</span>
<span class="line" id="L2596"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MT_COMPOSITE: DEVICE_TYPE = <span class="tok-number">0x0042</span>;</span>
<span class="line" id="L2597"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_MT_TRANSPORT: DEVICE_TYPE = <span class="tok-number">0x0043</span>;</span>
<span class="line" id="L2598"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_BIOMETRIC: DEVICE_TYPE = <span class="tok-number">0x0044</span>;</span>
<span class="line" id="L2599"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_PMI: DEVICE_TYPE = <span class="tok-number">0x0045</span>;</span>
<span class="line" id="L2600"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_EHSTOR: DEVICE_TYPE = <span class="tok-number">0x0046</span>;</span>
<span class="line" id="L2601"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_DEVAPI: DEVICE_TYPE = <span class="tok-number">0x0047</span>;</span>
<span class="line" id="L2602"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_GPIO: DEVICE_TYPE = <span class="tok-number">0x0048</span>;</span>
<span class="line" id="L2603"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_USBEX: DEVICE_TYPE = <span class="tok-number">0x0049</span>;</span>
<span class="line" id="L2604"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_CONSOLE: DEVICE_TYPE = <span class="tok-number">0x0050</span>;</span>
<span class="line" id="L2605"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NFP: DEVICE_TYPE = <span class="tok-number">0x0051</span>;</span>
<span class="line" id="L2606"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SYSENV: DEVICE_TYPE = <span class="tok-number">0x0052</span>;</span>
<span class="line" id="L2607"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_VIRTUAL_BLOCK: DEVICE_TYPE = <span class="tok-number">0x0053</span>;</span>
<span class="line" id="L2608"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_POINT_OF_SERVICE: DEVICE_TYPE = <span class="tok-number">0x0054</span>;</span>
<span class="line" id="L2609"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_STORAGE_REPLICATION: DEVICE_TYPE = <span class="tok-number">0x0055</span>;</span>
<span class="line" id="L2610"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_TRUST_ENV: DEVICE_TYPE = <span class="tok-number">0x0056</span>;</span>
<span class="line" id="L2611"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_UCM: DEVICE_TYPE = <span class="tok-number">0x0057</span>;</span>
<span class="line" id="L2612"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_UCMTCPCI: DEVICE_TYPE = <span class="tok-number">0x0058</span>;</span>
<span class="line" id="L2613"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_PERSISTENT_MEMORY: DEVICE_TYPE = <span class="tok-number">0x0059</span>;</span>
<span class="line" id="L2614"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_NVDIMM: DEVICE_TYPE = <span class="tok-number">0x005a</span>;</span>
<span class="line" id="L2615"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_HOLOGRAPHIC: DEVICE_TYPE = <span class="tok-number">0x005b</span>;</span>
<span class="line" id="L2616"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DEVICE_SDFXHCI: DEVICE_TYPE = <span class="tok-number">0x005c</span>;</span>
<span class="line" id="L2617"></span>
<span class="line" id="L2618"><span class="tok-comment">/// https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/buffer-descriptions-for-i-o-control-codes</span></span>
<span class="line" id="L2619"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TransferType = <span class="tok-kw">enum</span>(<span class="tok-type">u2</span>) {</span>
<span class="line" id="L2620">    METHOD_BUFFERED = <span class="tok-number">0</span>,</span>
<span class="line" id="L2621">    METHOD_IN_DIRECT = <span class="tok-number">1</span>,</span>
<span class="line" id="L2622">    METHOD_OUT_DIRECT = <span class="tok-number">2</span>,</span>
<span class="line" id="L2623">    METHOD_NEITHER = <span class="tok-number">3</span>,</span>
<span class="line" id="L2624">};</span>
<span class="line" id="L2625"></span>
<span class="line" id="L2626"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ANY_ACCESS = <span class="tok-number">0</span>;</span>
<span class="line" id="L2627"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_READ_ACCESS = <span class="tok-number">1</span>;</span>
<span class="line" id="L2628"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_WRITE_ACCESS = <span class="tok-number">2</span>;</span>
<span class="line" id="L2629"></span>
<span class="line" id="L2630"><span class="tok-comment">/// https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/defining-i-o-control-codes</span></span>
<span class="line" id="L2631"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">CTL_CODE</span>(deviceType: <span class="tok-type">u16</span>, function: <span class="tok-type">u12</span>, method: TransferType, access: <span class="tok-type">u2</span>) DWORD {</span>
<span class="line" id="L2632">    <span class="tok-kw">return</span> (<span class="tok-builtin">@as</span>(DWORD, deviceType) &lt;&lt; <span class="tok-number">16</span>) |</span>
<span class="line" id="L2633">        (<span class="tok-builtin">@as</span>(DWORD, access) &lt;&lt; <span class="tok-number">14</span>) |</span>
<span class="line" id="L2634">        (<span class="tok-builtin">@as</span>(DWORD, function) &lt;&lt; <span class="tok-number">2</span>) |</span>
<span class="line" id="L2635">        <span class="tok-builtin">@intFromEnum</span>(method);</span>
<span class="line" id="L2636">}</span>
<span class="line" id="L2637"></span>
<span class="line" id="L2638"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INVALID_HANDLE_VALUE = <span class="tok-builtin">@as</span>(HANDLE, <span class="tok-builtin">@ptrFromInt</span>(maxInt(<span class="tok-type">usize</span>)));</span>
<span class="line" id="L2639"></span>
<span class="line" id="L2640"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INVALID_FILE_ATTRIBUTES = <span class="tok-builtin">@as</span>(DWORD, maxInt(DWORD));</span>
<span class="line" id="L2641"></span>
<span class="line" id="L2642"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ALL_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2643">    BasicInformation: FILE_BASIC_INFORMATION,</span>
<span class="line" id="L2644">    StandardInformation: FILE_STANDARD_INFORMATION,</span>
<span class="line" id="L2645">    InternalInformation: FILE_INTERNAL_INFORMATION,</span>
<span class="line" id="L2646">    EaInformation: FILE_EA_INFORMATION,</span>
<span class="line" id="L2647">    AccessInformation: FILE_ACCESS_INFORMATION,</span>
<span class="line" id="L2648">    PositionInformation: FILE_POSITION_INFORMATION,</span>
<span class="line" id="L2649">    ModeInformation: FILE_MODE_INFORMATION,</span>
<span class="line" id="L2650">    AlignmentInformation: FILE_ALIGNMENT_INFORMATION,</span>
<span class="line" id="L2651">    NameInformation: FILE_NAME_INFORMATION,</span>
<span class="line" id="L2652">};</span>
<span class="line" id="L2653"></span>
<span class="line" id="L2654"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_BASIC_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2655">    CreationTime: LARGE_INTEGER,</span>
<span class="line" id="L2656">    LastAccessTime: LARGE_INTEGER,</span>
<span class="line" id="L2657">    LastWriteTime: LARGE_INTEGER,</span>
<span class="line" id="L2658">    ChangeTime: LARGE_INTEGER,</span>
<span class="line" id="L2659">    FileAttributes: ULONG,</span>
<span class="line" id="L2660">};</span>
<span class="line" id="L2661"></span>
<span class="line" id="L2662"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_STANDARD_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2663">    AllocationSize: LARGE_INTEGER,</span>
<span class="line" id="L2664">    EndOfFile: LARGE_INTEGER,</span>
<span class="line" id="L2665">    NumberOfLinks: ULONG,</span>
<span class="line" id="L2666">    DeletePending: BOOLEAN,</span>
<span class="line" id="L2667">    Directory: BOOLEAN,</span>
<span class="line" id="L2668">};</span>
<span class="line" id="L2669"></span>
<span class="line" id="L2670"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_INTERNAL_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2671">    IndexNumber: LARGE_INTEGER,</span>
<span class="line" id="L2672">};</span>
<span class="line" id="L2673"></span>
<span class="line" id="L2674"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_EA_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2675">    EaSize: ULONG,</span>
<span class="line" id="L2676">};</span>
<span class="line" id="L2677"></span>
<span class="line" id="L2678"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ACCESS_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2679">    AccessFlags: ACCESS_MASK,</span>
<span class="line" id="L2680">};</span>
<span class="line" id="L2681"></span>
<span class="line" id="L2682"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_POSITION_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2683">    CurrentByteOffset: LARGE_INTEGER,</span>
<span class="line" id="L2684">};</span>
<span class="line" id="L2685"></span>
<span class="line" id="L2686"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_END_OF_FILE_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2687">    EndOfFile: LARGE_INTEGER,</span>
<span class="line" id="L2688">};</span>
<span class="line" id="L2689"></span>
<span class="line" id="L2690"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_MODE_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2691">    Mode: ULONG,</span>
<span class="line" id="L2692">};</span>
<span class="line" id="L2693"></span>
<span class="line" id="L2694"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ALIGNMENT_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2695">    AlignmentRequirement: ULONG,</span>
<span class="line" id="L2696">};</span>
<span class="line" id="L2697"></span>
<span class="line" id="L2698"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NAME_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2699">    FileNameLength: ULONG,</span>
<span class="line" id="L2700">    FileName: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L2701">};</span>
<span class="line" id="L2702"></span>
<span class="line" id="L2703"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DISPOSITION_INFORMATION_EX = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2704">    <span class="tok-comment">/// combination of FILE_DISPOSITION_* flags</span></span>
<span class="line" id="L2705">    Flags: ULONG,</span>
<span class="line" id="L2706">};</span>
<span class="line" id="L2707"></span>
<span class="line" id="L2708"><span class="tok-kw">const</span> FILE_DISPOSITION_DO_NOT_DELETE: ULONG = <span class="tok-number">0x00000000</span>;</span>
<span class="line" id="L2709"><span class="tok-kw">const</span> FILE_DISPOSITION_DELETE: ULONG = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2710"><span class="tok-kw">const</span> FILE_DISPOSITION_POSIX_SEMANTICS: ULONG = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2711"><span class="tok-kw">const</span> FILE_DISPOSITION_FORCE_IMAGE_SECTION_CHECK: ULONG = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2712"><span class="tok-kw">const</span> FILE_DISPOSITION_ON_CLOSE: ULONG = <span class="tok-number">0x00000008</span>;</span>
<span class="line" id="L2713"><span class="tok-kw">const</span> FILE_DISPOSITION_IGNORE_READONLY_ATTRIBUTE: ULONG = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L2714"></span>
<span class="line" id="L2715"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_RENAME_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2716">    ReplaceIfExists: BOOLEAN,</span>
<span class="line" id="L2717">    RootDirectory: ?HANDLE,</span>
<span class="line" id="L2718">    FileNameLength: ULONG,</span>
<span class="line" id="L2719">    FileName: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L2720">};</span>
<span class="line" id="L2721"></span>
<span class="line" id="L2722"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IO_STATUS_BLOCK = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2723">    <span class="tok-comment">// &quot;DUMMYUNIONNAME&quot; expands to &quot;u&quot;</span>
</span>
<span class="line" id="L2724">    u: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L2725">        Status: NTSTATUS,</span>
<span class="line" id="L2726">        Pointer: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L2727">    },</span>
<span class="line" id="L2728">    Information: ULONG_PTR,</span>
<span class="line" id="L2729">};</span>
<span class="line" id="L2730"></span>
<span class="line" id="L2731"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_INFORMATION_CLASS = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L2732">    FileDirectoryInformation = <span class="tok-number">1</span>,</span>
<span class="line" id="L2733">    FileFullDirectoryInformation,</span>
<span class="line" id="L2734">    FileBothDirectoryInformation,</span>
<span class="line" id="L2735">    FileBasicInformation,</span>
<span class="line" id="L2736">    FileStandardInformation,</span>
<span class="line" id="L2737">    FileInternalInformation,</span>
<span class="line" id="L2738">    FileEaInformation,</span>
<span class="line" id="L2739">    FileAccessInformation,</span>
<span class="line" id="L2740">    FileNameInformation,</span>
<span class="line" id="L2741">    FileRenameInformation,</span>
<span class="line" id="L2742">    FileLinkInformation,</span>
<span class="line" id="L2743">    FileNamesInformation,</span>
<span class="line" id="L2744">    FileDispositionInformation,</span>
<span class="line" id="L2745">    FilePositionInformation,</span>
<span class="line" id="L2746">    FileFullEaInformation,</span>
<span class="line" id="L2747">    FileModeInformation,</span>
<span class="line" id="L2748">    FileAlignmentInformation,</span>
<span class="line" id="L2749">    FileAllInformation,</span>
<span class="line" id="L2750">    FileAllocationInformation,</span>
<span class="line" id="L2751">    FileEndOfFileInformation,</span>
<span class="line" id="L2752">    FileAlternateNameInformation,</span>
<span class="line" id="L2753">    FileStreamInformation,</span>
<span class="line" id="L2754">    FilePipeInformation,</span>
<span class="line" id="L2755">    FilePipeLocalInformation,</span>
<span class="line" id="L2756">    FilePipeRemoteInformation,</span>
<span class="line" id="L2757">    FileMailslotQueryInformation,</span>
<span class="line" id="L2758">    FileMailslotSetInformation,</span>
<span class="line" id="L2759">    FileCompressionInformation,</span>
<span class="line" id="L2760">    FileObjectIdInformation,</span>
<span class="line" id="L2761">    FileCompletionInformation,</span>
<span class="line" id="L2762">    FileMoveClusterInformation,</span>
<span class="line" id="L2763">    FileQuotaInformation,</span>
<span class="line" id="L2764">    FileReparsePointInformation,</span>
<span class="line" id="L2765">    FileNetworkOpenInformation,</span>
<span class="line" id="L2766">    FileAttributeTagInformation,</span>
<span class="line" id="L2767">    FileTrackingInformation,</span>
<span class="line" id="L2768">    FileIdBothDirectoryInformation,</span>
<span class="line" id="L2769">    FileIdFullDirectoryInformation,</span>
<span class="line" id="L2770">    FileValidDataLengthInformation,</span>
<span class="line" id="L2771">    FileShortNameInformation,</span>
<span class="line" id="L2772">    FileIoCompletionNotificationInformation,</span>
<span class="line" id="L2773">    FileIoStatusBlockRangeInformation,</span>
<span class="line" id="L2774">    FileIoPriorityHintInformation,</span>
<span class="line" id="L2775">    FileSfioReserveInformation,</span>
<span class="line" id="L2776">    FileSfioVolumeInformation,</span>
<span class="line" id="L2777">    FileHardLinkInformation,</span>
<span class="line" id="L2778">    FileProcessIdsUsingFileInformation,</span>
<span class="line" id="L2779">    FileNormalizedNameInformation,</span>
<span class="line" id="L2780">    FileNetworkPhysicalNameInformation,</span>
<span class="line" id="L2781">    FileIdGlobalTxDirectoryInformation,</span>
<span class="line" id="L2782">    FileIsRemoteDeviceInformation,</span>
<span class="line" id="L2783">    FileUnusedInformation,</span>
<span class="line" id="L2784">    FileNumaNodeInformation,</span>
<span class="line" id="L2785">    FileStandardLinkInformation,</span>
<span class="line" id="L2786">    FileRemoteProtocolInformation,</span>
<span class="line" id="L2787">    FileRenameInformationBypassAccessCheck,</span>
<span class="line" id="L2788">    FileLinkInformationBypassAccessCheck,</span>
<span class="line" id="L2789">    FileVolumeNameInformation,</span>
<span class="line" id="L2790">    FileIdInformation,</span>
<span class="line" id="L2791">    FileIdExtdDirectoryInformation,</span>
<span class="line" id="L2792">    FileReplaceCompletionInformation,</span>
<span class="line" id="L2793">    FileHardLinkFullIdInformation,</span>
<span class="line" id="L2794">    FileIdExtdBothDirectoryInformation,</span>
<span class="line" id="L2795">    FileDispositionInformationEx,</span>
<span class="line" id="L2796">    FileRenameInformationEx,</span>
<span class="line" id="L2797">    FileRenameInformationExBypassAccessCheck,</span>
<span class="line" id="L2798">    FileDesiredStorageClassInformation,</span>
<span class="line" id="L2799">    FileStatInformation,</span>
<span class="line" id="L2800">    FileMemoryPartitionInformation,</span>
<span class="line" id="L2801">    FileStatLxInformation,</span>
<span class="line" id="L2802">    FileCaseSensitiveInformation,</span>
<span class="line" id="L2803">    FileLinkInformationEx,</span>
<span class="line" id="L2804">    FileLinkInformationExBypassAccessCheck,</span>
<span class="line" id="L2805">    FileStorageReserveIdInformation,</span>
<span class="line" id="L2806">    FileCaseSensitiveInformationForceAccessCheck,</span>
<span class="line" id="L2807">    FileMaximumInformation,</span>
<span class="line" id="L2808">};</span>
<span class="line" id="L2809"></span>
<span class="line" id="L2810"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DISPOSITION_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2811">    DeleteFile: BOOLEAN,</span>
<span class="line" id="L2812">};</span>
<span class="line" id="L2813"></span>
<span class="line" id="L2814"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FS_DEVICE_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2815">    DeviceType: DEVICE_TYPE,</span>
<span class="line" id="L2816">    Characteristics: ULONG,</span>
<span class="line" id="L2817">};</span>
<span class="line" id="L2818"></span>
<span class="line" id="L2819"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FS_INFORMATION_CLASS = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L2820">    FileFsVolumeInformation = <span class="tok-number">1</span>,</span>
<span class="line" id="L2821">    FileFsLabelInformation,</span>
<span class="line" id="L2822">    FileFsSizeInformation,</span>
<span class="line" id="L2823">    FileFsDeviceInformation,</span>
<span class="line" id="L2824">    FileFsAttributeInformation,</span>
<span class="line" id="L2825">    FileFsControlInformation,</span>
<span class="line" id="L2826">    FileFsFullSizeInformation,</span>
<span class="line" id="L2827">    FileFsObjectIdInformation,</span>
<span class="line" id="L2828">    FileFsDriverPathInformation,</span>
<span class="line" id="L2829">    FileFsVolumeFlagsInformation,</span>
<span class="line" id="L2830">    FileFsSectorSizeInformation,</span>
<span class="line" id="L2831">    FileFsDataCopyInformation,</span>
<span class="line" id="L2832">    FileFsMetadataSizeInformation,</span>
<span class="line" id="L2833">    FileFsFullSizeInformationEx,</span>
<span class="line" id="L2834">    FileFsMaximumInformation,</span>
<span class="line" id="L2835">};</span>
<span class="line" id="L2836"></span>
<span class="line" id="L2837"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OVERLAPPED = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2838">    Internal: ULONG_PTR,</span>
<span class="line" id="L2839">    InternalHigh: ULONG_PTR,</span>
<span class="line" id="L2840">    DUMMYUNIONNAME: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L2841">        DUMMYSTRUCTNAME: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2842">            Offset: DWORD,</span>
<span class="line" id="L2843">            OffsetHigh: DWORD,</span>
<span class="line" id="L2844">        },</span>
<span class="line" id="L2845">        Pointer: ?PVOID,</span>
<span class="line" id="L2846">    },</span>
<span class="line" id="L2847">    hEvent: ?HANDLE,</span>
<span class="line" id="L2848">};</span>
<span class="line" id="L2849"></span>
<span class="line" id="L2850"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OVERLAPPED_ENTRY = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2851">    lpCompletionKey: ULONG_PTR,</span>
<span class="line" id="L2852">    lpOverlapped: *OVERLAPPED,</span>
<span class="line" id="L2853">    Internal: ULONG_PTR,</span>
<span class="line" id="L2854">    dwNumberOfBytesTransferred: DWORD,</span>
<span class="line" id="L2855">};</span>
<span class="line" id="L2856"></span>
<span class="line" id="L2857"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAX_PATH = <span class="tok-number">260</span>;</span>
<span class="line" id="L2858"></span>
<span class="line" id="L2859"><span class="tok-comment">// TODO issue #305</span>
</span>
<span class="line" id="L2860"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_INFO_BY_HANDLE_CLASS = <span class="tok-type">u32</span>;</span>
<span class="line" id="L2861"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileBasicInfo = <span class="tok-number">0</span>;</span>
<span class="line" id="L2862"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileStandardInfo = <span class="tok-number">1</span>;</span>
<span class="line" id="L2863"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileNameInfo = <span class="tok-number">2</span>;</span>
<span class="line" id="L2864"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileRenameInfo = <span class="tok-number">3</span>;</span>
<span class="line" id="L2865"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileDispositionInfo = <span class="tok-number">4</span>;</span>
<span class="line" id="L2866"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileAllocationInfo = <span class="tok-number">5</span>;</span>
<span class="line" id="L2867"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileEndOfFileInfo = <span class="tok-number">6</span>;</span>
<span class="line" id="L2868"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileStreamInfo = <span class="tok-number">7</span>;</span>
<span class="line" id="L2869"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileCompressionInfo = <span class="tok-number">8</span>;</span>
<span class="line" id="L2870"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileAttributeTagInfo = <span class="tok-number">9</span>;</span>
<span class="line" id="L2871"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileIdBothDirectoryInfo = <span class="tok-number">10</span>;</span>
<span class="line" id="L2872"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileIdBothDirectoryRestartInfo = <span class="tok-number">11</span>;</span>
<span class="line" id="L2873"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileIoPriorityHintInfo = <span class="tok-number">12</span>;</span>
<span class="line" id="L2874"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileRemoteProtocolInfo = <span class="tok-number">13</span>;</span>
<span class="line" id="L2875"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileFullDirectoryInfo = <span class="tok-number">14</span>;</span>
<span class="line" id="L2876"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileFullDirectoryRestartInfo = <span class="tok-number">15</span>;</span>
<span class="line" id="L2877"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileStorageInfo = <span class="tok-number">16</span>;</span>
<span class="line" id="L2878"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileAlignmentInfo = <span class="tok-number">17</span>;</span>
<span class="line" id="L2879"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileIdInfo = <span class="tok-number">18</span>;</span>
<span class="line" id="L2880"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileIdExtdDirectoryInfo = <span class="tok-number">19</span>;</span>
<span class="line" id="L2881"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FileIdExtdDirectoryRestartInfo = <span class="tok-number">20</span>;</span>
<span class="line" id="L2882"></span>
<span class="line" id="L2883"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BY_HANDLE_FILE_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2884">    dwFileAttributes: DWORD,</span>
<span class="line" id="L2885">    ftCreationTime: FILETIME,</span>
<span class="line" id="L2886">    ftLastAccessTime: FILETIME,</span>
<span class="line" id="L2887">    ftLastWriteTime: FILETIME,</span>
<span class="line" id="L2888">    dwVolumeSerialNumber: DWORD,</span>
<span class="line" id="L2889">    nFileSizeHigh: DWORD,</span>
<span class="line" id="L2890">    nFileSizeLow: DWORD,</span>
<span class="line" id="L2891">    nNumberOfLinks: DWORD,</span>
<span class="line" id="L2892">    nFileIndexHigh: DWORD,</span>
<span class="line" id="L2893">    nFileIndexLow: DWORD,</span>
<span class="line" id="L2894">};</span>
<span class="line" id="L2895"></span>
<span class="line" id="L2896"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NAME_INFO = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2897">    FileNameLength: DWORD,</span>
<span class="line" id="L2898">    FileName: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L2899">};</span>
<span class="line" id="L2900"></span>
<span class="line" id="L2901"><span class="tok-comment">/// Return the normalized drive name. This is the default.</span></span>
<span class="line" id="L2902"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NAME_NORMALIZED = <span class="tok-number">0x0</span>;</span>
<span class="line" id="L2903"></span>
<span class="line" id="L2904"><span class="tok-comment">/// Return the opened file name (not normalized).</span></span>
<span class="line" id="L2905"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NAME_OPENED = <span class="tok-number">0x8</span>;</span>
<span class="line" id="L2906"></span>
<span class="line" id="L2907"><span class="tok-comment">/// Return the path with the drive letter. This is the default.</span></span>
<span class="line" id="L2908"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VOLUME_NAME_DOS = <span class="tok-number">0x0</span>;</span>
<span class="line" id="L2909"></span>
<span class="line" id="L2910"><span class="tok-comment">/// Return the path with a volume GUID path instead of the drive name.</span></span>
<span class="line" id="L2911"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VOLUME_NAME_GUID = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L2912"></span>
<span class="line" id="L2913"><span class="tok-comment">/// Return the path with no drive information.</span></span>
<span class="line" id="L2914"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VOLUME_NAME_NONE = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L2915"></span>
<span class="line" id="L2916"><span class="tok-comment">/// Return the path with the volume device path.</span></span>
<span class="line" id="L2917"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VOLUME_NAME_NT = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L2918"></span>
<span class="line" id="L2919"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECURITY_ATTRIBUTES = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2920">    nLength: DWORD,</span>
<span class="line" id="L2921">    lpSecurityDescriptor: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L2922">    bInheritHandle: BOOL,</span>
<span class="line" id="L2923">};</span>
<span class="line" id="L2924"></span>
<span class="line" id="L2925"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_ACCESS_INBOUND = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2926"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_ACCESS_OUTBOUND = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2927"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_ACCESS_DUPLEX = <span class="tok-number">0x00000003</span>;</span>
<span class="line" id="L2928"></span>
<span class="line" id="L2929"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_TYPE_BYTE = <span class="tok-number">0x00000000</span>;</span>
<span class="line" id="L2930"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_TYPE_MESSAGE = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2931"></span>
<span class="line" id="L2932"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_READMODE_BYTE = <span class="tok-number">0x00000000</span>;</span>
<span class="line" id="L2933"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_READMODE_MESSAGE = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2934"></span>
<span class="line" id="L2935"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_WAIT = <span class="tok-number">0x00000000</span>;</span>
<span class="line" id="L2936"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIPE_NOWAIT = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2937"></span>
<span class="line" id="L2938"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GENERIC_READ = <span class="tok-number">0x80000000</span>;</span>
<span class="line" id="L2939"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GENERIC_WRITE = <span class="tok-number">0x40000000</span>;</span>
<span class="line" id="L2940"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GENERIC_EXECUTE = <span class="tok-number">0x20000000</span>;</span>
<span class="line" id="L2941"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GENERIC_ALL = <span class="tok-number">0x10000000</span>;</span>
<span class="line" id="L2942"></span>
<span class="line" id="L2943"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SHARE_DELETE = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2944"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SHARE_READ = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2945"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SHARE_WRITE = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2946"></span>
<span class="line" id="L2947"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DELETE = <span class="tok-number">0x00010000</span>;</span>
<span class="line" id="L2948"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> READ_CONTROL = <span class="tok-number">0x00020000</span>;</span>
<span class="line" id="L2949"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WRITE_DAC = <span class="tok-number">0x00040000</span>;</span>
<span class="line" id="L2950"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WRITE_OWNER = <span class="tok-number">0x00080000</span>;</span>
<span class="line" id="L2951"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYNCHRONIZE = <span class="tok-number">0x00100000</span>;</span>
<span class="line" id="L2952"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STANDARD_RIGHTS_READ = READ_CONTROL;</span>
<span class="line" id="L2953"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STANDARD_RIGHTS_WRITE = READ_CONTROL;</span>
<span class="line" id="L2954"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STANDARD_RIGHTS_EXECUTE = READ_CONTROL;</span>
<span class="line" id="L2955"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STANDARD_RIGHTS_REQUIRED = DELETE | READ_CONTROL | WRITE_DAC | WRITE_OWNER;</span>
<span class="line" id="L2956"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAXIMUM_ALLOWED = <span class="tok-number">0x02000000</span>;</span>
<span class="line" id="L2957"></span>
<span class="line" id="L2958"><span class="tok-comment">// disposition for NtCreateFile</span>
</span>
<span class="line" id="L2959"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SUPERSEDE = <span class="tok-number">0</span>;</span>
<span class="line" id="L2960"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN = <span class="tok-number">1</span>;</span>
<span class="line" id="L2961"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_CREATE = <span class="tok-number">2</span>;</span>
<span class="line" id="L2962"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_IF = <span class="tok-number">3</span>;</span>
<span class="line" id="L2963"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OVERWRITE = <span class="tok-number">4</span>;</span>
<span class="line" id="L2964"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OVERWRITE_IF = <span class="tok-number">5</span>;</span>
<span class="line" id="L2965"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_MAXIMUM_DISPOSITION = <span class="tok-number">5</span>;</span>
<span class="line" id="L2966"></span>
<span class="line" id="L2967"><span class="tok-comment">// flags for NtCreateFile and NtOpenFile</span>
</span>
<span class="line" id="L2968"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_READ_DATA = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2969"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_LIST_DIRECTORY = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2970"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_WRITE_DATA = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2971"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ADD_FILE = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2972"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_APPEND_DATA = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2973"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ADD_SUBDIRECTORY = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2974"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_CREATE_PIPE_INSTANCE = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2975"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_READ_EA = <span class="tok-number">0x00000008</span>;</span>
<span class="line" id="L2976"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_WRITE_EA = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L2977"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_EXECUTE = <span class="tok-number">0x00000020</span>;</span>
<span class="line" id="L2978"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_TRAVERSE = <span class="tok-number">0x00000020</span>;</span>
<span class="line" id="L2979"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DELETE_CHILD = <span class="tok-number">0x00000040</span>;</span>
<span class="line" id="L2980"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_READ_ATTRIBUTES = <span class="tok-number">0x00000080</span>;</span>
<span class="line" id="L2981"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_WRITE_ATTRIBUTES = <span class="tok-number">0x00000100</span>;</span>
<span class="line" id="L2982"></span>
<span class="line" id="L2983"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DIRECTORY_FILE = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L2984"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_WRITE_THROUGH = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L2985"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SEQUENTIAL_ONLY = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L2986"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NO_INTERMEDIATE_BUFFERING = <span class="tok-number">0x00000008</span>;</span>
<span class="line" id="L2987"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SYNCHRONOUS_IO_ALERT = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L2988"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SYNCHRONOUS_IO_NONALERT = <span class="tok-number">0x00000020</span>;</span>
<span class="line" id="L2989"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NON_DIRECTORY_FILE = <span class="tok-number">0x00000040</span>;</span>
<span class="line" id="L2990"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_CREATE_TREE_CONNECTION = <span class="tok-number">0x00000080</span>;</span>
<span class="line" id="L2991"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_COMPLETE_IF_OPLOCKED = <span class="tok-number">0x00000100</span>;</span>
<span class="line" id="L2992"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NO_EA_KNOWLEDGE = <span class="tok-number">0x00000200</span>;</span>
<span class="line" id="L2993"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_FOR_RECOVERY = <span class="tok-number">0x00000400</span>;</span>
<span class="line" id="L2994"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_RANDOM_ACCESS = <span class="tok-number">0x00000800</span>;</span>
<span class="line" id="L2995"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DELETE_ON_CLOSE = <span class="tok-number">0x00001000</span>;</span>
<span class="line" id="L2996"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_BY_FILE_ID = <span class="tok-number">0x00002000</span>;</span>
<span class="line" id="L2997"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_FOR_BACKUP_INTENT = <span class="tok-number">0x00004000</span>;</span>
<span class="line" id="L2998"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NO_COMPRESSION = <span class="tok-number">0x00008000</span>;</span>
<span class="line" id="L2999"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_RESERVE_OPFILTER = <span class="tok-number">0x00100000</span>;</span>
<span class="line" id="L3000"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_REPARSE_POINT = <span class="tok-number">0x00200000</span>;</span>
<span class="line" id="L3001"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_OFFLINE_FILE = <span class="tok-number">0x00400000</span>;</span>
<span class="line" id="L3002"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_OPEN_FOR_FREE_SPACE_QUERY = <span class="tok-number">0x00800000</span>;</span>
<span class="line" id="L3003"></span>
<span class="line" id="L3004"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CREATE_ALWAYS = <span class="tok-number">2</span>;</span>
<span class="line" id="L3005"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CREATE_NEW = <span class="tok-number">1</span>;</span>
<span class="line" id="L3006"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OPEN_ALWAYS = <span class="tok-number">4</span>;</span>
<span class="line" id="L3007"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OPEN_EXISTING = <span class="tok-number">3</span>;</span>
<span class="line" id="L3008"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TRUNCATE_EXISTING = <span class="tok-number">5</span>;</span>
<span class="line" id="L3009"></span>
<span class="line" id="L3010"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_ARCHIVE = <span class="tok-number">0x20</span>;</span>
<span class="line" id="L3011"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_COMPRESSED = <span class="tok-number">0x800</span>;</span>
<span class="line" id="L3012"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_DEVICE = <span class="tok-number">0x40</span>;</span>
<span class="line" id="L3013"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_DIRECTORY = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L3014"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_ENCRYPTED = <span class="tok-number">0x4000</span>;</span>
<span class="line" id="L3015"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_HIDDEN = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L3016"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_INTEGRITY_STREAM = <span class="tok-number">0x8000</span>;</span>
<span class="line" id="L3017"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_NORMAL = <span class="tok-number">0x80</span>;</span>
<span class="line" id="L3018"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_NOT_CONTENT_INDEXED = <span class="tok-number">0x2000</span>;</span>
<span class="line" id="L3019"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_NO_SCRUB_DATA = <span class="tok-number">0x20000</span>;</span>
<span class="line" id="L3020"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_OFFLINE = <span class="tok-number">0x1000</span>;</span>
<span class="line" id="L3021"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_READONLY = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L3022"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_RECALL_ON_DATA_ACCESS = <span class="tok-number">0x400000</span>;</span>
<span class="line" id="L3023"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_RECALL_ON_OPEN = <span class="tok-number">0x40000</span>;</span>
<span class="line" id="L3024"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_REPARSE_POINT = <span class="tok-number">0x400</span>;</span>
<span class="line" id="L3025"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_SPARSE_FILE = <span class="tok-number">0x200</span>;</span>
<span class="line" id="L3026"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_SYSTEM = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L3027"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_TEMPORARY = <span class="tok-number">0x100</span>;</span>
<span class="line" id="L3028"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ATTRIBUTE_VIRTUAL = <span class="tok-number">0x10000</span>;</span>
<span class="line" id="L3029"></span>
<span class="line" id="L3030"><span class="tok-comment">// flags for CreateEvent</span>
</span>
<span class="line" id="L3031"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CREATE_EVENT_INITIAL_SET = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L3032"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CREATE_EVENT_MANUAL_RESET = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3033"></span>
<span class="line" id="L3034"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EVENT_ALL_ACCESS = <span class="tok-number">0x1F0003</span>;</span>
<span class="line" id="L3035"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EVENT_MODIFY_STATE = <span class="tok-number">0x0002</span>;</span>
<span class="line" id="L3036"></span>
<span class="line" id="L3037"><span class="tok-comment">// MEMORY_BASIC_INFORMATION.Type flags for VirtualQuery</span>
</span>
<span class="line" id="L3038"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_IMAGE = <span class="tok-number">0x1000000</span>;</span>
<span class="line" id="L3039"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_MAPPED = <span class="tok-number">0x40000</span>;</span>
<span class="line" id="L3040"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_PRIVATE = <span class="tok-number">0x20000</span>;</span>
<span class="line" id="L3041"></span>
<span class="line" id="L3042"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROCESS_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3043">    hProcess: HANDLE,</span>
<span class="line" id="L3044">    hThread: HANDLE,</span>
<span class="line" id="L3045">    dwProcessId: DWORD,</span>
<span class="line" id="L3046">    dwThreadId: DWORD,</span>
<span class="line" id="L3047">};</span>
<span class="line" id="L3048"></span>
<span class="line" id="L3049"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTUPINFOW = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3050">    cb: DWORD,</span>
<span class="line" id="L3051">    lpReserved: ?LPWSTR,</span>
<span class="line" id="L3052">    lpDesktop: ?LPWSTR,</span>
<span class="line" id="L3053">    lpTitle: ?LPWSTR,</span>
<span class="line" id="L3054">    dwX: DWORD,</span>
<span class="line" id="L3055">    dwY: DWORD,</span>
<span class="line" id="L3056">    dwXSize: DWORD,</span>
<span class="line" id="L3057">    dwYSize: DWORD,</span>
<span class="line" id="L3058">    dwXCountChars: DWORD,</span>
<span class="line" id="L3059">    dwYCountChars: DWORD,</span>
<span class="line" id="L3060">    dwFillAttribute: DWORD,</span>
<span class="line" id="L3061">    dwFlags: DWORD,</span>
<span class="line" id="L3062">    wShowWindow: WORD,</span>
<span class="line" id="L3063">    cbReserved2: WORD,</span>
<span class="line" id="L3064">    lpReserved2: ?*BYTE,</span>
<span class="line" id="L3065">    hStdInput: ?HANDLE,</span>
<span class="line" id="L3066">    hStdOutput: ?HANDLE,</span>
<span class="line" id="L3067">    hStdError: ?HANDLE,</span>
<span class="line" id="L3068">};</span>
<span class="line" id="L3069"></span>
<span class="line" id="L3070"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_FORCEONFEEDBACK = <span class="tok-number">0x00000040</span>;</span>
<span class="line" id="L3071"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_FORCEOFFFEEDBACK = <span class="tok-number">0x00000080</span>;</span>
<span class="line" id="L3072"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_PREVENTPINNING = <span class="tok-number">0x00002000</span>;</span>
<span class="line" id="L3073"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_RUNFULLSCREEN = <span class="tok-number">0x00000020</span>;</span>
<span class="line" id="L3074"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_TITLEISAPPID = <span class="tok-number">0x00001000</span>;</span>
<span class="line" id="L3075"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_TITLEISLINKNAME = <span class="tok-number">0x00000800</span>;</span>
<span class="line" id="L3076"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_UNTRUSTEDSOURCE = <span class="tok-number">0x00008000</span>;</span>
<span class="line" id="L3077"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USECOUNTCHARS = <span class="tok-number">0x00000008</span>;</span>
<span class="line" id="L3078"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USEFILLATTRIBUTE = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L3079"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USEHOTKEY = <span class="tok-number">0x00000200</span>;</span>
<span class="line" id="L3080"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USEPOSITION = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L3081"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USESHOWWINDOW = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3082"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USESIZE = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L3083"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STARTF_USESTDHANDLES = <span class="tok-number">0x00000100</span>;</span>
<span class="line" id="L3084"></span>
<span class="line" id="L3085"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INFINITE = <span class="tok-number">4294967295</span>;</span>
<span class="line" id="L3086"></span>
<span class="line" id="L3087"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAXIMUM_WAIT_OBJECTS = <span class="tok-number">64</span>;</span>
<span class="line" id="L3088"></span>
<span class="line" id="L3089"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WAIT_ABANDONED = <span class="tok-number">0x00000080</span>;</span>
<span class="line" id="L3090"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WAIT_ABANDONED_0 = WAIT_ABANDONED + <span class="tok-number">0</span>;</span>
<span class="line" id="L3091"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WAIT_OBJECT_0 = <span class="tok-number">0x00000000</span>;</span>
<span class="line" id="L3092"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WAIT_TIMEOUT = <span class="tok-number">0x00000102</span>;</span>
<span class="line" id="L3093"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WAIT_FAILED = <span class="tok-number">0xFFFFFFFF</span>;</span>
<span class="line" id="L3094"></span>
<span class="line" id="L3095"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HANDLE_FLAG_INHERIT = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3096"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HANDLE_FLAG_PROTECT_FROM_CLOSE = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L3097"></span>
<span class="line" id="L3098"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOVEFILE_COPY_ALLOWED = <span class="tok-number">2</span>;</span>
<span class="line" id="L3099"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOVEFILE_CREATE_HARDLINK = <span class="tok-number">16</span>;</span>
<span class="line" id="L3100"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOVEFILE_DELAY_UNTIL_REBOOT = <span class="tok-number">4</span>;</span>
<span class="line" id="L3101"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOVEFILE_FAIL_IF_NOT_TRACKABLE = <span class="tok-number">32</span>;</span>
<span class="line" id="L3102"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOVEFILE_REPLACE_EXISTING = <span class="tok-number">1</span>;</span>
<span class="line" id="L3103"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOVEFILE_WRITE_THROUGH = <span class="tok-number">8</span>;</span>
<span class="line" id="L3104"></span>
<span class="line" id="L3105"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_BEGIN = <span class="tok-number">0</span>;</span>
<span class="line" id="L3106"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_CURRENT = <span class="tok-number">1</span>;</span>
<span class="line" id="L3107"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_END = <span class="tok-number">2</span>;</span>
<span class="line" id="L3108"></span>
<span class="line" id="L3109"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HEAP_CREATE_ENABLE_EXECUTE = <span class="tok-number">0x00040000</span>;</span>
<span class="line" id="L3110"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HEAP_REALLOC_IN_PLACE_ONLY = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L3111"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HEAP_GENERATE_EXCEPTIONS = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L3112"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HEAP_NO_SERIALIZE = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3113"></span>
<span class="line" id="L3114"><span class="tok-comment">// AllocationType values</span>
</span>
<span class="line" id="L3115"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_COMMIT = <span class="tok-number">0x1000</span>;</span>
<span class="line" id="L3116"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_RESERVE = <span class="tok-number">0x2000</span>;</span>
<span class="line" id="L3117"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_FREE = <span class="tok-number">0x10000</span>;</span>
<span class="line" id="L3118"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_RESET = <span class="tok-number">0x80000</span>;</span>
<span class="line" id="L3119"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_RESET_UNDO = <span class="tok-number">0x1000000</span>;</span>
<span class="line" id="L3120"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_LARGE_PAGES = <span class="tok-number">0x20000000</span>;</span>
<span class="line" id="L3121"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_PHYSICAL = <span class="tok-number">0x400000</span>;</span>
<span class="line" id="L3122"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_TOP_DOWN = <span class="tok-number">0x100000</span>;</span>
<span class="line" id="L3123"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_WRITE_WATCH = <span class="tok-number">0x200000</span>;</span>
<span class="line" id="L3124"></span>
<span class="line" id="L3125"><span class="tok-comment">// Protect values</span>
</span>
<span class="line" id="L3126"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_EXECUTE = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L3127"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_EXECUTE_READ = <span class="tok-number">0x20</span>;</span>
<span class="line" id="L3128"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_EXECUTE_READWRITE = <span class="tok-number">0x40</span>;</span>
<span class="line" id="L3129"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_EXECUTE_WRITECOPY = <span class="tok-number">0x80</span>;</span>
<span class="line" id="L3130"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_NOACCESS = <span class="tok-number">0x01</span>;</span>
<span class="line" id="L3131"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_READONLY = <span class="tok-number">0x02</span>;</span>
<span class="line" id="L3132"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_READWRITE = <span class="tok-number">0x04</span>;</span>
<span class="line" id="L3133"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_WRITECOPY = <span class="tok-number">0x08</span>;</span>
<span class="line" id="L3134"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_TARGETS_INVALID = <span class="tok-number">0x40000000</span>;</span>
<span class="line" id="L3135"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_TARGETS_NO_UPDATE = <span class="tok-number">0x40000000</span>; <span class="tok-comment">// Same as PAGE_TARGETS_INVALID</span>
</span>
<span class="line" id="L3136"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_GUARD = <span class="tok-number">0x100</span>;</span>
<span class="line" id="L3137"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_NOCACHE = <span class="tok-number">0x200</span>;</span>
<span class="line" id="L3138"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PAGE_WRITECOMBINE = <span class="tok-number">0x400</span>;</span>
<span class="line" id="L3139"></span>
<span class="line" id="L3140"><span class="tok-comment">// FreeType values</span>
</span>
<span class="line" id="L3141"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_COALESCE_PLACEHOLDERS = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L3142"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_RESERVE_PLACEHOLDERS = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L3143"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_DECOMMIT = <span class="tok-number">0x4000</span>;</span>
<span class="line" id="L3144"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM_RELEASE = <span class="tok-number">0x8000</span>;</span>
<span class="line" id="L3145"></span>
<span class="line" id="L3146"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PTHREAD_START_ROUTINE = *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (LPVOID) <span class="tok-kw">callconv</span>(.C) DWORD;</span>
<span class="line" id="L3147"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPTHREAD_START_ROUTINE = PTHREAD_START_ROUTINE;</span>
<span class="line" id="L3148"></span>
<span class="line" id="L3149"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WIN32_FIND_DATAW = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3150">    dwFileAttributes: DWORD,</span>
<span class="line" id="L3151">    ftCreationTime: FILETIME,</span>
<span class="line" id="L3152">    ftLastAccessTime: FILETIME,</span>
<span class="line" id="L3153">    ftLastWriteTime: FILETIME,</span>
<span class="line" id="L3154">    nFileSizeHigh: DWORD,</span>
<span class="line" id="L3155">    nFileSizeLow: DWORD,</span>
<span class="line" id="L3156">    dwReserved0: DWORD,</span>
<span class="line" id="L3157">    dwReserved1: DWORD,</span>
<span class="line" id="L3158">    cFileName: [<span class="tok-number">260</span>]<span class="tok-type">u16</span>,</span>
<span class="line" id="L3159">    cAlternateFileName: [<span class="tok-number">14</span>]<span class="tok-type">u16</span>,</span>
<span class="line" id="L3160">};</span>
<span class="line" id="L3161"></span>
<span class="line" id="L3162"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILETIME = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3163">    dwLowDateTime: DWORD,</span>
<span class="line" id="L3164">    dwHighDateTime: DWORD,</span>
<span class="line" id="L3165">};</span>
<span class="line" id="L3166"></span>
<span class="line" id="L3167"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYSTEM_INFO = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3168">    anon1: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L3169">        dwOemId: DWORD,</span>
<span class="line" id="L3170">        anon2: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3171">            wProcessorArchitecture: WORD,</span>
<span class="line" id="L3172">            wReserved: WORD,</span>
<span class="line" id="L3173">        },</span>
<span class="line" id="L3174">    },</span>
<span class="line" id="L3175">    dwPageSize: DWORD,</span>
<span class="line" id="L3176">    lpMinimumApplicationAddress: LPVOID,</span>
<span class="line" id="L3177">    lpMaximumApplicationAddress: LPVOID,</span>
<span class="line" id="L3178">    dwActiveProcessorMask: DWORD_PTR,</span>
<span class="line" id="L3179">    dwNumberOfProcessors: DWORD,</span>
<span class="line" id="L3180">    dwProcessorType: DWORD,</span>
<span class="line" id="L3181">    dwAllocationGranularity: DWORD,</span>
<span class="line" id="L3182">    wProcessorLevel: WORD,</span>
<span class="line" id="L3183">    wProcessorRevision: WORD,</span>
<span class="line" id="L3184">};</span>
<span class="line" id="L3185"></span>
<span class="line" id="L3186"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HRESULT = <span class="tok-type">c_long</span>;</span>
<span class="line" id="L3187"></span>
<span class="line" id="L3188"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KNOWNFOLDERID = GUID;</span>
<span class="line" id="L3189"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GUID = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3190">    Data1: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3191">    Data2: <span class="tok-type">u16</span>,</span>
<span class="line" id="L3192">    Data3: <span class="tok-type">u16</span>,</span>
<span class="line" id="L3193">    Data4: [<span class="tok-number">8</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L3194"></span>
<span class="line" id="L3195">    <span class="tok-kw">const</span> hex_offsets = <span class="tok-kw">switch</span> (builtin.target.cpu.arch.endian()) {</span>
<span class="line" id="L3196">        .Big =&gt; [<span class="tok-number">16</span>]<span class="tok-type">u6</span>{</span>
<span class="line" id="L3197">            <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">4</span>,  <span class="tok-number">6</span>,</span>
<span class="line" id="L3198">            <span class="tok-number">9</span>,  <span class="tok-number">11</span>, <span class="tok-number">14</span>, <span class="tok-number">16</span>,</span>
<span class="line" id="L3199">            <span class="tok-number">19</span>, <span class="tok-number">21</span>, <span class="tok-number">24</span>, <span class="tok-number">26</span>,</span>
<span class="line" id="L3200">            <span class="tok-number">28</span>, <span class="tok-number">30</span>, <span class="tok-number">32</span>, <span class="tok-number">34</span>,</span>
<span class="line" id="L3201">        },</span>
<span class="line" id="L3202">        .Little =&gt; [<span class="tok-number">16</span>]<span class="tok-type">u6</span>{</span>
<span class="line" id="L3203">            <span class="tok-number">6</span>,  <span class="tok-number">4</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L3204">            <span class="tok-number">11</span>, <span class="tok-number">9</span>,  <span class="tok-number">16</span>, <span class="tok-number">14</span>,</span>
<span class="line" id="L3205">            <span class="tok-number">19</span>, <span class="tok-number">21</span>, <span class="tok-number">24</span>, <span class="tok-number">26</span>,</span>
<span class="line" id="L3206">            <span class="tok-number">28</span>, <span class="tok-number">30</span>, <span class="tok-number">32</span>, <span class="tok-number">34</span>,</span>
<span class="line" id="L3207">        },</span>
<span class="line" id="L3208">    };</span>
<span class="line" id="L3209"></span>
<span class="line" id="L3210">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parse</span>(s: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) GUID {</span>
<span class="line" id="L3211">        assert(s[<span class="tok-number">0</span>] == <span class="tok-str">'{'</span>);</span>
<span class="line" id="L3212">        assert(s[<span class="tok-number">37</span>] == <span class="tok-str">'}'</span>);</span>
<span class="line" id="L3213">        <span class="tok-kw">return</span> parseNoBraces(s[<span class="tok-number">1</span> .. s.len - <span class="tok-number">1</span>]) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;invalid GUID string&quot;</span>);</span>
<span class="line" id="L3214">    }</span>
<span class="line" id="L3215"></span>
<span class="line" id="L3216">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseNoBraces</span>(s: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !GUID {</span>
<span class="line" id="L3217">        assert(s.len == <span class="tok-number">36</span>);</span>
<span class="line" id="L3218">        assert(s[<span class="tok-number">8</span>] == <span class="tok-str">'-'</span>);</span>
<span class="line" id="L3219">        assert(s[<span class="tok-number">13</span>] == <span class="tok-str">'-'</span>);</span>
<span class="line" id="L3220">        assert(s[<span class="tok-number">18</span>] == <span class="tok-str">'-'</span>);</span>
<span class="line" id="L3221">        assert(s[<span class="tok-number">23</span>] == <span class="tok-str">'-'</span>);</span>
<span class="line" id="L3222">        <span class="tok-kw">var</span> bytes: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3223">        <span class="tok-kw">for</span> (hex_offsets, <span class="tok-number">0</span>..) |hex_offset, i| {</span>
<span class="line" id="L3224">            bytes[i] = (<span class="tok-kw">try</span> std.fmt.charToDigit(s[hex_offset], <span class="tok-number">16</span>)) &lt;&lt; <span class="tok-number">4</span> |</span>
<span class="line" id="L3225">                <span class="tok-kw">try</span> std.fmt.charToDigit(s[hex_offset + <span class="tok-number">1</span>], <span class="tok-number">16</span>);</span>
<span class="line" id="L3226">        }</span>
<span class="line" id="L3227">        <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(GUID, <span class="tok-builtin">@bitCast</span>(bytes));</span>
<span class="line" id="L3228">    }</span>
<span class="line" id="L3229">};</span>
<span class="line" id="L3230"></span>
<span class="line" id="L3231"><span class="tok-kw">test</span> <span class="tok-str">&quot;GUID&quot;</span> {</span>
<span class="line" id="L3232">    <span class="tok-kw">try</span> std.testing.expectEqual(</span>
<span class="line" id="L3233">        GUID{</span>
<span class="line" id="L3234">            .Data1 = <span class="tok-number">0x01234567</span>,</span>
<span class="line" id="L3235">            .Data2 = <span class="tok-number">0x89ab</span>,</span>
<span class="line" id="L3236">            .Data3 = <span class="tok-number">0xef10</span>,</span>
<span class="line" id="L3237">            .Data4 = <span class="tok-str">&quot;\x32\x54\x76\x98\xba\xdc\xfe\x91&quot;</span>.*,</span>
<span class="line" id="L3238">        },</span>
<span class="line" id="L3239">        GUID.parse(<span class="tok-str">&quot;{01234567-89AB-EF10-3254-7698badcfe91}&quot;</span>),</span>
<span class="line" id="L3240">    );</span>
<span class="line" id="L3241">}</span>
<span class="line" id="L3242"></span>
<span class="line" id="L3243"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FOLDERID_LocalAppData = GUID.parse(<span class="tok-str">&quot;{F1B32785-6FBA-4FCF-9D55-7B8E7F157091}&quot;</span>);</span>
<span class="line" id="L3244"></span>
<span class="line" id="L3245"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_DEFAULT = <span class="tok-number">0</span>;</span>
<span class="line" id="L3246"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_NO_APPCONTAINER_REDIRECTION = <span class="tok-number">65536</span>;</span>
<span class="line" id="L3247"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_CREATE = <span class="tok-number">32768</span>;</span>
<span class="line" id="L3248"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_DONT_VERIFY = <span class="tok-number">16384</span>;</span>
<span class="line" id="L3249"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_DONT_UNEXPAND = <span class="tok-number">8192</span>;</span>
<span class="line" id="L3250"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_NO_ALIAS = <span class="tok-number">4096</span>;</span>
<span class="line" id="L3251"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_INIT = <span class="tok-number">2048</span>;</span>
<span class="line" id="L3252"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_DEFAULT_PATH = <span class="tok-number">1024</span>;</span>
<span class="line" id="L3253"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_NOT_PARENT_RELATIVE = <span class="tok-number">512</span>;</span>
<span class="line" id="L3254"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_SIMPLE_IDLIST = <span class="tok-number">256</span>;</span>
<span class="line" id="L3255"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KF_FLAG_ALIAS_ONLY = -<span class="tok-number">2147483648</span>;</span>
<span class="line" id="L3256"></span>
<span class="line" id="L3257"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> S_OK = <span class="tok-number">0</span>;</span>
<span class="line" id="L3258"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> S_FALSE = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3259"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_NOTIMPL = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80004001</span>)));</span>
<span class="line" id="L3260"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_NOINTERFACE = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80004002</span>)));</span>
<span class="line" id="L3261"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_POINTER = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80004003</span>)));</span>
<span class="line" id="L3262"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_ABORT = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80004004</span>)));</span>
<span class="line" id="L3263"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_FAIL = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80004005</span>)));</span>
<span class="line" id="L3264"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_UNEXPECTED = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x8000FFFF</span>)));</span>
<span class="line" id="L3265"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_ACCESSDENIED = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80070005</span>)));</span>
<span class="line" id="L3266"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_HANDLE = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80070006</span>)));</span>
<span class="line" id="L3267"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_OUTOFMEMORY = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x8007000E</span>)));</span>
<span class="line" id="L3268"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> E_INVALIDARG = <span class="tok-builtin">@as</span>(<span class="tok-type">c_long</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_ulong</span>, <span class="tok-number">0x80070057</span>)));</span>
<span class="line" id="L3269"></span>
<span class="line" id="L3270"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_BACKUP_SEMANTICS = <span class="tok-number">0x02000000</span>;</span>
<span class="line" id="L3271"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_DELETE_ON_CLOSE = <span class="tok-number">0x04000000</span>;</span>
<span class="line" id="L3272"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_NO_BUFFERING = <span class="tok-number">0x20000000</span>;</span>
<span class="line" id="L3273"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_OPEN_NO_RECALL = <span class="tok-number">0x00100000</span>;</span>
<span class="line" id="L3274"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_OPEN_REPARSE_POINT = <span class="tok-number">0x00200000</span>;</span>
<span class="line" id="L3275"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_OVERLAPPED = <span class="tok-number">0x40000000</span>;</span>
<span class="line" id="L3276"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_POSIX_SEMANTICS = <span class="tok-number">0x0100000</span>;</span>
<span class="line" id="L3277"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_RANDOM_ACCESS = <span class="tok-number">0x10000000</span>;</span>
<span class="line" id="L3278"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_SESSION_AWARE = <span class="tok-number">0x00800000</span>;</span>
<span class="line" id="L3279"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_SEQUENTIAL_SCAN = <span class="tok-number">0x08000000</span>;</span>
<span class="line" id="L3280"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_FLAG_WRITE_THROUGH = <span class="tok-number">0x80000000</span>;</span>
<span class="line" id="L3281"></span>
<span class="line" id="L3282"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RECT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3283">    left: LONG,</span>
<span class="line" id="L3284">    top: LONG,</span>
<span class="line" id="L3285">    right: LONG,</span>
<span class="line" id="L3286">    bottom: LONG,</span>
<span class="line" id="L3287">};</span>
<span class="line" id="L3288"></span>
<span class="line" id="L3289"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SMALL_RECT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3290">    Left: SHORT,</span>
<span class="line" id="L3291">    Top: SHORT,</span>
<span class="line" id="L3292">    Right: SHORT,</span>
<span class="line" id="L3293">    Bottom: SHORT,</span>
<span class="line" id="L3294">};</span>
<span class="line" id="L3295"></span>
<span class="line" id="L3296"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> POINT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3297">    x: LONG,</span>
<span class="line" id="L3298">    y: LONG,</span>
<span class="line" id="L3299">};</span>
<span class="line" id="L3300"></span>
<span class="line" id="L3301"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> COORD = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3302">    X: SHORT,</span>
<span class="line" id="L3303">    Y: SHORT,</span>
<span class="line" id="L3304">};</span>
<span class="line" id="L3305"></span>
<span class="line" id="L3306"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CREATE_UNICODE_ENVIRONMENT = <span class="tok-number">1024</span>;</span>
<span class="line" id="L3307"></span>
<span class="line" id="L3308"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TLS_OUT_OF_INDEXES = <span class="tok-number">4294967295</span>;</span>
<span class="line" id="L3309"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IMAGE_TLS_DIRECTORY = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3310">    StartAddressOfRawData: <span class="tok-type">usize</span>,</span>
<span class="line" id="L3311">    EndAddressOfRawData: <span class="tok-type">usize</span>,</span>
<span class="line" id="L3312">    AddressOfIndex: <span class="tok-type">usize</span>,</span>
<span class="line" id="L3313">    AddressOfCallBacks: <span class="tok-type">usize</span>,</span>
<span class="line" id="L3314">    SizeOfZeroFill: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3315">    Characteristics: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3316">};</span>
<span class="line" id="L3317"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IMAGE_TLS_DIRECTORY64 = IMAGE_TLS_DIRECTORY;</span>
<span class="line" id="L3318"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IMAGE_TLS_DIRECTORY32 = IMAGE_TLS_DIRECTORY;</span>
<span class="line" id="L3319"></span>
<span class="line" id="L3320"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PIMAGE_TLS_CALLBACK = ?*<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (PVOID, DWORD, PVOID) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">void</span>;</span>
<span class="line" id="L3321"></span>
<span class="line" id="L3322"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROV_RSA_FULL = <span class="tok-number">1</span>;</span>
<span class="line" id="L3323"></span>
<span class="line" id="L3324"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> REGSAM = ACCESS_MASK;</span>
<span class="line" id="L3325"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ACCESS_MASK = DWORD;</span>
<span class="line" id="L3326"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LSTATUS = LONG;</span>
<span class="line" id="L3327"></span>
<span class="line" id="L3328"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_INHERIT = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L3329">    ViewShare = <span class="tok-number">0</span>,</span>
<span class="line" id="L3330">    ViewUnmap = <span class="tok-number">1</span>,</span>
<span class="line" id="L3331">};</span>
<span class="line" id="L3332"></span>
<span class="line" id="L3333"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_QUERY = <span class="tok-number">0x0001</span>;</span>
<span class="line" id="L3334"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_MAP_WRITE = <span class="tok-number">0x0002</span>;</span>
<span class="line" id="L3335"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_MAP_READ = <span class="tok-number">0x0004</span>;</span>
<span class="line" id="L3336"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_MAP_EXECUTE = <span class="tok-number">0x0008</span>;</span>
<span class="line" id="L3337"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_EXTEND_SIZE = <span class="tok-number">0x0010</span>;</span>
<span class="line" id="L3338"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SECTION_ALL_ACCESS =</span>
<span class="line" id="L3339">    STANDARD_RIGHTS_REQUIRED |</span>
<span class="line" id="L3340">    SECTION_QUERY |</span>
<span class="line" id="L3341">    SECTION_MAP_WRITE |</span>
<span class="line" id="L3342">    SECTION_MAP_READ |</span>
<span class="line" id="L3343">    SECTION_MAP_EXECUTE |</span>
<span class="line" id="L3344">    SECTION_EXTEND_SIZE;</span>
<span class="line" id="L3345"></span>
<span class="line" id="L3346"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_64K_PAGES = <span class="tok-number">0x80000</span>;</span>
<span class="line" id="L3347"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_FILE = <span class="tok-number">0x800000</span>;</span>
<span class="line" id="L3348"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_IMAGE = <span class="tok-number">0x1000000</span>;</span>
<span class="line" id="L3349"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_PROTECTED_IMAGE = <span class="tok-number">0x2000000</span>;</span>
<span class="line" id="L3350"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_RESERVE = <span class="tok-number">0x4000000</span>;</span>
<span class="line" id="L3351"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_COMMIT = <span class="tok-number">0x8000000</span>;</span>
<span class="line" id="L3352"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_IMAGE_NO_EXECUTE = SEC_IMAGE | SEC_NOCACHE;</span>
<span class="line" id="L3353"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_NOCACHE = <span class="tok-number">0x10000000</span>;</span>
<span class="line" id="L3354"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_WRITECOMBINE = <span class="tok-number">0x40000000</span>;</span>
<span class="line" id="L3355"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SEC_LARGE_PAGES = <span class="tok-number">0x80000000</span>;</span>
<span class="line" id="L3356"></span>
<span class="line" id="L3357"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HKEY = *<span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L3358"></span>
<span class="line" id="L3359"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HKEY_LOCAL_MACHINE: HKEY = <span class="tok-builtin">@as</span>(HKEY, <span class="tok-builtin">@ptrFromInt</span>(<span class="tok-number">0x80000002</span>));</span>
<span class="line" id="L3360"></span>
<span class="line" id="L3361"><span class="tok-comment">/// Combines the STANDARD_RIGHTS_REQUIRED, KEY_QUERY_VALUE, KEY_SET_VALUE, KEY_CREATE_SUB_KEY,</span></span>
<span class="line" id="L3362"><span class="tok-comment">/// KEY_ENUMERATE_SUB_KEYS, KEY_NOTIFY, and KEY_CREATE_LINK access rights.</span></span>
<span class="line" id="L3363"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_ALL_ACCESS = <span class="tok-number">0xF003F</span>;</span>
<span class="line" id="L3364"><span class="tok-comment">/// Reserved for system use.</span></span>
<span class="line" id="L3365"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_CREATE_LINK = <span class="tok-number">0x0020</span>;</span>
<span class="line" id="L3366"><span class="tok-comment">/// Required to create a subkey of a registry key.</span></span>
<span class="line" id="L3367"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_CREATE_SUB_KEY = <span class="tok-number">0x0004</span>;</span>
<span class="line" id="L3368"><span class="tok-comment">/// Required to enumerate the subkeys of a registry key.</span></span>
<span class="line" id="L3369"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_ENUMERATE_SUB_KEYS = <span class="tok-number">0x0008</span>;</span>
<span class="line" id="L3370"><span class="tok-comment">/// Equivalent to KEY_READ.</span></span>
<span class="line" id="L3371"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_EXECUTE = <span class="tok-number">0x20019</span>;</span>
<span class="line" id="L3372"><span class="tok-comment">/// Required to request change notifications for a registry key or for subkeys of a registry key.</span></span>
<span class="line" id="L3373"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_NOTIFY = <span class="tok-number">0x0010</span>;</span>
<span class="line" id="L3374"><span class="tok-comment">/// Required to query the values of a registry key.</span></span>
<span class="line" id="L3375"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_QUERY_VALUE = <span class="tok-number">0x0001</span>;</span>
<span class="line" id="L3376"><span class="tok-comment">/// Combines the STANDARD_RIGHTS_READ, KEY_QUERY_VALUE, KEY_ENUMERATE_SUB_KEYS, and KEY_NOTIFY values.</span></span>
<span class="line" id="L3377"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_READ = <span class="tok-number">0x20019</span>;</span>
<span class="line" id="L3378"><span class="tok-comment">/// Required to create, delete, or set a registry value.</span></span>
<span class="line" id="L3379"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_SET_VALUE = <span class="tok-number">0x0002</span>;</span>
<span class="line" id="L3380"><span class="tok-comment">/// Indicates that an application on 64-bit Windows should operate on the 32-bit registry view.</span></span>
<span class="line" id="L3381"><span class="tok-comment">/// This flag is ignored by 32-bit Windows.</span></span>
<span class="line" id="L3382"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_WOW64_32KEY = <span class="tok-number">0x0200</span>;</span>
<span class="line" id="L3383"><span class="tok-comment">/// Indicates that an application on 64-bit Windows should operate on the 64-bit registry view.</span></span>
<span class="line" id="L3384"><span class="tok-comment">/// This flag is ignored by 32-bit Windows.</span></span>
<span class="line" id="L3385"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_WOW64_64KEY = <span class="tok-number">0x0100</span>;</span>
<span class="line" id="L3386"><span class="tok-comment">/// Combines the STANDARD_RIGHTS_WRITE, KEY_SET_VALUE, and KEY_CREATE_SUB_KEY access rights.</span></span>
<span class="line" id="L3387"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KEY_WRITE = <span class="tok-number">0x20006</span>;</span>
<span class="line" id="L3388"></span>
<span class="line" id="L3389"><span class="tok-comment">/// Open symbolic link.</span></span>
<span class="line" id="L3390"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> REG_OPTION_OPEN_LINK: DWORD = <span class="tok-number">0x8</span>;</span>
<span class="line" id="L3391"></span>
<span class="line" id="L3392"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_TABLE = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3393">    QueryRoutine: RTL_QUERY_REGISTRY_ROUTINE,</span>
<span class="line" id="L3394">    Flags: ULONG,</span>
<span class="line" id="L3395">    Name: ?PWSTR,</span>
<span class="line" id="L3396">    EntryContext: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3397">    DefaultType: ULONG,</span>
<span class="line" id="L3398">    DefaultData: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3399">    DefaultLength: ULONG,</span>
<span class="line" id="L3400">};</span>
<span class="line" id="L3401"></span>
<span class="line" id="L3402"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_ROUTINE = ?*<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (</span>
<span class="line" id="L3403">    PWSTR,</span>
<span class="line" id="L3404">    ULONG,</span>
<span class="line" id="L3405">    ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3406">    ULONG,</span>
<span class="line" id="L3407">    ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3408">    ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3409">) <span class="tok-kw">callconv</span>(WINAPI) NTSTATUS;</span>
<span class="line" id="L3410"></span>
<span class="line" id="L3411"><span class="tok-comment">/// Path is a full path</span></span>
<span class="line" id="L3412"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_ABSOLUTE = <span class="tok-number">0</span>;</span>
<span class="line" id="L3413"><span class="tok-comment">/// \Registry\Machine\System\CurrentControlSet\Services</span></span>
<span class="line" id="L3414"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_SERVICES = <span class="tok-number">1</span>;</span>
<span class="line" id="L3415"><span class="tok-comment">/// \Registry\Machine\System\CurrentControlSet\Control</span></span>
<span class="line" id="L3416"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_CONTROL = <span class="tok-number">2</span>;</span>
<span class="line" id="L3417"><span class="tok-comment">/// \Registry\Machine\Software\Microsoft\Windows NT\CurrentVersion</span></span>
<span class="line" id="L3418"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_WINDOWS_NT = <span class="tok-number">3</span>;</span>
<span class="line" id="L3419"><span class="tok-comment">/// \Registry\Machine\Hardware\DeviceMap</span></span>
<span class="line" id="L3420"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_DEVICEMAP = <span class="tok-number">4</span>;</span>
<span class="line" id="L3421"><span class="tok-comment">/// \Registry\User\CurrentUser</span></span>
<span class="line" id="L3422"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_USER = <span class="tok-number">5</span>;</span>
<span class="line" id="L3423"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_MAXIMUM = <span class="tok-number">6</span>;</span>
<span class="line" id="L3424"></span>
<span class="line" id="L3425"><span class="tok-comment">/// Low order bits are registry handle</span></span>
<span class="line" id="L3426"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_HANDLE = <span class="tok-number">0x40000000</span>;</span>
<span class="line" id="L3427"><span class="tok-comment">/// Indicates the key node is optional</span></span>
<span class="line" id="L3428"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_REGISTRY_OPTIONAL = <span class="tok-number">0x80000000</span>;</span>
<span class="line" id="L3429"></span>
<span class="line" id="L3430"><span class="tok-comment">/// Name is a subkey and remainder of table or until next subkey are value</span></span>
<span class="line" id="L3431"><span class="tok-comment">/// names for that subkey to look at.</span></span>
<span class="line" id="L3432"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_SUBKEY = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3433"></span>
<span class="line" id="L3434"><span class="tok-comment">/// Reset current key to original key for this and all following table entries.</span></span>
<span class="line" id="L3435"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_TOPKEY = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L3436"></span>
<span class="line" id="L3437"><span class="tok-comment">/// Fail if no match found for this table entry.</span></span>
<span class="line" id="L3438"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_REQUIRED = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L3439"></span>
<span class="line" id="L3440"><span class="tok-comment">/// Used to mark a table entry that has no value name, just wants a call out, not</span></span>
<span class="line" id="L3441"><span class="tok-comment">/// an enumeration of all values.</span></span>
<span class="line" id="L3442"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_NOVALUE = <span class="tok-number">0x00000008</span>;</span>
<span class="line" id="L3443"></span>
<span class="line" id="L3444"><span class="tok-comment">/// Used to suppress the expansion of REG_MULTI_SZ into multiple callouts or</span></span>
<span class="line" id="L3445"><span class="tok-comment">/// to prevent the expansion of environment variable values in REG_EXPAND_SZ.</span></span>
<span class="line" id="L3446"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_NOEXPAND = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L3447"></span>
<span class="line" id="L3448"><span class="tok-comment">/// QueryRoutine field ignored.  EntryContext field points to location to store value.</span></span>
<span class="line" id="L3449"><span class="tok-comment">/// For null terminated strings, EntryContext points to UNICODE_STRING structure that</span></span>
<span class="line" id="L3450"><span class="tok-comment">/// that describes maximum size of buffer. If .Buffer field is NULL then a buffer is</span></span>
<span class="line" id="L3451"><span class="tok-comment">/// allocated.</span></span>
<span class="line" id="L3452"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_DIRECT = <span class="tok-number">0x00000020</span>;</span>
<span class="line" id="L3453"></span>
<span class="line" id="L3454"><span class="tok-comment">/// Used to delete value keys after they are queried.</span></span>
<span class="line" id="L3455"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_DELETE = <span class="tok-number">0x00000040</span>;</span>
<span class="line" id="L3456"></span>
<span class="line" id="L3457"><span class="tok-comment">/// Use this flag with the RTL_QUERY_REGISTRY_DIRECT flag to verify that the REG_XXX type</span></span>
<span class="line" id="L3458"><span class="tok-comment">/// of the stored registry value matches the type expected by the caller.</span></span>
<span class="line" id="L3459"><span class="tok-comment">/// If the types do not match, the call fails.</span></span>
<span class="line" id="L3460"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_QUERY_REGISTRY_TYPECHECK = <span class="tok-number">0x00000100</span>;</span>
<span class="line" id="L3461"></span>
<span class="line" id="L3462"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> REG = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3463">    <span class="tok-comment">/// No value type</span></span>
<span class="line" id="L3464">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> NONE: ULONG = <span class="tok-number">0</span>;</span>
<span class="line" id="L3465">    <span class="tok-comment">/// Unicode nul terminated string</span></span>
<span class="line" id="L3466">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> SZ: ULONG = <span class="tok-number">1</span>;</span>
<span class="line" id="L3467">    <span class="tok-comment">/// Unicode nul terminated string (with environment variable references)</span></span>
<span class="line" id="L3468">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXPAND_SZ: ULONG = <span class="tok-number">2</span>;</span>
<span class="line" id="L3469">    <span class="tok-comment">/// Free form binary</span></span>
<span class="line" id="L3470">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> BINARY: ULONG = <span class="tok-number">3</span>;</span>
<span class="line" id="L3471">    <span class="tok-comment">/// 32-bit number</span></span>
<span class="line" id="L3472">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DWORD: ULONG = <span class="tok-number">4</span>;</span>
<span class="line" id="L3473">    <span class="tok-comment">/// 32-bit number (same as REG_DWORD)</span></span>
<span class="line" id="L3474">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DWORD_LITTLE_ENDIAN: ULONG = <span class="tok-number">4</span>;</span>
<span class="line" id="L3475">    <span class="tok-comment">/// 32-bit number</span></span>
<span class="line" id="L3476">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DWORD_BIG_ENDIAN: ULONG = <span class="tok-number">5</span>;</span>
<span class="line" id="L3477">    <span class="tok-comment">/// Symbolic Link (unicode)</span></span>
<span class="line" id="L3478">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> LINK: ULONG = <span class="tok-number">6</span>;</span>
<span class="line" id="L3479">    <span class="tok-comment">/// Multiple Unicode strings</span></span>
<span class="line" id="L3480">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> MULTI_SZ: ULONG = <span class="tok-number">7</span>;</span>
<span class="line" id="L3481">    <span class="tok-comment">/// Resource list in the resource map</span></span>
<span class="line" id="L3482">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> RESOURCE_LIST: ULONG = <span class="tok-number">8</span>;</span>
<span class="line" id="L3483">    <span class="tok-comment">/// Resource list in the hardware description</span></span>
<span class="line" id="L3484">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> FULL_RESOURCE_DESCRIPTOR: ULONG = <span class="tok-number">9</span>;</span>
<span class="line" id="L3485">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> RESOURCE_REQUIREMENTS_LIST: ULONG = <span class="tok-number">10</span>;</span>
<span class="line" id="L3486">    <span class="tok-comment">/// 64-bit number</span></span>
<span class="line" id="L3487">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> QWORD: ULONG = <span class="tok-number">11</span>;</span>
<span class="line" id="L3488">    <span class="tok-comment">/// 64-bit number (same as REG_QWORD)</span></span>
<span class="line" id="L3489">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> QWORD_LITTLE_ENDIAN: ULONG = <span class="tok-number">11</span>;</span>
<span class="line" id="L3490">};</span>
<span class="line" id="L3491"></span>
<span class="line" id="L3492"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3493">    NextEntryOffset: DWORD,</span>
<span class="line" id="L3494">    Action: DWORD,</span>
<span class="line" id="L3495">    FileNameLength: DWORD,</span>
<span class="line" id="L3496">    <span class="tok-comment">// Flexible array member</span>
</span>
<span class="line" id="L3497">    <span class="tok-comment">// FileName: [1]WCHAR,</span>
</span>
<span class="line" id="L3498">};</span>
<span class="line" id="L3499"></span>
<span class="line" id="L3500"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ACTION_ADDED = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L3501"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ACTION_REMOVED = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L3502"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ACTION_MODIFIED = <span class="tok-number">0x00000003</span>;</span>
<span class="line" id="L3503"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ACTION_RENAMED_OLD_NAME = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L3504"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_ACTION_RENAMED_NEW_NAME = <span class="tok-number">0x00000005</span>;</span>
<span class="line" id="L3505"></span>
<span class="line" id="L3506"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LPOVERLAPPED_COMPLETION_ROUTINE = ?*<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (DWORD, DWORD, *OVERLAPPED) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">void</span>;</span>
<span class="line" id="L3507"></span>
<span class="line" id="L3508"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_CREATION = <span class="tok-number">64</span>;</span>
<span class="line" id="L3509"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_SIZE = <span class="tok-number">8</span>;</span>
<span class="line" id="L3510"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_SECURITY = <span class="tok-number">256</span>;</span>
<span class="line" id="L3511"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_LAST_ACCESS = <span class="tok-number">32</span>;</span>
<span class="line" id="L3512"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_LAST_WRITE = <span class="tok-number">16</span>;</span>
<span class="line" id="L3513"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_DIR_NAME = <span class="tok-number">2</span>;</span>
<span class="line" id="L3514"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_FILE_NAME = <span class="tok-number">1</span>;</span>
<span class="line" id="L3515"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_NOTIFY_CHANGE_ATTRIBUTES = <span class="tok-number">4</span>;</span>
<span class="line" id="L3516"></span>
<span class="line" id="L3517"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CONSOLE_SCREEN_BUFFER_INFO = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3518">    dwSize: COORD,</span>
<span class="line" id="L3519">    dwCursorPosition: COORD,</span>
<span class="line" id="L3520">    wAttributes: WORD,</span>
<span class="line" id="L3521">    srWindow: SMALL_RECT,</span>
<span class="line" id="L3522">    dwMaximumWindowSize: COORD,</span>
<span class="line" id="L3523">};</span>
<span class="line" id="L3524"></span>
<span class="line" id="L3525"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ENABLE_VIRTUAL_TERMINAL_PROCESSING = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L3526"></span>
<span class="line" id="L3527"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FOREGROUND_BLUE = <span class="tok-number">1</span>;</span>
<span class="line" id="L3528"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FOREGROUND_GREEN = <span class="tok-number">2</span>;</span>
<span class="line" id="L3529"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FOREGROUND_RED = <span class="tok-number">4</span>;</span>
<span class="line" id="L3530"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FOREGROUND_INTENSITY = <span class="tok-number">8</span>;</span>
<span class="line" id="L3531"></span>
<span class="line" id="L3532"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LIST_ENTRY = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3533">    Flink: *LIST_ENTRY,</span>
<span class="line" id="L3534">    Blink: *LIST_ENTRY,</span>
<span class="line" id="L3535">};</span>
<span class="line" id="L3536"></span>
<span class="line" id="L3537"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_CRITICAL_SECTION_DEBUG = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3538">    Type: WORD,</span>
<span class="line" id="L3539">    CreatorBackTraceIndex: WORD,</span>
<span class="line" id="L3540">    CriticalSection: *RTL_CRITICAL_SECTION,</span>
<span class="line" id="L3541">    ProcessLocksList: LIST_ENTRY,</span>
<span class="line" id="L3542">    EntryCount: DWORD,</span>
<span class="line" id="L3543">    ContentionCount: DWORD,</span>
<span class="line" id="L3544">    Flags: DWORD,</span>
<span class="line" id="L3545">    CreatorBackTraceIndexHigh: WORD,</span>
<span class="line" id="L3546">    SpareWORD: WORD,</span>
<span class="line" id="L3547">};</span>
<span class="line" id="L3548"></span>
<span class="line" id="L3549"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_CRITICAL_SECTION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3550">    DebugInfo: *RTL_CRITICAL_SECTION_DEBUG,</span>
<span class="line" id="L3551">    LockCount: LONG,</span>
<span class="line" id="L3552">    RecursionCount: LONG,</span>
<span class="line" id="L3553">    OwningThread: HANDLE,</span>
<span class="line" id="L3554">    LockSemaphore: HANDLE,</span>
<span class="line" id="L3555">    SpinCount: ULONG_PTR,</span>
<span class="line" id="L3556">};</span>
<span class="line" id="L3557"></span>
<span class="line" id="L3558"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CRITICAL_SECTION = RTL_CRITICAL_SECTION;</span>
<span class="line" id="L3559"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INIT_ONCE = RTL_RUN_ONCE;</span>
<span class="line" id="L3560"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INIT_ONCE_STATIC_INIT = RTL_RUN_ONCE_INIT;</span>
<span class="line" id="L3561"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> INIT_ONCE_FN = *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (InitOnce: *INIT_ONCE, Parameter: ?*<span class="tok-type">anyopaque</span>, Context: ?*<span class="tok-type">anyopaque</span>) <span class="tok-kw">callconv</span>(.C) BOOL;</span>
<span class="line" id="L3562"></span>
<span class="line" id="L3563"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_RUN_ONCE = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3564">    Ptr: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3565">};</span>
<span class="line" id="L3566"></span>
<span class="line" id="L3567"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_RUN_ONCE_INIT = RTL_RUN_ONCE{ .Ptr = <span class="tok-null">null</span> };</span>
<span class="line" id="L3568"></span>
<span class="line" id="L3569"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> COINIT = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3570">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> APARTMENTTHREADED = <span class="tok-number">2</span>;</span>
<span class="line" id="L3571">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> MULTITHREADED = <span class="tok-number">0</span>;</span>
<span class="line" id="L3572">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DISABLE_OLE1DDE = <span class="tok-number">4</span>;</span>
<span class="line" id="L3573">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> SPEED_OVER_MEMORY = <span class="tok-number">8</span>;</span>
<span class="line" id="L3574">};</span>
<span class="line" id="L3575"></span>
<span class="line" id="L3576"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEMORY_BASIC_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3577">    BaseAddress: PVOID,</span>
<span class="line" id="L3578">    AllocationBase: PVOID,</span>
<span class="line" id="L3579">    AllocationProtect: DWORD,</span>
<span class="line" id="L3580">    PartitionId: WORD,</span>
<span class="line" id="L3581">    RegionSize: SIZE_T,</span>
<span class="line" id="L3582">    State: DWORD,</span>
<span class="line" id="L3583">    Protect: DWORD,</span>
<span class="line" id="L3584">    Type: DWORD,</span>
<span class="line" id="L3585">};</span>
<span class="line" id="L3586"></span>
<span class="line" id="L3587"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PMEMORY_BASIC_INFORMATION = *MEMORY_BASIC_INFORMATION;</span>
<span class="line" id="L3588"></span>
<span class="line" id="L3589"><span class="tok-comment">/// &gt; The maximum path of 32,767 characters is approximate, because the &quot;\\?\&quot;</span></span>
<span class="line" id="L3590"><span class="tok-comment">/// &gt; prefix may be expanded to a longer string by the system at run time, and</span></span>
<span class="line" id="L3591"><span class="tok-comment">/// &gt; this expansion applies to the total length.</span></span>
<span class="line" id="L3592"><span class="tok-comment">/// from https://docs.microsoft.com/en-us/windows/desktop/FileIO/naming-a-file#maximum-path-length-limitation</span></span>
<span class="line" id="L3593"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PATH_MAX_WIDE = <span class="tok-number">32767</span>;</span>
<span class="line" id="L3594"></span>
<span class="line" id="L3595"><span class="tok-comment">/// &gt; [Each file name component can be] up to the value returned in the</span></span>
<span class="line" id="L3596"><span class="tok-comment">/// &gt; lpMaximumComponentLength parameter of the GetVolumeInformation function</span></span>
<span class="line" id="L3597"><span class="tok-comment">/// &gt; (this value is commonly 255 characters)</span></span>
<span class="line" id="L3598"><span class="tok-comment">/// from https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation</span></span>
<span class="line" id="L3599"><span class="tok-comment">///</span></span>
<span class="line" id="L3600"><span class="tok-comment">/// &gt; The value that is stored in the variable that *lpMaximumComponentLength points to is</span></span>
<span class="line" id="L3601"><span class="tok-comment">/// &gt; used to indicate that a specified file system supports long names. For example, for</span></span>
<span class="line" id="L3602"><span class="tok-comment">/// &gt; a FAT file system that supports long names, the function stores the value 255, rather</span></span>
<span class="line" id="L3603"><span class="tok-comment">/// &gt; than the previous 8.3 indicator. Long names can also be supported on systems that use</span></span>
<span class="line" id="L3604"><span class="tok-comment">/// &gt; the NTFS file system.</span></span>
<span class="line" id="L3605"><span class="tok-comment">/// from https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getvolumeinformationw</span></span>
<span class="line" id="L3606"><span class="tok-comment">///</span></span>
<span class="line" id="L3607"><span class="tok-comment">/// The assumption being made here is that while lpMaximumComponentLength may vary, it will never</span></span>
<span class="line" id="L3608"><span class="tok-comment">/// be larger than 255.</span></span>
<span class="line" id="L3609"><span class="tok-comment">///</span></span>
<span class="line" id="L3610"><span class="tok-comment">/// TODO: More verification of this assumption.</span></span>
<span class="line" id="L3611"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NAME_MAX = <span class="tok-number">255</span>;</span>
<span class="line" id="L3612"></span>
<span class="line" id="L3613"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_ALLOCATE_BUFFER = <span class="tok-number">0x00000100</span>;</span>
<span class="line" id="L3614"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_ARGUMENT_ARRAY = <span class="tok-number">0x00002000</span>;</span>
<span class="line" id="L3615"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_FROM_HMODULE = <span class="tok-number">0x00000800</span>;</span>
<span class="line" id="L3616"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_FROM_STRING = <span class="tok-number">0x00000400</span>;</span>
<span class="line" id="L3617"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_FROM_SYSTEM = <span class="tok-number">0x00001000</span>;</span>
<span class="line" id="L3618"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_IGNORE_INSERTS = <span class="tok-number">0x00000200</span>;</span>
<span class="line" id="L3619"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FORMAT_MESSAGE_MAX_WIDTH_MASK = <span class="tok-number">0x000000FF</span>;</span>
<span class="line" id="L3620"></span>
<span class="line" id="L3621"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_DATATYPE_MISALIGNMENT = <span class="tok-number">0x80000002</span>;</span>
<span class="line" id="L3622"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_ACCESS_VIOLATION = <span class="tok-number">0xc0000005</span>;</span>
<span class="line" id="L3623"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_ILLEGAL_INSTRUCTION = <span class="tok-number">0xc000001d</span>;</span>
<span class="line" id="L3624"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_STACK_OVERFLOW = <span class="tok-number">0xc00000fd</span>;</span>
<span class="line" id="L3625"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_CONTINUE_SEARCH = <span class="tok-number">0</span>;</span>
<span class="line" id="L3626"></span>
<span class="line" id="L3627"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_RECORD = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3628">    ExceptionCode: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3629">    ExceptionFlags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3630">    ExceptionRecord: *EXCEPTION_RECORD,</span>
<span class="line" id="L3631">    ExceptionAddress: *<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3632">    NumberParameters: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3633">    ExceptionInformation: [<span class="tok-number">15</span>]<span class="tok-type">usize</span>,</span>
<span class="line" id="L3634">};</span>
<span class="line" id="L3635"></span>
<span class="line" id="L3636"><span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-kw">switch</span> (native_arch) {</span>
<span class="line" id="L3637">    .x86 =&gt; <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3638">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> FLOATING_SAVE_AREA = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3639">            ControlWord: DWORD,</span>
<span class="line" id="L3640">            StatusWord: DWORD,</span>
<span class="line" id="L3641">            TagWord: DWORD,</span>
<span class="line" id="L3642">            ErrorOffset: DWORD,</span>
<span class="line" id="L3643">            ErrorSelector: DWORD,</span>
<span class="line" id="L3644">            DataOffset: DWORD,</span>
<span class="line" id="L3645">            DataSelector: DWORD,</span>
<span class="line" id="L3646">            RegisterArea: [<span class="tok-number">80</span>]BYTE,</span>
<span class="line" id="L3647">            Cr0NpxState: DWORD,</span>
<span class="line" id="L3648">        };</span>
<span class="line" id="L3649"></span>
<span class="line" id="L3650">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> CONTEXT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3651">            ContextFlags: DWORD,</span>
<span class="line" id="L3652">            Dr0: DWORD,</span>
<span class="line" id="L3653">            Dr1: DWORD,</span>
<span class="line" id="L3654">            Dr2: DWORD,</span>
<span class="line" id="L3655">            Dr3: DWORD,</span>
<span class="line" id="L3656">            Dr6: DWORD,</span>
<span class="line" id="L3657">            Dr7: DWORD,</span>
<span class="line" id="L3658">            FloatSave: FLOATING_SAVE_AREA,</span>
<span class="line" id="L3659">            SegGs: DWORD,</span>
<span class="line" id="L3660">            SegFs: DWORD,</span>
<span class="line" id="L3661">            SegEs: DWORD,</span>
<span class="line" id="L3662">            SegDs: DWORD,</span>
<span class="line" id="L3663">            Edi: DWORD,</span>
<span class="line" id="L3664">            Esi: DWORD,</span>
<span class="line" id="L3665">            Ebx: DWORD,</span>
<span class="line" id="L3666">            Edx: DWORD,</span>
<span class="line" id="L3667">            Ecx: DWORD,</span>
<span class="line" id="L3668">            Eax: DWORD,</span>
<span class="line" id="L3669">            Ebp: DWORD,</span>
<span class="line" id="L3670">            Eip: DWORD,</span>
<span class="line" id="L3671">            SegCs: DWORD,</span>
<span class="line" id="L3672">            EFlags: DWORD,</span>
<span class="line" id="L3673">            Esp: DWORD,</span>
<span class="line" id="L3674">            SegSs: DWORD,</span>
<span class="line" id="L3675">            ExtendedRegisters: [<span class="tok-number">512</span>]BYTE,</span>
<span class="line" id="L3676"></span>
<span class="line" id="L3677">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getRegs</span>(ctx: *<span class="tok-kw">const</span> CONTEXT) <span class="tok-kw">struct</span> { bp: <span class="tok-type">usize</span>, ip: <span class="tok-type">usize</span> } {</span>
<span class="line" id="L3678">                <span class="tok-kw">return</span> .{ .bp = ctx.Ebp, .ip = ctx.Eip };</span>
<span class="line" id="L3679">            }</span>
<span class="line" id="L3680">        };</span>
<span class="line" id="L3681">    },</span>
<span class="line" id="L3682">    .x86_64 =&gt; <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3683">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> M128A = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3684">            Low: ULONGLONG,</span>
<span class="line" id="L3685">            High: LONGLONG,</span>
<span class="line" id="L3686">        };</span>
<span class="line" id="L3687"></span>
<span class="line" id="L3688">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> XMM_SAVE_AREA32 = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3689">            ControlWord: WORD,</span>
<span class="line" id="L3690">            StatusWord: WORD,</span>
<span class="line" id="L3691">            TagWord: BYTE,</span>
<span class="line" id="L3692">            Reserved1: BYTE,</span>
<span class="line" id="L3693">            ErrorOpcode: WORD,</span>
<span class="line" id="L3694">            ErrorOffset: DWORD,</span>
<span class="line" id="L3695">            ErrorSelector: WORD,</span>
<span class="line" id="L3696">            Reserved2: WORD,</span>
<span class="line" id="L3697">            DataOffset: DWORD,</span>
<span class="line" id="L3698">            DataSelector: WORD,</span>
<span class="line" id="L3699">            Reserved3: WORD,</span>
<span class="line" id="L3700">            MxCsr: DWORD,</span>
<span class="line" id="L3701">            MxCsr_Mask: DWORD,</span>
<span class="line" id="L3702">            FloatRegisters: [<span class="tok-number">8</span>]M128A,</span>
<span class="line" id="L3703">            XmmRegisters: [<span class="tok-number">16</span>]M128A,</span>
<span class="line" id="L3704">            Reserved4: [<span class="tok-number">96</span>]BYTE,</span>
<span class="line" id="L3705">        };</span>
<span class="line" id="L3706"></span>
<span class="line" id="L3707">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> CONTEXT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3708">            P1Home: DWORD64 <span class="tok-kw">align</span>(<span class="tok-number">16</span>),</span>
<span class="line" id="L3709">            P2Home: DWORD64,</span>
<span class="line" id="L3710">            P3Home: DWORD64,</span>
<span class="line" id="L3711">            P4Home: DWORD64,</span>
<span class="line" id="L3712">            P5Home: DWORD64,</span>
<span class="line" id="L3713">            P6Home: DWORD64,</span>
<span class="line" id="L3714">            ContextFlags: DWORD,</span>
<span class="line" id="L3715">            MxCsr: DWORD,</span>
<span class="line" id="L3716">            SegCs: WORD,</span>
<span class="line" id="L3717">            SegDs: WORD,</span>
<span class="line" id="L3718">            SegEs: WORD,</span>
<span class="line" id="L3719">            SegFs: WORD,</span>
<span class="line" id="L3720">            SegGs: WORD,</span>
<span class="line" id="L3721">            SegSs: WORD,</span>
<span class="line" id="L3722">            EFlags: DWORD,</span>
<span class="line" id="L3723">            Dr0: DWORD64,</span>
<span class="line" id="L3724">            Dr1: DWORD64,</span>
<span class="line" id="L3725">            Dr2: DWORD64,</span>
<span class="line" id="L3726">            Dr3: DWORD64,</span>
<span class="line" id="L3727">            Dr6: DWORD64,</span>
<span class="line" id="L3728">            Dr7: DWORD64,</span>
<span class="line" id="L3729">            Rax: DWORD64,</span>
<span class="line" id="L3730">            Rcx: DWORD64,</span>
<span class="line" id="L3731">            Rdx: DWORD64,</span>
<span class="line" id="L3732">            Rbx: DWORD64,</span>
<span class="line" id="L3733">            Rsp: DWORD64,</span>
<span class="line" id="L3734">            Rbp: DWORD64,</span>
<span class="line" id="L3735">            Rsi: DWORD64,</span>
<span class="line" id="L3736">            Rdi: DWORD64,</span>
<span class="line" id="L3737">            R8: DWORD64,</span>
<span class="line" id="L3738">            R9: DWORD64,</span>
<span class="line" id="L3739">            R10: DWORD64,</span>
<span class="line" id="L3740">            R11: DWORD64,</span>
<span class="line" id="L3741">            R12: DWORD64,</span>
<span class="line" id="L3742">            R13: DWORD64,</span>
<span class="line" id="L3743">            R14: DWORD64,</span>
<span class="line" id="L3744">            R15: DWORD64,</span>
<span class="line" id="L3745">            Rip: DWORD64,</span>
<span class="line" id="L3746">            DUMMYUNIONNAME: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L3747">                FltSave: XMM_SAVE_AREA32,</span>
<span class="line" id="L3748">                FloatSave: XMM_SAVE_AREA32,</span>
<span class="line" id="L3749">                DUMMYSTRUCTNAME: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3750">                    Header: [<span class="tok-number">2</span>]M128A,</span>
<span class="line" id="L3751">                    Legacy: [<span class="tok-number">8</span>]M128A,</span>
<span class="line" id="L3752">                    Xmm0: M128A,</span>
<span class="line" id="L3753">                    Xmm1: M128A,</span>
<span class="line" id="L3754">                    Xmm2: M128A,</span>
<span class="line" id="L3755">                    Xmm3: M128A,</span>
<span class="line" id="L3756">                    Xmm4: M128A,</span>
<span class="line" id="L3757">                    Xmm5: M128A,</span>
<span class="line" id="L3758">                    Xmm6: M128A,</span>
<span class="line" id="L3759">                    Xmm7: M128A,</span>
<span class="line" id="L3760">                    Xmm8: M128A,</span>
<span class="line" id="L3761">                    Xmm9: M128A,</span>
<span class="line" id="L3762">                    Xmm10: M128A,</span>
<span class="line" id="L3763">                    Xmm11: M128A,</span>
<span class="line" id="L3764">                    Xmm12: M128A,</span>
<span class="line" id="L3765">                    Xmm13: M128A,</span>
<span class="line" id="L3766">                    Xmm14: M128A,</span>
<span class="line" id="L3767">                    Xmm15: M128A,</span>
<span class="line" id="L3768">                },</span>
<span class="line" id="L3769">            },</span>
<span class="line" id="L3770">            VectorRegister: [<span class="tok-number">26</span>]M128A,</span>
<span class="line" id="L3771">            VectorControl: DWORD64,</span>
<span class="line" id="L3772">            DebugControl: DWORD64,</span>
<span class="line" id="L3773">            LastBranchToRip: DWORD64,</span>
<span class="line" id="L3774">            LastBranchFromRip: DWORD64,</span>
<span class="line" id="L3775">            LastExceptionToRip: DWORD64,</span>
<span class="line" id="L3776">            LastExceptionFromRip: DWORD64,</span>
<span class="line" id="L3777"></span>
<span class="line" id="L3778">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getRegs</span>(ctx: *<span class="tok-kw">const</span> CONTEXT) <span class="tok-kw">struct</span> { bp: <span class="tok-type">usize</span>, ip: <span class="tok-type">usize</span>, sp: <span class="tok-type">usize</span> } {</span>
<span class="line" id="L3779">                <span class="tok-kw">return</span> .{ .bp = ctx.Rbp, .ip = ctx.Rip, .sp = ctx.Rsp };</span>
<span class="line" id="L3780">            }</span>
<span class="line" id="L3781"></span>
<span class="line" id="L3782">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setIp</span>(ctx: *CONTEXT, ip: <span class="tok-type">usize</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3783">                ctx.Rip = ip;</span>
<span class="line" id="L3784">            }</span>
<span class="line" id="L3785"></span>
<span class="line" id="L3786">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setSp</span>(ctx: *CONTEXT, sp: <span class="tok-type">usize</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3787">                ctx.Rsp = sp;</span>
<span class="line" id="L3788">            }</span>
<span class="line" id="L3789">        };</span>
<span class="line" id="L3790"></span>
<span class="line" id="L3791">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> RUNTIME_FUNCTION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3792">            BeginAddress: DWORD,</span>
<span class="line" id="L3793">            EndAddress: DWORD,</span>
<span class="line" id="L3794">            UnwindData: DWORD,</span>
<span class="line" id="L3795">        };</span>
<span class="line" id="L3796"></span>
<span class="line" id="L3797">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> KNONVOLATILE_CONTEXT_POINTERS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3798">            FloatingContext: [<span class="tok-number">16</span>]?*M128A,</span>
<span class="line" id="L3799">            IntegerContext: [<span class="tok-number">16</span>]?*ULONG64,</span>
<span class="line" id="L3800">        };</span>
<span class="line" id="L3801">    },</span>
<span class="line" id="L3802">    .aarch64 =&gt; <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3803">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> NEON128 = <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L3804">            DUMMYSTRUCTNAME: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3805">                Low: ULONGLONG,</span>
<span class="line" id="L3806">                High: LONGLONG,</span>
<span class="line" id="L3807">            },</span>
<span class="line" id="L3808">            D: [<span class="tok-number">2</span>]<span class="tok-type">f64</span>,</span>
<span class="line" id="L3809">            S: [<span class="tok-number">4</span>]<span class="tok-type">f32</span>,</span>
<span class="line" id="L3810">            H: [<span class="tok-number">8</span>]WORD,</span>
<span class="line" id="L3811">            B: [<span class="tok-number">16</span>]BYTE,</span>
<span class="line" id="L3812">        };</span>
<span class="line" id="L3813"></span>
<span class="line" id="L3814">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> CONTEXT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3815">            ContextFlags: ULONG <span class="tok-kw">align</span>(<span class="tok-number">16</span>),</span>
<span class="line" id="L3816">            Cpsr: ULONG,</span>
<span class="line" id="L3817">            DUMMYUNIONNAME: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L3818">                DUMMYSTRUCTNAME: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3819">                    X0: DWORD64,</span>
<span class="line" id="L3820">                    X1: DWORD64,</span>
<span class="line" id="L3821">                    X2: DWORD64,</span>
<span class="line" id="L3822">                    X3: DWORD64,</span>
<span class="line" id="L3823">                    X4: DWORD64,</span>
<span class="line" id="L3824">                    X5: DWORD64,</span>
<span class="line" id="L3825">                    X6: DWORD64,</span>
<span class="line" id="L3826">                    X7: DWORD64,</span>
<span class="line" id="L3827">                    X8: DWORD64,</span>
<span class="line" id="L3828">                    X9: DWORD64,</span>
<span class="line" id="L3829">                    X10: DWORD64,</span>
<span class="line" id="L3830">                    X11: DWORD64,</span>
<span class="line" id="L3831">                    X12: DWORD64,</span>
<span class="line" id="L3832">                    X13: DWORD64,</span>
<span class="line" id="L3833">                    X14: DWORD64,</span>
<span class="line" id="L3834">                    X15: DWORD64,</span>
<span class="line" id="L3835">                    X16: DWORD64,</span>
<span class="line" id="L3836">                    X17: DWORD64,</span>
<span class="line" id="L3837">                    X18: DWORD64,</span>
<span class="line" id="L3838">                    X19: DWORD64,</span>
<span class="line" id="L3839">                    X20: DWORD64,</span>
<span class="line" id="L3840">                    X21: DWORD64,</span>
<span class="line" id="L3841">                    X22: DWORD64,</span>
<span class="line" id="L3842">                    X23: DWORD64,</span>
<span class="line" id="L3843">                    X24: DWORD64,</span>
<span class="line" id="L3844">                    X25: DWORD64,</span>
<span class="line" id="L3845">                    X26: DWORD64,</span>
<span class="line" id="L3846">                    X27: DWORD64,</span>
<span class="line" id="L3847">                    X28: DWORD64,</span>
<span class="line" id="L3848">                    Fp: DWORD64,</span>
<span class="line" id="L3849">                    Lr: DWORD64,</span>
<span class="line" id="L3850">                },</span>
<span class="line" id="L3851">                X: [<span class="tok-number">31</span>]DWORD64,</span>
<span class="line" id="L3852">            },</span>
<span class="line" id="L3853">            Sp: DWORD64,</span>
<span class="line" id="L3854">            Pc: DWORD64,</span>
<span class="line" id="L3855">            V: [<span class="tok-number">32</span>]NEON128,</span>
<span class="line" id="L3856">            Fpcr: DWORD,</span>
<span class="line" id="L3857">            Fpsr: DWORD,</span>
<span class="line" id="L3858">            Bcr: [<span class="tok-number">8</span>]DWORD,</span>
<span class="line" id="L3859">            Bvr: [<span class="tok-number">8</span>]DWORD64,</span>
<span class="line" id="L3860">            Wcr: [<span class="tok-number">2</span>]DWORD,</span>
<span class="line" id="L3861">            Wvr: [<span class="tok-number">2</span>]DWORD64,</span>
<span class="line" id="L3862"></span>
<span class="line" id="L3863">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getRegs</span>(ctx: *<span class="tok-kw">const</span> CONTEXT) <span class="tok-kw">struct</span> { bp: <span class="tok-type">usize</span>, ip: <span class="tok-type">usize</span>, sp: <span class="tok-type">usize</span> } {</span>
<span class="line" id="L3864">                <span class="tok-kw">return</span> .{</span>
<span class="line" id="L3865">                    .bp = ctx.DUMMYUNIONNAME.DUMMYSTRUCTNAME.Fp,</span>
<span class="line" id="L3866">                    .ip = ctx.Pc,</span>
<span class="line" id="L3867">                    .sp = ctx.Sp,</span>
<span class="line" id="L3868">                };</span>
<span class="line" id="L3869">            }</span>
<span class="line" id="L3870"></span>
<span class="line" id="L3871">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setIp</span>(ctx: *CONTEXT, ip: <span class="tok-type">usize</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3872">                ctx.Pc = ip;</span>
<span class="line" id="L3873">            }</span>
<span class="line" id="L3874"></span>
<span class="line" id="L3875">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setSp</span>(ctx: *CONTEXT, sp: <span class="tok-type">usize</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3876">                ctx.Sp = sp;</span>
<span class="line" id="L3877">            }</span>
<span class="line" id="L3878">        };</span>
<span class="line" id="L3879"></span>
<span class="line" id="L3880">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> RUNTIME_FUNCTION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3881">            BeginAddress: DWORD,</span>
<span class="line" id="L3882">            DUMMYUNIONNAME: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L3883">                UnwindData: DWORD,</span>
<span class="line" id="L3884">                DUMMYSTRUCTNAME: <span class="tok-kw">packed</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3885">                    Flag: <span class="tok-type">u2</span>,</span>
<span class="line" id="L3886">                    FunctionLength: <span class="tok-type">u11</span>,</span>
<span class="line" id="L3887">                    RegF: <span class="tok-type">u3</span>,</span>
<span class="line" id="L3888">                    RegI: <span class="tok-type">u4</span>,</span>
<span class="line" id="L3889">                    H: <span class="tok-type">u1</span>,</span>
<span class="line" id="L3890">                    CR: <span class="tok-type">u2</span>,</span>
<span class="line" id="L3891">                    FrameSize: <span class="tok-type">u9</span>,</span>
<span class="line" id="L3892">                },</span>
<span class="line" id="L3893">            },</span>
<span class="line" id="L3894">        };</span>
<span class="line" id="L3895"></span>
<span class="line" id="L3896">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> KNONVOLATILE_CONTEXT_POINTERS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3897">            X19: ?*DWORD64,</span>
<span class="line" id="L3898">            X20: ?*DWORD64,</span>
<span class="line" id="L3899">            X21: ?*DWORD64,</span>
<span class="line" id="L3900">            X22: ?*DWORD64,</span>
<span class="line" id="L3901">            X23: ?*DWORD64,</span>
<span class="line" id="L3902">            X24: ?*DWORD64,</span>
<span class="line" id="L3903">            X25: ?*DWORD64,</span>
<span class="line" id="L3904">            X26: ?*DWORD64,</span>
<span class="line" id="L3905">            X27: ?*DWORD64,</span>
<span class="line" id="L3906">            X28: ?*DWORD64,</span>
<span class="line" id="L3907">            Fp: ?*DWORD64,</span>
<span class="line" id="L3908">            Lr: ?*DWORD64,</span>
<span class="line" id="L3909">            D8: ?*DWORD64,</span>
<span class="line" id="L3910">            D9: ?*DWORD64,</span>
<span class="line" id="L3911">            D10: ?*DWORD64,</span>
<span class="line" id="L3912">            D11: ?*DWORD64,</span>
<span class="line" id="L3913">            D12: ?*DWORD64,</span>
<span class="line" id="L3914">            D13: ?*DWORD64,</span>
<span class="line" id="L3915">            D14: ?*DWORD64,</span>
<span class="line" id="L3916">            D15: ?*DWORD64,</span>
<span class="line" id="L3917">        };</span>
<span class="line" id="L3918">    },</span>
<span class="line" id="L3919">    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">struct</span> {},</span>
<span class="line" id="L3920">};</span>
<span class="line" id="L3921"></span>
<span class="line" id="L3922"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_POINTERS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3923">    ExceptionRecord: *EXCEPTION_RECORD,</span>
<span class="line" id="L3924">    ContextRecord: *std.os.windows.CONTEXT,</span>
<span class="line" id="L3925">};</span>
<span class="line" id="L3926"></span>
<span class="line" id="L3927"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VECTORED_EXCEPTION_HANDLER = *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (ExceptionInfo: *EXCEPTION_POINTERS) <span class="tok-kw">callconv</span>(WINAPI) <span class="tok-type">c_long</span>;</span>
<span class="line" id="L3928"></span>
<span class="line" id="L3929"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_DISPOSITION = <span class="tok-type">i32</span>;</span>
<span class="line" id="L3930"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_ROUTINE = *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (</span>
<span class="line" id="L3931">    ExceptionRecord: ?*EXCEPTION_RECORD,</span>
<span class="line" id="L3932">    EstablisherFrame: PVOID,</span>
<span class="line" id="L3933">    ContextRecord: *(Self.CONTEXT),</span>
<span class="line" id="L3934">    DispatcherContext: PVOID,</span>
<span class="line" id="L3935">) <span class="tok-kw">callconv</span>(WINAPI) EXCEPTION_DISPOSITION;</span>
<span class="line" id="L3936"></span>
<span class="line" id="L3937"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNWIND_HISTORY_TABLE_SIZE = <span class="tok-number">12</span>;</span>
<span class="line" id="L3938"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNWIND_HISTORY_TABLE_ENTRY = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3939">    ImageBase: ULONG64,</span>
<span class="line" id="L3940">    FunctionEntry: *Self.RUNTIME_FUNCTION,</span>
<span class="line" id="L3941">};</span>
<span class="line" id="L3942"></span>
<span class="line" id="L3943"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNWIND_HISTORY_TABLE = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3944">    Count: ULONG,</span>
<span class="line" id="L3945">    LocalHint: BYTE,</span>
<span class="line" id="L3946">    GlobalHint: BYTE,</span>
<span class="line" id="L3947">    Search: BYTE,</span>
<span class="line" id="L3948">    Once: BYTE,</span>
<span class="line" id="L3949">    LowAddress: ULONG64,</span>
<span class="line" id="L3950">    HighAddress: ULONG64,</span>
<span class="line" id="L3951">    Entry: [UNWIND_HISTORY_TABLE_SIZE]UNWIND_HISTORY_TABLE_ENTRY,</span>
<span class="line" id="L3952">};</span>
<span class="line" id="L3953"></span>
<span class="line" id="L3954"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNW_FLAG_NHANDLER = <span class="tok-number">0x0</span>;</span>
<span class="line" id="L3955"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNW_FLAG_EHANDLER = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L3956"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNW_FLAG_UHANDLER = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L3957"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNW_FLAG_CHAININFO = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L3958"></span>
<span class="line" id="L3959"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJECT_ATTRIBUTES = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3960">    Length: ULONG,</span>
<span class="line" id="L3961">    RootDirectory: ?HANDLE,</span>
<span class="line" id="L3962">    ObjectName: *UNICODE_STRING,</span>
<span class="line" id="L3963">    Attributes: ULONG,</span>
<span class="line" id="L3964">    SecurityDescriptor: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3965">    SecurityQualityOfService: ?*<span class="tok-type">anyopaque</span>,</span>
<span class="line" id="L3966">};</span>
<span class="line" id="L3967"></span>
<span class="line" id="L3968"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_INHERIT = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L3969"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_PERMANENT = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L3970"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_EXCLUSIVE = <span class="tok-number">0x00000020</span>;</span>
<span class="line" id="L3971"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_CASE_INSENSITIVE = <span class="tok-number">0x00000040</span>;</span>
<span class="line" id="L3972"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_OPENIF = <span class="tok-number">0x00000080</span>;</span>
<span class="line" id="L3973"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_OPENLINK = <span class="tok-number">0x00000100</span>;</span>
<span class="line" id="L3974"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_KERNEL_HANDLE = <span class="tok-number">0x00000200</span>;</span>
<span class="line" id="L3975"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJ_VALID_ATTRIBUTES = <span class="tok-number">0x000003F2</span>;</span>
<span class="line" id="L3976"></span>
<span class="line" id="L3977"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> UNICODE_STRING = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3978">    Length: <span class="tok-type">c_ushort</span>,</span>
<span class="line" id="L3979">    MaximumLength: <span class="tok-type">c_ushort</span>,</span>
<span class="line" id="L3980">    Buffer: [*]WCHAR,</span>
<span class="line" id="L3981">};</span>
<span class="line" id="L3982"></span>
<span class="line" id="L3983"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ACTIVATION_CONTEXT_DATA = <span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L3984"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ASSEMBLY_STORAGE_MAP = <span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L3985"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FLS_CALLBACK_INFO = <span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L3986"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_BITMAP = <span class="tok-kw">opaque</span> {};</span>
<span class="line" id="L3987"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KAFFINITY = <span class="tok-type">usize</span>;</span>
<span class="line" id="L3988"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KPRIORITY = <span class="tok-type">i32</span>;</span>
<span class="line" id="L3989"></span>
<span class="line" id="L3990"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CLIENT_ID = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3991">    UniqueProcess: HANDLE,</span>
<span class="line" id="L3992">    UniqueThread: HANDLE,</span>
<span class="line" id="L3993">};</span>
<span class="line" id="L3994"></span>
<span class="line" id="L3995"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> THREAD_BASIC_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3996">    ExitStatus: NTSTATUS,</span>
<span class="line" id="L3997">    TebBaseAddress: PVOID,</span>
<span class="line" id="L3998">    ClientId: CLIENT_ID,</span>
<span class="line" id="L3999">    AffinityMask: KAFFINITY,</span>
<span class="line" id="L4000">    Priority: KPRIORITY,</span>
<span class="line" id="L4001">    BasePriority: KPRIORITY,</span>
<span class="line" id="L4002">};</span>
<span class="line" id="L4003"></span>
<span class="line" id="L4004"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TEB = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4005">    Reserved1: [<span class="tok-number">12</span>]PVOID,</span>
<span class="line" id="L4006">    ProcessEnvironmentBlock: *PEB,</span>
<span class="line" id="L4007">    Reserved2: [<span class="tok-number">399</span>]PVOID,</span>
<span class="line" id="L4008">    Reserved3: [<span class="tok-number">1952</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L4009">    TlsSlots: [<span class="tok-number">64</span>]PVOID,</span>
<span class="line" id="L4010">    Reserved4: [<span class="tok-number">8</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L4011">    Reserved5: [<span class="tok-number">26</span>]PVOID,</span>
<span class="line" id="L4012">    ReservedForOle: PVOID,</span>
<span class="line" id="L4013">    Reserved6: [<span class="tok-number">4</span>]PVOID,</span>
<span class="line" id="L4014">    TlsExpansionSlots: PVOID,</span>
<span class="line" id="L4015">};</span>
<span class="line" id="L4016"></span>
<span class="line" id="L4017"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXCEPTION_REGISTRATION_RECORD = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4018">    Next: ?*EXCEPTION_REGISTRATION_RECORD,</span>
<span class="line" id="L4019">    Handler: ?*EXCEPTION_DISPOSITION,</span>
<span class="line" id="L4020">};</span>
<span class="line" id="L4021"></span>
<span class="line" id="L4022"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NT_TIB = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4023">    ExceptionList: ?*EXCEPTION_REGISTRATION_RECORD,</span>
<span class="line" id="L4024">    StackBase: PVOID,</span>
<span class="line" id="L4025">    StackLimit: PVOID,</span>
<span class="line" id="L4026">    SubSystemTib: PVOID,</span>
<span class="line" id="L4027">    DUMMYUNIONNAME: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> { FiberData: PVOID, Version: DWORD },</span>
<span class="line" id="L4028">    ArbitraryUserPointer: PVOID,</span>
<span class="line" id="L4029">    Self: ?*<span class="tok-builtin">@This</span>(),</span>
<span class="line" id="L4030">};</span>
<span class="line" id="L4031"></span>
<span class="line" id="L4032"><span class="tok-comment">/// Process Environment Block</span></span>
<span class="line" id="L4033"><span class="tok-comment">/// Microsoft documentation of this is incomplete, the fields here are taken from various resources including:</span></span>
<span class="line" id="L4034"><span class="tok-comment">///  - https://github.com/wine-mirror/wine/blob/1aff1e6a370ee8c0213a0fd4b220d121da8527aa/include/winternl.h#L269</span></span>
<span class="line" id="L4035"><span class="tok-comment">///  - https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/index.htm</span></span>
<span class="line" id="L4036"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PEB = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4037">    <span class="tok-comment">// Versions: All</span>
</span>
<span class="line" id="L4038">    InheritedAddressSpace: BOOLEAN,</span>
<span class="line" id="L4039"></span>
<span class="line" id="L4040">    <span class="tok-comment">// Versions: 3.51+</span>
</span>
<span class="line" id="L4041">    ReadImageFileExecOptions: BOOLEAN,</span>
<span class="line" id="L4042">    BeingDebugged: BOOLEAN,</span>
<span class="line" id="L4043"></span>
<span class="line" id="L4044">    <span class="tok-comment">// Versions: 5.2+ (previously was padding)</span>
</span>
<span class="line" id="L4045">    BitField: UCHAR,</span>
<span class="line" id="L4046"></span>
<span class="line" id="L4047">    <span class="tok-comment">// Versions: all</span>
</span>
<span class="line" id="L4048">    Mutant: HANDLE,</span>
<span class="line" id="L4049">    ImageBaseAddress: HMODULE,</span>
<span class="line" id="L4050">    Ldr: *PEB_LDR_DATA,</span>
<span class="line" id="L4051">    ProcessParameters: *RTL_USER_PROCESS_PARAMETERS,</span>
<span class="line" id="L4052">    SubSystemData: PVOID,</span>
<span class="line" id="L4053">    ProcessHeap: HANDLE,</span>
<span class="line" id="L4054"></span>
<span class="line" id="L4055">    <span class="tok-comment">// Versions: 5.1+</span>
</span>
<span class="line" id="L4056">    FastPebLock: *RTL_CRITICAL_SECTION,</span>
<span class="line" id="L4057"></span>
<span class="line" id="L4058">    <span class="tok-comment">// Versions: 5.2+</span>
</span>
<span class="line" id="L4059">    AtlThunkSListPtr: PVOID,</span>
<span class="line" id="L4060">    IFEOKey: PVOID,</span>
<span class="line" id="L4061"></span>
<span class="line" id="L4062">    <span class="tok-comment">// Versions: 6.0+</span>
</span>
<span class="line" id="L4063"></span>
<span class="line" id="L4064">    <span class="tok-comment">/// https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/crossprocessflags.htm</span></span>
<span class="line" id="L4065">    CrossProcessFlags: ULONG,</span>
<span class="line" id="L4066"></span>
<span class="line" id="L4067">    <span class="tok-comment">// Versions: 6.0+</span>
</span>
<span class="line" id="L4068">    union1: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4069">        KernelCallbackTable: PVOID,</span>
<span class="line" id="L4070">        UserSharedInfoPtr: PVOID,</span>
<span class="line" id="L4071">    },</span>
<span class="line" id="L4072"></span>
<span class="line" id="L4073">    <span class="tok-comment">// Versions: 5.1+</span>
</span>
<span class="line" id="L4074">    SystemReserved: ULONG,</span>
<span class="line" id="L4075"></span>
<span class="line" id="L4076">    <span class="tok-comment">// Versions: 5.1, (not 5.2, not 6.0), 6.1+</span>
</span>
<span class="line" id="L4077">    AtlThunkSListPtr32: ULONG,</span>
<span class="line" id="L4078"></span>
<span class="line" id="L4079">    <span class="tok-comment">// Versions: 6.1+</span>
</span>
<span class="line" id="L4080">    ApiSetMap: PVOID,</span>
<span class="line" id="L4081"></span>
<span class="line" id="L4082">    <span class="tok-comment">// Versions: all</span>
</span>
<span class="line" id="L4083">    TlsExpansionCounter: ULONG,</span>
<span class="line" id="L4084">    <span class="tok-comment">// note: there is padding here on 64 bit</span>
</span>
<span class="line" id="L4085">    TlsBitmap: *RTL_BITMAP,</span>
<span class="line" id="L4086">    TlsBitmapBits: [<span class="tok-number">2</span>]ULONG,</span>
<span class="line" id="L4087">    ReadOnlySharedMemoryBase: PVOID,</span>
<span class="line" id="L4088"></span>
<span class="line" id="L4089">    <span class="tok-comment">// Versions: 1703+</span>
</span>
<span class="line" id="L4090">    SharedData: PVOID,</span>
<span class="line" id="L4091"></span>
<span class="line" id="L4092">    <span class="tok-comment">// Versions: all</span>
</span>
<span class="line" id="L4093">    ReadOnlyStaticServerData: *PVOID,</span>
<span class="line" id="L4094">    AnsiCodePageData: PVOID,</span>
<span class="line" id="L4095">    OemCodePageData: PVOID,</span>
<span class="line" id="L4096">    UnicodeCaseTableData: PVOID,</span>
<span class="line" id="L4097"></span>
<span class="line" id="L4098">    <span class="tok-comment">// Versions: 3.51+</span>
</span>
<span class="line" id="L4099">    NumberOfProcessors: ULONG,</span>
<span class="line" id="L4100">    NtGlobalFlag: ULONG,</span>
<span class="line" id="L4101"></span>
<span class="line" id="L4102">    <span class="tok-comment">// Versions: all</span>
</span>
<span class="line" id="L4103">    CriticalSectionTimeout: LARGE_INTEGER,</span>
<span class="line" id="L4104"></span>
<span class="line" id="L4105">    <span class="tok-comment">// End of Original PEB size</span>
</span>
<span class="line" id="L4106"></span>
<span class="line" id="L4107">    <span class="tok-comment">// Fields appended in 3.51:</span>
</span>
<span class="line" id="L4108">    HeapSegmentReserve: ULONG_PTR,</span>
<span class="line" id="L4109">    HeapSegmentCommit: ULONG_PTR,</span>
<span class="line" id="L4110">    HeapDeCommitTotalFreeThreshold: ULONG_PTR,</span>
<span class="line" id="L4111">    HeapDeCommitFreeBlockThreshold: ULONG_PTR,</span>
<span class="line" id="L4112">    NumberOfHeaps: ULONG,</span>
<span class="line" id="L4113">    MaximumNumberOfHeaps: ULONG,</span>
<span class="line" id="L4114">    ProcessHeaps: *PVOID,</span>
<span class="line" id="L4115"></span>
<span class="line" id="L4116">    <span class="tok-comment">// Fields appended in 4.0:</span>
</span>
<span class="line" id="L4117">    GdiSharedHandleTable: PVOID,</span>
<span class="line" id="L4118">    ProcessStarterHelper: PVOID,</span>
<span class="line" id="L4119">    GdiDCAttributeList: ULONG,</span>
<span class="line" id="L4120">    <span class="tok-comment">// note: there is padding here on 64 bit</span>
</span>
<span class="line" id="L4121">    LoaderLock: *RTL_CRITICAL_SECTION,</span>
<span class="line" id="L4122">    OSMajorVersion: ULONG,</span>
<span class="line" id="L4123">    OSMinorVersion: ULONG,</span>
<span class="line" id="L4124">    OSBuildNumber: USHORT,</span>
<span class="line" id="L4125">    OSCSDVersion: USHORT,</span>
<span class="line" id="L4126">    OSPlatformId: ULONG,</span>
<span class="line" id="L4127">    ImageSubSystem: ULONG,</span>
<span class="line" id="L4128">    ImageSubSystemMajorVersion: ULONG,</span>
<span class="line" id="L4129">    ImageSubSystemMinorVersion: ULONG,</span>
<span class="line" id="L4130">    <span class="tok-comment">// note: there is padding here on 64 bit</span>
</span>
<span class="line" id="L4131">    ActiveProcessAffinityMask: KAFFINITY,</span>
<span class="line" id="L4132">    GdiHandleBuffer: [</span>
<span class="line" id="L4133">        <span class="tok-kw">switch</span> (<span class="tok-builtin">@sizeOf</span>(<span class="tok-type">usize</span>)) {</span>
<span class="line" id="L4134">            <span class="tok-number">4</span> =&gt; <span class="tok-number">0x22</span>,</span>
<span class="line" id="L4135">            <span class="tok-number">8</span> =&gt; <span class="tok-number">0x3C</span>,</span>
<span class="line" id="L4136">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4137">        }</span>
<span class="line" id="L4138">    ]ULONG,</span>
<span class="line" id="L4139"></span>
<span class="line" id="L4140">    <span class="tok-comment">// Fields appended in 5.0 (Windows 2000):</span>
</span>
<span class="line" id="L4141">    PostProcessInitRoutine: PVOID,</span>
<span class="line" id="L4142">    TlsExpansionBitmap: *RTL_BITMAP,</span>
<span class="line" id="L4143">    TlsExpansionBitmapBits: [<span class="tok-number">32</span>]ULONG,</span>
<span class="line" id="L4144">    SessionId: ULONG,</span>
<span class="line" id="L4145">    <span class="tok-comment">// note: there is padding here on 64 bit</span>
</span>
<span class="line" id="L4146">    <span class="tok-comment">// Versions: 5.1+</span>
</span>
<span class="line" id="L4147">    AppCompatFlags: ULARGE_INTEGER,</span>
<span class="line" id="L4148">    AppCompatFlagsUser: ULARGE_INTEGER,</span>
<span class="line" id="L4149">    ShimData: PVOID,</span>
<span class="line" id="L4150">    <span class="tok-comment">// Versions: 5.0+</span>
</span>
<span class="line" id="L4151">    AppCompatInfo: PVOID,</span>
<span class="line" id="L4152">    CSDVersion: UNICODE_STRING,</span>
<span class="line" id="L4153"></span>
<span class="line" id="L4154">    <span class="tok-comment">// Fields appended in 5.1 (Windows XP):</span>
</span>
<span class="line" id="L4155">    ActivationContextData: *<span class="tok-kw">const</span> ACTIVATION_CONTEXT_DATA,</span>
<span class="line" id="L4156">    ProcessAssemblyStorageMap: *ASSEMBLY_STORAGE_MAP,</span>
<span class="line" id="L4157">    SystemDefaultActivationData: *<span class="tok-kw">const</span> ACTIVATION_CONTEXT_DATA,</span>
<span class="line" id="L4158">    SystemAssemblyStorageMap: *ASSEMBLY_STORAGE_MAP,</span>
<span class="line" id="L4159">    MinimumStackCommit: ULONG_PTR,</span>
<span class="line" id="L4160"></span>
<span class="line" id="L4161">    <span class="tok-comment">// Fields appended in 5.2 (Windows Server 2003):</span>
</span>
<span class="line" id="L4162">    FlsCallback: *FLS_CALLBACK_INFO,</span>
<span class="line" id="L4163">    FlsListHead: LIST_ENTRY,</span>
<span class="line" id="L4164">    FlsBitmap: *RTL_BITMAP,</span>
<span class="line" id="L4165">    FlsBitmapBits: [<span class="tok-number">4</span>]ULONG,</span>
<span class="line" id="L4166">    FlsHighIndex: ULONG,</span>
<span class="line" id="L4167"></span>
<span class="line" id="L4168">    <span class="tok-comment">// Fields appended in 6.0 (Windows Vista):</span>
</span>
<span class="line" id="L4169">    WerRegistrationData: PVOID,</span>
<span class="line" id="L4170">    WerShipAssertPtr: PVOID,</span>
<span class="line" id="L4171"></span>
<span class="line" id="L4172">    <span class="tok-comment">// Fields appended in 6.1 (Windows 7):</span>
</span>
<span class="line" id="L4173">    pUnused: PVOID, <span class="tok-comment">// previously pContextData</span>
</span>
<span class="line" id="L4174">    pImageHeaderHash: PVOID,</span>
<span class="line" id="L4175"></span>
<span class="line" id="L4176">    <span class="tok-comment">/// TODO: https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/tracingflags.htm</span></span>
<span class="line" id="L4177">    TracingFlags: ULONG,</span>
<span class="line" id="L4178"></span>
<span class="line" id="L4179">    <span class="tok-comment">// Fields appended in 6.2 (Windows 8):</span>
</span>
<span class="line" id="L4180">    CsrServerReadOnlySharedMemoryBase: ULONGLONG,</span>
<span class="line" id="L4181"></span>
<span class="line" id="L4182">    <span class="tok-comment">// Fields appended in 1511:</span>
</span>
<span class="line" id="L4183">    TppWorkerpListLock: ULONG,</span>
<span class="line" id="L4184">    TppWorkerpList: LIST_ENTRY,</span>
<span class="line" id="L4185">    WaitOnAddressHashTable: [<span class="tok-number">0x80</span>]PVOID,</span>
<span class="line" id="L4186"></span>
<span class="line" id="L4187">    <span class="tok-comment">// Fields appended in 1709:</span>
</span>
<span class="line" id="L4188">    TelemetryCoverageHeader: PVOID,</span>
<span class="line" id="L4189">    CloudFileFlags: ULONG,</span>
<span class="line" id="L4190">};</span>
<span class="line" id="L4191"></span>
<span class="line" id="L4192"><span class="tok-comment">/// The `PEB_LDR_DATA` structure is the main record of what modules are loaded in a process.</span></span>
<span class="line" id="L4193"><span class="tok-comment">/// It is essentially the head of three double-linked lists of `LDR_DATA_TABLE_ENTRY` structures which each represent one loaded module.</span></span>
<span class="line" id="L4194"><span class="tok-comment">///</span></span>
<span class="line" id="L4195"><span class="tok-comment">/// Microsoft documentation of this is incomplete, the fields here are taken from various resources including:</span></span>
<span class="line" id="L4196"><span class="tok-comment">///  - https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb_ldr_data.htm</span></span>
<span class="line" id="L4197"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PEB_LDR_DATA = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4198">    <span class="tok-comment">// Versions: 3.51 and higher</span>
</span>
<span class="line" id="L4199">    <span class="tok-comment">/// The size in bytes of the structure</span></span>
<span class="line" id="L4200">    Length: ULONG,</span>
<span class="line" id="L4201"></span>
<span class="line" id="L4202">    <span class="tok-comment">/// TRUE if the structure is prepared.</span></span>
<span class="line" id="L4203">    Initialized: BOOLEAN,</span>
<span class="line" id="L4204"></span>
<span class="line" id="L4205">    SsHandle: PVOID,</span>
<span class="line" id="L4206">    InLoadOrderModuleList: LIST_ENTRY,</span>
<span class="line" id="L4207">    InMemoryOrderModuleList: LIST_ENTRY,</span>
<span class="line" id="L4208">    InInitializationOrderModuleList: LIST_ENTRY,</span>
<span class="line" id="L4209"></span>
<span class="line" id="L4210">    <span class="tok-comment">// Versions: 5.1 and higher</span>
</span>
<span class="line" id="L4211"></span>
<span class="line" id="L4212">    <span class="tok-comment">/// No known use of this field is known in Windows 8 and higher.</span></span>
<span class="line" id="L4213">    EntryInProgress: PVOID,</span>
<span class="line" id="L4214"></span>
<span class="line" id="L4215">    <span class="tok-comment">// Versions: 6.0 from Windows Vista SP1, and higher</span>
</span>
<span class="line" id="L4216">    ShutdownInProgress: BOOLEAN,</span>
<span class="line" id="L4217"></span>
<span class="line" id="L4218">    <span class="tok-comment">/// Though ShutdownThreadId is declared as a HANDLE,</span></span>
<span class="line" id="L4219">    <span class="tok-comment">/// it is indeed the thread ID as suggested by its name.</span></span>
<span class="line" id="L4220">    <span class="tok-comment">/// It is picked up from the UniqueThread member of the CLIENT_ID in the</span></span>
<span class="line" id="L4221">    <span class="tok-comment">/// TEB of the thread that asks to terminate the process.</span></span>
<span class="line" id="L4222">    ShutdownThreadId: HANDLE,</span>
<span class="line" id="L4223">};</span>
<span class="line" id="L4224"></span>
<span class="line" id="L4225"><span class="tok-comment">/// Microsoft documentation of this is incomplete, the fields here are taken from various resources including:</span></span>
<span class="line" id="L4226"><span class="tok-comment">///  - https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb_ldr_data</span></span>
<span class="line" id="L4227"><span class="tok-comment">///  - https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntldr/ldr_data_table_entry.htm</span></span>
<span class="line" id="L4228"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LDR_DATA_TABLE_ENTRY = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4229">    Reserved1: [<span class="tok-number">2</span>]PVOID,</span>
<span class="line" id="L4230">    InMemoryOrderLinks: LIST_ENTRY,</span>
<span class="line" id="L4231">    Reserved2: [<span class="tok-number">2</span>]PVOID,</span>
<span class="line" id="L4232">    DllBase: PVOID,</span>
<span class="line" id="L4233">    EntryPoint: PVOID,</span>
<span class="line" id="L4234">    SizeOfImage: ULONG,</span>
<span class="line" id="L4235">    FullDllName: UNICODE_STRING,</span>
<span class="line" id="L4236">    Reserved4: [<span class="tok-number">8</span>]BYTE,</span>
<span class="line" id="L4237">    Reserved5: [<span class="tok-number">3</span>]PVOID,</span>
<span class="line" id="L4238">    DUMMYUNIONNAME: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4239">        CheckSum: ULONG,</span>
<span class="line" id="L4240">        Reserved6: PVOID,</span>
<span class="line" id="L4241">    },</span>
<span class="line" id="L4242">    TimeDateStamp: ULONG,</span>
<span class="line" id="L4243">};</span>
<span class="line" id="L4244"></span>
<span class="line" id="L4245"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_USER_PROCESS_PARAMETERS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4246">    AllocationSize: ULONG,</span>
<span class="line" id="L4247">    Size: ULONG,</span>
<span class="line" id="L4248">    Flags: ULONG,</span>
<span class="line" id="L4249">    DebugFlags: ULONG,</span>
<span class="line" id="L4250">    ConsoleHandle: HANDLE,</span>
<span class="line" id="L4251">    ConsoleFlags: ULONG,</span>
<span class="line" id="L4252">    hStdInput: HANDLE,</span>
<span class="line" id="L4253">    hStdOutput: HANDLE,</span>
<span class="line" id="L4254">    hStdError: HANDLE,</span>
<span class="line" id="L4255">    CurrentDirectory: CURDIR,</span>
<span class="line" id="L4256">    DllPath: UNICODE_STRING,</span>
<span class="line" id="L4257">    ImagePathName: UNICODE_STRING,</span>
<span class="line" id="L4258">    CommandLine: UNICODE_STRING,</span>
<span class="line" id="L4259">    Environment: [*:<span class="tok-number">0</span>]WCHAR,</span>
<span class="line" id="L4260">    dwX: ULONG,</span>
<span class="line" id="L4261">    dwY: ULONG,</span>
<span class="line" id="L4262">    dwXSize: ULONG,</span>
<span class="line" id="L4263">    dwYSize: ULONG,</span>
<span class="line" id="L4264">    dwXCountChars: ULONG,</span>
<span class="line" id="L4265">    dwYCountChars: ULONG,</span>
<span class="line" id="L4266">    dwFillAttribute: ULONG,</span>
<span class="line" id="L4267">    dwFlags: ULONG,</span>
<span class="line" id="L4268">    dwShowWindow: ULONG,</span>
<span class="line" id="L4269">    WindowTitle: UNICODE_STRING,</span>
<span class="line" id="L4270">    Desktop: UNICODE_STRING,</span>
<span class="line" id="L4271">    ShellInfo: UNICODE_STRING,</span>
<span class="line" id="L4272">    RuntimeInfo: UNICODE_STRING,</span>
<span class="line" id="L4273">    DLCurrentDirectory: [<span class="tok-number">0x20</span>]RTL_DRIVE_LETTER_CURDIR,</span>
<span class="line" id="L4274">};</span>
<span class="line" id="L4275"></span>
<span class="line" id="L4276"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_DRIVE_LETTER_CURDIR = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4277">    Flags: <span class="tok-type">c_ushort</span>,</span>
<span class="line" id="L4278">    Length: <span class="tok-type">c_ushort</span>,</span>
<span class="line" id="L4279">    TimeStamp: ULONG,</span>
<span class="line" id="L4280">    DosPath: UNICODE_STRING,</span>
<span class="line" id="L4281">};</span>
<span class="line" id="L4282"></span>
<span class="line" id="L4283"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PPS_POST_PROCESS_INIT_ROUTINE = ?*<span class="tok-kw">const</span> <span class="tok-kw">fn</span> () <span class="tok-kw">callconv</span>(.C) <span class="tok-type">void</span>;</span>
<span class="line" id="L4284"></span>
<span class="line" id="L4285"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_DIRECTORY_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4286">    NextEntryOffset: ULONG,</span>
<span class="line" id="L4287">    FileIndex: ULONG,</span>
<span class="line" id="L4288">    CreationTime: LARGE_INTEGER,</span>
<span class="line" id="L4289">    LastAccessTime: LARGE_INTEGER,</span>
<span class="line" id="L4290">    LastWriteTime: LARGE_INTEGER,</span>
<span class="line" id="L4291">    ChangeTime: LARGE_INTEGER,</span>
<span class="line" id="L4292">    EndOfFile: LARGE_INTEGER,</span>
<span class="line" id="L4293">    AllocationSize: LARGE_INTEGER,</span>
<span class="line" id="L4294">    FileAttributes: ULONG,</span>
<span class="line" id="L4295">    FileNameLength: ULONG,</span>
<span class="line" id="L4296">    FileName: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L4297">};</span>
<span class="line" id="L4298"></span>
<span class="line" id="L4299"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_BOTH_DIR_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4300">    NextEntryOffset: ULONG,</span>
<span class="line" id="L4301">    FileIndex: ULONG,</span>
<span class="line" id="L4302">    CreationTime: LARGE_INTEGER,</span>
<span class="line" id="L4303">    LastAccessTime: LARGE_INTEGER,</span>
<span class="line" id="L4304">    LastWriteTime: LARGE_INTEGER,</span>
<span class="line" id="L4305">    ChangeTime: LARGE_INTEGER,</span>
<span class="line" id="L4306">    EndOfFile: LARGE_INTEGER,</span>
<span class="line" id="L4307">    AllocationSize: LARGE_INTEGER,</span>
<span class="line" id="L4308">    FileAttributes: ULONG,</span>
<span class="line" id="L4309">    FileNameLength: ULONG,</span>
<span class="line" id="L4310">    EaSize: ULONG,</span>
<span class="line" id="L4311">    ShortNameLength: CHAR,</span>
<span class="line" id="L4312">    ShortName: [<span class="tok-number">12</span>]WCHAR,</span>
<span class="line" id="L4313">    FileName: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L4314">};</span>
<span class="line" id="L4315"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_BOTH_DIRECTORY_INFORMATION = FILE_BOTH_DIR_INFORMATION;</span>
<span class="line" id="L4316"></span>
<span class="line" id="L4317"><span class="tok-comment">/// Helper for iterating a byte buffer of FILE_*_INFORMATION structures (from</span></span>
<span class="line" id="L4318"><span class="tok-comment">/// things like NtQueryDirectoryFile calls).</span></span>
<span class="line" id="L4319"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">FileInformationIterator</span>(<span class="tok-kw">comptime</span> FileInformationType: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L4320">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4321">        byte_offset: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L4322">        buf: []<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(FileInformationType)),</span>
<span class="line" id="L4323"></span>
<span class="line" id="L4324">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">next</span>(self: *<span class="tok-builtin">@This</span>()) ?*FileInformationType {</span>
<span class="line" id="L4325">            <span class="tok-kw">if</span> (self.byte_offset &gt;= self.buf.len) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L4326">            <span class="tok-kw">const</span> cur: *FileInformationType = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(&amp;self.buf[self.byte_offset]));</span>
<span class="line" id="L4327">            <span class="tok-kw">if</span> (cur.NextEntryOffset == <span class="tok-number">0</span>) {</span>
<span class="line" id="L4328">                self.byte_offset = self.buf.len;</span>
<span class="line" id="L4329">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4330">                self.byte_offset += cur.NextEntryOffset;</span>
<span class="line" id="L4331">            }</span>
<span class="line" id="L4332">            <span class="tok-kw">return</span> cur;</span>
<span class="line" id="L4333">        }</span>
<span class="line" id="L4334">    };</span>
<span class="line" id="L4335">}</span>
<span class="line" id="L4336"></span>
<span class="line" id="L4337"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IO_APC_ROUTINE = *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (PVOID, *IO_STATUS_BLOCK, ULONG) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">void</span>;</span>
<span class="line" id="L4338"></span>
<span class="line" id="L4339"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CURDIR = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4340">    DosPath: UNICODE_STRING,</span>
<span class="line" id="L4341">    Handle: HANDLE,</span>
<span class="line" id="L4342">};</span>
<span class="line" id="L4343"></span>
<span class="line" id="L4344"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DUPLICATE_SAME_ACCESS = <span class="tok-number">2</span>;</span>
<span class="line" id="L4345"></span>
<span class="line" id="L4346"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MODULEINFO = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4347">    lpBaseOfDll: LPVOID,</span>
<span class="line" id="L4348">    SizeOfImage: DWORD,</span>
<span class="line" id="L4349">    EntryPoint: LPVOID,</span>
<span class="line" id="L4350">};</span>
<span class="line" id="L4351"></span>
<span class="line" id="L4352"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PSAPI_WS_WATCH_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4353">    FaultingPc: LPVOID,</span>
<span class="line" id="L4354">    FaultingVa: LPVOID,</span>
<span class="line" id="L4355">};</span>
<span class="line" id="L4356"></span>
<span class="line" id="L4357"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> VM_COUNTERS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4358">    PeakVirtualSize: SIZE_T,</span>
<span class="line" id="L4359">    VirtualSize: SIZE_T,</span>
<span class="line" id="L4360">    PageFaultCount: ULONG,</span>
<span class="line" id="L4361">    PeakWorkingSetSize: SIZE_T,</span>
<span class="line" id="L4362">    WorkingSetSize: SIZE_T,</span>
<span class="line" id="L4363">    QuotaPeakPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4364">    QuotaPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4365">    QuotaPeakNonPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4366">    QuotaNonPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4367">    PagefileUsage: SIZE_T,</span>
<span class="line" id="L4368">    PeakPagefileUsage: SIZE_T,</span>
<span class="line" id="L4369">};</span>
<span class="line" id="L4370"></span>
<span class="line" id="L4371"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROCESS_MEMORY_COUNTERS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4372">    cb: DWORD,</span>
<span class="line" id="L4373">    PageFaultCount: DWORD,</span>
<span class="line" id="L4374">    PeakWorkingSetSize: SIZE_T,</span>
<span class="line" id="L4375">    WorkingSetSize: SIZE_T,</span>
<span class="line" id="L4376">    QuotaPeakPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4377">    QuotaPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4378">    QuotaPeakNonPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4379">    QuotaNonPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4380">    PagefileUsage: SIZE_T,</span>
<span class="line" id="L4381">    PeakPagefileUsage: SIZE_T,</span>
<span class="line" id="L4382">};</span>
<span class="line" id="L4383"></span>
<span class="line" id="L4384"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROCESS_MEMORY_COUNTERS_EX = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4385">    cb: DWORD,</span>
<span class="line" id="L4386">    PageFaultCount: DWORD,</span>
<span class="line" id="L4387">    PeakWorkingSetSize: SIZE_T,</span>
<span class="line" id="L4388">    WorkingSetSize: SIZE_T,</span>
<span class="line" id="L4389">    QuotaPeakPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4390">    QuotaPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4391">    QuotaPeakNonPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4392">    QuotaNonPagedPoolUsage: SIZE_T,</span>
<span class="line" id="L4393">    PagefileUsage: SIZE_T,</span>
<span class="line" id="L4394">    PeakPagefileUsage: SIZE_T,</span>
<span class="line" id="L4395">    PrivateUsage: SIZE_T,</span>
<span class="line" id="L4396">};</span>
<span class="line" id="L4397"></span>
<span class="line" id="L4398"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetProcessMemoryInfoError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L4399">    AccessDenied,</span>
<span class="line" id="L4400">    InvalidHandle,</span>
<span class="line" id="L4401">    Unexpected,</span>
<span class="line" id="L4402">};</span>
<span class="line" id="L4403"></span>
<span class="line" id="L4404"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">GetProcessMemoryInfo</span>(hProcess: HANDLE) GetProcessMemoryInfoError!VM_COUNTERS {</span>
<span class="line" id="L4405">    <span class="tok-kw">var</span> vmc: VM_COUNTERS = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4406">    <span class="tok-kw">const</span> rc = ntdll.NtQueryInformationProcess(hProcess, .ProcessVmCounters, &amp;vmc, <span class="tok-builtin">@sizeOf</span>(VM_COUNTERS), <span class="tok-null">null</span>);</span>
<span class="line" id="L4407">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L4408">        .SUCCESS =&gt; <span class="tok-kw">return</span> vmc,</span>
<span class="line" id="L4409">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L4410">        .INVALID_HANDLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidHandle,</span>
<span class="line" id="L4411">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L4412">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L4413">    }</span>
<span class="line" id="L4414">}</span>
<span class="line" id="L4415"></span>
<span class="line" id="L4416"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PERFORMANCE_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4417">    cb: DWORD,</span>
<span class="line" id="L4418">    CommitTotal: SIZE_T,</span>
<span class="line" id="L4419">    CommitLimit: SIZE_T,</span>
<span class="line" id="L4420">    CommitPeak: SIZE_T,</span>
<span class="line" id="L4421">    PhysicalTotal: SIZE_T,</span>
<span class="line" id="L4422">    PhysicalAvailable: SIZE_T,</span>
<span class="line" id="L4423">    SystemCache: SIZE_T,</span>
<span class="line" id="L4424">    KernelTotal: SIZE_T,</span>
<span class="line" id="L4425">    KernelPaged: SIZE_T,</span>
<span class="line" id="L4426">    KernelNonpaged: SIZE_T,</span>
<span class="line" id="L4427">    PageSize: SIZE_T,</span>
<span class="line" id="L4428">    HandleCount: DWORD,</span>
<span class="line" id="L4429">    ProcessCount: DWORD,</span>
<span class="line" id="L4430">    ThreadCount: DWORD,</span>
<span class="line" id="L4431">};</span>
<span class="line" id="L4432"></span>
<span class="line" id="L4433"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ENUM_PAGE_FILE_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4434">    cb: DWORD,</span>
<span class="line" id="L4435">    Reserved: DWORD,</span>
<span class="line" id="L4436">    TotalSize: SIZE_T,</span>
<span class="line" id="L4437">    TotalInUse: SIZE_T,</span>
<span class="line" id="L4438">    PeakUsage: SIZE_T,</span>
<span class="line" id="L4439">};</span>
<span class="line" id="L4440"></span>
<span class="line" id="L4441"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PENUM_PAGE_FILE_CALLBACKW = ?*<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (?LPVOID, *ENUM_PAGE_FILE_INFORMATION, LPCWSTR) <span class="tok-kw">callconv</span>(.C) BOOL;</span>
<span class="line" id="L4442"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PENUM_PAGE_FILE_CALLBACKA = ?*<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (?LPVOID, *ENUM_PAGE_FILE_INFORMATION, LPCSTR) <span class="tok-kw">callconv</span>(.C) BOOL;</span>
<span class="line" id="L4443"></span>
<span class="line" id="L4444"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PSAPI_WS_WATCH_INFORMATION_EX = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4445">    BasicInfo: PSAPI_WS_WATCH_INFORMATION,</span>
<span class="line" id="L4446">    FaultingThreadId: ULONG_PTR,</span>
<span class="line" id="L4447">    Flags: ULONG_PTR,</span>
<span class="line" id="L4448">};</span>
<span class="line" id="L4449"></span>
<span class="line" id="L4450"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OSVERSIONINFOW = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4451">    dwOSVersionInfoSize: ULONG,</span>
<span class="line" id="L4452">    dwMajorVersion: ULONG,</span>
<span class="line" id="L4453">    dwMinorVersion: ULONG,</span>
<span class="line" id="L4454">    dwBuildNumber: ULONG,</span>
<span class="line" id="L4455">    dwPlatformId: ULONG,</span>
<span class="line" id="L4456">    szCSDVersion: [<span class="tok-number">128</span>]WCHAR,</span>
<span class="line" id="L4457">};</span>
<span class="line" id="L4458"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RTL_OSVERSIONINFOW = OSVERSIONINFOW;</span>
<span class="line" id="L4459"></span>
<span class="line" id="L4460"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> REPARSE_DATA_BUFFER = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4461">    ReparseTag: ULONG,</span>
<span class="line" id="L4462">    ReparseDataLength: USHORT,</span>
<span class="line" id="L4463">    Reserved: USHORT,</span>
<span class="line" id="L4464">    DataBuffer: [<span class="tok-number">1</span>]UCHAR,</span>
<span class="line" id="L4465">};</span>
<span class="line" id="L4466"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYMBOLIC_LINK_REPARSE_BUFFER = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4467">    SubstituteNameOffset: USHORT,</span>
<span class="line" id="L4468">    SubstituteNameLength: USHORT,</span>
<span class="line" id="L4469">    PrintNameOffset: USHORT,</span>
<span class="line" id="L4470">    PrintNameLength: USHORT,</span>
<span class="line" id="L4471">    Flags: ULONG,</span>
<span class="line" id="L4472">    PathBuffer: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L4473">};</span>
<span class="line" id="L4474"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOUNT_POINT_REPARSE_BUFFER = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4475">    SubstituteNameOffset: USHORT,</span>
<span class="line" id="L4476">    SubstituteNameLength: USHORT,</span>
<span class="line" id="L4477">    PrintNameOffset: USHORT,</span>
<span class="line" id="L4478">    PrintNameLength: USHORT,</span>
<span class="line" id="L4479">    PathBuffer: [<span class="tok-number">1</span>]WCHAR,</span>
<span class="line" id="L4480">};</span>
<span class="line" id="L4481"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAXIMUM_REPARSE_DATA_BUFFER_SIZE: ULONG = <span class="tok-number">16</span> * <span class="tok-number">1024</span>;</span>
<span class="line" id="L4482"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FSCTL_SET_REPARSE_POINT: DWORD = <span class="tok-number">0x900a4</span>;</span>
<span class="line" id="L4483"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FSCTL_GET_REPARSE_POINT: DWORD = <span class="tok-number">0x900a8</span>;</span>
<span class="line" id="L4484"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IO_REPARSE_TAG_SYMLINK: ULONG = <span class="tok-number">0xa000000c</span>;</span>
<span class="line" id="L4485"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IO_REPARSE_TAG_MOUNT_POINT: ULONG = <span class="tok-number">0xa0000003</span>;</span>
<span class="line" id="L4486"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYMLINK_FLAG_RELATIVE: ULONG = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L4487"></span>
<span class="line" id="L4488"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYMBOLIC_LINK_FLAG_DIRECTORY: DWORD = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L4489"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYMBOLIC_LINK_FLAG_ALLOW_UNPRIVILEGED_CREATE: DWORD = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L4490"></span>
<span class="line" id="L4491"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOUNTMGR_MOUNT_POINT = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4492">    SymbolicLinkNameOffset: ULONG,</span>
<span class="line" id="L4493">    SymbolicLinkNameLength: USHORT,</span>
<span class="line" id="L4494">    Reserved1: USHORT,</span>
<span class="line" id="L4495">    UniqueIdOffset: ULONG,</span>
<span class="line" id="L4496">    UniqueIdLength: USHORT,</span>
<span class="line" id="L4497">    Reserved2: USHORT,</span>
<span class="line" id="L4498">    DeviceNameOffset: ULONG,</span>
<span class="line" id="L4499">    DeviceNameLength: USHORT,</span>
<span class="line" id="L4500">    Reserved3: USHORT,</span>
<span class="line" id="L4501">};</span>
<span class="line" id="L4502"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOUNTMGR_MOUNT_POINTS = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4503">    Size: ULONG,</span>
<span class="line" id="L4504">    NumberOfMountPoints: ULONG,</span>
<span class="line" id="L4505">    MountPoints: [<span class="tok-number">1</span>]MOUNTMGR_MOUNT_POINT,</span>
<span class="line" id="L4506">};</span>
<span class="line" id="L4507"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IOCTL_MOUNTMGR_QUERY_POINTS: ULONG = <span class="tok-number">0x6d0008</span>;</span>
<span class="line" id="L4508"></span>
<span class="line" id="L4509"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJECT_INFORMATION_CLASS = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L4510">    ObjectBasicInformation = <span class="tok-number">0</span>,</span>
<span class="line" id="L4511">    ObjectNameInformation = <span class="tok-number">1</span>,</span>
<span class="line" id="L4512">    ObjectTypeInformation = <span class="tok-number">2</span>,</span>
<span class="line" id="L4513">    ObjectTypesInformation = <span class="tok-number">3</span>,</span>
<span class="line" id="L4514">    ObjectHandleFlagInformation = <span class="tok-number">4</span>,</span>
<span class="line" id="L4515">    ObjectSessionInformation = <span class="tok-number">5</span>,</span>
<span class="line" id="L4516">    MaxObjectInfoClass,</span>
<span class="line" id="L4517">};</span>
<span class="line" id="L4518"></span>
<span class="line" id="L4519"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OBJECT_NAME_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4520">    Name: UNICODE_STRING,</span>
<span class="line" id="L4521">};</span>
<span class="line" id="L4522"></span>
<span class="line" id="L4523"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SRWLOCK_INIT = SRWLOCK{};</span>
<span class="line" id="L4524"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SRWLOCK = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4525">    Ptr: ?PVOID = <span class="tok-null">null</span>,</span>
<span class="line" id="L4526">};</span>
<span class="line" id="L4527"></span>
<span class="line" id="L4528"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CONDITION_VARIABLE_INIT = CONDITION_VARIABLE{};</span>
<span class="line" id="L4529"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CONDITION_VARIABLE = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4530">    Ptr: ?PVOID = <span class="tok-null">null</span>,</span>
<span class="line" id="L4531">};</span>
<span class="line" id="L4532"></span>
<span class="line" id="L4533"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SKIP_COMPLETION_PORT_ON_SUCCESS = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L4534"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FILE_SKIP_SET_EVENT_ON_HANDLE = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L4535"></span>
<span class="line" id="L4536"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CTRL_C_EVENT: DWORD = <span class="tok-number">0</span>;</span>
<span class="line" id="L4537"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CTRL_BREAK_EVENT: DWORD = <span class="tok-number">1</span>;</span>
<span class="line" id="L4538"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CTRL_CLOSE_EVENT: DWORD = <span class="tok-number">2</span>;</span>
<span class="line" id="L4539"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CTRL_LOGOFF_EVENT: DWORD = <span class="tok-number">5</span>;</span>
<span class="line" id="L4540"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CTRL_SHUTDOWN_EVENT: DWORD = <span class="tok-number">6</span>;</span>
<span class="line" id="L4541"></span>
<span class="line" id="L4542"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> HANDLER_ROUTINE = *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (dwCtrlType: DWORD) <span class="tok-kw">callconv</span>(WINAPI) BOOL;</span>
<span class="line" id="L4543"></span>
<span class="line" id="L4544"><span class="tok-comment">/// Processor feature enumeration.</span></span>
<span class="line" id="L4545"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PF = <span class="tok-kw">enum</span>(DWORD) {</span>
<span class="line" id="L4546">    <span class="tok-comment">/// On a Pentium, a floating-point precision error can occur in rare circumstances.</span></span>
<span class="line" id="L4547">    FLOATING_POINT_PRECISION_ERRATA = <span class="tok-number">0</span>,</span>
<span class="line" id="L4548"></span>
<span class="line" id="L4549">    <span class="tok-comment">/// Floating-point operations are emulated using software emulator.</span></span>
<span class="line" id="L4550">    <span class="tok-comment">/// This function returns a nonzero value if floating-point operations are emulated; otherwise, it returns zero.</span></span>
<span class="line" id="L4551">    FLOATING_POINT_EMULATED = <span class="tok-number">1</span>,</span>
<span class="line" id="L4552"></span>
<span class="line" id="L4553">    <span class="tok-comment">/// The atomic compare and exchange operation (cmpxchg) is available.</span></span>
<span class="line" id="L4554">    COMPARE_EXCHANGE_DOUBLE = <span class="tok-number">2</span>,</span>
<span class="line" id="L4555"></span>
<span class="line" id="L4556">    <span class="tok-comment">/// The MMX instruction set is available.</span></span>
<span class="line" id="L4557">    MMX_INSTRUCTIONS_AVAILABLE = <span class="tok-number">3</span>,</span>
<span class="line" id="L4558"></span>
<span class="line" id="L4559">    PPC_MOVEMEM_64BIT_OK = <span class="tok-number">4</span>,</span>
<span class="line" id="L4560">    ALPHA_BYTE_INSTRUCTIONS = <span class="tok-number">5</span>,</span>
<span class="line" id="L4561"></span>
<span class="line" id="L4562">    <span class="tok-comment">/// The SSE instruction set is available.</span></span>
<span class="line" id="L4563">    XMMI_INSTRUCTIONS_AVAILABLE = <span class="tok-number">6</span>,</span>
<span class="line" id="L4564"></span>
<span class="line" id="L4565">    <span class="tok-comment">/// The 3D-Now instruction is available.</span></span>
<span class="line" id="L4566">    @&quot;3DNOW_INSTRUCTIONS_AVAILABLE&quot; = <span class="tok-number">7</span>,</span>
<span class="line" id="L4567"></span>
<span class="line" id="L4568">    <span class="tok-comment">/// The RDTSC instruction is available.</span></span>
<span class="line" id="L4569">    RDTSC_INSTRUCTION_AVAILABLE = <span class="tok-number">8</span>,</span>
<span class="line" id="L4570"></span>
<span class="line" id="L4571">    <span class="tok-comment">/// The processor is PAE-enabled.</span></span>
<span class="line" id="L4572">    PAE_ENABLED = <span class="tok-number">9</span>,</span>
<span class="line" id="L4573"></span>
<span class="line" id="L4574">    <span class="tok-comment">/// The SSE2 instruction set is available.</span></span>
<span class="line" id="L4575">    XMMI64_INSTRUCTIONS_AVAILABLE = <span class="tok-number">10</span>,</span>
<span class="line" id="L4576"></span>
<span class="line" id="L4577">    SSE_DAZ_MODE_AVAILABLE = <span class="tok-number">11</span>,</span>
<span class="line" id="L4578"></span>
<span class="line" id="L4579">    <span class="tok-comment">/// Data execution prevention is enabled.</span></span>
<span class="line" id="L4580">    NX_ENABLED = <span class="tok-number">12</span>,</span>
<span class="line" id="L4581"></span>
<span class="line" id="L4582">    <span class="tok-comment">/// The SSE3 instruction set is available.</span></span>
<span class="line" id="L4583">    SSE3_INSTRUCTIONS_AVAILABLE = <span class="tok-number">13</span>,</span>
<span class="line" id="L4584"></span>
<span class="line" id="L4585">    <span class="tok-comment">/// The atomic compare and exchange 128-bit operation (cmpxchg16b) is available.</span></span>
<span class="line" id="L4586">    COMPARE_EXCHANGE128 = <span class="tok-number">14</span>,</span>
<span class="line" id="L4587"></span>
<span class="line" id="L4588">    <span class="tok-comment">/// The atomic compare 64 and exchange 128-bit operation (cmp8xchg16) is available.</span></span>
<span class="line" id="L4589">    COMPARE64_EXCHANGE128 = <span class="tok-number">15</span>,</span>
<span class="line" id="L4590"></span>
<span class="line" id="L4591">    <span class="tok-comment">/// The processor channels are enabled.</span></span>
<span class="line" id="L4592">    CHANNELS_ENABLED = <span class="tok-number">16</span>,</span>
<span class="line" id="L4593"></span>
<span class="line" id="L4594">    <span class="tok-comment">/// The processor implements the XSAVI and XRSTOR instructions.</span></span>
<span class="line" id="L4595">    XSAVE_ENABLED = <span class="tok-number">17</span>,</span>
<span class="line" id="L4596"></span>
<span class="line" id="L4597">    <span class="tok-comment">/// The VFP/Neon: 32 x 64bit register bank is present.</span></span>
<span class="line" id="L4598">    <span class="tok-comment">/// This flag has the same meaning as PF_ARM_VFP_EXTENDED_REGISTERS.</span></span>
<span class="line" id="L4599">    ARM_VFP_32_REGISTERS_AVAILABLE = <span class="tok-number">18</span>,</span>
<span class="line" id="L4600"></span>
<span class="line" id="L4601">    <span class="tok-comment">/// This ARM processor implements the ARM v8 NEON instruction set.</span></span>
<span class="line" id="L4602">    ARM_NEON_INSTRUCTIONS_AVAILABLE = <span class="tok-number">19</span>,</span>
<span class="line" id="L4603"></span>
<span class="line" id="L4604">    <span class="tok-comment">/// Second Level Address Translation is supported by the hardware.</span></span>
<span class="line" id="L4605">    SECOND_LEVEL_ADDRESS_TRANSLATION = <span class="tok-number">20</span>,</span>
<span class="line" id="L4606"></span>
<span class="line" id="L4607">    <span class="tok-comment">/// Virtualization is enabled in the firmware and made available by the operating system.</span></span>
<span class="line" id="L4608">    VIRT_FIRMWARE_ENABLED = <span class="tok-number">21</span>,</span>
<span class="line" id="L4609"></span>
<span class="line" id="L4610">    <span class="tok-comment">/// RDFSBASE, RDGSBASE, WRFSBASE, and WRGSBASE instructions are available.</span></span>
<span class="line" id="L4611">    RDWRFSGBASE_AVAILABLE = <span class="tok-number">22</span>,</span>
<span class="line" id="L4612"></span>
<span class="line" id="L4613">    <span class="tok-comment">/// _fastfail() is available.</span></span>
<span class="line" id="L4614">    FASTFAIL_AVAILABLE = <span class="tok-number">23</span>,</span>
<span class="line" id="L4615"></span>
<span class="line" id="L4616">    <span class="tok-comment">/// The divide instruction_available.</span></span>
<span class="line" id="L4617">    ARM_DIVIDE_INSTRUCTION_AVAILABLE = <span class="tok-number">24</span>,</span>
<span class="line" id="L4618"></span>
<span class="line" id="L4619">    <span class="tok-comment">/// The 64-bit load/store atomic instructions are available.</span></span>
<span class="line" id="L4620">    ARM_64BIT_LOADSTORE_ATOMIC = <span class="tok-number">25</span>,</span>
<span class="line" id="L4621"></span>
<span class="line" id="L4622">    <span class="tok-comment">/// The external cache is available.</span></span>
<span class="line" id="L4623">    ARM_EXTERNAL_CACHE_AVAILABLE = <span class="tok-number">26</span>,</span>
<span class="line" id="L4624"></span>
<span class="line" id="L4625">    <span class="tok-comment">/// The floating-point multiply-accumulate instruction is available.</span></span>
<span class="line" id="L4626">    ARM_FMAC_INSTRUCTIONS_AVAILABLE = <span class="tok-number">27</span>,</span>
<span class="line" id="L4627"></span>
<span class="line" id="L4628">    RDRAND_INSTRUCTION_AVAILABLE = <span class="tok-number">28</span>,</span>
<span class="line" id="L4629"></span>
<span class="line" id="L4630">    <span class="tok-comment">/// This ARM processor implements the ARM v8 instructions set.</span></span>
<span class="line" id="L4631">    ARM_V8_INSTRUCTIONS_AVAILABLE = <span class="tok-number">29</span>,</span>
<span class="line" id="L4632"></span>
<span class="line" id="L4633">    <span class="tok-comment">/// This ARM processor implements the ARM v8 extra cryptographic instructions (i.e., AES, SHA1 and SHA2).</span></span>
<span class="line" id="L4634">    ARM_V8_CRYPTO_INSTRUCTIONS_AVAILABLE = <span class="tok-number">30</span>,</span>
<span class="line" id="L4635"></span>
<span class="line" id="L4636">    <span class="tok-comment">/// This ARM processor implements the ARM v8 extra CRC32 instructions.</span></span>
<span class="line" id="L4637">    ARM_V8_CRC32_INSTRUCTIONS_AVAILABLE = <span class="tok-number">31</span>,</span>
<span class="line" id="L4638"></span>
<span class="line" id="L4639">    RDTSCP_INSTRUCTION_AVAILABLE = <span class="tok-number">32</span>,</span>
<span class="line" id="L4640">    RDPID_INSTRUCTION_AVAILABLE = <span class="tok-number">33</span>,</span>
<span class="line" id="L4641"></span>
<span class="line" id="L4642">    <span class="tok-comment">/// This ARM processor implements the ARM v8.1 atomic instructions (e.g., CAS, SWP).</span></span>
<span class="line" id="L4643">    ARM_V81_ATOMIC_INSTRUCTIONS_AVAILABLE = <span class="tok-number">34</span>,</span>
<span class="line" id="L4644"></span>
<span class="line" id="L4645">    MONITORX_INSTRUCTION_AVAILABLE = <span class="tok-number">35</span>,</span>
<span class="line" id="L4646"></span>
<span class="line" id="L4647">    <span class="tok-comment">/// The SSSE3 instruction set is available.</span></span>
<span class="line" id="L4648">    SSSE3_INSTRUCTIONS_AVAILABLE = <span class="tok-number">36</span>,</span>
<span class="line" id="L4649"></span>
<span class="line" id="L4650">    <span class="tok-comment">/// The SSE4_1 instruction set is available.</span></span>
<span class="line" id="L4651">    SSE4_1_INSTRUCTIONS_AVAILABLE = <span class="tok-number">37</span>,</span>
<span class="line" id="L4652"></span>
<span class="line" id="L4653">    <span class="tok-comment">/// The SSE4_2 instruction set is available.</span></span>
<span class="line" id="L4654">    SSE4_2_INSTRUCTIONS_AVAILABLE = <span class="tok-number">38</span>,</span>
<span class="line" id="L4655"></span>
<span class="line" id="L4656">    <span class="tok-comment">/// The AVX instruction set is available.</span></span>
<span class="line" id="L4657">    AVX_INSTRUCTIONS_AVAILABLE = <span class="tok-number">39</span>,</span>
<span class="line" id="L4658"></span>
<span class="line" id="L4659">    <span class="tok-comment">/// The AVX2 instruction set is available.</span></span>
<span class="line" id="L4660">    AVX2_INSTRUCTIONS_AVAILABLE = <span class="tok-number">40</span>,</span>
<span class="line" id="L4661"></span>
<span class="line" id="L4662">    <span class="tok-comment">/// The AVX512F instruction set is available.</span></span>
<span class="line" id="L4663">    AVX512F_INSTRUCTIONS_AVAILABLE = <span class="tok-number">41</span>,</span>
<span class="line" id="L4664"></span>
<span class="line" id="L4665">    ERMS_AVAILABLE = <span class="tok-number">42</span>,</span>
<span class="line" id="L4666"></span>
<span class="line" id="L4667">    <span class="tok-comment">/// This ARM processor implements the ARM v8.2 Dot Product (DP) instructions.</span></span>
<span class="line" id="L4668">    ARM_V82_DP_INSTRUCTIONS_AVAILABLE = <span class="tok-number">43</span>,</span>
<span class="line" id="L4669"></span>
<span class="line" id="L4670">    <span class="tok-comment">/// This ARM processor implements the ARM v8.3 JavaScript conversion (JSCVT) instructions.</span></span>
<span class="line" id="L4671">    ARM_V83_JSCVT_INSTRUCTIONS_AVAILABLE = <span class="tok-number">44</span>,</span>
<span class="line" id="L4672">};</span>
<span class="line" id="L4673"></span>
<span class="line" id="L4674"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAX_WOW64_SHARED_ENTRIES = <span class="tok-number">16</span>;</span>
<span class="line" id="L4675"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROCESSOR_FEATURE_MAX = <span class="tok-number">64</span>;</span>
<span class="line" id="L4676"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAXIMUM_XSTATE_FEATURES = <span class="tok-number">64</span>;</span>
<span class="line" id="L4677"></span>
<span class="line" id="L4678"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KSYSTEM_TIME = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4679">    LowPart: ULONG,</span>
<span class="line" id="L4680">    High1Time: LONG,</span>
<span class="line" id="L4681">    High2Time: LONG,</span>
<span class="line" id="L4682">};</span>
<span class="line" id="L4683"></span>
<span class="line" id="L4684"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NT_PRODUCT_TYPE = <span class="tok-kw">enum</span>(INT) {</span>
<span class="line" id="L4685">    NtProductWinNt = <span class="tok-number">1</span>,</span>
<span class="line" id="L4686">    NtProductLanManNt,</span>
<span class="line" id="L4687">    NtProductServer,</span>
<span class="line" id="L4688">};</span>
<span class="line" id="L4689"></span>
<span class="line" id="L4690"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ALTERNATIVE_ARCHITECTURE_TYPE = <span class="tok-kw">enum</span>(INT) {</span>
<span class="line" id="L4691">    StandardDesign,</span>
<span class="line" id="L4692">    NEC98x86,</span>
<span class="line" id="L4693">    EndAlternatives,</span>
<span class="line" id="L4694">};</span>
<span class="line" id="L4695"></span>
<span class="line" id="L4696"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XSTATE_FEATURE = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4697">    Offset: ULONG,</span>
<span class="line" id="L4698">    Size: ULONG,</span>
<span class="line" id="L4699">};</span>
<span class="line" id="L4700"></span>
<span class="line" id="L4701"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XSTATE_CONFIGURATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4702">    EnabledFeatures: ULONG64,</span>
<span class="line" id="L4703">    Size: ULONG,</span>
<span class="line" id="L4704">    OptimizedSave: ULONG,</span>
<span class="line" id="L4705">    Features: [MAXIMUM_XSTATE_FEATURES]XSTATE_FEATURE,</span>
<span class="line" id="L4706">};</span>
<span class="line" id="L4707"></span>
<span class="line" id="L4708"><span class="tok-comment">/// Shared Kernel User Data</span></span>
<span class="line" id="L4709"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> KUSER_SHARED_DATA = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4710">    TickCountLowDeprecated: ULONG,</span>
<span class="line" id="L4711">    TickCountMultiplier: ULONG,</span>
<span class="line" id="L4712">    InterruptTime: KSYSTEM_TIME,</span>
<span class="line" id="L4713">    SystemTime: KSYSTEM_TIME,</span>
<span class="line" id="L4714">    TimeZoneBias: KSYSTEM_TIME,</span>
<span class="line" id="L4715">    ImageNumberLow: USHORT,</span>
<span class="line" id="L4716">    ImageNumberHigh: USHORT,</span>
<span class="line" id="L4717">    NtSystemRoot: [<span class="tok-number">260</span>]WCHAR,</span>
<span class="line" id="L4718">    MaxStackTraceDepth: ULONG,</span>
<span class="line" id="L4719">    CryptoExponent: ULONG,</span>
<span class="line" id="L4720">    TimeZoneId: ULONG,</span>
<span class="line" id="L4721">    LargePageMinimum: ULONG,</span>
<span class="line" id="L4722">    AitSamplingValue: ULONG,</span>
<span class="line" id="L4723">    AppCompatFlag: ULONG,</span>
<span class="line" id="L4724">    RNGSeedVersion: ULONGLONG,</span>
<span class="line" id="L4725">    GlobalValidationRunlevel: ULONG,</span>
<span class="line" id="L4726">    TimeZoneBiasStamp: LONG,</span>
<span class="line" id="L4727">    NtBuildNumber: ULONG,</span>
<span class="line" id="L4728">    NtProductType: NT_PRODUCT_TYPE,</span>
<span class="line" id="L4729">    ProductTypeIsValid: BOOLEAN,</span>
<span class="line" id="L4730">    Reserved0: [<span class="tok-number">1</span>]BOOLEAN,</span>
<span class="line" id="L4731">    NativeProcessorArchitecture: USHORT,</span>
<span class="line" id="L4732">    NtMajorVersion: ULONG,</span>
<span class="line" id="L4733">    NtMinorVersion: ULONG,</span>
<span class="line" id="L4734">    ProcessorFeatures: [PROCESSOR_FEATURE_MAX]BOOLEAN,</span>
<span class="line" id="L4735">    Reserved1: ULONG,</span>
<span class="line" id="L4736">    Reserved3: ULONG,</span>
<span class="line" id="L4737">    TimeSlip: ULONG,</span>
<span class="line" id="L4738">    AlternativeArchitecture: ALTERNATIVE_ARCHITECTURE_TYPE,</span>
<span class="line" id="L4739">    BootId: ULONG,</span>
<span class="line" id="L4740">    SystemExpirationDate: LARGE_INTEGER,</span>
<span class="line" id="L4741">    SuiteMaskY: ULONG,</span>
<span class="line" id="L4742">    KdDebuggerEnabled: BOOLEAN,</span>
<span class="line" id="L4743">    DummyUnion1: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4744">        MitigationPolicies: UCHAR,</span>
<span class="line" id="L4745">        Alt: <span class="tok-kw">packed</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4746">            NXSupportPolicy: <span class="tok-type">u2</span>,</span>
<span class="line" id="L4747">            SEHValidationPolicy: <span class="tok-type">u2</span>,</span>
<span class="line" id="L4748">            CurDirDevicesSkippedForDlls: <span class="tok-type">u2</span>,</span>
<span class="line" id="L4749">            Reserved: <span class="tok-type">u2</span>,</span>
<span class="line" id="L4750">        },</span>
<span class="line" id="L4751">    },</span>
<span class="line" id="L4752">    CyclesPerYield: USHORT,</span>
<span class="line" id="L4753">    ActiveConsoleId: ULONG,</span>
<span class="line" id="L4754">    DismountCount: ULONG,</span>
<span class="line" id="L4755">    ComPlusPackage: ULONG,</span>
<span class="line" id="L4756">    LastSystemRITEventTickCount: ULONG,</span>
<span class="line" id="L4757">    NumberOfPhysicalPages: ULONG,</span>
<span class="line" id="L4758">    SafeBootMode: BOOLEAN,</span>
<span class="line" id="L4759">    DummyUnion2: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4760">        VirtualizationFlags: UCHAR,</span>
<span class="line" id="L4761">        Alt: <span class="tok-kw">packed</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4762">            ArchStartedInEl2: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4763">            QcSlIsSupported: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4764">            SpareBits: <span class="tok-type">u6</span>,</span>
<span class="line" id="L4765">        },</span>
<span class="line" id="L4766">    },</span>
<span class="line" id="L4767">    Reserved12: [<span class="tok-number">2</span>]UCHAR,</span>
<span class="line" id="L4768">    DummyUnion3: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4769">        SharedDataFlags: ULONG,</span>
<span class="line" id="L4770">        Alt: <span class="tok-kw">packed</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4771">            DbgErrorPortPresent: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4772">            DbgElevationEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4773">            DbgVirtEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4774">            DbgInstallerDetectEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4775">            DbgLkgEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4776">            DbgDynProcessorEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4777">            DbgConsoleBrokerEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4778">            DbgSecureBootEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4779">            DbgMultiSessionSku: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4780">            DbgMultiUsersInSessionSku: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4781">            DbgStateSeparationEnabled: <span class="tok-type">u1</span>,</span>
<span class="line" id="L4782">            SpareBits: <span class="tok-type">u21</span>,</span>
<span class="line" id="L4783">        },</span>
<span class="line" id="L4784">    },</span>
<span class="line" id="L4785">    DataFlagsPad: [<span class="tok-number">1</span>]ULONG,</span>
<span class="line" id="L4786">    TestRetInstruction: ULONGLONG,</span>
<span class="line" id="L4787">    QpcFrequency: LONGLONG,</span>
<span class="line" id="L4788">    SystemCall: ULONG,</span>
<span class="line" id="L4789">    Reserved2: ULONG,</span>
<span class="line" id="L4790">    SystemCallPad: [<span class="tok-number">2</span>]ULONGLONG,</span>
<span class="line" id="L4791">    DummyUnion4: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4792">        TickCount: KSYSTEM_TIME,</span>
<span class="line" id="L4793">        TickCountQuad: ULONG64,</span>
<span class="line" id="L4794">        Alt: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4795">            ReservedTickCountOverlay: [<span class="tok-number">3</span>]ULONG,</span>
<span class="line" id="L4796">            TickCountPad: [<span class="tok-number">1</span>]ULONG,</span>
<span class="line" id="L4797">        },</span>
<span class="line" id="L4798">    },</span>
<span class="line" id="L4799">    Cookie: ULONG,</span>
<span class="line" id="L4800">    CookiePad: [<span class="tok-number">1</span>]ULONG,</span>
<span class="line" id="L4801">    ConsoleSessionForegroundProcessId: LONGLONG,</span>
<span class="line" id="L4802">    TimeUpdateLock: ULONGLONG,</span>
<span class="line" id="L4803">    BaselineSystemTimeQpc: ULONGLONG,</span>
<span class="line" id="L4804">    BaselineInterruptTimeQpc: ULONGLONG,</span>
<span class="line" id="L4805">    QpcSystemTimeIncrement: ULONGLONG,</span>
<span class="line" id="L4806">    QpcInterruptTimeIncrement: ULONGLONG,</span>
<span class="line" id="L4807">    QpcSystemTimeIncrementShift: UCHAR,</span>
<span class="line" id="L4808">    QpcInterruptTimeIncrementShift: UCHAR,</span>
<span class="line" id="L4809">    UnparkedProcessorCount: USHORT,</span>
<span class="line" id="L4810">    EnclaveFeatureMask: [<span class="tok-number">4</span>]ULONG,</span>
<span class="line" id="L4811">    TelemetryCoverageRound: ULONG,</span>
<span class="line" id="L4812">    UserModeGlobalLogger: [<span class="tok-number">16</span>]USHORT,</span>
<span class="line" id="L4813">    ImageFileExecutionOptions: ULONG,</span>
<span class="line" id="L4814">    LangGenerationCount: ULONG,</span>
<span class="line" id="L4815">    Reserved4: ULONGLONG,</span>
<span class="line" id="L4816">    InterruptTimeBias: ULONGLONG,</span>
<span class="line" id="L4817">    QpcBias: ULONGLONG,</span>
<span class="line" id="L4818">    ActiveProcessorCount: ULONG,</span>
<span class="line" id="L4819">    ActiveGroupCount: UCHAR,</span>
<span class="line" id="L4820">    Reserved9: UCHAR,</span>
<span class="line" id="L4821">    DummyUnion5: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L4822">        QpcData: USHORT,</span>
<span class="line" id="L4823">        Alt: <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4824">            QpcBypassEnabled: UCHAR,</span>
<span class="line" id="L4825">            QpcShift: UCHAR,</span>
<span class="line" id="L4826">        },</span>
<span class="line" id="L4827">    },</span>
<span class="line" id="L4828">    TimeZoneBiasEffectiveStart: LARGE_INTEGER,</span>
<span class="line" id="L4829">    TimeZoneBiasEffectiveEnd: LARGE_INTEGER,</span>
<span class="line" id="L4830">    XState: XSTATE_CONFIGURATION,</span>
<span class="line" id="L4831">    FeatureConfigurationChangeStamp: KSYSTEM_TIME,</span>
<span class="line" id="L4832">    Spare: ULONG,</span>
<span class="line" id="L4833">    UserPointerAuthMask: ULONG64,</span>
<span class="line" id="L4834">};</span>
<span class="line" id="L4835"></span>
<span class="line" id="L4836"><span class="tok-comment">/// Read-only user-mode address for the shared data.</span></span>
<span class="line" id="L4837"><span class="tok-comment">/// https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/ntexapi_x/kuser_shared_data/index.htm</span></span>
<span class="line" id="L4838"><span class="tok-comment">/// https://msrc-blog.microsoft.com/2022/04/05/randomizing-the-kuser_shared_data-structure-on-windows/</span></span>
<span class="line" id="L4839"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SharedUserData: *<span class="tok-kw">const</span> KUSER_SHARED_DATA = <span class="tok-builtin">@as</span>(*<span class="tok-kw">const</span> KUSER_SHARED_DATA, <span class="tok-builtin">@ptrFromInt</span>(<span class="tok-number">0x7FFE0000</span>));</span>
<span class="line" id="L4840"></span>
<span class="line" id="L4841"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">IsProcessorFeaturePresent</span>(feature: PF) <span class="tok-type">bool</span> {</span>
<span class="line" id="L4842">    <span class="tok-kw">if</span> (<span class="tok-builtin">@intFromEnum</span>(feature) &gt;= PROCESSOR_FEATURE_MAX) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L4843">    <span class="tok-kw">return</span> SharedUserData.ProcessorFeatures[<span class="tok-builtin">@intFromEnum</span>(feature)] == <span class="tok-number">1</span>;</span>
<span class="line" id="L4844">}</span>
<span class="line" id="L4845"></span>
<span class="line" id="L4846"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_SNAPHEAPLIST = <span class="tok-number">0x00000001</span>;</span>
<span class="line" id="L4847"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_SNAPPROCESS = <span class="tok-number">0x00000002</span>;</span>
<span class="line" id="L4848"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_SNAPTHREAD = <span class="tok-number">0x00000004</span>;</span>
<span class="line" id="L4849"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_SNAPMODULE = <span class="tok-number">0x00000008</span>;</span>
<span class="line" id="L4850"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_SNAPMODULE32 = <span class="tok-number">0x00000010</span>;</span>
<span class="line" id="L4851"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_SNAPALL = TH32CS_SNAPHEAPLIST | TH32CS_SNAPPROCESS | TH32CS_SNAPTHREAD | TH32CS_SNAPMODULE;</span>
<span class="line" id="L4852"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TH32CS_INHERIT = <span class="tok-number">0x80000000</span>;</span>
<span class="line" id="L4853"></span>
<span class="line" id="L4854"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAX_MODULE_NAME32 = <span class="tok-number">255</span>;</span>
<span class="line" id="L4855"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MODULEENTRY32 = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4856">    dwSize: DWORD,</span>
<span class="line" id="L4857">    th32ModuleID: DWORD,</span>
<span class="line" id="L4858">    th32ProcessID: DWORD,</span>
<span class="line" id="L4859">    GlblcntUsage: DWORD,</span>
<span class="line" id="L4860">    ProccntUsage: DWORD,</span>
<span class="line" id="L4861">    modBaseAddr: *BYTE,</span>
<span class="line" id="L4862">    modBaseSize: DWORD,</span>
<span class="line" id="L4863">    hModule: HMODULE,</span>
<span class="line" id="L4864">    szModule: [MAX_MODULE_NAME32 + <span class="tok-number">1</span>]CHAR,</span>
<span class="line" id="L4865">    szExePath: [MAX_PATH]CHAR,</span>
<span class="line" id="L4866">};</span>
<span class="line" id="L4867"></span>
<span class="line" id="L4868"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYSTEM_INFORMATION_CLASS = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L4869">    SystemBasicInformation = <span class="tok-number">0</span>,</span>
<span class="line" id="L4870">    SystemPerformanceInformation = <span class="tok-number">2</span>,</span>
<span class="line" id="L4871">    SystemTimeOfDayInformation = <span class="tok-number">3</span>,</span>
<span class="line" id="L4872">    SystemProcessInformation = <span class="tok-number">5</span>,</span>
<span class="line" id="L4873">    SystemProcessorPerformanceInformation = <span class="tok-number">8</span>,</span>
<span class="line" id="L4874">    SystemInterruptInformation = <span class="tok-number">23</span>,</span>
<span class="line" id="L4875">    SystemExceptionInformation = <span class="tok-number">33</span>,</span>
<span class="line" id="L4876">    SystemRegistryQuotaInformation = <span class="tok-number">37</span>,</span>
<span class="line" id="L4877">    SystemLookasideInformation = <span class="tok-number">45</span>,</span>
<span class="line" id="L4878">    SystemCodeIntegrityInformation = <span class="tok-number">103</span>,</span>
<span class="line" id="L4879">    SystemPolicyInformation = <span class="tok-number">134</span>,</span>
<span class="line" id="L4880">};</span>
<span class="line" id="L4881"></span>
<span class="line" id="L4882"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SYSTEM_BASIC_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4883">    Reserved: ULONG,</span>
<span class="line" id="L4884">    TimerResolution: ULONG,</span>
<span class="line" id="L4885">    PageSize: ULONG,</span>
<span class="line" id="L4886">    NumberOfPhysicalPages: ULONG,</span>
<span class="line" id="L4887">    LowestPhysicalPageNumber: ULONG,</span>
<span class="line" id="L4888">    HighestPhysicalPageNumber: ULONG,</span>
<span class="line" id="L4889">    AllocationGranularity: ULONG,</span>
<span class="line" id="L4890">    MinimumUserModeAddress: ULONG_PTR,</span>
<span class="line" id="L4891">    MaximumUserModeAddress: ULONG_PTR,</span>
<span class="line" id="L4892">    ActiveProcessorsAffinityMask: KAFFINITY,</span>
<span class="line" id="L4893">    NumberOfProcessors: UCHAR,</span>
<span class="line" id="L4894">};</span>
<span class="line" id="L4895"></span>
<span class="line" id="L4896"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> THREADINFOCLASS = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L4897">    ThreadBasicInformation,</span>
<span class="line" id="L4898">    ThreadTimes,</span>
<span class="line" id="L4899">    ThreadPriority,</span>
<span class="line" id="L4900">    ThreadBasePriority,</span>
<span class="line" id="L4901">    ThreadAffinityMask,</span>
<span class="line" id="L4902">    ThreadImpersonationToken,</span>
<span class="line" id="L4903">    ThreadDescriptorTableEntry,</span>
<span class="line" id="L4904">    ThreadEnableAlignmentFaultFixup,</span>
<span class="line" id="L4905">    ThreadEventPair_Reusable,</span>
<span class="line" id="L4906">    ThreadQuerySetWin32StartAddress,</span>
<span class="line" id="L4907">    ThreadZeroTlsCell,</span>
<span class="line" id="L4908">    ThreadPerformanceCount,</span>
<span class="line" id="L4909">    ThreadAmILastThread,</span>
<span class="line" id="L4910">    ThreadIdealProcessor,</span>
<span class="line" id="L4911">    ThreadPriorityBoost,</span>
<span class="line" id="L4912">    ThreadSetTlsArrayAddress,</span>
<span class="line" id="L4913">    ThreadIsIoPending,</span>
<span class="line" id="L4914">    <span class="tok-comment">// Windows 2000+ from here</span>
</span>
<span class="line" id="L4915">    ThreadHideFromDebugger,</span>
<span class="line" id="L4916">    <span class="tok-comment">// Windows XP+ from here</span>
</span>
<span class="line" id="L4917">    ThreadBreakOnTermination,</span>
<span class="line" id="L4918">    ThreadSwitchLegacyState,</span>
<span class="line" id="L4919">    ThreadIsTerminated,</span>
<span class="line" id="L4920">    <span class="tok-comment">// Windows Vista+ from here</span>
</span>
<span class="line" id="L4921">    ThreadLastSystemCall,</span>
<span class="line" id="L4922">    ThreadIoPriority,</span>
<span class="line" id="L4923">    ThreadCycleTime,</span>
<span class="line" id="L4924">    ThreadPagePriority,</span>
<span class="line" id="L4925">    ThreadActualBasePriority,</span>
<span class="line" id="L4926">    ThreadTebInformation,</span>
<span class="line" id="L4927">    ThreadCSwitchMon,</span>
<span class="line" id="L4928">    <span class="tok-comment">// Windows 7+ from here</span>
</span>
<span class="line" id="L4929">    ThreadCSwitchPmu,</span>
<span class="line" id="L4930">    ThreadWow64Context,</span>
<span class="line" id="L4931">    ThreadGroupInformation,</span>
<span class="line" id="L4932">    ThreadUmsInformation,</span>
<span class="line" id="L4933">    ThreadCounterProfiling,</span>
<span class="line" id="L4934">    ThreadIdealProcessorEx,</span>
<span class="line" id="L4935">    <span class="tok-comment">// Windows 8+ from here</span>
</span>
<span class="line" id="L4936">    ThreadCpuAccountingInformation,</span>
<span class="line" id="L4937">    <span class="tok-comment">// Windows 8.1+ from here</span>
</span>
<span class="line" id="L4938">    ThreadSuspendCount,</span>
<span class="line" id="L4939">    <span class="tok-comment">// Windows 10+ from here</span>
</span>
<span class="line" id="L4940">    ThreadHeterogeneousCpuPolicy,</span>
<span class="line" id="L4941">    ThreadContainerId,</span>
<span class="line" id="L4942">    ThreadNameInformation,</span>
<span class="line" id="L4943">    ThreadSelectedCpuSets,</span>
<span class="line" id="L4944">    ThreadSystemThreadInformation,</span>
<span class="line" id="L4945">    ThreadActualGroupAffinity,</span>
<span class="line" id="L4946">};</span>
<span class="line" id="L4947"></span>
<span class="line" id="L4948"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROCESSINFOCLASS = <span class="tok-kw">enum</span>(<span class="tok-type">c_int</span>) {</span>
<span class="line" id="L4949">    ProcessBasicInformation,</span>
<span class="line" id="L4950">    ProcessQuotaLimits,</span>
<span class="line" id="L4951">    ProcessIoCounters,</span>
<span class="line" id="L4952">    ProcessVmCounters,</span>
<span class="line" id="L4953">    ProcessTimes,</span>
<span class="line" id="L4954">    ProcessBasePriority,</span>
<span class="line" id="L4955">    ProcessRaisePriority,</span>
<span class="line" id="L4956">    ProcessDebugPort,</span>
<span class="line" id="L4957">    ProcessExceptionPort,</span>
<span class="line" id="L4958">    ProcessAccessToken,</span>
<span class="line" id="L4959">    ProcessLdtInformation,</span>
<span class="line" id="L4960">    ProcessLdtSize,</span>
<span class="line" id="L4961">    ProcessDefaultHardErrorMode,</span>
<span class="line" id="L4962">    ProcessIoPortHandlers,</span>
<span class="line" id="L4963">    ProcessPooledUsageAndLimits,</span>
<span class="line" id="L4964">    ProcessWorkingSetWatch,</span>
<span class="line" id="L4965">    ProcessUserModeIOPL,</span>
<span class="line" id="L4966">    ProcessEnableAlignmentFaultFixup,</span>
<span class="line" id="L4967">    ProcessPriorityClass,</span>
<span class="line" id="L4968">    ProcessWx86Information,</span>
<span class="line" id="L4969">    ProcessHandleCount,</span>
<span class="line" id="L4970">    ProcessAffinityMask,</span>
<span class="line" id="L4971">    ProcessPriorityBoost,</span>
<span class="line" id="L4972">    ProcessDeviceMap,</span>
<span class="line" id="L4973">    ProcessSessionInformation,</span>
<span class="line" id="L4974">    ProcessForegroundInformation,</span>
<span class="line" id="L4975">    ProcessWow64Information,</span>
<span class="line" id="L4976">    ProcessImageFileName,</span>
<span class="line" id="L4977">    ProcessLUIDDeviceMapsEnabled,</span>
<span class="line" id="L4978">    ProcessBreakOnTermination,</span>
<span class="line" id="L4979">    ProcessDebugObjectHandle,</span>
<span class="line" id="L4980">    ProcessDebugFlags,</span>
<span class="line" id="L4981">    ProcessHandleTracing,</span>
<span class="line" id="L4982">    ProcessIoPriority,</span>
<span class="line" id="L4983">    ProcessExecuteFlags,</span>
<span class="line" id="L4984">    ProcessTlsInformation,</span>
<span class="line" id="L4985">    ProcessCookie,</span>
<span class="line" id="L4986">    ProcessImageInformation,</span>
<span class="line" id="L4987">    ProcessCycleTime,</span>
<span class="line" id="L4988">    ProcessPagePriority,</span>
<span class="line" id="L4989">    ProcessInstrumentationCallback,</span>
<span class="line" id="L4990">    ProcessThreadStackAllocation,</span>
<span class="line" id="L4991">    ProcessWorkingSetWatchEx,</span>
<span class="line" id="L4992">    ProcessImageFileNameWin32,</span>
<span class="line" id="L4993">    ProcessImageFileMapping,</span>
<span class="line" id="L4994">    ProcessAffinityUpdateMode,</span>
<span class="line" id="L4995">    ProcessMemoryAllocationMode,</span>
<span class="line" id="L4996">    ProcessGroupInformation,</span>
<span class="line" id="L4997">    ProcessTokenVirtualizationEnabled,</span>
<span class="line" id="L4998">    ProcessConsoleHostProcess,</span>
<span class="line" id="L4999">    ProcessWindowInformation,</span>
<span class="line" id="L5000">    MaxProcessInfoClass,</span>
<span class="line" id="L5001">};</span>
<span class="line" id="L5002"></span>
<span class="line" id="L5003"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PROCESS_BASIC_INFORMATION = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L5004">    ExitStatus: NTSTATUS,</span>
<span class="line" id="L5005">    PebBaseAddress: *PEB,</span>
<span class="line" id="L5006">    AffinityMask: ULONG_PTR,</span>
<span class="line" id="L5007">    BasePriority: KPRIORITY,</span>
<span class="line" id="L5008">    UniqueProcessId: ULONG_PTR,</span>
<span class="line" id="L5009">    InheritedFromUniqueProcessId: ULONG_PTR,</span>
<span class="line" id="L5010">};</span>
<span class="line" id="L5011"></span>
<span class="line" id="L5012"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ReadMemoryError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5013">    Unexpected,</span>
<span class="line" id="L5014">};</span>
<span class="line" id="L5015"></span>
<span class="line" id="L5016"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ReadProcessMemory</span>(handle: HANDLE, addr: ?LPVOID, buffer: []<span class="tok-type">u8</span>) ReadMemoryError![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L5017">    <span class="tok-kw">var</span> nread: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L5018">    <span class="tok-kw">switch</span> (ntdll.NtReadVirtualMemory(</span>
<span class="line" id="L5019">        handle,</span>
<span class="line" id="L5020">        addr,</span>
<span class="line" id="L5021">        buffer.ptr,</span>
<span class="line" id="L5022">        buffer.len,</span>
<span class="line" id="L5023">        &amp;nread,</span>
<span class="line" id="L5024">    )) {</span>
<span class="line" id="L5025">        .SUCCESS =&gt; <span class="tok-kw">return</span> buffer[<span class="tok-number">0</span>..nread],</span>
<span class="line" id="L5026">        <span class="tok-comment">// TODO: map errors</span>
</span>
<span class="line" id="L5027">        <span class="tok-kw">else</span> =&gt; |rc| <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L5028">    }</span>
<span class="line" id="L5029">}</span>
<span class="line" id="L5030"></span>
<span class="line" id="L5031"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> WriteMemoryError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L5032">    Unexpected,</span>
<span class="line" id="L5033">};</span>
<span class="line" id="L5034"></span>
<span class="line" id="L5035"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">WriteProcessMemory</span>(handle: HANDLE, addr: ?LPVOID, buffer: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) WriteMemoryError!<span class="tok-type">usize</span> {</span>
<span class="line" id="L5036">    <span class="tok-kw">var</span> nwritten: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L5037">    <span class="tok-kw">switch</span> (ntdll.NtWriteVirtualMemory(</span>
<span class="line" id="L5038">        handle,</span>
<span class="line" id="L5039">        addr,</span>
<span class="line" id="L5040">        <span class="tok-builtin">@as</span>(*<span class="tok-kw">const</span> <span class="tok-type">anyopaque</span>, <span class="tok-builtin">@ptrCast</span>(buffer.ptr)),</span>
<span class="line" id="L5041">        buffer.len,</span>
<span class="line" id="L5042">        &amp;nwritten,</span>
<span class="line" id="L5043">    )) {</span>
<span class="line" id="L5044">        .SUCCESS =&gt; <span class="tok-kw">return</span> nwritten,</span>
<span class="line" id="L5045">        <span class="tok-comment">// TODO: map errors</span>
</span>
<span class="line" id="L5046">        <span class="tok-kw">else</span> =&gt; |rc| <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L5047">    }</span>
<span class="line" id="L5048">}</span>
<span class="line" id="L5049"></span>
<span class="line" id="L5050"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ProcessBaseAddressError = GetProcessMemoryInfoError || ReadMemoryError;</span>
<span class="line" id="L5051"></span>
<span class="line" id="L5052"><span class="tok-comment">/// Returns the base address of the process loaded into memory.</span></span>
<span class="line" id="L5053"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ProcessBaseAddress</span>(handle: HANDLE) ProcessBaseAddressError!HMODULE {</span>
<span class="line" id="L5054">    <span class="tok-kw">var</span> info: PROCESS_BASIC_INFORMATION = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5055">    <span class="tok-kw">var</span> nread: DWORD = <span class="tok-number">0</span>;</span>
<span class="line" id="L5056">    <span class="tok-kw">const</span> rc = ntdll.NtQueryInformationProcess(</span>
<span class="line" id="L5057">        handle,</span>
<span class="line" id="L5058">        .ProcessBasicInformation,</span>
<span class="line" id="L5059">        &amp;info,</span>
<span class="line" id="L5060">        <span class="tok-builtin">@sizeOf</span>(PROCESS_BASIC_INFORMATION),</span>
<span class="line" id="L5061">        &amp;nread,</span>
<span class="line" id="L5062">    );</span>
<span class="line" id="L5063">    <span class="tok-kw">switch</span> (rc) {</span>
<span class="line" id="L5064">        .SUCCESS =&gt; {},</span>
<span class="line" id="L5065">        .ACCESS_DENIED =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L5066">        .INVALID_HANDLE =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidHandle,</span>
<span class="line" id="L5067">        .INVALID_PARAMETER =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L5068">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> unexpectedStatus(rc),</span>
<span class="line" id="L5069">    }</span>
<span class="line" id="L5070"></span>
<span class="line" id="L5071">    <span class="tok-kw">var</span> peb_buf: [<span class="tok-builtin">@sizeOf</span>(PEB)]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-builtin">@alignOf</span>(PEB)) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L5072">    <span class="tok-kw">const</span> peb_out = <span class="tok-kw">try</span> ReadProcessMemory(handle, info.PebBaseAddress, &amp;peb_buf);</span>
<span class="line" id="L5073">    <span class="tok-kw">const</span> ppeb: *<span class="tok-kw">const</span> PEB = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@alignCast</span>(peb_out.ptr));</span>
<span class="line" id="L5074">    <span class="tok-kw">return</span> ppeb.ImageBaseAddress;</span>
<span class="line" id="L5075">}</span>
<span class="line" id="L5076"></span>
</code></pre></body>
</html>